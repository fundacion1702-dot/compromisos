<!-- ‚úÖ PARTE 1/3 ‚Äî compromisos.html (ESTILO NUEVO ‚ÄúTARJETAS / MEN√ö VISUAL‚Äù tipo la foto) -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Compromisos</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#F2F3F5"/>

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Compromisos">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      /* üé® Look & feel tipo ‚Äúmen√∫ visual‚Äù (como tu captura) */
      --bg: #F2F3F5;
      --surface: #FFFFFF;
      --surface2: #F7F8FA;
      --text: #111827;
      --muted: #6B7280;
      --border: #E5E7EB;
      --shadow: 0 10px 28px rgba(17,24,39,.08);
      --shadow2: 0 6px 18px rgba(17,24,39,.06);

      --primary: #2563EB;
      --primarySoft: rgba(37,99,235,.10);

      --danger: #DC2626;
      --dangerSoft: rgba(220,38,38,.10);

      --good: #16A34A;
      --goodSoft: rgba(22,163,74,.10);

      --chip: #EEF2FF;
      --chipText: #1F2A5A;

      --radius: 18px;
      --radius2: 22px;
      --max: 880px;

      --tap: 48px;
      --fs: 16px;
      --fsBig: 18px;

      --icon: #111827;
    }

    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      font-size: var(--fs);
    }

    a{ color:inherit; }

    .wrap{
      width: min(var(--max), calc(100% - 24px));
      margin: 0 auto;
      padding: 14px 0 92px;
    }

    /* Top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(242,243,245,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229,231,235,.7);
    }
    .topbarInner{
      width: min(var(--max), calc(100% - 24px));
      margin: 0 auto;
      padding: 12px 0;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .logo{
      width: 42px; height: 42px;
      border-radius: 14px;
      background: linear-gradient(180deg, #fff, #f3f4f6);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .logo span{ font-size: 20px; }
    .titleBox{ min-width:0; }
    .title{
      margin:0;
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      margin: 3px 0 0;
      font-size: 12.5px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topActions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
    }

    /* ‚ÄúP√≠ldoras‚Äù arriba (notifs / recibidos / vencidos) */
    .pills{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;
    }
    .pillBtn{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: 13px;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .pillBtn:active{ transform: translateY(1px); }
    .pillDot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--muted);
      opacity: .35;
    }
    .pillCount{
      min-width: 22px;
      height: 22px;
      padding: 0 7px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight: 800;
      font-size: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
    }
    .pillBtn.primary .pillDot{ background: var(--primary); opacity: .9; }
    .pillBtn.primary .pillCount{ background: var(--primarySoft); border-color: rgba(37,99,235,.18); }

    .pillBtn.danger .pillDot{ background: var(--danger); opacity: .9; }
    .pillBtn.danger .pillCount{ background: var(--dangerSoft); border-color: rgba(220,38,38,.18); }

    .pillBtn.good .pillDot{ background: var(--good); opacity: .9; }
    .pillBtn.good .pillCount{ background: var(--goodSoft); border-color: rgba(22,163,74,.18); }

    /* Men√∫ visual tipo ‚Äúcuadr√≠culas‚Äù */
    .menuGrid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .tile{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      padding: 14px 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      gap: 12px;
      min-height: 72px;
    }
    .tile:active{ transform: translateY(1px); }
    .tileIcon{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--icon);
      flex: 0 0 auto;
    }
    .tileIcon span{ font-size: 20px; }
    .tileText{ min-width:0; flex: 1 1 auto; }
    .tileTitle{
      margin:0;
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 16px;
      line-height: 1.1;
    }
    .tileMeta{
      margin: 5px 0 0;
      font-size: 12.5px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 28px;
      height: 22px;
      padding: 0 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      font-weight: 900;
      font-size: 12px;
      color: var(--text);
    }
    .badge.primary{ background: var(--primarySoft); border-color: rgba(37,99,235,.20); color: #1E40AF; }
    .badge.danger{ background: var(--dangerSoft); border-color: rgba(220,38,38,.20); color: #991B1B; }
    .badge.good{ background: var(--goodSoft); border-color: rgba(22,163,74,.20); color: #14532D; }

    /* Secciones */
    .section{
      margin-top: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow: hidden;
    }
    .sectionHead{
      padding: 14px 14px 12px;
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(229,231,235,.8);
      background: linear-gradient(180deg, #fff, #fbfbfc);
    }
    .sectionHead h2{
      margin:0;
      font-size: 16px;
      font-weight: 950;
      letter-spacing: .2px;
    }
    .sectionHead p{
      margin: 4px 0 0;
      font-size: 12.5px;
      color: var(--muted);
    }
    .segTabs{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .segBtn{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      background: var(--surface2);
      border: 1px solid var(--border);
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    .segBtn.active{
      background: var(--primarySoft);
      border-color: rgba(37,99,235,.22);
      color: #1E40AF;
    }

    /* Tarjetas (compromisos / contactos) */
    .list{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      padding: 12px 12px;
    }
    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .who .name{
      margin:0;
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 15.5px;
    }
    .who .meta{
      margin: 6px 0 0;
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: var(--chip);
      color: var(--chipText);
      border: 1px solid rgba(99,102,241,.18);
    }

    .due{
      flex: 0 0 auto;
      font-size: 12.5px;
      color: var(--muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 800;
      white-space: nowrap;
    }
    .due.bad{
      color: #991B1B;
      background: var(--dangerSoft);
      border-color: rgba(220,38,38,.20);
    }

    .desc{
      margin-top: 10px;
      color: var(--text);
      line-height: 1.35;
      font-size: 14.5px;
      padding: 10px 10px;
      border-radius: 14px;
      background: #FAFAFB;
      border: 1px solid rgba(229,231,235,.9);
    }

    .actions{
      margin-top: 10px;
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Botones */
    .btn{
      height: 40px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: var(--primarySoft);
      border-color: rgba(37,99,235,.22);
      color: #1E40AF;
    }
    .btn.good{
      background: var(--goodSoft);
      border-color: rgba(22,163,74,.22);
      color: #14532D;
    }
    .btn.danger{
      background: var(--dangerSoft);
      border-color: rgba(220,38,38,.22);
      color: #991B1B;
    }

    /* Vac√≠o */
    .empty{
      padding: 14px 12px 18px;
      color: var(--muted);
      text-align:center;
      font-size: 13.5px;
    }

    /* Bottom bar (m√°s limpio) */
    .bottomBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(229,231,235,.9);
      padding: 10px 12px;
      z-index: 20;
    }
    .bottomInner{
      width: min(var(--max), calc(100% - 24px));
      margin: 0 auto;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
    }
    .navBtn{
      flex: 1 1 0;
      height: 44px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow2);
      cursor:pointer;
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      -webkit-tap-highlight-color: transparent;
    }
    .navBtn.active{
      background: var(--primarySoft);
      border-color: rgba(37,99,235,.22);
      color: #1E40AF;
    }

    /* FAB */
    .fab{
      position: fixed;
      right: 16px;
      bottom: 82px;
      width: 56px;
      height: 56px;
      border-radius: 20px;
      border: 1px solid rgba(37,99,235,.18);
      background: #2563EB;
      color: #fff;
      font-size: 26px;
      font-weight: 900;
      display:grid;
      place-items:center;
      cursor:pointer;
      box-shadow: 0 18px 40px rgba(37,99,235,.22);
      z-index: 25;
      -webkit-tap-highlight-color: transparent;
    }
    .fab:active{ transform: translateY(1px); }

    /* Modales (misma l√≥gica, nuevo look) */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .backdrop.show{ display:flex; }

    .modal{
      width: min(560px, 100%);
      border-radius: 22px;
      background: var(--surface);
      border: 1px solid rgba(229,231,235,.9);
      box-shadow: 0 24px 70px rgba(17,24,39,.20);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(229,231,235,.9);
      background: linear-gradient(180deg, #fff, #fbfbfc);
    }
    .modalHead h3{
      margin:0;
      font-size: 16px;
      font-weight: 950;
    }
    .iconBtn{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface2);
      cursor:pointer;
      font-weight: 900;
    }
    .modalBody{ padding: 12px 14px 14px; }
    .field{ margin-top: 10px; }
    .label{
      display:block;
      font-size: 12.5px;
      color: var(--muted);
      margin: 0 0 6px;
      font-weight: 800;
    }
    input, select, textarea{
      width: 100%;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .modalFoot{
      padding: 12px 14px 14px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      border-top: 1px solid rgba(229,231,235,.9);
      justify-content:flex-end;
      background: #fff;
    }
    .dangerTxt{ color: #991B1B; font-weight: 800; }

    /* Banner instalaci√≥n */
    .installBanner{
      position: fixed;
      left: 12px; right: 12px;
      bottom: 156px;
      z-index: 30;
      display:none;
    }
    .installBanner.show{ display:block; }
    .installCard{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 12px 12px;
    }
    .installRow{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content: space-between;
    }
    .installTitle{
      margin: 0;
      font-weight: 950;
      font-size: 14.5px;
    }
    .installText{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.3;
    }

    /* Responsive */
    @media (min-width: 720px){
      .menuGrid{ grid-template-columns: 1fr 1fr 1fr 1fr; }
      .tile{ min-height: 78px; }
      .fab{ right: 22px; }
    }
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand" role="banner" aria-label="Compromisos">
        <div class="logo" aria-hidden="true"><span>üóìÔ∏è</span></div>
        <div class="titleBox">
          <p class="title">Compromisos</p>
          <p class="subtitle" id="statsKicker">Todo en tarjetas, m√°s visual.</p>
        </div>
      </div>

      <div class="topActions">
        <div class="pills" aria-label="Indicadores">
          <!-- estos IDs los usa tu JS -->
          <button class="pillBtn primary" id="btnNotifPend" type="button" title="Notificaciones pendientes">
            <span class="pillDot" aria-hidden="true"></span>
            <span>Pendientes</span>
            <span class="pillCount" id="bPending">0</span>
          </button>

          <button class="pillBtn danger" id="btnOverdue" type="button" title="Vencidos">
            <span class="pillDot" aria-hidden="true"></span>
            <span>Vencidos</span>
            <span class="pillCount" id="bOverdue">0</span>
          </button>

          <button class="pillBtn good" id="btnReceived" type="button" title="Recibidos">
            <span class="pillDot" aria-hidden="true"></span>
            <span>Recibidos</span>
            <span class="pillCount" id="bReceived">0</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Men√∫ visual (tipo tu foto) -->
    <div class="menuGrid" aria-label="Men√∫">
      <div class="tile" id="tilePending" role="button" tabindex="0">
        <div class="tileIcon"><span>üìù</span></div>
        <div class="tileText">
          <p class="tileTitle">Pendientes</p>
          <p class="tileMeta">
            <span class="badge primary" id="tilePendingCount">0</span>
            <span>compromisos</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileDone" role="button" tabindex="0">
        <div class="tileIcon"><span>‚úÖ</span></div>
        <div class="tileText">
          <p class="tileTitle">Hechos</p>
          <p class="tileMeta">
            <span class="badge good" id="tileDoneCount">0</span>
            <span>completados</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileContacts" role="button" tabindex="0">
        <div class="tileIcon"><span>üë•</span></div>
        <div class="tileText">
          <p class="tileTitle">Amigos</p>
          <p class="tileMeta">
            <span class="badge" id="tileContactsCount">0</span>
            <span>guardados</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileSettings" role="button" tabindex="0">
        <div class="tileIcon"><span>‚öôÔ∏è</span></div>
        <div class="tileText">
          <p class="tileTitle">Ajustes</p>
          <p class="tileMeta">
            <span class="badge">üîí</span>
            <span>privacidad</span>
          </p>
        </div>
      </div>
    </div>

    <!-- PANE: COMPROMISOS -->
    <div id="commitmentsPane" class="section" style="margin-top:14px;">
      <div class="sectionHead">
        <div>
          <h2>Compromisos</h2>
          <p>Todo ordenado y f√°cil de ver.</p>
        </div>
        <div class="segTabs" role="tablist" aria-label="Pendientes o Hechos">
          <button class="segBtn active" id="tabPending" type="button">Pendientes</button>
          <button class="segBtn" id="tabDone" type="button">Hechos</button>
        </div>
      </div>

      <div class="list" id="list"></div>
      <div class="empty" id="empty">No hay compromisos aqu√≠ todav√≠a.</div>
    </div>

    <!-- PANE: CONTACTOS -->
    <div id="contactsPane" class="section" style="display:none;">
      <div class="sectionHead">
        <div>
          <h2>Amigos</h2>
          <p>Toca una tarjeta para crear un compromiso con ese amigo.</p>
        </div>
        <div class="segTabs">
          <span class="badge" id="bContacts">0</span>
        </div>
      </div>

      <div class="list" id="contactsList"></div>
      <div class="empty" id="contactsEmpty">A√∫n no has creado amigos.</div>
    </div>

    <!-- PANE: SETTINGS (sigue en PARTE 2) -->
    <div id="settingsPane" class="section" style="display:none;">
      <div class="sectionHead">
        <div>
          <h2>Ajustes</h2>
          <p>Bloqueo, notificaciones y accesibilidad.</p>
        </div>
      </div>

      <!-- ‚úÖ CONTIN√öA EN PARTE 2 -->
      <div class="list" style="gap:12px;">
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Accesibilidad</p>
              <p class="meta"><span class="chip">üëÅÔ∏è Texto grande</span></p>
            </div>
            <div class="due">Ajuste r√°pido</div>
          </div>
          <div class="actions">
            <button class="btn primary" id="btnA11y" type="button">üîé Texto grande</button>
          </div>
        </div>

        <!-- (el resto de Ajustes + modales + JS va en PARTE 2 y PARTE 3) -->
      </div>
    </div>
  </div>

  <!-- Bottom nav (IDs existentes) -->
  <div class="bottomBar">
    <div class="bottomInner">
      <button class="navBtn active" id="tabCommitments" type="button">üóìÔ∏è Compromisos</button>
      <button class="navBtn" id="tabContacts" type="button">üë• Amigos</button>
      <button class="navBtn" id="tabSettings" type="button">‚öôÔ∏è Ajustes</button>
      <button class="navBtn" id="btnInstall" type="button" style="display:none;">‚¨áÔ∏è Instalar</button>
    </div>
  </div>

  <button class="fab" id="fab" type="button" aria-label="Nuevo compromiso">Ôºã</button>

  <!-- Banner instalaci√≥n (estructura; l√≥gica en JS) -->
  <div class="installBanner" id="installBanner" aria-hidden="true">
    <div class="installCard">
      <div class="installRow">
        <div>
          <p class="installTitle" id="installTitle">Inst√°lala</p>
          <p class="installText" id="installText">Consejo</p>
        </div>
        <button class="iconBtn" id="btnHideBanner" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn primary" id="btnInstallBanner" type="button" style="display:none;">‚¨áÔ∏è Instalar</button>
        <button class="btn" id="btnOpenChrome" type="button" style="display:none;">üåê Abrir en Chrome</button>
        <button class="btn" id="btnCopyLink" type="button" style="display:none;">üîó Copiar enlace</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODALES + JS COMPLETO EN PARTE 2 y PARTE 3 -->

<!-- ‚úÖ PARTE 2/3 ‚Äî MODALES + BASE JS (helpers/estado) -->

  <style>
    /* Extras de UI para el nuevo look (teclado PIN, toast, etc.) */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 88px;
      background: rgba(17,24,39,.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      font-size: 13.5px;
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      display:none;
      z-index: 60;
      max-width: min(560px, calc(100% - 24px));
      width: fit-content;
      text-align:center;
    }
    .toast.show{ display:block; }

    .twoCol{ display:flex; gap: 10px; flex-wrap: wrap; }
    .twoCol > *{ flex:1; min-width: 170px; }

    .hint{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }

    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .key{
      height: 52px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface2);
      font-weight: 950;
      font-size: 18px;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .key:active{ transform: translateY(1px); }
    .key.primary{ background: var(--primarySoft); border-color: rgba(37,99,235,.22); color:#1E40AF; }
    .key.danger{ background: var(--dangerSoft); border-color: rgba(220,38,38,.22); color:#991B1B; }

    .pinDots{ display:flex; justify-content:center; gap: 10px; margin-top: 8px; }
    .dot{
      width: 12px; height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(17,24,39,.22);
      background: rgba(17,24,39,.08);
    }
    .dot.on{
      background: rgba(37,99,235,.9);
      border-color: rgba(37,99,235,.25);
      box-shadow: 0 10px 26px rgba(37,99,235,.18);
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12.5px;
      color: #111827;
      background: #FAFAFB;
      border: 1px solid rgba(229,231,235,.95);
      padding: 10px 10px;
      border-radius: 16px;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .seg{
      display:flex;
      gap: 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      padding: 6px;
    }
    .seg button{
      flex:1;
      height: 34px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      font-weight: 900;
      cursor:pointer;
    }
    .seg button.active{
      background: var(--surface);
      border-color: rgba(229,231,235,.95);
      box-shadow: var(--shadow2);
      color: #111827;
    }
  </style>

  <!-- Modal Compromiso -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">Nuevo compromiso</h3>
        <button class="iconBtn" id="btnClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label class="label" for="fContact">¬øCon qui√©n?</label>
          <select id="fContact"></select>
          <div class="hint" id="contactHint">Elige un amigo o escribe un nombre sin guardar.</div>
        </div>

        <div class="field" id="customWhoField" style="display:none">
          <label class="label" for="fWho">Nombre (sin guardar)</label>
          <input id="fWho" type="text" placeholder="Ej: Laura / Mam√° / Juan (del trabajo)" autocomplete="off"/>
        </div>

        <div class="field">
          <label class="label" for="fWhat">¬øQu√© se acord√≥?</label>
          <textarea id="fWhat" placeholder="Ej: Te paso el PDF / Te devuelvo 20‚Ç¨ / Quedamos el jueves‚Ä¶"></textarea>
        </div>

        <div class="twoCol">
          <div class="field">
            <label class="label" for="fWhen">¬øPara cu√°ndo?</label>
            <input id="fWhen" type="datetime-local"/>
            <div class="hint">Puedes dejarlo sin fecha.</div>
          </div>

          <div class="field">
            <label class="label" for="fRemind">Recordatorio (por fecha)</label>
            <select id="fRemind">
              <option value="0">Ninguno</option>
              <option value="5">5 min antes</option>
              <option value="15">15 min antes</option>
              <option value="60">1 hora antes</option>
              <option value="1440">1 d√≠a antes</option>
            </select>
            <div class="hint">Requiere fecha.</div>
          </div>
        </div>

        <div class="field">
          <label class="label" for="fAfter">Avisar ‚Äúdesde ahora‚Äù (viaja en el enlace)</label>
          <select id="fAfter">
            <option value="0">No</option>
            <option value="5">En 5 minutos</option>
            <option value="15">En 15 minutos</option>
            <option value="60">En 1 hora</option>
            <option value="180">En 3 horas</option>
            <option value="1440">Ma√±ana (24h)</option>
          </select>
          <div class="hint">El receptor debe abrir el enlace para que se programe en su m√≥vil.</div>
        </div>

        <div class="hint">
          Al guardar, se abrir√° el modal de <b>Compartir</b> (con copiar enlace).
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="btnCancel" type="button">Cancelar</button>
        <button class="btn good" id="btnSave" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Contacto -->
  <div class="backdrop" id="cBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="cModalTitle">Nuevo amigo</h3>
        <button class="iconBtn" id="cBtnClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label class="label" for="cName">Nombre</label>
          <input id="cName" type="text" placeholder="Ej: Laura" autocomplete="off"/>
        </div>
        <div class="field">
          <label class="label" for="cNote">Nota (opcional)</label>
          <input id="cNote" type="text" placeholder="Ej: Trabajo / Vecina / Familia" autocomplete="off"/>
        </div>
        <div class="hint">Esto solo se guarda en tu m√≥vil.</div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="cBtnCancel" type="button">Cancelar</button>
        <button class="btn good" id="cBtnSave" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal PIN -->
  <div class="backdrop" id="pinBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="pinTitle">Configurar PIN</h3>
        <button class="iconBtn" id="pinClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="hint" id="pinHint" style="margin-top:0"></div>

        <div class="field" id="pinOldWrap" style="display:none">
          <label class="label" for="pinOld">PIN actual</label>
          <input id="pinOld" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNewWrap">
          <label class="label" for="pinNew">Nuevo PIN (4 d√≠gitos)</label>
          <input id="pinNew" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNew2Wrap">
          <label class="label" for="pinNew2">Repite el PIN</label>
          <input id="pinNew2" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="hint" id="pinHelp">Consejo: usa un PIN que solo t√∫ sepas.</div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="pinCancel" type="button">Cancelar</button>
        <button class="btn good" id="pinOk" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Compartir -->
  <div class="backdrop" id="shareBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3>Compartir paquete</h3>
        <button class="iconBtn" id="shareClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="hint" id="shareTitle" style="margin-top:0"></div>

        <div class="seg" role="tablist" aria-label="Formato">
          <button id="shareShort" class="active" type="button">Corto</button>
          <button id="shareLong" type="button">Detallado</button>
        </div>

        <div class="mono" id="shareTextBox" style="margin-top:10px;"></div>

        <div class="hint" style="margin-top:10px;">Enlace (puedes copiarlo directo):</div>
        <div class="mono" id="shareUrlBox" style="margin-top:8px;"></div>

        <div class="hint">Pulsa <b>Compartir</b> para enviarlo por WhatsApp/Telegram. Si no aparece, usa copiar.</div>
      </div>

      <div class="modalFoot">
        <button class="btn" id="shareCopyUrl" type="button">üîó Copiar enlace</button>
        <button class="btn" id="shareCopyAll" type="button">üìã Copiar texto+enlace</button>
        <button class="btn primary" id="shareSend" type="button">üì§ Compartir</button>
        <button class="btn danger" id="shareCancel" type="button">Hecho</button>
      </div>
    </div>
  </div>

  <!-- Overlay bloqueo -->
  <div class="backdrop" id="lockOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h3>üîí App bloqueada</h3>
        <button class="iconBtn" id="lockClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modalBody">
        <p class="hint" style="margin-top:0">Introduce tu PIN para continuar.</p>
        <div class="pinDots" aria-label="PIN">
          <div class="dot" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
          <div class="dot" id="d4"></div>
        </div>

        <div class="keypad" id="keypad">
          <button class="key" data-k="1" type="button">1</button>
          <button class="key" data-k="2" type="button">2</button>
          <button class="key" data-k="3" type="button">3</button>
          <button class="key" data-k="4" type="button">4</button>
          <button class="key" data-k="5" type="button">5</button>
          <button class="key" data-k="6" type="button">6</button>
          <button class="key" data-k="7" type="button">7</button>
          <button class="key" data-k="8" type="button">8</button>
          <button class="key" data-k="9" type="button">9</button>
          <button class="key danger" data-k="del" type="button">‚å´</button>
          <button class="key" data-k="0" type="button">0</button>
          <button class="key primary" data-k="ok" type="button">OK</button>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn" id="btnLockCopyLink" type="button">üîó Copiar enlace actual</button>
          <button class="btn danger" id="btnLockReset" type="button">üßπ Borrar todo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirm (propio) -->
  <div class="backdrop" id="confirmBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="confirmTitle">Confirmar</h3>
        <button class="iconBtn" id="confirmClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modalBody">
        <div id="confirmMsg" class="hint" style="margin-top:0; color:#111827;"></div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="confirmNo" type="button">Cancelar</button>
        <button class="btn danger" id="confirmYes" type="button">S√≠, continuar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    (function(){
      "use strict";

      const $ = (id) => document.getElementById(id);

      /* =========================
         Storage keys (mismos que ten√≠as)
         ========================= */
      const KEY = "compromisos_local_v5";
      const EVENTS_KEY = "compromisos_events_v5";
      const CONTACTS_KEY = "compromisos_contacts_v5";
      const SETTINGS_KEY = "compromisos_settings_v3";
      const REMIND_FIRED_KEY = "compromisos_remind_fired_v2";
      const AFTER_FIRED_KEY = "compromisos_after_fired_v1";

      const INBOX_PACK_KEY = "compromisos_inbox_pack_v1";
      const INBOX_TS_KEY   = "compromisos_inbox_ts_v1";

      const A11Y_KEY = "compromisos_a11y_v1";

      const PENDING_NOTIF_KEY = "compromisos_pending_notifs_v1";
      const RECEIVED_KEY = "compromisos_received_v1";

      const T = { CREATE:0, DONE:1, REOPEN:2, DELETE:3, EDIT:4 };

      function uid(){
        return "c" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function pad2(n){ return String(n).padStart(2,"0"); }

      function toast(msg){
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(()=> t.classList.remove("show"), 2400);
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function load(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          const v = JSON.parse(raw);
          return v ?? fallback;
        }catch(e){ return fallback; }
      }
      function save(key, value){
        localStorage.setItem(key, JSON.stringify(value));
      }

      function fmtDate(dt){
        if(!dt) return "Sin fecha";
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return "Sin fecha";
        const now = new Date();
        const sameYear = d.getFullYear() === now.getFullYear();
        const day = pad2(d.getDate());
        const mon = pad2(d.getMonth()+1);
        const hh = pad2(d.getHours());
        const mm = pad2(d.getMinutes());
        return (sameYear ? `${day}/${mon}` : `${day}/${mon}/${d.getFullYear()}`) + ` ${hh}:${mm}`;
      }

      function isOverdue(dt){
        if(!dt) return false;
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return false;
        return d.getTime() < Date.now();
      }

      // Base64URL (utf8-safe)
      function b64urlEncode(str){
        const b64 = btoa(unescape(encodeURIComponent(str)));
        return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
      }
      function b64urlDecode(b64url){
        let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
        while(b64.length % 4) b64 += "=";
        return decodeURIComponent(escape(atob(b64)));
      }

      /* =========================
         Datos
         ========================= */
      let data = load(KEY, []);
      let events = load(EVENTS_KEY, []);
      let contacts = load(CONTACTS_KEY, []);
      let firedMap = load(REMIND_FIRED_KEY, {});
      let afterFired = load(AFTER_FIRED_KEY, {});

      /* =========================
         Notifs ‚Äúpendientes‚Äù (contador local)
         ========================= */
      let pendingNotifs = load(PENDING_NOTIF_KEY, { c:0, at:0 });

      function ensureNotifsPill(){
        // ‚úÖ Creamos una pill extra ‚ÄúNotifs‚Äù sin tocar la PARTE 1
        const host = document.querySelector(".pills");
        if(!host) return;
        if($("btnNotifAlerts")) return;

        const b = document.createElement("button");
        b.className = "pillBtn";
        b.id = "btnNotifAlerts";
        b.type = "button";
        b.title = "Notificaciones (recordatorios/avisos disparados)";
        b.innerHTML = `
          <span class="pillDot" aria-hidden="true"></span>
          <span>Notifs</span>
          <span class="pillCount" id="bNotifPend">0</span>
        `;
        host.prepend(b);
      }

      function renderNotifAlertsBadge(){
        ensureNotifsPill();
        const c = Math.max(0, Number(pendingNotifs?.c || 0));
        const count = $("bNotifPend");
        const pill = $("btnNotifAlerts");
        if(count) count.textContent = String(c);

        if(pill){
          pill.classList.toggle("primary", c > 0);
          pill.classList.toggle("good", false);
          pill.classList.toggle("danger", false);
        }
      }

      function incNotifAlerts(){
        pendingNotifs.c = Math.max(0, Number(pendingNotifs.c || 0)) + 1;
        pendingNotifs.at = Date.now();
        save(PENDING_NOTIF_KEY, pendingNotifs);
        renderNotifAlertsBadge();
      }

      function clearNotifAlerts(){
        pendingNotifs.c = 0;
        pendingNotifs.at = Date.now();
        save(PENDING_NOTIF_KEY, pendingNotifs);
        renderNotifAlertsBadge();
        toast("Notificaciones marcadas como le√≠das");
      }

      /* =========================
         Recibidos
         ========================= */
      let received = load(RECEIVED_KEY, { c:0, last:0 });

      function incReceived(){
        received.c = Math.max(0, Number(received.c || 0)) + 1;
        received.last = Date.now();
        save(RECEIVED_KEY, received);
      }
      function clearReceived(){
        received.c = 0;
        received.last = Date.now();
        save(RECEIVED_KEY, received);
      }
      function renderReceivedBadge(){
        const c = Math.max(0, Number(received?.c || 0));
        $("bReceived").textContent = String(c);
        const pill = $("btnReceived");
        if(pill){
          pill.classList.toggle("good", c > 0);
        }
      }

      /* =========================
         Confirm modal (propio)
         ========================= */
      const Confirm = (function(){
        let resolver = null;

        function open({ title, msg, yesText, danger }){
          $("confirmTitle").textContent = title || "Confirmar";
          $("confirmMsg").innerHTML = msg || "";
          $("confirmYes").textContent = yesText || "S√≠, continuar";
          $("confirmYes").classList.toggle("danger", !!danger);

          $("confirmBackdrop").classList.add("show");
          $("confirmBackdrop").setAttribute("aria-hidden","false");
          return new Promise((resolve)=>{ resolver = resolve; });
        }
        function close(val){
          $("confirmBackdrop").classList.remove("show");
          $("confirmBackdrop").setAttribute("aria-hidden","true");
          const r = resolver;
          resolver = null;
          if(r) r(!!val);
        }

        $("confirmClose").addEventListener("click", ()=> close(false));
        $("confirmNo").addEventListener("click", ()=> close(false));
        $("confirmYes").addEventListener("click", ()=> close(true));
        $("confirmBackdrop").addEventListener("click", (e)=>{ if(e.target === $("confirmBackdrop")) close(false); });

        return { open };
      })();

      /* =========================
         Accesibilidad (texto grande)
         ========================= */
      function setTextScale(on){
        const isOn = !!on;
        document.body.style.fontSize = isOn ? "var(--fsBig)" : "var(--fs)";
        save(A11Y_KEY, { big: isOn });
        $("btnA11y").textContent = isOn ? "üîé Texto normal" : "üîé Texto grande";
      }
      function toggleTextScale(){
        const s = load(A11Y_KEY, { big:false });
        setTextScale(!s.big);
      }

      /* =========================
         Ajustes PIN / notifs (igual l√≥gica)
         ========================= */
      const defaultSettings = {
        notifEnabled: false,
        pinEnabled: false,
        pinHash: null,
        autoLockMin: 0,
        rememberMin: 10,
        unlockUntil: 0
      };
      let settings = Object.assign({}, defaultSettings, load(SETTINGS_KEY, {}));

      let sessionUnlocked = false;
      let lockAtTs = 0;

      async function sha256Base64Url(str){
        try{
          if(!crypto || !crypto.subtle) throw new Error("no subtle");
          const enc = new TextEncoder();
          const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
          const bytes = Array.from(new Uint8Array(buf));
          const b64 = btoa(String.fromCharCode(...bytes));
          return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
        }catch(e){
          let h = 0;
          const s = String(str);
          for(let i=0;i<s.length;i++){
            h = ((h<<5)-h) + s.charCodeAt(i);
            h |= 0;
          }
          return "fh_" + String(h);
        }
      }
      function normalizePin(pin){
        return String(pin||"").trim().replaceAll(/\D/g,"").slice(0,4);
      }
      async function verifyPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) return false;
        const h = await sha256Base64Url("pin:" + p);
        return settings.pinHash && h === settings.pinHash;
      }
      async function setPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) throw new Error("pin");
        settings.pinHash = await sha256Base64Url("pin:" + p);
        save(SETTINGS_KEY, settings);
      }

      function isUnlockedNow(){
        if(!settings.pinEnabled) return true;
        const now = Date.now();
        if(settings.unlockUntil && now < settings.unlockUntil) return true;
        return sessionUnlocked === true;
      }

      function applyUnlock(){
        if(!settings.pinEnabled) return;
        const now = Date.now();
        const rem = Number(settings.rememberMin || 0);
        if(rem > 0){
          settings.unlockUntil = now + rem*60*1000;
          sessionUnlocked = false;
        } else {
          settings.unlockUntil = 0;
          sessionUnlocked = true;
        }
        save(SETTINGS_KEY, settings);
      }

      function showLockOverlay(){
        if(!settings.pinEnabled) return;
        $("lockOverlay").classList.add("show");
        $("lockOverlay").setAttribute("aria-hidden","false");
      }
      function hideLockOverlay(){
        $("lockOverlay").classList.remove("show");
        $("lockOverlay").setAttribute("aria-hidden","true");
      }

      function forceLock(){
        if(!settings.pinEnabled) return;
        settings.unlockUntil = 0;
        sessionUnlocked = false;
        lockAtTs = 0;
        save(SETTINGS_KEY, settings);
        showLockOverlay();
      }

      function notifPermission(){
        try{ return Notification.permission; }catch(e){ return "unsupported"; }
      }
      function notifSupported(){
        return typeof Notification !== "undefined";
      }
      async function requestNotifPermission(){
        if(!notifSupported()){
          toast("Tu navegador no soporta notificaciones");
          return false;
        }
        try{
          const p = await Notification.requestPermission();
          if(p === "granted"){ toast("Notificaciones permitidas ‚úÖ"); return true; }
          toast("Permiso no concedido");
          return false;
        }catch(e){
          toast("No se pudo pedir permiso");
          return false;
        }
      }

      function canNotify(){
        if(!settings.notifEnabled) return false;
        if(typeof Notification === "undefined") return false;
        return Notification.permission === "granted";
      }
      function sendLocalNotification(title, body){
        try{
          if(canNotify()){
            new Notification(title, { body });
            return true;
          }
        }catch(e){}
        return false;
      }

      /* =========================
         Eventos / paquetes
         ========================= */
      function makeEvent(type, payload){
        return { id: uid(), type, at: new Date().toISOString(), payload };
      }

      function packEvent(ev){
        return { v:1, e:{ i: ev.id, t: ev.type, a: ev.at, p: ev.payload || {} } };
      }
      function unpackEvent(pack){
        if(!pack || pack.v !== 1 || !pack.e) return null;
        const e = pack.e;
        if(!e.i || e.t == null || !e.a) return null;
        return { id: e.i, type: e.t, at: e.a, payload: e.p || {} };
      }
      function makePackage(ev){
        return b64urlEncode(JSON.stringify(packEvent(ev)));
      }
      function parsePackage(p){
        const json = b64urlDecode(p);
        return JSON.parse(json);
      }
      function baseFolderUrl(){
        const path = location.pathname || "/";
        const folder = path.replace(/\/[^\/]*$/, "/");
        return location.origin + folder;
      }
      function baseFileUrl(){
        return location.origin + location.pathname;
      }
      function makeLinkFromPackage(p){
        return baseFolderUrl() + "compromisos.html#p=" + p;
      }

      /* ‚úÖ FIN PARTE 2/3
         En la PARTE 3 va TODO lo que falta:
         - applyEvent completo + limpieza firedMaps
         - render (compromisos/contacts) con tarjetas nuevas
         - CLICK en tarjeta de amigo => abrir modal compromiso con su nombre ya seleccionado ‚úÖ
         - tabs / tiles / nav
         - sharing, import (hash + buz√≥n), PWA banner
         - checkReminders (incrementa notifs arriba)
         - boot final
      */
/* =========================
         applyEvent + limpieza firedMaps
         ========================= */
      function cleanupFiredMaps(){
        const liveA = new Set();
        const liveB = new Set();

        for(const it of data){
          if(it.done) continue;

          if(it.when && Number(it.remindMin||0) > 0){
            liveA.add(firedKey(it));
          }
          if(it.afterAt && Number(it.afterMin||0) > 0){
            liveB.add(afterKey(it));
          }
        }

        const nextA = {};
        for(const k of Object.keys(firedMap||{})){
          if(liveA.has(k)) nextA[k] = firedMap[k];
        }
        firedMap = nextA;
        save(REMIND_FIRED_KEY, firedMap);

        const nextB = {};
        for(const k of Object.keys(afterFired||{})){
          if(liveB.has(k)) nextB[k] = afterFired[k];
        }
        afterFired = nextB;
        save(AFTER_FIRED_KEY, afterFired);
      }

      function applyEvent(ev){
        if(!ev || ev.type == null) return false;
        if(events.some(x => x.id === ev.id)) return false;

        let changed = false;

        if(ev.type === T.CREATE){
          const p = ev.payload || {};
          const itemId = p.i || uid();

          const afterMin = Number(p.af || 0);
          const afterAt = p.aa || null;

          if(!data.some(x => x.id === itemId)){
            data.push({
              id: itemId,
              whoId: p.c || null,
              whoName: p.w || "Sin nombre",
              what: p.s || "",
              when: p.n || null,
              remindMin: Number(p.r || 0),

              afterMin: afterMin,
              afterAt: afterAt,

              done: false,
              createdAt: p.ca || ev.at,
              doneAt: null,
              updatedAt: null
            });
            changed = true;
          } else {
            const it = data.find(x => x.id === itemId);
            if(it){
              const before = JSON.stringify(it);
              it.whoId = p.c || null;
              it.whoName = p.w || it.whoName;
              it.what = p.s ?? it.what;
              it.when = (p.n ?? it.when) || null;
              it.remindMin = Number(p.r ?? it.remindMin ?? 0);

              if(p.af != null) it.afterMin = afterMin;
              if(p.aa != null) it.afterAt = afterAt;

              it.updatedAt = ev.at;
              changed = (JSON.stringify(it) !== before);
            }
          }
        }
        else if(ev.type === T.DONE){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it && !it.done){
            it.done = true;
            it.doneAt = ev.at;
            it.updatedAt = ev.at;
            changed = true;
          }
        }
        else if(ev.type === T.REOPEN){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it && it.done){
            it.done = false;
            it.doneAt = null;
            it.updatedAt = ev.at;
            changed = true;
          }
        }
        else if(ev.type === T.DELETE){
          const p = ev.payload || {};
          const before = data.length;
          data = data.filter(x => x.id !== p.i);
          changed = (data.length !== before);
        }
        else if(ev.type === T.EDIT){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it){
            const before = JSON.stringify(it);
            if(p.w != null) it.whoName = p.w;
            if(p.c != null) it.whoId = p.c || null;
            if(p.s != null) it.what = p.s;
            if(p.n != null) it.when = p.n || null;
            if(p.r != null) it.remindMin = Number(p.r || 0);

            if(p.af != null) it.afterMin = Number(p.af || 0);
            if(p.aa != null) it.afterAt = p.aa || null;

            it.updatedAt = ev.at;
            changed = (JSON.stringify(it) !== before);
          }
        }

        events.push(ev);
        save(EVENTS_KEY, events);
        save(KEY, data);

        cleanupFiredMaps();
        return changed;
      }

      /* =========================
         Helpers (compromisos / contactos)
         ========================= */
      function contactById(id){ return contacts.find(c => c.id === id) || null; }

      function normalizedWho(item){
        if(item.whoId){
          const c = contactById(item.whoId);
          if(c && c.name) return c.name;
        }
        return item.whoName || "Sin nombre";
      }

      function shortPreview(text, n){
        const s = String(text||"").trim();
        if(s.length <= n) return s;
        return s.slice(0, n-1) + "‚Ä¶";
      }

      function remindLabel(min){
        const m = Number(min||0);
        if(!m) return "";
        if(m === 5) return "üîî 5m";
        if(m === 15) return "üîî 15m";
        if(m === 60) return "üîî 1h";
        if(m === 1440) return "üîî 1d";
        return "üîî";
      }

      /* =========================
         UI state / pesta√±as
         ========================= */
      let pane = "commitments";  // commitments | contacts | settings
      let view = "pending";      // pending | done

      function safeShow(el, show){
        if(!el) return;
        el.style.display = show ? "" : "none";
      }

      function setPane(newPane){
        pane = newPane;

        const tC = $("tabCommitments");
        const tA = $("tabContacts");
        const tS = $("tabSettings");

        if(tC) tC.classList.toggle("active", pane==="commitments");
        if(tA) tA.classList.toggle("active", pane==="contacts");
        if(tS) tS.classList.toggle("active", pane==="settings");

        safeShow($("commitmentsPane"), pane==="commitments");
        safeShow($("contactsPane"), pane==="contacts");
        safeShow($("settingsPane"), pane==="settings");

        const fab = $("fab");
        if(fab){
          if(pane === "settings") fab.style.display = "none";
          else{
            fab.style.display = "grid";
            fab.setAttribute("aria-label", pane==="contacts" ? "Nuevo amigo" : "Nuevo compromiso");
          }
        }

        renderAll();
        try{ window.scrollTo({ top: 0, behavior: "smooth" }); }catch(e){ window.scrollTo(0,0); }
      }

      function setViewPending(){
        view = "pending";
        const a = $("tabPending");
        const b = $("tabDone");
        if(a) a.classList.add("active");
        if(b) b.classList.remove("active");
        renderCommitments();
      }
      function setViewDone(){
        view = "done";
        const a = $("tabDone");
        const b = $("tabPending");
        if(a) a.classList.add("active");
        if(b) b.classList.remove("active");
        renderCommitments();
      }

      /* =========================
         Render (contadores + listas)
         ========================= */
      function updateTopBadges(){
        // Cuenta pendientes + vencidos
        const pending = data.filter(x => !x.done);
        const overdueCount = pending.filter(x => isOverdue(x.when)).length;

        // Pills del header (si existen en la PARTE 1)
        const bPend = $("bPending") || $("bPendCommit");
        if(bPend) bPend.textContent = String(pending.length);

        const bOver = $("bOverdue");
        if(bOver) bOver.textContent = String(overdueCount);

        // Recibidos (pill existente)
        if($("bReceived")) $("bReceived").textContent = String(Math.max(0, Number(received?.c || 0)));

        // Notifs (pill din√°mica)
        renderNotifAlertsBadge();
        renderReceivedBadge();
      }

      function renderCommitments(){
        updateTopBadges();

        const list = $("list");
        const empty = $("empty");
        if(!list) return;

        list.innerHTML = "";

        const pending = data.filter(x => !x.done);
        const done = data.filter(x => x.done);

        // subtabs contadores si existen
        if($("bPending")) $("bPending").textContent = String(pending.length);
        if($("bDone")) $("bDone").textContent = String(done.length);

        const items = (view === "pending") ? pending : done;

        if(empty) empty.style.display = items.length ? "none" : "block";

        // Orden visual:
        // - Pendientes: vencidos arriba, luego por fecha
        // - Hechos: por doneAt desc
        items
          .slice()
          .sort((a,b)=>{
            if(view === "pending"){
              const ao = isOverdue(a.when) ? 1 : 0;
              const bo = isOverdue(b.when) ? 1 : 0;
              if(ao !== bo) return bo - ao;
              const ta = a.when ? new Date(a.when).getTime() : Number.POSITIVE_INFINITY;
              const tb = b.when ? new Date(b.when).getTime() : Number.POSITIVE_INFINITY;
              if(ta !== tb) return ta - tb;
              const ua = new Date(a.updatedAt || a.createdAt || 0).getTime();
              const ub = new Date(b.updatedAt || b.createdAt || 0).getTime();
              return ub - ua;
            }
            return (new Date(b.doneAt||0).getTime()) - (new Date(a.doneAt||0).getTime());
          })
          .forEach((it, idx)=> list.appendChild(renderCommitmentCard(it, idx)));
      }

      function renderCommitmentCard(item, idx){
        const card = document.createElement("div");
        card.className = "card";

        // ‚úÖ Se distingue m√°s del fondo: alternamos un tono suave
        card.style.background = (idx % 2)
          ? "linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86))"
          : "linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90))";

        const who = normalizedWho(item);
        const dueText = item.when ? fmtDate(item.when) : "Sin fecha";
        const overdue = !item.done && isOverdue(item.when);

        const chips = [
          `<span class="chip">üìù ${escapeHtml(fmtDate(item.createdAt))}</span>`,
          item.updatedAt ? `<span class="chip">‚úçÔ∏è ${escapeHtml(fmtDate(item.updatedAt))}</span>` : "",
          item.done ? `<span class="chip">‚úÖ ${escapeHtml(fmtDate(item.doneAt))}</span>` : "",
          item.when && Number(item.remindMin||0) > 0 ? `<span class="chip">${escapeHtml(remindLabel(item.remindMin))}</span>` : "",
          item.afterAt && Number(item.afterMin||0) > 0 ? `<span class="chip">‚è≥ ${escapeHtml(item.afterMin>=60 ? (item.afterMin/60)+"h" : item.afterMin+"m")}</span>` : ""
        ].filter(Boolean).join("");

        card.innerHTML = `
          <div class="cardRow">
            <div style="min-width:0">
              <div class="title" title="${escapeHtml(who)}">${escapeHtml(who)}</div>
              <div class="meta">${chips}</div>
            </div>
            <div class="due ${overdue ? "danger" : ""}" style="white-space:nowrap;">
              ‚è∞ ${escapeHtml(dueText)}${overdue ? " ¬∑ Vencido" : ""}
            </div>
          </div>

          <div class="desc">${escapeHtml(item.what || "‚Äî")}</div>

          <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" type="button" data-act="cal">üìÖ Calendario</button>
            <button class="btn primary" type="button" data-act="share">üì¶ Compartir</button>
            ${item.done
              ? `<button class="btn" type="button" data-act="reopen">‚Ü©Ô∏è Reabrir</button>`
              : `<button class="btn good" type="button" data-act="done">‚úÖ Hecho</button>`
            }
            <button class="btn" type="button" data-act="edit">‚úçÔ∏è Editar</button>
            <button class="btn danger" type="button" data-act="del">üóëÔ∏è Eliminar</button>
          </div>
        `;

        card.querySelector('[data-act="cal"]').addEventListener("click", ()=> addToCalendar(item.id));
        card.querySelector('[data-act="share"]').addEventListener("click", ()=> shareSnapshot(item.id));
        card.querySelector('[data-act="edit"]').addEventListener("click", ()=> openEditModal(item.id));
        card.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteItem(item.id));
        if(item.done) card.querySelector('[data-act="reopen"]').addEventListener("click", ()=> reopen(item.id));
        else card.querySelector('[data-act="done"]').addEventListener("click", ()=> markDone(item.id));

        return card;
      }

      function renderContacts(){
        const list = $("contactsList");
        const empty = $("contactsEmpty");
        if(!list) return;

        list.innerHTML = "";
        if(empty) empty.style.display = contacts.length ? "none" : "block";

        contacts
          .slice()
          .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
          .forEach((c, idx)=> list.appendChild(renderContactCard(c, idx)));
      }

      function renderContactCard(c, idx){
        const card = document.createElement("div");
        card.className = "card";
        card.style.background = (idx % 2)
          ? "linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90))"
          : "linear-gradient(180deg, rgba(255,255,255,.93), rgba(255,255,255,.86))";

        const note = c.note ? `<span class="chip">üõà ${escapeHtml(c.note)}</span>` : "";

        card.innerHTML = `
          <div class="cardRow">
            <div style="min-width:0">
              <div class="title">${escapeHtml(c.name || "Sin nombre")}</div>
              <div class="meta">
                <span class="chip">üë• Amigo</span>
                ${note}
              </div>
            </div>
            <button class="btn primary" type="button" data-act="new" style="flex:0 0 auto;">‚ûï Compromiso</button>
          </div>
          <div class="desc">${escapeHtml(c.note || "Amigo guardado en tu m√≥vil.")}</div>
          <div class="actions" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn" type="button" data-act="edit">‚úçÔ∏è Editar</button>
            <button class="btn danger" type="button" data-act="del">üóëÔ∏è Eliminar</button>
          </div>
        `;

        // ‚úÖ Como pediste: al pulsar tarjeta O bot√≥n => abrir nuevo compromiso con ese amigo preseleccionado
        const openCommitWithFriend = () => openNewCommitmentForContact(c.id);

        card.addEventListener("click", (e)=>{
          const inBtn = e.target.closest("button");
          if(inBtn) return; // botones tienen su propio handler
          openCommitWithFriend();
        });
        card.style.cursor = "pointer";
        card.setAttribute("role","button");
        card.setAttribute("tabindex","0");
        card.addEventListener("keydown",(e)=>{
          if(e.key==="Enter" || e.key===" "){
            e.preventDefault();
            openCommitWithFriend();
          }
        });

        card.querySelector('[data-act="new"]').addEventListener("click", openCommitWithFriend);
        card.querySelector('[data-act="edit"]').addEventListener("click", ()=> openContactEdit(c.id));
        card.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteContact(c.id));

        return card;
      }

      function renderAll(){
        renderCommitments();
        renderContacts();
        fillContactSelect();
        updateSettingsUI();
        renderNotifAlertsBadge();
        renderReceivedBadge();
      }

      /* =========================
         Modal compromiso (nuevo/editar)
         ========================= */
      let editingItemId = null;

      function openModal(){
        $("backdrop").classList.add("show");
        $("backdrop").setAttribute("aria-hidden","false");
      }
      function closeModal(){
        $("backdrop").classList.remove("show");
        $("backdrop").setAttribute("aria-hidden","true");
      }

      function toggleCustomWho(show){
        const w = $("customWhoField");
        if(!w) return;
        w.style.display = show ? "" : "none";
      }

      function fillContactSelect(){
        const sel = $("fContact");
        if(!sel) return;

        const current = sel.value;
        sel.innerHTML = "";

        const optCustom = document.createElement("option");
        optCustom.value = "__custom__";
        optCustom.textContent = "‚úçÔ∏è Escribir un nombre (sin guardar)";
        sel.appendChild(optCustom);

        if(contacts.length){
          const sep = document.createElement("option");
          sep.disabled = true;
          sep.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
          sel.appendChild(sep);

          contacts
            .slice()
            .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
            .forEach(c => {
              const o = document.createElement("option");
              o.value = c.id;
              o.textContent = "üë§ " + (c.name || "Sin nombre");
              sel.appendChild(o);
            });
        }

        const optNew = document.createElement("option");
        optNew.value = "__new_contact__";
        optNew.textContent = "‚ûï Crear amigo‚Ä¶";
        sel.appendChild(optNew);

        if(current){
          sel.value = current;
          if(sel.value !== current) sel.value = "__custom__";
        } else {
          sel.value = "__custom__";
        }
      }

      function onContactSelectChanged(){
        const sel = $("fContact");
        if(!sel) return;
        const v = sel.value;

        if(v === "__custom__"){
          toggleCustomWho(true);
          return;
        }
        if(v === "__new_contact__"){
          resetContactForm();
          openContactModal();
          try{ $("cName").focus(); }catch(e){}
          sel.value = "__custom__";
          toggleCustomWho(true);
          return;
        }
        // contacto existente
        toggleCustomWho(false);
        if($("fWho")) $("fWho").value = "";
      }

      function resetCommitmentForm(){
        editingItemId = null;
        if($("modalTitle")) $("modalTitle").textContent = "Nuevo compromiso";
        if($("fWhat")) $("fWhat").value = "";
        if($("fWhen")) $("fWhen").value = "";
        if($("fWho")) $("fWho").value = "";
        if($("fRemind")) $("fRemind").value = "0";
        if($("fAfter")) $("fAfter").value = "0";
        fillContactSelect();
        if($("fContact")) $("fContact").value = "__custom__";
        toggleCustomWho(true);
      }

      function toInputDatetimeLocal(iso){
        if(!iso) return "";
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return "";
        const yyyy = d.getFullYear();
        const mm = pad2(d.getMonth()+1);
        const dd = pad2(d.getDate());
        const hh = pad2(d.getHours());
        const mi = pad2(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }

      function openEditModal(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }

        editingItemId = itemId;
        if($("modalTitle")) $("modalTitle").textContent = "Editar compromiso";

        fillContactSelect();
        if(it.whoId && contactById(it.whoId)){
          $("fContact").value = it.whoId;
          toggleCustomWho(false);
          $("fWho").value = "";
        } else {
          $("fContact").value = "__custom__";
          toggleCustomWho(true);
          $("fWho").value = it.whoName || "";
        }

        $("fWhat").value = it.what || "";
        $("fWhen").value = toInputDatetimeLocal(it.when);
        $("fRemind").value = String(Number(it.remindMin||0));
        $("fAfter").value = String(Number(it.afterMin||0));

        openModal();
        try{ $("fWhat").focus(); }catch(e){}
      }

      // ‚úÖ Abrir ‚ÄúNuevo compromiso‚Äù con un amigo ya seleccionado
      function openNewCommitmentForContact(contactId){
        const c = contactById(contactId);
        if(!c){ toast("Amigo no encontrado"); return; }

        setPane("commitments"); // nos aseguramos de estar en compromisos
        setViewPending();

        resetCommitmentForm();
        fillContactSelect();
        $("fContact").value = c.id;
        toggleCustomWho(false);
        if($("fWho")) $("fWho").value = "";
        openModal();
        try{ $("fWhat").focus(); }catch(e){}
      }

      function createOrEditCommitment(){
        const contactSel = $("fContact").value;
        const what = ($("fWhat").value || "").trim();
        const whenISO = $("fWhen").value ? new Date($("fWhen").value).toISOString() : null;
        const remindMin = Number($("fRemind").value || 0);

        const afterMin = Number($("fAfter").value || 0);
        const afterAt = afterMin > 0 ? new Date(Date.now() + afterMin*60*1000).toISOString() : null;

        if(!what){
          toast("Escribe qu√© se acord√≥");
          try{ $("fWhat").focus(); }catch(e){}
          return null;
        }

        let whoId = null;
        let whoName = "";

        if(contactSel && contactSel !== "__custom__" && contactSel !== "__new_contact__"){
          const c = contactById(contactSel);
          if(!c){ toast("Amigo no v√°lido"); return null; }
          whoId = c.id;
          whoName = c.name || "Sin nombre";
        } else {
          whoName = ($("fWho").value || "").trim();
          if(!whoName){
            toast("Pon con qui√©n es el compromiso");
            try{ $("fWho").focus(); }catch(e){}
            return null;
          }
        }

        if(remindMin > 0 && !whenISO){
          toast("Para recordatorio por fecha necesitas fecha");
          try{ $("fWhen").focus(); }catch(e){}
          return null;
        }

        const now = new Date().toISOString();

        if(!editingItemId){
          const itemId = uid();
          const ev = {
            id: uid(),
            type: T.CREATE,
            at: now,
            payload: {
              i: itemId,
              c: whoId || null,
              w: whoName,
              s: what,
              n: whenISO || null,
              r: remindMin || 0,
              af: afterMin || 0,
              aa: afterAt || null,
              ca: now
            }
          };
          const changed = applyEvent(ev);
          if(!changed){ toast("No se pudo guardar"); return null; }
          return { itemId, ev };
        } else {
          const it = data.find(x => x.id === editingItemId);
          if(!it){ toast("No encontrado"); return null; }

          const ev = {
            id: uid(),
            type: T.EDIT,
            at: now,
            payload: {
              i: editingItemId,
              c: whoId || null,
              w: whoName,
              s: what,
              n: whenISO || null,
              r: remindMin || 0,
              af: afterMin || 0,
              aa: afterAt || null
            }
          };

          const changed = applyEvent(ev);
          if(!changed){ toast("Sin cambios"); return null; }
          return { itemId: editingItemId, ev };
        }
      }

      async function markDone(itemId){
        const ev = makeEvent(T.DONE, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Marcado como hecho ‚úÖ");
          await prepareShare(ev, data.find(x => x.id === itemId));
        } else toast("Sin cambios");
      }

      async function reopen(itemId){
        const ev = makeEvent(T.REOPEN, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Reabierto");
          await prepareShare(ev, data.find(x => x.id === itemId));
        } else toast("Sin cambios");
      }

      async function deleteItem(itemId){
        const ok = await Confirm.open({
          title: "Eliminar compromiso",
          msg: `¬øSeguro que quieres eliminar este compromiso?<br><b style="color:#B91C1C">Esta acci√≥n no se puede deshacer.</b>`,
          yesText: "S√≠, eliminar",
          danger: true
        });
        if(!ok) return;

        const ev = makeEvent(T.DELETE, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Eliminado");
          await prepareShare(ev, { id:itemId, whoName:"(eliminado)", what:"", when:null, remindMin:0, afterMin:0, afterAt:null, done:false });
        } else {
          toast("Sin cambios");
        }
      }

      /* =========================
         Contactos modal (nuevo/editar)
         ========================= */
      let editingContactId = null;

      function openContactModal(){
        $("cBackdrop").classList.add("show");
        $("cBackdrop").setAttribute("aria-hidden","false");
      }
      function closeContactModal(){
        $("cBackdrop").classList.remove("show");
        $("cBackdrop").setAttribute("aria-hidden","true");
      }
      function resetContactForm(){
        editingContactId = null;
        if($("cModalTitle")) $("cModalTitle").textContent = "Nuevo amigo";
        if($("cName")) $("cName").value = "";
        if($("cNote")) $("cNote").value = "";
      }
      function openContactEdit(id){
        const c = contacts.find(x => x.id === id);
        if(!c){ toast("Amigo no encontrado"); return; }
        editingContactId = id;
        if($("cModalTitle")) $("cModalTitle").textContent = "Editar amigo";
        $("cName").value = c.name || "";
        $("cNote").value = c.note || "";
        openContactModal();
        try{ $("cName").focus(); }catch(e){}
      }

      function upsertContact(name, note){
        const n = String(name||"").trim();
        if(!n){ toast("Pon un nombre"); return null; }

        if(!editingContactId){
          const c = { id: uid(), name: n, note: String(note||"").trim(), createdAt: new Date().toISOString() };
          contacts.push(c);
          save(CONTACTS_KEY, contacts);
          return c;
        } else {
          const c = contacts.find(x => x.id === editingContactId);
          if(!c){ toast("No encontrado"); return null; }
          c.name = n;
          c.note = String(note||"").trim();
          c.updatedAt = new Date().toISOString();
          save(CONTACTS_KEY, contacts);
          save(KEY, data);
          return c;
        }
      }

      async function deleteContact(id){
        const ok = await Confirm.open({
          title: "Eliminar amigo",
          msg: `¬øEliminar este amigo?<br><b style="color:#B91C1C">Los compromisos quedar√°n con el nombre ‚Äúguardado‚Äù.</b>`,
          yesText: "S√≠, eliminar",
          danger: true
        });
        if(!ok) return;

        // convertir referencias whoId a whoName
        data.forEach(it => {
          if(it.whoId === id){
            it.whoName = normalizedWho(it);
            it.whoId = null;
          }
        });
        contacts = contacts.filter(x => x.id !== id);

        save(CONTACTS_KEY, contacts);
        save(KEY, data);

        renderAll();
        toast("Amigo eliminado");
      }

      /* =========================
         Compartir
         ========================= */
      let shareState = { title:"", shortText:"", longText:"", url:"", mode:"short" };

      function openShareModal(){
        $("shareBackdrop").classList.add("show");
        $("shareBackdrop").setAttribute("aria-hidden","false");
        updateShareUI();
      }
      function closeShareModal(){
        $("shareBackdrop").classList.remove("show");
        $("shareBackdrop").setAttribute("aria-hidden","true");
      }
      function updateShareUI(){
        $("shareShort").classList.toggle("active", shareState.mode === "short");
        $("shareLong").classList.toggle("active", shareState.mode === "long");
        $("shareTitle").innerHTML = `<b>${escapeHtml(shareState.title || "Compartir")}</b>`;
        const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
        $("shareTextBox").textContent = msg || "";
        $("shareUrlBox").textContent = shareState.url || "";
      }

      async function copyToClipboard(text){
        try{
          await navigator.clipboard.writeText(text);
          toast("Copiado ‚úÖ");
          return true;
        }catch(e){
          // ‚úÖ sin prompt del navegador: dejamos el texto visible en el modal
          toast("Mant√©n pulsado para copiar (si no funciona el bot√≥n)");
          return false;
        }
      }

      async function doShare(){
        const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
        const payload = { title: shareState.title || "Compromisos", text: msg, url: shareState.url };

        try{
          if(navigator.share){
            await navigator.share(payload);
            toast("Enviado ‚úÖ");
            closeShareModal();
            return true;
          }
        }catch(e){}

        const combined = (payload.title ? payload.title + "\n" : "") + (payload.text ? payload.text + "\n" : "") + payload.url;
        await copyToClipboard(combined);
        return true;
      }

      function eventTitle(type){
        if(type === T.CREATE) return "üìå Nuevo/Actualizado";
        if(type === T.EDIT) return "‚úçÔ∏è Compromiso editado";
        if(type === T.DONE) return "‚úÖ Compromiso finalizado";
        if(type === T.REOPEN) return "‚Ü©Ô∏è Compromiso reabierto";
        if(type === T.DELETE) return "üóëÔ∏è Compromiso eliminado";
        return "üì¶ Paquete";
      }

      function buildShareMessages(ev, it){
        const who = it ? normalizedWho(it) : (ev?.payload?.w || "Sin nombre");
        const what = it ? shortPreview(it.what, 120) : shortPreview(ev?.payload?.s || "", 120);
        const whenTxt = it?.when ? fmtDate(it.when) : (ev?.payload?.n ? fmtDate(ev.payload.n) : "Sin fecha");

        const afterMin = Number(it?.afterMin || ev?.payload?.af || 0);
        const afterTxt = afterMin ? `‚è≥ Aviso en: ${afterMin >= 1440 ? "24h" : (afterMin >= 60 ? (afterMin/60)+"h" : afterMin+"m")}` : "";

        const title = eventTitle(ev.type);
        const shortMsg =
          `${title}\n` +
          `üë§ ${who}\n` +
          (what ? `üìù ${shortPreview(what, 70)}\n` : "") +
          (afterTxt ? `${afterTxt}\n` : "") +
          `üîó Abre el enlace para importar.`;

        const longMsg =
          `${title}\n` +
          `üë§ Con: ${who}\n` +
          (what ? `üìù ${what}\n` : "") +
          `‚è∞ Para: ${whenTxt}\n` +
          (afterTxt ? `${afterTxt}\n` : "") +
          `üîó Abre el enlace para importar en la app.`;

        return { title, shortMsg, longMsg };
      }

      async function prepareShare(ev, it){
        const p = makePackage(ev);
        const link = makeLinkFromPackage(p);
        const msgs = buildShareMessages(ev, it);

        shareState = {
          title: msgs.title,
          shortText: msgs.shortMsg,
          longText: msgs.longMsg,
          url: link,
          mode: "short"
        };

        openShareModal();
      }

      async function shareSnapshot(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }

        const af = Number(it.afterMin || 0);
        const aa = af > 0 ? new Date(Date.now() + af*60*1000).toISOString() : null;

        const ev = {
          id: uid(),
          type: T.CREATE,
          at: new Date().toISOString(),
          payload: {
            i: it.id,
            c: it.whoId || null,
            w: normalizedWho(it),
            s: it.what || "",
            n: it.when || null,
            r: Number(it.remindMin || 0),
            af: af || 0,
            aa: aa,
            ca: it.createdAt || new Date().toISOString()
          }
        };
        await prepareShare(ev, it);
      }

      /* =========================
         Recordatorios (por fecha + desde ahora)
         ========================= */
      function firedKey(it){
        return `${it.id}|${it.when||""}|${Number(it.remindMin||0)}|${it.done?"1":"0"}`;
      }
      function afterKey(it){
        return `${it.id}|${it.afterAt||""}|${Number(it.afterMin||0)}|${it.done?"1":"0"}`;
      }

      function checkReminders(){
        const now = Date.now();

        // A) Por fecha (X min antes)
        for(const it of data){
          if(it.done) continue;
          const rm = Number(it.remindMin||0);
          if(!it.when || rm <= 0) continue;

          const due = new Date(it.when).getTime();
          if(Number.isNaN(due)) continue;

          const trigger = due - rm*60*1000;
          if(now < trigger) continue;
          if(now > due + 30*60*1000) continue;

          const k = firedKey(it);
          if(firedMap && firedMap[k]) continue;

          const who = normalizedWho(it);
          const what = shortPreview(it.what, 80);
          const dueTxt = fmtDate(it.when);

          const title = `‚è∞ Compromiso: ${who}`;
          const body = (what ? what + " ¬∑ " : "") + `Para: ${dueTxt}`;

          sendLocalNotification(title, body);
          incNotifAlerts(); // ‚úÖ suma notificaciones arriba
          firedMap[k] = now;
          save(REMIND_FIRED_KEY, firedMap);
        }

        // B) Desde ahora (afterAt)
        for(const it of data){
          if(it.done) continue;
          const am = Number(it.afterMin||0);
          if(!it.afterAt || am <= 0) continue;

          const at = new Date(it.afterAt).getTime();
          if(Number.isNaN(at)) continue;

          if(now < at) continue;
          if(now > at + 30*60*1000) continue;

          const k = afterKey(it);
          if(afterFired && afterFired[k]) continue;

          const who = normalizedWho(it);
          const what = shortPreview(it.what, 80);

          const title = `üîî Aviso: ${who}`;
          const body = what || "Tienes un compromiso pendiente.";

          sendLocalNotification(title, body);
          incNotifAlerts(); // ‚úÖ suma notificaciones arriba
          afterFired[k] = now;
          save(AFTER_FIRED_KEY, afterFired);
        }

        renderNotifAlertsBadge();
      }

      /* =========================
         Calendario (.ics)
         ========================= */
      function dtToICS(iso){
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return null;
        const y = d.getUTCFullYear();
        const m = pad2(d.getUTCMonth()+1);
        const da = pad2(d.getUTCDate());
        const h = pad2(d.getUTCHours());
        const mi = pad2(d.getUTCMinutes());
        const s = pad2(d.getUTCSeconds());
        return `${y}${m}${da}T${h}${mi}${s}Z`;
      }
      function makeICSForItem(it){
        if(!it.when) return null;
        const dtStart = dtToICS(it.when);
        if(!dtStart) return null;
        const startMs = new Date(it.when).getTime();
        const endMs = startMs + 15*60*1000;
        const dtEnd = dtToICS(new Date(endMs).toISOString());

        const who = normalizedWho(it);
        const summary = `Compromiso: ${who}`;
        const desc = (it.what || "").replaceAll("\n","\\n");
        const uidv = `${it.id}@compromisos.local`;
        const stamp = dtToICS(new Date().toISOString());

        return [
          "BEGIN:VCALENDAR",
          "VERSION:2.0",
          "PRODID:-//Compromisos//Local//ES",
          "CALSCALE:GREGORIAN",
          "METHOD:PUBLISH",
          "BEGIN:VEVENT",
          `UID:${uidv}`,
          `DTSTAMP:${stamp}`,
          `DTSTART:${dtStart}`,
          `DTEND:${dtEnd}`,
          `SUMMARY:${summary}`,
          `DESCRIPTION:${desc}`,
          "END:VEVENT",
          "END:VCALENDAR"
        ].join("\r\n");
      }
      async function addToCalendar(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }
        if(!it.when){ toast("Pon una fecha para usar calendario"); return; }

        const ics = makeICSForItem(it);
        if(!ics){ toast("No se pudo crear el evento"); return; }

        const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
        const filename = `compromiso_${itemId}.ics`;

        try{
          if(navigator.canShare && navigator.share){
            const file = new File([blob], filename, { type: "text/calendar" });
            if(navigator.canShare({ files: [file] })){
              await navigator.share({ title: "A√±adir al calendario", text: "Abre el archivo para a√±adirlo a tu calendario.", files: [file] });
              toast("Evento listo ‚úÖ");
              return;
            }
          }
        }catch(e){}

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 1200);
        toast("Descargado .ics ‚úÖ (√°brelo)");
      }

      /* =========================
         Import (#p=... + buz√≥n)
         ========================= */
      function parsePackageFromHash(){
        const h = location.hash || "";
        const m = h.match(/#p=([A-Za-z0-9\-_]+)/);
        return m ? m[1] : null;
      }
      function clearHashToBase(){
        try{
          history.replaceState(null, "", baseFileUrl());
        }catch(e){
          location.hash = "";
        }
      }

      const isAndroid = /Android/i.test(navigator.userAgent || "");
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const isIOSStandalone = !!navigator.standalone;
      const isInAppBrowser = (function(){
        const ua = (navigator.userAgent || "").toLowerCase();
        return ua.includes("wv") || ua.includes("webview") ||
               ua.includes("instagram") ||
               ua.includes("fbav") || ua.includes("fb_iab") ||
               ua.includes("telegram") ||
               ua.includes("whatsapp");
      })();

      function tryImportPackage(p){
        try{
          const pack = parsePackage(p);
          const ev = unpackEvent(pack);
          if(!ev) throw new Error("bad");

          const applied = applyEvent(ev);

          if(applied){
            incReceived();
            renderReceivedBadge();
          }
          renderAll();
          toast(applied ? "Paquete importado ‚úÖ" : "Paquete ya aplicado (o sin cambios)");
        }catch(e){
          toast("No se pudo importar el paquete");
        }
      }

      /* =========================
         Service worker (si existe sw.js)
         ========================= */
      (async function registerSW(){
        if(!("serviceWorker" in navigator)) return;
        try{
          await navigator.serviceWorker.register("./sw.js", { scope: "./" });
        }catch(e){}
      })();

      /* =========================
         PIN overlay (teclado)
         ========================= */
      let pinBuf = "";

      function setDots(n){
        $("d1").classList.toggle("on", n>=1);
        $("d2").classList.toggle("on", n>=2);
        $("d3").classList.toggle("on", n>=3);
        $("d4").classList.toggle("on", n>=4);
      }

      async function tryUnlockWithPin(pin){
        const ok = await verifyPin(pin);
        if(ok){
          applyUnlock();
          hideLockOverlay();
          toast("Desbloqueado ‚úÖ");
        } else {
          pinBuf = "";
          setDots(0);
          toast("PIN incorrecto");
        }
      }

      if($("keypad")){
        $("keypad").addEventListener("click", async (e) => {
          const btn = e.target.closest("button");
          if(!btn) return;
          const k = btn.getAttribute("data-k");
          if(!k) return;

          if(k === "del"){
            pinBuf = pinBuf.slice(0, -1);
            setDots(pinBuf.length);
            return;
          }
          if(k === "ok"){
            if(pinBuf.length !== 4){ toast("Introduce 4 d√≠gitos"); return; }
            await tryUnlockWithPin(pinBuf);
            return;
          }
          if(/^\d$/.test(k)){
            if(pinBuf.length >= 4) return;
            pinBuf += k;
            setDots(pinBuf.length);
            if(pinBuf.length === 4){
              await tryUnlockWithPin(pinBuf);
            }
          }
        });
      }

      /* =========================
         UI: handlers base
         ========================= */
      // Tabs
      if($("tabCommitments")) $("tabCommitments").addEventListener("click", ()=> setPane("commitments"));
      if($("tabContacts")) $("tabContacts").addEventListener("click", ()=> setPane("contacts"));
      if($("tabSettings")) $("tabSettings").addEventListener("click", ()=> setPane("settings"));

      // Subtabs
      if($("tabPending")) $("tabPending").addEventListener("click", setViewPending);
      if($("tabDone")) $("tabDone").addEventListener("click", setViewDone);

      // FAB
      if($("fab")){
        $("fab").addEventListener("click", () => {
          if(pane === "contacts"){
            resetContactForm();
            openContactModal();
            try{ $("cName").focus(); }catch(e){}
            return;
          }
          resetCommitmentForm();
          openModal();
          try{ $("fContact").focus(); }catch(e){}
        });
      }

      // Modal Compromiso: cerrar
      if($("btnClose")) $("btnClose").addEventListener("click", closeModal);
      if($("btnCancel")) $("btnCancel").addEventListener("click", closeModal);
      if($("backdrop")){
        $("backdrop").addEventListener("click", (e)=>{ if(e.target === $("backdrop")) closeModal(); });
      }

      // Select contacto
      if($("fContact")) $("fContact").addEventListener("change", onContactSelectChanged);

      // Guardar compromiso
      if($("btnSave")){
        $("btnSave").addEventListener("click", async () => {
          const res = createOrEditCommitment();
          if(!res) return;

          closeModal();
          renderAll();

          toast(editingItemId ? "Actualizado ‚úÖ" : "Guardado ‚úÖ");
          await prepareShare(res.ev, data.find(x => x.id === res.itemId));
        });
      }

      // Modal amigo: cerrar
      if($("cBtnClose")) $("cBtnClose").addEventListener("click", closeContactModal);
      if($("cBtnCancel")) $("cBtnCancel").addEventListener("click", closeContactModal);
      if($("cBackdrop")){
        $("cBackdrop").addEventListener("click", (e)=>{ if(e.target === $("cBackdrop")) closeContactModal(); });
      }

      // Guardar amigo
      if($("cBtnSave")){
        $("cBtnSave").addEventListener("click", () => {
          const c = upsertContact($("cName").value, $("cNote").value);
          if(!c) return;

          closeContactModal();
          renderAll();
          toast("Amigo guardado ‚úÖ");
        });
      }

      /* =========================
         Ajustes (UI)
         ========================= */
      function updateSettingsUI(){
        const swP = $("swPin");
        const swN = $("swNotif");

        if(swP){
          swP.classList.toggle("on", !!settings.pinEnabled);
          swP.setAttribute("aria-checked", settings.pinEnabled ? "true":"false");
        }
        if(swN){
          swN.classList.toggle("on", !!settings.notifEnabled);
          swN.setAttribute("aria-checked", settings.notifEnabled ? "true":"false");
        }

        if($("selAutoLock")) $("selAutoLock").value = String(settings.autoLockMin ?? 0);
        if($("selRemember")) $("selRemember").value = String(settings.rememberMin ?? 10);

        const hint = $("notifHint");
        if(hint){
          const perm = notifPermission();
          const sup = notifSupported();
          if(!sup){
            hint.textContent = "‚ö†Ô∏è Este navegador no soporta notificaciones. Usa ‚ÄúüìÖ Calendario‚Äù.";
            if($("btnNotifPerm")) $("btnNotifPerm").style.display = "none";
          }else{
            if($("btnNotifPerm")) $("btnNotifPerm").style.display = "";
            if(perm === "granted"){
              hint.textContent = settings.notifEnabled ? "‚úÖ Notificaciones activadas." : "‚ÑπÔ∏è Permiso OK, pero desactivadas. Act√≠valas con el switch.";
            } else if(perm === "denied"){
              hint.textContent = "üö´ Notificaciones bloqueadas. Perm√≠telas en Ajustes del m√≥vil o reinstala la PWA.";
            } else {
              hint.textContent = "‚ÑπÔ∏è Pulsa ‚ÄúPermitir‚Äù para recibir recordatorios.";
            }
          }
        }
      }

      function setPinEnabled(on){
        settings.pinEnabled = !!on;
        if(!settings.pinEnabled){
          settings.pinHash = null;
          settings.unlockUntil = 0;
          sessionUnlocked = false;
          lockAtTs = 0;
        }
        save(SETTINGS_KEY, settings);
        updateSettingsUI();
      }

      function setNotifEnabled(on){
        settings.notifEnabled = !!on;
        save(SETTINGS_KEY, settings);
        updateSettingsUI();
      }

      // PIN modal
      let pinMode = "enable";
      function openPinModal(mode){
        pinMode = mode;
        $("pinBackdrop").classList.add("show");
        $("pinBackdrop").setAttribute("aria-hidden","false");

        $("pinOld").value = "";
        $("pinNew").value = "";
        $("pinNew2").value = "";

        if(mode === "enable"){
          $("pinTitle").textContent = "Activar PIN";
          $("pinHint").textContent = "Crea un PIN de 4 d√≠gitos para bloquear la app.";
          $("pinOldWrap").style.display = "none";
          $("pinNewWrap").style.display = "";
          $("pinNew2Wrap").style.display = "";
        } else if(mode === "change"){
          $("pinTitle").textContent = "Cambiar PIN";
          $("pinHint").textContent = "Introduce tu PIN actual y el nuevo PIN.";
          $("pinOldWrap").style.display = "";
          $("pinNewWrap").style.display = "";
          $("pinNew2Wrap").style.display = "";
        } else if(mode === "disable"){
          $("pinTitle").textContent = "Desactivar PIN";
          $("pinHint").textContent = "Introduce tu PIN actual para desactivarlo.";
          $("pinOldWrap").style.display = "";
          $("pinNewWrap").style.display = "none";
          $("pinNew2Wrap").style.display = "none";
        }

        setTimeout(()=> {
          const el = (mode === "enable") ? $("pinNew") : $("pinOld");
          try{ el.focus(); }catch(e){}
        }, 60);
      }
      function closePinModal(){
        $("pinBackdrop").classList.remove("show");
        $("pinBackdrop").setAttribute("aria-hidden","true");
      }

      function clampPinInput(el){ el.value = normalizePin(el.value); }
      ["pinOld","pinNew","pinNew2"].forEach(id => {
        if($(id)) $(id).addEventListener("input", () => clampPinInput($(id)));
      });

      if($("pinClose")) $("pinClose").addEventListener("click", closePinModal);
      if($("pinCancel")) $("pinCancel").addEventListener("click", closePinModal);
      if($("pinBackdrop")){
        $("pinBackdrop").addEventListener("click", (e)=>{ if(e.target === $("pinBackdrop")) closePinModal(); });
      }

      if($("pinOk")){
        $("pinOk").addEventListener("click", async () => {
          try{
            if(pinMode === "enable"){
              const p1 = normalizePin($("pinNew").value);
              const p2 = normalizePin($("pinNew2").value);
              if(p1.length !== 4) { toast("PIN inv√°lido"); return; }
              if(p1 !== p2) { toast("Los PIN no coinciden"); return; }
              await setPin(p1);
              settings.pinEnabled = true;
              settings.unlockUntil = 0;
              sessionUnlocked = false;
              save(SETTINGS_KEY, settings);
              updateSettingsUI();
              closePinModal();
              toast("PIN activado ‚úÖ");
              forceLock();
              return;
            }

            if(pinMode === "change"){
              const oldp = normalizePin($("pinOld").value);
              if(oldp.length !== 4) { toast("PIN actual inv√°lido"); return; }
              const ok = await verifyPin(oldp);
              if(!ok){ toast("PIN actual incorrecto"); return; }

              const p1 = normalizePin($("pinNew").value);
              const p2 = normalizePin($("pinNew2").value);
              if(p1.length !== 4) { toast("Nuevo PIN inv√°lido"); return; }
              if(p1 !== p2) { toast("Los PIN no coinciden"); return; }

              await setPin(p1);
              settings.pinEnabled = true;
              settings.unlockUntil = 0;
              sessionUnlocked = false;
              save(SETTINGS_KEY, settings);
              updateSettingsUI();
              closePinModal();
              toast("PIN cambiado ‚úÖ");
              forceLock();
              return;
            }

            if(pinMode === "disable"){
              const oldp = normalizePin($("pinOld").value);
              if(oldp.length !== 4) { toast("PIN inv√°lido"); return; }
              const ok = await verifyPin(oldp);
              if(!ok){ toast("PIN incorrecto"); return; }

              setPinEnabled(false);
              closePinModal();
              hideLockOverlay();
              toast("PIN desactivado");
              return;
            }
          }catch(e){
            toast("No se pudo aplicar el PIN");
          }
        });
      }

      function toggleSwitchPin(){
        if(settings.pinEnabled) openPinModal("disable");
        else openPinModal("enable");
      }

      function toggleSwitchNotif(){
        if(!settings.notifEnabled){
          if(notifSupported() && notifPermission() !== "granted"){
            requestNotifPermission().then(ok => {
              if(ok) setNotifEnabled(true);
              else setNotifEnabled(false);
            });
          } else {
            setNotifEnabled(true);
          }
        } else {
          setNotifEnabled(false);
        }
      }

      if($("swPin")){
        $("swPin").addEventListener("click", toggleSwitchPin);
        $("swPin").addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggleSwitchPin(); } });
      }
      if($("swNotif")){
        $("swNotif").addEventListener("click", toggleSwitchNotif);
        $("swNotif").addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggleSwitchNotif(); } });
      }

      if($("btnNotifPerm")) $("btnNotifPerm").addEventListener("click", requestNotifPermission);

      if($("selAutoLock")){
        $("selAutoLock").addEventListener("change", () => {
          settings.autoLockMin = Number($("selAutoLock").value || 0);
          save(SETTINGS_KEY, settings);
          toast("Auto-bloqueo actualizado");
        });
      }
      if($("selRemember")){
        $("selRemember").addEventListener("change", () => {
          settings.rememberMin = Number($("selRemember").value || 0);
          save(SETTINGS_KEY, settings);
          toast("Recordar desbloqueo actualizado");
        });
      }

      if($("btnChangePin")){
        $("btnChangePin").addEventListener("click", () => {
          if(!settings.pinEnabled){ toast("Activa primero el PIN"); return; }
          openPinModal("change");
        });
      }

      if($("btnLockNow")){
        $("btnLockNow").addEventListener("click", () => {
          if(!settings.pinEnabled){ toast("Activa el PIN para bloquear"); setPane("settings"); return; }
          forceLock();
        });
      }

      async function resetAll(){
        const ok = await Confirm.open({
          title: "Borrar todo",
          msg: `Esto borrar√° <b>TODO</b> (compromisos, amigos y ajustes).<br><b style="color:#B91C1C">No se puede deshacer.</b>`,
          yesText: "S√≠, borrar todo",
          danger: true
        });
        if(!ok) return;
        localStorage.clear();
        location.replace(baseFolderUrl() + "compromisos.html");
      }
      if($("btnResetAll")) $("btnResetAll").addEventListener("click", resetAll);

      // Texto grande
      if($("btnA11y")) $("btnA11y").addEventListener("click", toggleTextScale);

      /* =========================
         Pills/tiles: navegaci√≥n r√°pida (si existen)
         ========================= */
      function goToCommitmentsPending(){
        setPane("commitments");
        setViewPending();
        try{ window.scrollTo({ top: 0, behavior: "smooth" }); }catch(e){ window.scrollTo(0,0); }
      }
      function scrollToFirstOverdue(){
        const list = $("list");
        if(!list) return;
        const first = list.querySelector(".due.danger");
        if(first){
          const card = first.closest(".card");
          if(card){
            try{ card.scrollIntoView({ behavior:"smooth", block:"start" }); }catch(e){}
          }
        }
      }

      // Notifs pill din√°mica
      document.addEventListener("click", async (e)=>{
        const b = e.target.closest("#btnNotifAlerts");
        if(!b) return;
        const c = Math.max(0, Number(pendingNotifs?.c || 0));
        const alreadyThere = (pane === "commitments" && view === "pending");
        if(!alreadyThere){
          goToCommitmentsPending();
          toast(c > 0 ? "üîî Notificaciones pendientes" : "Sin notificaciones");
          return;
        }
        if(c <= 0){ toast("Sin notificaciones"); return; }

        const ok = await Confirm.open({
          title: "Notificaciones",
          msg: `Tienes <b>${c}</b> notificaci√≥n(es).<br>¬øMarcar como le√≠das y limpiar el contador?`,
          yesText: "S√≠, limpiar",
          danger: false
        });
        if(ok) clearNotifAlerts();
      });

      // Recibidos pill (si existe)
      if($("btnReceived")){
        $("btnReceived").addEventListener("click", async () => {
          const c = Math.max(0, Number(received?.c || 0));
          const alreadyThere = (pane === "commitments" && view === "pending");
          if(!alreadyThere){
            goToCommitmentsPending();
            toast(c > 0 ? "üì• Paquetes recibidos" : "Sin recibidos");
            return;
          }
          if(c <= 0){ toast("Sin recibidos"); return; }

          const ok = await Confirm.open({
            title: "Recibidos",
            msg: `Has recibido <b>${c}</b> paquete(s).<br>¬øMarcar como vistos y poner el contador a 0?`,
            yesText: "S√≠, marcar vistos",
            danger: false
          });
          if(ok){
            clearReceived();
            renderReceivedBadge();
            toast("Recibidos marcados ‚úÖ");
          }
        });
      }

      // Pendientes / vencidos pills (si existen)
      if($("btnPendCommit")) $("btnPendCommit").addEventListener("click", ()=>{ goToCommitmentsPending(); toast("üìù Mostrando pendientes"); });
      if($("btnOverdue")) $("btnOverdue").addEventListener("click", ()=>{
        goToCommitmentsPending();
        const overdueCount = data.filter(x => !x.done && isOverdue(x.when)).length;
        if(overdueCount > 0){
          toast(`‚è∞ ${overdueCount} vencido(s)`);
          setTimeout(scrollToFirstOverdue, 250);
        } else toast("Sin vencidos ‚úÖ");
      });

      /* =========================
         Share modal handlers
         ========================= */
      if($("shareClose")) $("shareClose").addEventListener("click", closeShareModal);
      if($("shareCancel")) $("shareCancel").addEventListener("click", closeShareModal);
      if($("shareBackdrop")){
        $("shareBackdrop").addEventListener("click", (e)=>{ if(e.target === $("shareBackdrop")) closeShareModal(); });
      }
      if($("shareShort")) $("shareShort").addEventListener("click", ()=>{ shareState.mode="short"; updateShareUI(); });
      if($("shareLong")) $("shareLong").addEventListener("click", ()=>{ shareState.mode="long"; updateShareUI(); });

      if($("shareCopyUrl")){
        $("shareCopyUrl").addEventListener("click", async ()=> {
          await copyToClipboard(shareState.url || "");
        });
      }
      if($("shareCopyAll")){
        $("shareCopyAll").addEventListener("click", async ()=> {
          const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
          const combined = (shareState.title ? shareState.title + "\n" : "") + (msg ? msg + "\n" : "") + shareState.url;
          await copyToClipboard(combined);
        });
      }
      if($("shareSend")) $("shareSend").addEventListener("click", doShare);

      /* =========================
         Lock overlay extra buttons
         ========================= */
      async function copyCurrentLink(){
        try{
          await navigator.clipboard.writeText(location.href);
          toast("Enlace copiado ‚úÖ");
        }catch(e){
          toast("No se pudo copiar autom√°ticamente");
        }
      }

      if($("btnLockCopyLink")) $("btnLockCopyLink").addEventListener("click", copyCurrentLink);
      if($("btnLockReset")){
        $("btnLockReset").addEventListener("click", resetAll);
      }
      if($("lockClose")){
        $("lockClose").addEventListener("click", ()=>{ /* no cerramos si est√° bloqueada */ toast("Introduce tu PIN"); });
      }

      document.addEventListener("visibilitychange", () => {
        if(!settings.pinEnabled) return;
        if(document.visibilityState === "hidden"){
          const m = Number(settings.autoLockMin || 0);
          lockAtTs = (m === 0) ? Date.now() : (Date.now() + m*60*1000);
        } else {
          if(lockAtTs && Date.now() >= lockAtTs){
            forceLock();
          }
          lockAtTs = 0;
        }
      });

      /* =========================
         Boot
         ========================= */
      // Preferencia texto
      const a11y = load(A11Y_KEY, { big:false });
      setTextScale(!!a11y.big);

      updateSettingsUI();
      renderAll();

      // Import desde hash
      (function(){
        const p = parsePackageFromHash();
        if(!p) return;

        if(isInAppBrowser){
          try{
            localStorage.setItem(INBOX_PACK_KEY, p);
            localStorage.setItem(INBOX_TS_KEY, String(Date.now()));
          }catch(e){}
          clearHashToBase();
          toast("Para importar: abre en Chrome");
          return;
        }

        tryImportPackage(p);
        clearHashToBase();
      })();

      // Import desde buz√≥n
      (function(){
        if(isInAppBrowser) return;
        try{
          const p = localStorage.getItem(INBOX_PACK_KEY);
          if(!p) return;
          localStorage.removeItem(INBOX_PACK_KEY);
          localStorage.removeItem(INBOX_TS_KEY);
          toast("Importando paquete pendiente‚Ä¶");
          tryImportPackage(p);
        }catch(e){}
      })();

      cleanupFiredMaps();

      // Demo inicial
      if(data.length === 0){
        const now = new Date().toISOString();
        const ev = {
          id: uid(),
          type: T.CREATE,
          at: now,
          payload: {
            i: uid(),
            c: null,
            w: "Ejemplo: Laura",
            s: "Te paso el PDF del seguro",
            n: new Date(Date.now() + 3*60*60*1000).toISOString(),
            r: 15,
            af: 60,
            aa: new Date(Date.now() + 60*60*1000).toISOString(),
            ca: now
          }
        };
        applyEvent(ev);
        renderAll();
      }

      if(settings.pinEnabled && !isUnlockedNow()){
        showLockOverlay();
      } else {
        hideLockOverlay();
      }

      setInterval(() => {
        if(settings.pinEnabled && !isUnlockedNow()) return;
        checkReminders();
      }, 20000);

      setTimeout(() => {
        if(settings.pinEnabled && !isUnlockedNow()) return;
        checkReminders();
      }, 1200);

    })();
  </script>
</body>
</html>