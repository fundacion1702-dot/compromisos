<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compromisos</title>
  <meta name="theme-color" content="#6b5bff"/>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0b0c12;
      --surface:#121427;
      --surface2:#171a33;
      --text:#e9ecff;
      --muted:#aab0d6;
      --primary:#6b5bff;
      --primary2:#8a7dff;
      --good:#36d399;
      --bad:#ff5c7a;
      --warn:#ffcc66;
      --stroke:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px;
      --fs-base: 16px; /* se ajusta desde JS (texto grande) */
    }
    *{ box-sizing:border-box; }

    /* ‚úÖ A11y: toda la UI escalar√° porque usamos rem */
    html{ font-size: var(--fs-base); }

    body{
      margin:0;
      font-size: 1rem;
      font-family:
        system-ui, -apple-system, Segoe UI, Roboto, Arial,
        "Noto Color Emoji", "Segoe UI Emoji", "Apple Color Emoji",
        "Noto Emoji", sans-serif;
      background: radial-gradient(62.5rem 37.5rem at 20% -10%, rgba(107,91,255,.35), transparent 60%),
                  radial-gradient(50rem 37.5rem at 90% 0%, rgba(255,204,102,.15), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      padding-bottom:6rem;
    }
    .wrap{ max-width:35rem; margin:0 auto; padding:1rem .875rem 0; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-top:.375rem; }
    .brand{ display:flex; align-items:center; gap:.625rem; min-width:0; }
    .logo{
      width:2.75rem;height:2.75rem;border-radius:.9375rem; display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.70));
      box-shadow: 0 .75rem 1.875rem rgba(107,91,255,.25);
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto; font-weight:950; letter-spacing:.03125rem;
      font-size: 1.125rem;
    }
    .brand h1{ margin:0; font-size:1.25rem; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brand p{ margin:.125rem 0 0; font-size:.84375rem; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .iconbtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: .875rem;
      padding: .6875rem .75rem;
      cursor:pointer;
      box-shadow: 0 .625rem 1.5rem rgba(0,0,0,.18);
      transition: transform .08s ease, background .15s ease;
      display:flex; align-items:center; gap:.5rem;
      font-weight:900;
      font-size: .875rem;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .iconbtn:active{ transform: scale(.98); }
    .iconbtn small{ color:var(--muted); font-weight:800; font-size: .78125rem; }

    .hero{
      margin-top: .75rem;
      padding: .75rem; /* ‚úÖ m√°s compacto */
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
    }

    /* ‚úÖ Barra superior del hero (izq: pendientes, der: texto grande) */
    .heroBar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.625rem;
    }
    .heroLeft{
      display:flex;
      align-items:center;
      gap:.5rem;
      min-width:0;
      flex:1;
    }

    .pill{
      display:inline-flex; align-items:center; gap:.5rem;
      padding: .5rem .625rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(107,91,255,.14);
      color: var(--text);
      font-size: .8125rem;
      font-weight: 850;
      white-space:nowrap;
    }

    /* ‚úÖ pill clicable para pendientes */
    .pill.btnPill{
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease;
    }
    .pill.btnPill:active{ transform: scale(.99); }
    .pill.btnPill .badge{
      margin-left:.25rem;
      min-width: 1.375rem;
      padding: .125rem .5rem;
      font-size: .78125rem;
      background: rgba(0,0,0,.22);
    }
    .pill.btnPill.muted{
      background: rgba(255,255,255,.06);
      color: var(--muted);
      border-color: rgba(255,255,255,.12);
    }

    .hero h2{
      margin: .5rem 0 .3125rem; /* ‚úÖ m√°s compacto */
      font-size: 1.125rem;
      line-height:1.25;
    }
    .hero p{
      margin: 0;
      color: var(--muted);
      font-size: .9375rem;
      line-height:1.4;
    }

    .banner{
      margin-top: .75rem;
      padding: .75rem;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: 0 .75rem 1.875rem rgba(0,0,0,.18);
      display:none;
    }
    .banner.show{ display:block; }
    .banner .title{ font-weight:950; margin:0 0 .375rem; font-size: 1rem; }
    .banner .txt{ margin:0; color:var(--muted); font-size:.90625rem; line-height:1.35; }
    .banner .row{ display:flex; gap:.625rem; margin-top:.625rem; flex-wrap:wrap; }

    .btn{
      border-radius: .875rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: .6875rem .75rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .9375rem;
      transition: transform .08s ease, background .15s ease;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      flex:1;
      min-width: 7.5rem;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{ background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55)); border-color: rgba(255,255,255,.16); }
    .btn.good{ background: linear-gradient(135deg, rgba(54,211,153,.95), rgba(54,211,153,.55)); border-color: rgba(255,255,255,.16); color:#06150f; }
    .btn.danger{ background: rgba(255,92,122,.12); border-color: rgba(255,92,122,.35); }
    .btn.ghost{ background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.12); }

    .tabs{
      margin-top: .875rem;
      display:flex; gap:.625rem; padding: .375rem;
      border-radius: 1rem;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: 0 .625rem 1.5625rem rgba(0,0,0,.15);
    }
    .tab{
      flex:1;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: .6875rem .75rem;
      border-radius: .875rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .9375rem;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      min-width: 0;
      white-space:nowrap;
    }
    .tab.active{
      color: var(--text);
      background: linear-gradient(135deg, rgba(107,91,255,.85), rgba(138,125,255,.55));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 .75rem 1.875rem rgba(107,91,255,.22);
    }
    .badge{
      display:inline-grid; place-items:center;
      min-width: 1.5rem;
      padding: .125rem .5625rem;
      border-radius: 999px;
      font-size: .8125rem;
      font-weight: 950;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }

    .subtabs{
      margin-top: .75rem;
      display:flex; gap:.625rem; padding: .375rem;
      border-radius: 1rem;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
    }
    .subtab{
      flex:1;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: .625rem .75rem;
      border-radius: .875rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .90625rem;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      min-width:0;
      white-space:nowrap;
    }
    .subtab.active{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
    }

    .list{ margin-top: .875rem; display:flex; flex-direction:column; gap: .625rem; }
    .card{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      padding: .75rem;
      box-shadow: 0 .75rem 1.875rem rgba(0,0,0,.22);
    }
    .cardTop{ display:flex; justify-content:space-between; gap:.625rem; align-items:flex-start; }
    .who{ min-width:0; }
    .who .name{
      margin:0; font-size: 1rem; font-weight: 950; letter-spacing:.0125rem;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .who .meta{
      margin: .25rem 0 0; font-size: .8125rem; color: var(--muted);
      display:flex; gap:.5rem; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:.375rem;
      padding: .25rem .5625rem; border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 850;
      font-size: .78125rem;
    }
    .due{
      font-size: .84375rem;
      font-weight: 950;
      padding: .4375rem .6875rem;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,204,102,.12);
      color: var(--text);
      white-space:nowrap;
    }
    .due.bad{ background: rgba(255,92,122,.14); }
    .desc{
      margin: .625rem 0 0;
      font-size: .9375rem;
      line-height:1.35;
      color: var(--text);
      opacity: .95;
      word-break: break-word;
    }
    .actions{ margin-top: .625rem; display:flex; gap: .625rem; flex-wrap:wrap; }
    .empty{
      padding: 1.125rem .875rem;
      border-radius: var(--r);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      text-align:center;
      line-height:1.35;
      display:none;
      font-size: .9375rem;
    }

    .fab{
      position: fixed;
      right: 1rem;
      bottom: 1.125rem;
      width: 3.875rem;
      height: 3.875rem;
      border-radius: 1.25rem;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55));
      box-shadow: 0 1.125rem 2.8125rem rgba(107,91,255,.25), 0 .875rem 2.5rem rgba(0,0,0,.35);
      color: white;
      font-size: 1.875rem;
      font-weight: 950;
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      z-index: 50;
    }
    .fab:active{ transform: scale(.98); }

    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: .875rem;
      z-index: 999;
    }
    .backdrop.show{ display:flex; }

    .sheet{
      width: min(35rem, 100%);
      border-radius: 1.375rem;
      background: linear-gradient(180deg, rgba(23,26,51,.98), rgba(18,20,39,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 1.375rem 3.75rem rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheetHead{
      padding: .75rem .875rem;
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .sheetHead h3{ margin:0; font-size: 1.0625rem; font-weight: 950; letter-spacing:.0125rem; }
    .close{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: .875rem;
      padding: .5625rem .6875rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .875rem;
    }
    .sheetBody{ padding: .875rem; display:flex; flex-direction:column; gap: .625rem; }
    .field label{
      display:block;
      font-size: .84375rem;
      font-weight: 950;
      color: var(--muted);
      margin-bottom: .375rem;
    }
    .field input, .field textarea, .field select{
      width: 100%;
      padding: .8125rem .75rem;
      border-radius: .875rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      font-size: 1rem;
    }
    .field textarea{ min-height: 5.75rem; resize: vertical; }

    .hint{
      font-size: .84375rem;
      color: var(--muted);
      margin-top: .375rem;
      line-height:1.35;
    }

    .sheetFoot{ padding: .75rem .875rem .875rem; display:flex; gap: .625rem; flex-wrap:wrap; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 5.625rem;
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding: .625rem .75rem;
      border-radius: .875rem;
      box-shadow: 0 1.125rem 2.5rem rgba(0,0,0,.45);
      font-weight: 850;
      font-size: .875rem;
      display:none;
      z-index: 1000;
      max-width: calc(100% - 1.75rem);
      text-align:center;
    }
    .toast.show{ display:block; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.8125rem;
      color:var(--muted);
      word-break: break-all;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:.625rem;
      border-radius:.875rem;
      margin-top:.625rem;
      display:none;
    }
    .mono.show{ display:block; }

    .kicker{
      font-size: .8125rem;
      color: var(--muted);
      margin: .625rem 0 0;
    }

    .rowline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      padding: .75rem;
      border-radius: 1rem;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: 0 .625rem 1.5625rem rgba(0,0,0,.12);
    }
    .rowline .ttl{ font-weight: 950; }
    .rowline .sub{ font-size: .84375rem; color: var(--muted); margin-top: .1875rem; line-height:1.25; }
    .stack{ display:flex; flex-direction:column; min-width:0; }
    .right{ display:flex; gap:.625rem; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .switch{
      width: 3.25rem;
      height: 2rem;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      position: relative;
      cursor:pointer;
      flex:0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      width: 1.625rem;
      height: 1.625rem;
      border-radius: 50%;
      top: .125rem;
      left: .125rem;
      background: rgba(255,255,255,.90);
      box-shadow: 0 .625rem 1.25rem rgba(0,0,0,.35);
      transition: transform .18s ease, background .18s ease;
    }
    .switch.on{
      background: rgba(107,91,255,.35);
      border-color: rgba(255,255,255,.22);
    }
    .switch.on::after{ transform: translateX(1.25rem); background: rgba(255,255,255,.96); }

    .lockOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 1rem;
      z-index: 2000;
    }
    .lockOverlay.show{ display:flex; }
    .lockCard{
      width: min(26.25rem, 100%);
      border-radius: 1.375rem;
      background: linear-gradient(180deg, rgba(23,26,51,.98), rgba(18,20,39,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 1.375rem 3.75rem rgba(0,0,0,.55);
      overflow:hidden;
    }
    .lockHead{
      padding: .875rem .875rem .625rem;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .lockHead h3{ margin:0; font-size: 1.125rem; font-weight: 950; }
    .lockHead p{ margin:.375rem 0 0; color: var(--muted); font-size: .875rem; line-height:1.25; }
    .lockBody{ padding: .875rem; display:flex; flex-direction:column; gap: .75rem; }
    .pinDots{ display:flex; justify-content:center; gap:.625rem; margin-top: .125rem; }
    .dot{
      width: .875rem; height: .875rem;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
    }
    .dot.on{
      background: rgba(107,91,255,.85);
      border-color: rgba(255,255,255,.30);
      box-shadow: 0 .625rem 1.5625rem rgba(107,91,255,.22);
    }
    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: .625rem;
      margin-top: .375rem;
    }
    .key{
      border-radius: 1rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: .875rem .75rem;
      font-size: 1.125rem;
      font-weight: 950;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      text-align:center;
    }
    .key:active{ transform: scale(.99); }
    .key.primary{ background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55)); border-color: rgba(255,255,255,.18); }
    .key.danger{ background: rgba(255,92,122,.12); border-color: rgba(255,92,122,.35); }
    .lockFoot{ padding: .75rem .875rem .875rem; display:flex; gap:.625rem; flex-wrap:wrap; }

    .seg{
      display:flex;
      gap:.625rem;
      padding: .375rem;
      border-radius: 1rem;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .seg button{
      flex:1;
      border-radius: .875rem;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: .625rem .75rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .90625rem;
      white-space:nowrap;
    }
    .seg button.active{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
    }

    .twoCol{ display:flex; gap:.625rem; flex-wrap:wrap; }
    .twoCol > *{ flex:1; min-width: 10rem; }

    /* Modal confirm propio */
    .confirmMsg{ font-size:.9375rem; color:var(--text); opacity:.95; line-height:1.35; }
    .dangerTxt{ color: rgba(255,92,122,.95); font-weight: 950; }

    /* Bot√≥n texto grande */
    .iconbtn.tgl.on{
      background: rgba(107,91,255,.20);
      border-color: rgba(255,255,255,.18);
    }

    /* ‚úÖ Manual plegable */
    .helpWrap{ margin-top:.625rem; } /* ‚úÖ un pel√≠n m√°s compacto */
    .helpMiniBtn{
      width:100%;
      justify-content:space-between;
    }
    .helpBox{
      margin-top:.625rem;
      padding:.75rem;
      border-radius: 1rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .helpBox h3{
      margin:0 0 .375rem;
      font-size: .9375rem;
      font-weight: 950;
    }
    .helpBox ul{
      margin:.375rem 0 0 1.1rem;
      padding:0;
      color: var(--muted);
      font-size: .90625rem;
      line-height:1.35;
    }
    .helpBox li{ margin:.25rem 0; }

    /* ‚úÖ Contacto clickable */
    .contactCard{
      cursor:pointer;
      user-select:none;
    }
    .contactCard:active{
      transform: scale(.995);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">C</div>
        <div style="min-width:0">
          <h1>Compromisos</h1>
          <p>Paquetes entre m√≥viles ¬∑ sin base de datos</p>
        </div>
      </div>

      <!-- ‚úÖ En header dejamos solo instalar (texto grande va en el hero, como en tu captura) -->
      <div style="display:flex; gap:.625rem; align-items:center; flex:0 0 auto;">
        <button class="iconbtn" id="btnInstall" style="display:none">‚¨áÔ∏è <small>Instalar</small></button>
      </div>
    </header>

    <section class="hero">
      <!-- ‚úÖ Izquierda: avisador pendientes. Derecha: bot√≥n texto grande (zona del c√≠rculo rojo) -->
      <div class="heroBar">
        <div class="heroLeft">
          <div class="pill btnPill muted" id="btnNotifPend" title="Notificaciones pendientes (toca para limpiar)">
            üîî Pendientes <span class="badge" id="bNotifPend">0</span>
          </div>
        </div>

        <button class="iconbtn tgl" id="btnA11y" title="Texto grande">üëì <small id="a11yLabel">Texto</small></button>
      </div>

      <h2>Comparte cambios como un enlace (sin cuentas).</h2>
      <p>Ahora puedes enviar un compromiso con un <b>aviso ‚Äúdesde ahora‚Äù</b> (5 min / 1 hora‚Ä¶) que se programa al importar.</p>

      <!-- ‚úÖ Manual plegable (limpia pantalla) -->
      <div class="helpWrap">
        <button class="iconbtn helpMiniBtn" id="btnHelpToggle" title="Gu√≠a r√°pida">
          üìò <span id="helpToggleLabel" style="font-weight:950">Ver gu√≠a r√°pida</span>
          <small id="helpToggleHint">Toques</small>
        </button>
        <div class="helpBox" id="helpBox" style="display:none">
          <h3>Gu√≠a r√°pida</h3>
          <ul>
            <li><b>+</b> crea un compromiso (o un contacto si est√°s en ‚ÄúAmigos‚Äù).</li>
            <li><b>üì¶ Compartir</b> env√≠a el paquete por WhatsApp/Telegram.</li>
            <li>El receptor abre el enlace y se <b>importa</b> en su m√≥vil.</li>
            <li><b>‚è≥ Desde ahora</b> crea un aviso relativo (5 min / 1 h‚Ä¶).</li>
            <li><b>üìÖ Calendario</b> es la opci√≥n m√°s fiable para recordatorios.</li>
          </ul>
        </div>
      </div>

      <div class="kicker" id="statsKicker" style="display:none"></div>
    </section>

    <section class="banner" id="installBanner">
      <p class="title" id="installTitle">Inst√°lala para usarla como app</p>
      <p class="txt" id="installText">
        Si la abres dentro de WhatsApp/Telegram, toca <b>Abrir en Chrome</b> para poder instalar e importar bien.
      </p>
      <div class="row">
        <button class="btn primary" id="btnInstallBanner" style="display:none">‚¨áÔ∏è Instalar</button>
        <button class="btn primary" id="btnOpenChrome" style="display:none">üåê Abrir en Chrome</button>
        <button class="btn" id="btnCopyLink" style="display:none">üìã Copiar enlace</button>
        <button class="btn" id="btnHideBanner">Ocultar</button>
      </div>
    </section>

    <nav class="tabs" aria-label="Vistas">
      <button class="tab active" id="tabCommitments">üìù Compromisos</button>
      <button class="tab" id="tabContacts">üë• Amigos <span class="badge" id="bContacts">0</span></button>
      <button class="tab" id="tabSettings">‚öôÔ∏è Ajustes</button>
    </nav>

    <div id="commitmentsPane">
      <nav class="subtabs" aria-label="Pesta√±as">
        <button class="subtab active" id="tabPending">Pendientes <span class="badge" id="bPending">0</span></button>
        <button class="subtab" id="tabDone">Hechos <span class="badge" id="bDone">0</span></button>
      </nav>

      <div class="list" id="list"></div>
      <div class="empty" id="empty">No tienes compromisos aqu√≠. Pulsa <b>+</b> para crear uno nuevo.</div>
    </div>

    <div id="contactsPane" style="display:none">
      <div class="list" id="contactsList"></div>
      <div class="empty" id="contactsEmpty">No tienes contactos a√∫n. Pulsa <b>+</b> para crear el primero.</div>
    </div>

    <div id="settingsPane" style="display:none">
      <div class="list">

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîî Notificaciones</div>
            <div class="sub">Recordatorios locales (fiables con la app abierta; en segundo plano depende del m√≥vil). Usa Calendario si quieres 100%.</div>
          </div>
          <div class="right">
            <div class="switch" id="swNotif" role="switch" aria-checked="false" tabindex="0"></div>
            <button class="btn" id="btnNotifPerm" style="flex:0 0 auto; min-width: 10rem;">Permitir</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîí Bloqueo por PIN</div>
            <div class="sub">Protege la app con un PIN de 4 d√≠gitos. Puedes activarlo o desactivarlo cuando quieras.</div>
          </div>
          <div class="right">
            <div class="switch" id="swPin" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">‚è±Ô∏è Auto-bloqueo</div>
            <div class="sub">Cuando sales de la app, se bloquea pasado este tiempo.</div>
          </div>
          <div class="right">
            <select id="selAutoLock" style="min-width:10rem">
              <option value="0">Inmediato</option>
              <option value="1">1 minuto</option>
              <option value="5">5 minutos</option>
              <option value="15">15 minutos</option>
              <option value="60">60 minutos</option>
            </select>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üïí Recordar desbloqueo</div>
            <div class="sub">Durante este tiempo no pedir√° PIN (si el PIN est√° activado).</div>
          </div>
          <div class="right">
            <select id="selRemember" style="min-width:10rem">
              <option value="0">No recordar</option>
              <option value="10">10 minutos</option>
              <option value="30">30 minutos</option>
              <option value="60">60 minutos</option>
            </select>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîÅ Cambiar PIN</div>
            <div class="sub">Requiere el PIN actual (si est√° activado).</div>
          </div>
          <div class="right">
            <button class="btn" id="btnChangePin">Cambiar</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîí Bloquear ahora</div>
            <div class="sub">Te pide el PIN en la pr√≥xima apertura (o ahora mismo si el PIN est√° activado).</div>
          </div>
          <div class="right">
            <button class="btn danger" id="btnLockNow">Bloquear</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üßπ Restablecer app</div>
            <div class="sub">Borra compromisos, contactos y ajustes del m√≥vil (irreversible).</div>
          </div>
          <div class="right">
            <button class="btn danger" id="btnResetAll">Borrar todo</button>
          </div>
        </div>

        <div class="hint" style="margin-top:.375rem" id="notifHint"></div>

      </div>
    </div>
  </div>

  <button class="fab" id="fab" aria-label="Nuevo">+</button>

  <!-- Modal Compromiso -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="modalTitle">Nuevo compromiso</h3>
        <button class="close" id="btnClose">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="field">
          <label for="fContact">¬øCon qui√©n?</label>
          <select id="fContact"></select>
          <div class="hint" id="contactHint">Puedes elegir un contacto o escribir uno nuevo.</div>
        </div>

        <div class="field" id="customWhoField" style="display:none">
          <label for="fWho">Nombre (nuevo contacto)</label>
          <input id="fWho" type="text" placeholder="Ej: Laura / Mam√° / Juan (del trabajo)" autocomplete="off"/>
        </div>

        <div class="field">
          <label for="fWhat">¬øQu√© se acord√≥?</label>
          <textarea id="fWhat" placeholder="Ej: Te paso el PDF / Te devuelvo 20‚Ç¨ / Quedamos el jueves‚Ä¶"></textarea>
        </div>

        <div class="twoCol">
          <div class="field">
            <label for="fWhen">¬øPara cu√°ndo?</label>
            <input id="fWhen" type="datetime-local" />
            <div class="hint">Puedes dejarlo sin fecha.</div>
          </div>

          <div class="field">
            <label for="fRemind">Recordatorio (por fecha)</label>
            <select id="fRemind">
              <option value="0">Ninguno</option>
              <option value="5">5 min antes</option>
              <option value="15">15 min antes</option>
              <option value="60">1 hora antes</option>
              <option value="1440">1 d√≠a antes</option>
            </select>
            <div class="hint">Requiere fecha.</div>
          </div>
        </div>

        <div class="field">
          <label for="fAfter">Avisar ‚Äúdesde ahora‚Äù (viaja en el enlace)</label>
          <select id="fAfter">
            <option value="0">No</option>
            <option value="5">En 5 minutos</option>
            <option value="15">En 15 minutos</option>
            <option value="60">En 1 hora</option>
            <option value="180">En 3 horas</option>
            <option value="1440">Ma√±ana (24h)</option>
          </select>
          <div class="hint">El receptor debe abrir el enlace para que se programe en su m√≥vil.</div>
        </div>

        <div class="hint">
          Al guardar, se abrir√° el modal de <b>Compartir</b> (con copiar enlace directo).
        </div>
      </div>

      <div class="sheetFoot">
        <button class="btn danger" id="btnCancel">Cancelar</button>
        <button class="btn good" id="btnSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Contacto -->
  <div class="backdrop" id="cBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="cModalTitle">Nuevo contacto</h3>
        <button class="close" id="cBtnClose">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="field">
          <label for="cName">Nombre</label>
          <input id="cName" type="text" placeholder="Ej: Laura" autocomplete="off"/>
        </div>
        <div class="field">
          <label for="cNote">Nota (opcional)</label>
          <input id="cNote" type="text" placeholder="Ej: Trabajo / Vecina / Familia" autocomplete="off"/>
        </div>
        <div class="hint">Esto solo se guarda en tu m√≥vil.</div>
      </div>

      <div class="sheetFoot">
        <button class="btn danger" id="cBtnCancel">Cancelar</button>
        <button class="btn good" id="cBtnSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal PIN -->
  <div class="backdrop" id="pinBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="pinTitle">Configurar PIN</h3>
        <button class="close" id="pinClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="hint" id="pinHint" style="margin-top:0"></div>

        <div class="field" id="pinOldWrap" style="display:none">
          <label for="pinOld">PIN actual</label>
          <input id="pinOld" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNewWrap">
          <label for="pinNew">Nuevo PIN (4 d√≠gitos)</label>
          <input id="pinNew" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNew2Wrap">
          <label for="pinNew2">Repite el PIN</label>
          <input id="pinNew2" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="hint" id="pinHelp">Consejo: usa un PIN que solo t√∫ sepas. Puedes desactivarlo en Ajustes.</div>
      </div>
      <div class="sheetFoot">
        <button class="btn danger" id="pinCancel">Cancelar</button>
        <button class="btn good" id="pinOk">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Compartir -->
  <div class="backdrop" id="shareBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3>Compartir paquete</h3>
        <button class="close" id="shareClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="hint" id="shareTitle" style="margin-top:0"></div>

        <div class="seg" role="tablist" aria-label="Formato">
          <button id="shareShort" class="active" type="button">Corto</button>
          <button id="shareLong" type="button">Detallado</button>
        </div>

        <div class="mono show" id="shareTextBox"></div>

        <div class="hint" style="margin-top:.125rem">
          Enlace (puedes copiarlo directo):
        </div>
        <div class="mono show" id="shareUrlBox"></div>

        <div class="hint">Pulsa <b>Compartir</b> para enviarlo por WhatsApp/Telegram. Si no aparece, usa copiar.</div>
      </div>
      <div class="sheetFoot">
        <button class="btn" id="shareCopyUrl">üîó Copiar enlace</button>
        <button class="btn" id="shareCopyAll">üìã Copiar texto+enlace</button>
        <button class="btn primary" id="shareSend">üì§ Compartir</button>
        <button class="btn danger" id="shareCancel">Hecho</button>
      </div>
    </div>
  </div>

  <!-- Overlay bloqueo -->
  <div class="lockOverlay" id="lockOverlay" aria-hidden="true">
    <div class="lockCard" role="dialog" aria-modal="true">
      <div class="lockHead">
        <h3>üîí App bloqueada</h3>
        <p>Introduce tu PIN para continuar.</p>
      </div>
      <div class="lockBody">
        <div class="pinDots" aria-label="PIN">
          <div class="dot" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
          <div class="dot" id="d4"></div>
        </div>

        <div class="keypad" id="keypad">
          <button class="key" data-k="1">1</button>
          <button class="key" data-k="2">2</button>
          <button class="key" data-k="3">3</button>
          <button class="key" data-k="4">4</button>
          <button class="key" data-k="5">5</button>
          <button class="key" data-k="6">6</button>
          <button class="key" data-k="7">7</button>
          <button class="key" data-k="8">8</button>
          <button class="key" data-k="9">9</button>
          <button class="key danger" data-k="del">‚å´</button>
          <button class="key" data-k="0">0</button>
          <button class="key primary" data-k="ok">OK</button>
        </div>
      </div>
      <div class="lockFoot">
        <button class="btn ghost" id="btnLockCopyLink">üìã Copiar enlace actual</button>
        <button class="btn danger" id="btnLockReset">Borrar todo</button>
      </div>
    </div>
  </div>

  <!-- Modal Confirm (propio) -->
  <div class="backdrop" id="confirmBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="confirmTitle">Confirmar</h3>
        <button class="close" id="confirmClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="confirmMsg" id="confirmMsg"></div>
      </div>
      <div class="sheetFoot">
        <button class="btn" id="confirmNo">Cancelar</button>
        <button class="btn danger" id="confirmYes">S√≠, continuar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    (function(){
      "use strict";

      const $ = (id) => document.getElementById(id);

      const KEY = "compromisos_local_v5";
      const EVENTS_KEY = "compromisos_events_v5";
      const CONTACTS_KEY = "compromisos_contacts_v5";
      const SETTINGS_KEY = "compromisos_settings_v3";
      const REMIND_FIRED_KEY = "compromisos_remind_fired_v2";
      const AFTER_FIRED_KEY = "compromisos_after_fired_v1";

      // ‚úÖ Buz√≥n para importaci√≥n ‚Äúdesde in-app browser‚Äù
      const INBOX_PACK_KEY = "compromisos_inbox_pack_v1";
      const INBOX_TS_KEY   = "compromisos_inbox_ts_v1";

      // ‚úÖ Accesibilidad: texto grande
      const A11Y_KEY = "compromisos_a11y_v1";

      // ‚úÖ Manual plegable
      const HELP_KEY = "compromisos_help_v1";

      // ‚úÖ Indicador local de pendientes (placeholder ‚Äúpendientes por leer‚Äù)
      const PENDING_NOTIF_KEY = "compromisos_pending_notifs_v1";

      // Tipos num√©ricos para acortar paquetes
      const T = { CREATE:0, DONE:1, REOPEN:2, DELETE:3, EDIT:4 };

      function uid(){
        return "c" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function pad2(n){ return String(n).padStart(2,"0"); }

      function fmtDate(dt){
        if(!dt) return "Sin fecha";
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return "Sin fecha";
        const now = new Date();
        const sameYear = d.getFullYear() === now.getFullYear();
        const day = pad2(d.getDate());
        const mon = pad2(d.getMonth()+1);
        const hh = pad2(d.getHours());
        const mm = pad2(d.getMinutes());
        return (sameYear ? `${day}/${mon}` : `${day}/${mon}/${d.getFullYear()}`) + ` ${hh}:${mm}`;
      }
      function isOverdue(dt){
        if(!dt) return false;
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return false;
        return d.getTime() < Date.now();
      }

      function toast(msg){
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(()=> t.classList.remove("show"), 2400);
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // Base64URL (utf8-safe)
      function b64urlEncode(str){
        const b64 = btoa(unescape(encodeURIComponent(str)));
        return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
      }
      function b64urlDecode(b64url){
        let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
        while(b64.length % 4) b64 += "=";
        return decodeURIComponent(escape(atob(b64)));
      }

      function load(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          const v = JSON.parse(raw);
          return v ?? fallback;
        }catch(e){ return fallback; }
      }
      function save(key, value){
        localStorage.setItem(key, JSON.stringify(value));
      }

      // --------- Pendientes (contador local m√≠nimo) ----------
      let pendingNotifs = load(PENDING_NOTIF_KEY, { c:0, at:0 });

      function renderPendingBadge(){
        const c = Math.max(0, Number(pendingNotifs?.c || 0));
        const pill = $("btnNotifPend");
        $("bNotifPend").textContent = String(c);

        // visual: si 0, se ve ‚Äúmuted‚Äù; si >0, se ve como pill normal
        if(c > 0){
          pill.classList.remove("muted");
        } else {
          pill.classList.add("muted");
        }
      }

      function incPendingBadge(){
        pendingNotifs.c = Math.max(0, Number(pendingNotifs.c || 0)) + 1;
        pendingNotifs.at = Date.now();
        save(PENDING_NOTIF_KEY, pendingNotifs);
        renderPendingBadge();
      }

      function clearPendingBadge(){
        pendingNotifs.c = 0;
        pendingNotifs.at = Date.now();
        save(PENDING_NOTIF_KEY, pendingNotifs);
        renderPendingBadge();
        toast("Pendientes limpiadas");
      }

      // --------- Confirm modal (propio) ----------
      const Confirm = (function(){
        let resolver = null;

        function open({ title, msg, yesText, danger }){
          $("confirmTitle").textContent = title || "Confirmar";
          $("confirmMsg").innerHTML = msg || "";
          $("confirmYes").textContent = yesText || "S√≠, continuar";
          $("confirmYes").classList.toggle("danger", !!danger);

          $("confirmBackdrop").classList.add("show");
          $("confirmBackdrop").setAttribute("aria-hidden","false");
          return new Promise((resolve)=>{ resolver = resolve; });
        }
        function close(val){
          $("confirmBackdrop").classList.remove("show");
          $("confirmBackdrop").setAttribute("aria-hidden","true");
          const r = resolver;
          resolver = null;
          if(r) r(!!val);
        }

        $("confirmClose").addEventListener("click", ()=> close(false));
        $("confirmNo").addEventListener("click", ()=> close(false));
        $("confirmYes").addEventListener("click", ()=> close(true));
        $("confirmBackdrop").addEventListener("click", (e)=>{ if(e.target === $("confirmBackdrop")) close(false); });

        return { open };
      })();

      // --------- Accesibilidad (texto grande) ----------
      function setTextScale(on){
        const isOn = !!on;
        const root = document.documentElement;

        // ‚úÖ Ahora afecta a TODO porque toda la UI usa rem y html font-size
        root.style.setProperty("--fs-base", isOn ? "18px" : "16px");

        const b = $("btnA11y");
        b.classList.toggle("on", isOn);
        $("a11yLabel").textContent = isOn ? "Grande" : "Texto";

        save(A11Y_KEY, { big: isOn });
      }
      function toggleTextScale(){
        const s = load(A11Y_KEY, { big:false });
        setTextScale(!s.big);
      }

      // --------- Manual plegable ----------
      function setHelpVisible(on){
        const show = !!on;
        $("helpBox").style.display = show ? "" : "none";
        $("helpToggleLabel").textContent = show ? "Ocultar gu√≠a r√°pida" : "Ver gu√≠a r√°pida";
        $("helpToggleHint").textContent = show ? "Menos" : "Ayuda";
        save(HELP_KEY, { show });
      }
      function toggleHelp(){
        const s = load(HELP_KEY, { show:false });
        setHelpVisible(!s.show);
      }

      // --------- Ajustes (PIN / notifs) ----------
      const defaultSettings = {
        notifEnabled: false,
        pinEnabled: false,
        pinHash: null,
        autoLockMin: 0,
        rememberMin: 10,
        unlockUntil: 0
      };
      let settings = Object.assign({}, defaultSettings, load(SETTINGS_KEY, {}));

      let sessionUnlocked = false;
      let lockAtTs = 0;

      async function sha256Base64Url(str){
        try{
          if(!crypto || !crypto.subtle) throw new Error("no subtle");
          const enc = new TextEncoder();
          const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
          const bytes = Array.from(new Uint8Array(buf));
          const b64 = btoa(String.fromCharCode(...bytes));
          return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
        }catch(e){
          let h = 0;
          const s = String(str);
          for(let i=0;i<s.length;i++){
            h = ((h<<5)-h) + s.charCodeAt(i);
            h |= 0;
          }
          return "fh_" + String(h);
        }
      }

      function normalizePin(pin){
        return String(pin||"").trim().replaceAll(/\D/g,"").slice(0,4);
      }

      async function verifyPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) return false;
        const h = await sha256Base64Url("pin:" + p);
        return settings.pinHash && h === settings.pinHash;
      }

      async function setPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) throw new Error("pin");
        settings.pinHash = await sha256Base64Url("pin:" + p);
        save(SETTINGS_KEY, settings);
      }

      function isUnlockedNow(){
        if(!settings.pinEnabled) return true;
        const now = Date.now();
        if(settings.unlockUntil && now < settings.unlockUntil) return true;
        return sessionUnlocked === true;
      }

      function applyUnlock(){
        if(!settings.pinEnabled) return;
        const now = Date.now();
        const rem = Number(settings.rememberMin || 0);
        if(rem > 0){
          settings.unlockUntil = now + rem*60*1000;
          sessionUnlocked = false;
        } else {
          settings.unlockUntil = 0;
          sessionUnlocked = true;
        }
        save(SETTINGS_KEY, settings);
      }

      function forceLock(){
        if(!settings.pinEnabled) return;
        settings.unlockUntil = 0;
        sessionUnlocked = false;
        lockAtTs = 0;
        save(SETTINGS_KEY, settings);
        showLockOverlay();
      }

      function setPinEnabled(on){
        settings.pinEnabled = !!on;
        if(!settings.pinEnabled){
          settings.pinHash = null;
          settings.unlockUntil = 0;
          sessionUnlocked = false;
          lockAtTs = 0;
        }
        save(SETTINGS_KEY, settings);
        updateSettingsUI();
      }

      function setNotifEnabled(on){
        settings.notifEnabled = !!on;
        save(SETTINGS_KEY, settings);
        updateSettingsUI();
      }

      function notifPermission(){
        try{ return Notification.permission; }catch(e){ return "unsupported"; }
      }
      function notifSupported(){
        return typeof Notification !== "undefined";
      }

      async function requestNotifPermission(){
        if(!notifSupported()){
          toast("Tu navegador no soporta notificaciones");
          return false;
        }
        try{
          const p = await Notification.requestPermission();
          updateSettingsUI();
          if(p === "granted"){ toast("Notificaciones permitidas ‚úÖ"); return true; }
          toast("Permiso no concedido");
          return false;
        }catch(e){
          toast("No se pudo pedir permiso");
          return false;
        }
      }

      function updateSettingsUI(){
        const swP = $("swPin");
        swP.classList.toggle("on", !!settings.pinEnabled);
        swP.setAttribute("aria-checked", settings.pinEnabled ? "true":"false");

        const swN = $("swNotif");
        swN.classList.toggle("on", !!settings.notifEnabled);
        swN.setAttribute("aria-checked", settings.notifEnabled ? "true":"false");

        $("selAutoLock").value = String(settings.autoLockMin ?? 0);
        $("selRemember").value = String(settings.rememberMin ?? 10);

        const hint = $("notifHint");
        const perm = notifPermission();
        const sup = notifSupported();
        if(!sup){
          hint.textContent = "‚ö†Ô∏è Este navegador no soporta notificaciones. Usa ‚ÄúüìÖ Calendario‚Äù en cada compromiso.";
          $("btnNotifPerm").style.display = "none";
        }else{
          $("btnNotifPerm").style.display = "";
          if(perm === "granted"){
            hint.textContent = settings.notifEnabled
              ? "‚úÖ Notificaciones activadas."
              : "‚ÑπÔ∏è Tienes permiso concedido, pero est√°n desactivadas. Act√≠valas con el switch.";
          } else if(perm === "denied"){
            hint.textContent = "üö´ Notificaciones bloqueadas. Perm√≠telas en Ajustes de Android/Chrome o reinstala la PWA. Usa Calendario como alternativa.";
          } else {
            hint.textContent = "‚ÑπÔ∏è Pulsa ‚ÄúPermitir‚Äù para recibir recordatorios. Si no, usa Calendario.";
          }
        }
      }

      // --------- Datos ----------
      let data = load(KEY, []);
      let events = load(EVENTS_KEY, []);
      let contacts = load(CONTACTS_KEY, []);
      let firedMap = load(REMIND_FIRED_KEY, {});
      let afterFired = load(AFTER_FIRED_KEY, {});

      let view = "pending";
      let pane = "commitments";

      function contactById(id){ return contacts.find(c => c.id === id) || null; }

      function normalizedWho(item){
        if(item.whoId){
          const c = contactById(item.whoId);
          if(c && c.name) return c.name;
        }
        return item.whoName || "Sin nombre";
      }

      function remindLabel(min){
        const m = Number(min||0);
        if(!m) return "";
        if(m === 5) return "üîî 5m";
        if(m === 15) return "üîî 15m";
        if(m === 60) return "üîî 1h";
        if(m === 1440) return "üîî 1d";
        return "üîî";
      }

      // --------- Eventos + paquetes cortos ----------
      function makeEvent(type, payload){
        return { id: uid(), type, at: new Date().toISOString(), payload };
      }

      function applyEvent(ev){
        if(!ev || ev.type == null) return false;
        if(events.some(x => x.id === ev.id)) return false;

        let changed = false;

        if(ev.type === T.CREATE){
          const p = ev.payload || {};
          const itemId = p.i || uid();

          const afterMin = Number(p.af || 0);
          const afterAt = p.aa || null;

          if(!data.some(x => x.id === itemId)){
            data.push({
              id: itemId,
              whoId: p.c || null,
              whoName: p.w || "Sin nombre",
              what: p.s || "",
              when: p.n || null,
              remindMin: Number(p.r || 0),

              afterMin: afterMin,
              afterAt: afterAt,

              done: false,
              createdAt: p.ca || ev.at,
              doneAt: null,
              updatedAt: null
            });
            changed = true;
          } else {
            const it = data.find(x => x.id === itemId);
            if(it){
              const before = JSON.stringify(it);
              it.whoId = p.c || null;
              it.whoName = p.w || it.whoName;
              it.what = p.s ?? it.what;
              it.when = (p.n ?? it.when) || null;
              it.remindMin = Number(p.r ?? it.remindMin ?? 0);

              if(p.af != null) it.afterMin = afterMin;
              if(p.aa != null) it.afterAt = afterAt;

              it.updatedAt = ev.at;
              changed = (JSON.stringify(it) !== before);
            }
          }
        }
        else if(ev.type === T.DONE){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it && !it.done){
            it.done = true;
            it.doneAt = ev.at;
            it.updatedAt = ev.at;
            changed = true;
          }
        }
        else if(ev.type === T.REOPEN){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it && it.done){
            it.done = false;
            it.doneAt = null;
            it.updatedAt = ev.at;
            changed = true;
          }
        }
        else if(ev.type === T.DELETE){
          const p = ev.payload || {};
          const before = data.length;
          data = data.filter(x => x.id !== p.i);
          changed = (data.length !== before);
        }
        else if(ev.type === T.EDIT){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it){
            const before = JSON.stringify(it);
            if(p.w != null) it.whoName = p.w;
            if(p.c != null) it.whoId = p.c || null;
            if(p.s != null) it.what = p.s;
            if(p.n != null) it.when = p.n || null;
            if(p.r != null) it.remindMin = Number(p.r || 0);

            if(p.af != null) it.afterMin = Number(p.af || 0);
            if(p.aa != null) it.afterAt = p.aa || null;

            it.updatedAt = ev.at;
            changed = (JSON.stringify(it) !== before);
          }
        }

        events.push(ev);
        save(EVENTS_KEY, events);
        save(KEY, data);

        cleanupFiredMaps();
        return changed;
      }

      function packEvent(ev){
        return { v:1, e:{ i: ev.id, t: ev.type, a: ev.at, p: ev.payload || {} } };
      }
      function unpackEvent(pack){
        if(!pack || pack.v !== 1 || !pack.e) return null;
        const e = pack.e;
        if(!e.i || e.t == null || !e.a) return null;
        return { id: e.i, type: e.t, at: e.a, payload: e.p || {} };
      }
      function makePackage(ev){
        return b64urlEncode(JSON.stringify(packEvent(ev)));
      }
      function parsePackage(p){
        const json = b64urlDecode(p);
        return JSON.parse(json);
      }

      function baseFolderUrl(){
        const path = location.pathname || "/";
        const folder = path.replace(/\/[^\/]*$/, "/");
        return location.origin + folder;
      }
      function baseFileUrl(){
        return location.origin + location.pathname;
      }
      function makeLinkFromPackage(p){
        return baseFolderUrl() + "compromisos.html#p=" + p;
      }

      function shortPreview(text, n){
        const s = String(text||"").trim();
        if(s.length <= n) return s;
        return s.slice(0, n-1) + "‚Ä¶";
      }

      // --------- Compartir (modal) ----------
      let shareState = { title:"", shortText:"", longText:"", url:"", mode:"short" };

      function openShareModal(){
        $("shareBackdrop").classList.add("show");
        $("shareBackdrop").setAttribute("aria-hidden","false");
        updateShareUI();
      }
      function closeShareModal(){
        $("shareBackdrop").classList.remove("show");
        $("shareBackdrop").setAttribute("aria-hidden","true");
      }
      function updateShareUI(){
        $("shareShort").classList.toggle("active", shareState.mode === "short");
        $("shareLong").classList.toggle("active", shareState.mode === "long");
        $("shareTitle").innerHTML = `<b>${escapeHtml(shareState.title || "Compartir")}</b>`;
        const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
        $("shareTextBox").textContent = msg || "";
        $("shareUrlBox").textContent = shareState.url || "";
      }

      async function copyToClipboard(text){
        try{
          await navigator.clipboard.writeText(text);
          toast("Copiado ‚úÖ");
          return true;
        }catch(e){
          prompt("Copia este texto:", text);
          return true;
        }
      }

      async function doShare(){
        const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
        const payload = { title: shareState.title || "Compromisos", text: msg, url: shareState.url };

        try{
          if(navigator.share){
            await navigator.share(payload);
            toast("Enviado ‚úÖ");
            closeShareModal();
            return true;
          }
        }catch(e){}

        const combined = (payload.title ? payload.title + "\n" : "") + (payload.text ? payload.text + "\n" : "") + payload.url;
        await copyToClipboard(combined);
        closeShareModal();
        return true;
      }

      function eventTitle(type){
        if(type === T.CREATE) return "üìå Nuevo/Actualizado";
        if(type === T.EDIT) return "‚úçÔ∏è Compromiso editado";
        if(type === T.DONE) return "‚úÖ Compromiso finalizado";
        if(type === T.REOPEN) return "‚Ü©Ô∏è Compromiso reabierto";
        if(type === T.DELETE) return "üóëÔ∏è Compromiso eliminado";
        return "üì¶ Paquete";
      }

      function buildShareMessages(ev, it){
        const who = it ? normalizedWho(it) : (ev?.payload?.w || "Sin nombre");
        const what = it ? shortPreview(it.what, 120) : shortPreview(ev?.payload?.s || "", 120);
        const whenTxt = it?.when ? fmtDate(it.when) : (ev?.payload?.n ? fmtDate(ev.payload.n) : "Sin fecha");

        const afterMin = Number(it?.afterMin || ev?.payload?.af || 0);
        const afterTxt = afterMin ? `‚è≥ Aviso en: ${afterMin >= 1440 ? "24h" : (afterMin >= 60 ? (afterMin/60)+"h" : afterMin+"m")}` : "";

        const title = eventTitle(ev.type);
        const shortMsg =
          `${title}\n` +
          `üë§ ${who}\n` +
          (what ? `üìù ${shortPreview(what, 70)}\n` : "") +
          (afterTxt ? `${afterTxt}\n` : "") +
          `üîó Abre el enlace para importar.`;

        const longMsg =
          `${title}\n` +
          `üë§ Con: ${who}\n` +
          (what ? `üìù ${what}\n` : "") +
          `‚è∞ Para: ${whenTxt}\n` +
          (afterTxt ? `${afterTxt}\n` : "") +
          `üîó Abre el enlace para importar en la app.`;

        return { title, shortMsg, longMsg };
      }

      async function prepareShare(ev, it){
        const p = makePackage(ev);
        const link = makeLinkFromPackage(p);

        const msgs = buildShareMessages(ev, it);

        shareState = {
          title: msgs.title,
          shortText: msgs.shortMsg,
          longText: msgs.longMsg,
          url: link,
          mode: "short"
        };

        openShareModal();
      }

      // --------- Recordatorios (por fecha + desde ahora) ----------
      function firedKey(it){
        return `${it.id}|${it.when||""}|${Number(it.remindMin||0)}|${it.done?"1":"0"}`;
      }
      function afterKey(it){
        return `${it.id}|${it.afterAt||""}|${Number(it.afterMin||0)}|${it.done?"1":"0"}`;
      }

      function cleanupFiredMaps(){
        const liveA = new Set();
        const liveB = new Set();

        for(const it of data){
          if(it.done) continue;

          if(it.when && Number(it.remindMin||0) > 0){
            liveA.add(firedKey(it));
          }
          if(it.afterAt && Number(it.afterMin||0) > 0){
            liveB.add(afterKey(it));
          }
        }

        const nextA = {};
        for(const k of Object.keys(firedMap||{})){
          if(liveA.has(k)) nextA[k] = firedMap[k];
        }
        firedMap = nextA;
        save(REMIND_FIRED_KEY, firedMap);

        const nextB = {};
        for(const k of Object.keys(afterFired||{})){
          if(liveB.has(k)) nextB[k] = afterFired[k];
        }
        afterFired = nextB;
        save(AFTER_FIRED_KEY, afterFired);
      }

      function canNotify(){
        if(!settings.notifEnabled) return false;
        if(typeof Notification === "undefined") return false;
        return Notification.permission === "granted";
      }

      function sendLocalNotification(title, body){
        try{
          if(canNotify()){
            new Notification(title, { body });
            return true;
          }
        }catch(e){}
        return false;
      }

      function checkReminders(){
        const now = Date.now();

        // A) Por fecha (X min antes)
        for(const it of data){
          if(it.done) continue;
          const rm = Number(it.remindMin||0);
          if(!it.when || rm <= 0) continue;

          const due = new Date(it.when).getTime();
          if(Number.isNaN(due)) continue;

          const trigger = due - rm*60*1000;
          if(now < trigger) continue;
          if(now > due + 30*60*1000) continue;

          const k = firedKey(it);
          if(firedMap && firedMap[k]) continue;

          const who = normalizedWho(it);
          const what = shortPreview(it.what, 80);
          const dueTxt = fmtDate(it.when);

          const title = `‚è∞ Compromiso: ${who}`;
          const body = (what ? what + " ¬∑ " : "") + `Para: ${dueTxt}`;

          sendLocalNotification(title, body);
          toast(`‚è∞ Recordatorio: ${who}`);

          // ‚úÖ sube contador local ‚Äúpendientes‚Äù
          incPendingBadge();

          firedMap[k] = now;
          save(REMIND_FIRED_KEY, firedMap);
        }

        // B) Desde ahora (afterAt)
        for(const it of data){
          if(it.done) continue;
          const am = Number(it.afterMin||0);
          if(!it.afterAt || am <= 0) continue;

          const at = new Date(it.afterAt).getTime();
          if(Number.isNaN(at)) continue;

          if(now < at) continue;
          if(now > at + 30*60*1000) continue;

          const k = afterKey(it);
          if(afterFired && afterFired[k]) continue;

          const who = normalizedWho(it);
          const what = shortPreview(it.what, 80);

          const title = `üîî Aviso: ${who}`;
          const body = what || "Tienes un compromiso pendiente.";

          sendLocalNotification(title, body);
          toast(`üîî Aviso: ${who}`);

          // ‚úÖ sube contador local ‚Äúpendientes‚Äù
          incPendingBadge();

          afterFired[k] = now;
          save(AFTER_FIRED_KEY, afterFired);
        }
      }

      // --------- Calendario (.ics) ----------
      function dtToICS(iso){
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return null;
        const y = d.getUTCFullYear();
        const m = pad2(d.getUTCMonth()+1);
        const da = pad2(d.getUTCDate());
        const h = pad2(d.getUTCHours());
        const mi = pad2(d.getUTCMinutes());
        const s = pad2(d.getUTCSeconds());
        return `${y}${m}${da}T${h}${mi}${s}Z`;
      }
      function makeICSForItem(it){
        if(!it.when) return null;
        const dtStart = dtToICS(it.when);
        if(!dtStart) return null;
        const startMs = new Date(it.when).getTime();
        const endMs = startMs + 15*60*1000;
        const dtEnd = dtToICS(new Date(endMs).toISOString());

        const who = normalizedWho(it);
        const summary = `Compromiso: ${who}`;
        const desc = (it.what || "").replaceAll("\n","\\n");
        const uidv = `${it.id}@compromisos.local`;
        const stamp = dtToICS(new Date().toISOString());

        return [
          "BEGIN:VCALENDAR",
          "VERSION:2.0",
          "PRODID:-//Compromisos//Local//ES",
          "CALSCALE:GREGORIAN",
          "METHOD:PUBLISH",
          "BEGIN:VEVENT",
          `UID:${uidv}`,
          `DTSTAMP:${stamp}`,
          `DTSTART:${dtStart}`,
          `DTEND:${dtEnd}`,
          `SUMMARY:${summary}`,
          `DESCRIPTION:${desc}`,
          "END:VEVENT",
          "END:VCALENDAR"
        ].join("\r\n");
      }
      async function addToCalendar(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }
        if(!it.when){ toast("Pon una fecha para usar calendario"); return; }

        const ics = makeICSForItem(it);
        if(!ics){ toast("No se pudo crear el evento"); return; }

        const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
        const filename = `compromiso_${itemId}.ics`;

        try{
          if(navigator.canShare && navigator.share){
            const file = new File([blob], filename, { type: "text/calendar" });
            if(navigator.canShare({ files: [file] })){
              await navigator.share({ title: "A√±adir al calendario", text: "Abre el archivo para a√±adirlo a tu calendario.", files: [file] });
              toast("Evento listo ‚úÖ");
              return;
            }
          }
        }catch(e){}

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 1200);
        toast("Descargado .ics ‚úÖ (√°brelo)");
      }

      // --------- UI / Vistas ----------
      function setPane(newPane){
        pane = newPane;
        $("tabCommitments").classList.toggle("active", pane==="commitments");
        $("tabContacts").classList.toggle("active", pane==="contacts");
        $("tabSettings").classList.toggle("active", pane==="settings");

        $("commitmentsPane").style.display = (pane==="commitments") ? "" : "none";
        $("contactsPane").style.display = (pane==="contacts") ? "" : "none";
        $("settingsPane").style.display = (pane==="settings") ? "" : "none";

        if(pane === "settings"){
          $("fab").style.display = "none";
        } else {
          $("fab").style.display = "grid";
          $("fab").setAttribute("aria-label", pane==="contacts" ? "Nuevo contacto" : "Nuevo compromiso");
        }

        renderAll();
      }

      function renderCommitments(){
        const list = $("list");
        list.innerHTML = "";

        const pending = data.filter(x => !x.done);
        const done = data.filter(x => x.done);

        $("bPending").textContent = String(pending.length);
        $("bDone").textContent = String(done.length);
        $("bContacts").textContent = String(contacts.length);

        const items = (view === "pending") ? pending : done;

        $("empty").style.display = items.length ? "none" : "block";

        items
          .sort((a,b) => {
            const ta = a.when ? new Date(a.when).getTime() : (view==="pending" ? Number.POSITIVE_INFINITY : 0);
            const tb = b.when ? new Date(b.when).getTime() : (view==="pending" ? Number.POSITIVE_INFINITY : 0);
            if(view === "pending") return ta - tb;
            return (new Date(b.doneAt||0).getTime()) - (new Date(a.doneAt||0).getTime());
          })
          .forEach(item => list.appendChild(renderCard(item)));

        const overdue = pending.filter(x => isOverdue(x.when)).length;
        const k = $("statsKicker");
        k.style.display = "block";
        k.textContent = overdue ? `‚è∞ Tienes ${overdue} compromiso(s) vencido(s).` : `‚úÖ Todo en orden.`;
      }

      function renderCard(item){
        const card = document.createElement("div");
        card.className = "card";

        const who = normalizedWho(item);
        const dueText = item.when ? fmtDate(item.when) : "Sin fecha";
        const overdue = !item.done && isOverdue(item.when);
        const dueClass = overdue ? "due bad" : "due";

        const chips = [
          `<span class="chip">üìù ${escapeHtml(fmtDate(item.createdAt))}</span>`,
          item.updatedAt ? `<span class="chip">‚úçÔ∏è ${escapeHtml(fmtDate(item.updatedAt))}</span>` : "",
          item.done ? `<span class="chip">‚úÖ ${escapeHtml(fmtDate(item.doneAt))}</span>` : "",
          item.when && Number(item.remindMin||0) > 0 ? `<span class="chip">${escapeHtml(remindLabel(item.remindMin))}</span>` : "",
          item.afterAt && Number(item.afterMin||0) > 0 ? `<span class="chip">‚è≥ ${escapeHtml(item.afterMin>=60 ? (item.afterMin/60)+"h" : item.afterMin+"m")}</span>` : ""
        ].filter(Boolean).join("");

        card.innerHTML = `
          <div class="cardTop">
            <div class="who">
              <p class="name">${escapeHtml(who)}</p>
              <p class="meta">${chips}</p>
            </div>
            <div class="${dueClass}">‚è∞ ${escapeHtml(dueText)}${overdue ? " ¬∑ Vencido" : ""}</div>
          </div>
          <div class="desc">${escapeHtml(item.what || "‚Äî")}</div>
          <div class="actions"></div>
        `;

        const actions = card.querySelector(".actions");
        actions.appendChild(mkBtn("üìÖ Calendario", "btn", () => addToCalendar(item.id)));
        actions.appendChild(mkBtn("üì¶ Compartir", "btn primary", () => shareSnapshot(item.id)));
        if(!item.done){
          actions.appendChild(mkBtn("‚úÖ Hecho", "btn good", () => markDone(item.id)));
          actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openEditModal(item.id)));
          actions.appendChild(mkBtn("üóëÔ∏è Eliminar", "btn danger", () => deleteItem(item.id)));
        }else{
          actions.appendChild(mkBtn("‚Ü©Ô∏è Reabrir", "btn", () => reopen(item.id)));
          actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openEditModal(item.id)));
          actions.appendChild(mkBtn("üóëÔ∏è Eliminar", "btn danger", () => deleteItem(item.id)));
        }

        return card;
      }

      function mkBtn(text, cls, onClick){
        const b = document.createElement("button");
        b.className = cls;
        b.textContent = text;
        b.addEventListener("click", onClick);
        return b;
      }

      function renderContacts(){
        const list = $("contactsList");
        list.innerHTML = "";
        $("bContacts").textContent = String(contacts.length);
        $("contactsEmpty").style.display = contacts.length ? "none" : "block";

        contacts
          .slice()
          .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
          .forEach(c => list.appendChild(renderContactCard(c)));
      }

      function openNewCommitmentForContact(contactId){
        const c = contactById(contactId);
        if(!c){ toast("Contacto no encontrado"); return; }

        // ‚úÖ Ir a Compromisos y abrir modal ya con el contacto elegido
        setPane("commitments");
        resetCommitmentForm();
        fillContactSelect();
        $("fContact").value = c.id;
        toggleCustomWho(false);
        $("fWho").value = "";
        openModal();
        $("fWhat").focus();
      }

      function renderContactCard(c){
        const card = document.createElement("div");
        card.className = "card contactCard";
        card.dataset.id = c.id;

        const note = c.note ? `<span class="chip">üõà ${escapeHtml(c.note)}</span>` : "";
        card.innerHTML = `
          <div class="cardTop">
            <div class="who">
              <p class="name">${escapeHtml(c.name || "Sin nombre")}</p>
              <p class="meta">
                <span class="chip">üë• Contacto</span>
                ${note}
              </p>
            </div>
            <div class="due">‚ûï</div>
          </div>
          <div class="desc">${escapeHtml(c.note || "Pulsa para crear un compromiso con esta persona.")}</div>
          <div class="actions"></div>
        `;

        const actions = card.querySelector(".actions");
        actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openContactEdit(c.id)));
        actions.appendChild(mkBtn("üóëÔ∏è Eliminar", "btn danger", () => deleteContact(c.id)));

        // ‚úÖ Click en la tarjeta (excepto botones) -> nuevo compromiso con ese contacto
        card.addEventListener("click", (e) => {
          if(e.target.closest("button")) return;
          openNewCommitmentForContact(c.id);
        });

        return card;
      }

      function renderAll(){
        renderCommitments();
        renderContacts();
        fillContactSelect();
        updateSettingsUI();
        renderPendingBadge();
      }

      // --------- Modal compromiso ----------
      let editingItemId = null;

      function openModal(){
        $("backdrop").classList.add("show");
        $("backdrop").setAttribute("aria-hidden","false");
      }
      function closeModal(){
        $("backdrop").classList.remove("show");
        $("backdrop").setAttribute("aria-hidden","true");
      }

      function resetCommitmentForm(){
        editingItemId = null;
        $("modalTitle").textContent = "Nuevo compromiso";
        $("fWhat").value = "";
        $("fWhen").value = "";
        $("fWho").value = "";
        $("fRemind").value = "0";
        $("fAfter").value = "0";
        fillContactSelect();
        $("fContact").value = "__custom__";
        toggleCustomWho(true);
      }

      function toggleCustomWho(show){
        $("customWhoField").style.display = show ? "" : "none";
      }

      function toInputDatetimeLocal(iso){
        if(!iso) return "";
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return "";
        const yyyy = d.getFullYear();
        const mm = pad2(d.getMonth()+1);
        const dd = pad2(d.getDate());
        const hh = pad2(d.getHours());
        const mi = pad2(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }

      function openEditModal(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }

        editingItemId = itemId;
        $("modalTitle").textContent = "Editar compromiso";

        fillContactSelect();
        if(it.whoId && contactById(it.whoId)){
          $("fContact").value = it.whoId;
          toggleCustomWho(false);
          $("fWho").value = "";
        } else {
          $("fContact").value = "__custom__";
          toggleCustomWho(true);
          $("fWho").value = it.whoName || "";
        }

        $("fWhat").value = it.what || "";
        $("fWhen").value = toInputDatetimeLocal(it.when);
        $("fRemind").value = String(Number(it.remindMin||0));
        $("fAfter").value = String(Number(it.afterMin||0));

        openModal();
        $("fWhat").focus();
      }

      // --------- Contactos modal ----------
      let editingContactId = null;

      function openContactModal(){
        $("cBackdrop").classList.add("show");
        $("cBackdrop").setAttribute("aria-hidden","false");
      }
      function closeContactModal(){
        $("cBackdrop").classList.remove("show");
        $("cBackdrop").setAttribute("aria-hidden","true");
      }
      function resetContactForm(){
        editingContactId = null;
        $("cModalTitle").textContent = "Nuevo contacto";
        $("cName").value = "";
        $("cNote").value = "";
      }

      function openContactEdit(id){
        const c = contacts.find(x => x.id === id);
        if(!c){ toast("Contacto no encontrado"); return; }
        editingContactId = id;
        $("cModalTitle").textContent = "Editar contacto";
        $("cName").value = c.name || "";
        $("cNote").value = c.note || "";
        openContactModal();
        $("cName").focus();
      }

      // --------- Contact select ----------
      function fillContactSelect(){
        const sel = $("fContact");
        const current = sel.value;
        sel.innerHTML = "";

        const optCustom = document.createElement("option");
        optCustom.value = "__custom__";
        optCustom.textContent = "‚úçÔ∏è Escribir un nombre (sin guardar)";
        sel.appendChild(optCustom);

        if(contacts.length){
          const sep = document.createElement("option");
          sep.disabled = true;
          sep.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
          sel.appendChild(sep);

          contacts
            .slice()
            .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
            .forEach(c => {
              const o = document.createElement("option");
              o.value = c.id;
              o.textContent = "üë§ " + (c.name || "Sin nombre");
              sel.appendChild(o);
            });
        }

        const optNew = document.createElement("option");
        optNew.value = "__new_contact__";
        optNew.textContent = "‚ûï Crear contacto‚Ä¶";
        sel.appendChild(optNew);

        if(current){
          sel.value = current;
          if(sel.value !== current) sel.value = "__custom__";
        } else {
          sel.value = "__custom__";
        }
      }

      function onContactSelectChanged(){
        const v = $("fContact").value;
        if(v === "__custom__"){
          toggleCustomWho(true);
          return;
        }
        if(v === "__new_contact__"){
          resetContactForm();
          openContactModal();
          $("cName").focus();
          $("fContact").value = "__custom__";
          toggleCustomWho(true);
          return;
        }
        toggleCustomWho(false);
        $("fWho").value = "";
      }

      // --------- Compromisos acciones ----------
      function createOrEditCommitment(){
        const contactSel = $("fContact").value;
        const what = $("fWhat").value.trim();
        const whenISO = $("fWhen").value ? new Date($("fWhen").value).toISOString() : null;
        const remindMin = Number($("fRemind").value || 0);

        const afterMin = Number($("fAfter").value || 0);
        const afterAt = afterMin > 0 ? new Date(Date.now() + afterMin*60*1000).toISOString() : null;

        if(!what){
          toast("Escribe qu√© se acord√≥");
          $("fWhat").focus();
          return null;
        }

        let whoId = null;
        let whoName = "";

        if(contactSel && contactSel !== "__custom__" && contactSel !== "__new_contact__"){
          const c = contactById(contactSel);
          if(!c){ toast("Contacto no v√°lido"); return null; }
          whoId = c.id;
          whoName = c.name || "Sin nombre";
        } else {
          whoName = $("fWho").value.trim();
          if(!whoName){
            toast("Pon con qui√©n es el compromiso");
            $("fWho").focus();
            return null;
          }
        }

        if(remindMin > 0 && !whenISO){
          toast("Para recordatorio por fecha necesitas fecha");
          $("fWhen").focus();
          return null;
        }

        const now = new Date().toISOString();

        if(!editingItemId){
          const itemId = uid();
          const ev = {
            id: uid(),
            type: T.CREATE,
            at: now,
            payload: {
              i: itemId,
              c: whoId || null,
              w: whoName,
              s: what,
              n: whenISO || null,
              r: remindMin || 0,
              af: afterMin || 0,
              aa: afterAt || null,
              ca: now
            }
          };
          const changed = applyEvent(ev);
          if(!changed){ toast("No se pudo guardar"); return null; }
          return { itemId, ev };
        } else {
          const it = data.find(x => x.id === editingItemId);
          if(!it){ toast("No encontrado"); return null; }

          const ev = {
            id: uid(),
            type: T.EDIT,
            at: now,
            payload: {
              i: editingItemId,
              c: whoId || null,
              w: whoName,
              s: what,
              n: whenISO || null,
              r: remindMin || 0,
              af: afterMin || 0,
              aa: afterAt || null
            }
          };

          const changed = applyEvent(ev);
          if(!changed){ toast("Sin cambios"); return null; }
          return { itemId: editingItemId, ev };
        }
      }

      async function markDone(itemId){
        const ev = makeEvent(T.DONE, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Marcado como hecho ‚úÖ");
          await prepareShare(ev, data.find(x => x.id === itemId));
        } else toast("Sin cambios");
      }

      async function reopen(itemId){
        const ev = makeEvent(T.REOPEN, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Reabierto");
          await prepareShare(ev, data.find(x => x.id === itemId));
        } else toast("Sin cambios");
      }

      async function deleteItem(itemId){
        const ok = await Confirm.open({
          title: "Eliminar compromiso",
          msg: `¬øSeguro que quieres eliminar este compromiso?<br><span class="dangerTxt">Esta acci√≥n no se puede deshacer.</span>`,
          yesText: "S√≠, eliminar",
          danger: true
        });
        if(!ok) return;

        const ev = makeEvent(T.DELETE, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Eliminado");
          await prepareShare(ev, { id:itemId, whoName:"(eliminado)", what:"", when:null, remindMin:0, afterMin:0, afterAt:null, done:false });
        } else {
          toast("Sin cambios");
        }
      }

      // üì¶ Compartir ‚Äúestado completo‚Äù
      async function shareSnapshot(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }

        const af = Number(it.afterMin || 0);
        const aa = af > 0 ? new Date(Date.now() + af*60*1000).toISOString() : null;

        const ev = {
          id: uid(),
          type: T.CREATE,
          at: new Date().toISOString(),
          payload: {
            i: it.id,
            c: it.whoId || null,
            w: normalizedWho(it),
            s: it.what || "",
            n: it.when || null,
            r: Number(it.remindMin || 0),
            af: af || 0,
            aa: aa,
            ca: it.createdAt || new Date().toISOString()
          }
        };
        await prepareShare(ev, it);
      }

      // --------- Contactos CRUD ----------
      function upsertContact(name, note){
        const n = String(name||"").trim();
        if(!n){ toast("Pon un nombre"); return null; }

        if(!editingContactId){
          const c = { id: uid(), name: n, note: String(note||"").trim(), createdAt: new Date().toISOString() };
          contacts.push(c);
          save(CONTACTS_KEY, contacts);
          return c;
        } else {
          const c = contacts.find(x => x.id === editingContactId);
          if(!c){ toast("No encontrado"); return null; }
          c.name = n;
          c.note = String(note||"").trim();
          c.updatedAt = new Date().toISOString();
          save(CONTACTS_KEY, contacts);
          save(KEY, data);
          return c;
        }
      }

      async function deleteContact(id){
        const ok = await Confirm.open({
          title: "Eliminar contacto",
          msg: `¬øEliminar este contacto?<br><span class="dangerTxt">Los compromisos quedar√°n con el nombre ‚Äúguardado‚Äù.</span>`,
          yesText: "S√≠, eliminar",
          danger: true
        });
        if(!ok) return;

        data.forEach(it => {
          if(it.whoId === id){
            it.whoName = normalizedWho(it);
            it.whoId = null;
          }
        });
        contacts = contacts.filter(x => x.id !== id);

        save(CONTACTS_KEY, contacts);
        save(KEY, data);

        renderAll();
        toast("Contacto eliminado");
      }

      // --------- Import desde URL (robusto con ‚Äúbuz√≥n‚Äù) ----------
      function parsePackageFromHash(){
        const h = location.hash || "";
        const m = h.match(/#p=([A-Za-z0-9\-_]+)/);
        return m ? m[1] : null;
      }

      function clearHashToBase(){
        try{
          history.replaceState(null, "", baseFileUrl());
        }catch(e){
          location.hash = "";
        }
      }

      // --------- PWA banner ----------
      const isAndroid = /Android/i.test(navigator.userAgent || "");
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const isIOSStandalone = !!navigator.standalone;
      const isInAppBrowser = (function(){
        const ua = (navigator.userAgent || "").toLowerCase();
        return ua.includes("wv") || ua.includes("webview") ||
               ua.includes("instagram") ||
               ua.includes("fbav") || ua.includes("fb_iab") ||
               ua.includes("telegram") ||
               ua.includes("whatsapp");
      })();

      let deferredPrompt = null;

      function showBanner(mode){
        const banner = $("installBanner");
        const title = $("installTitle");
        const text = $("installText");
        const bInstall = $("btnInstallBanner");
        const bOpen = $("btnOpenChrome");
        const bCopy = $("btnCopyLink");

        bInstall.style.display = "none";
        bOpen.style.display = "none";
        bCopy.style.display = "none";

        if(mode === "openchrome_import"){
          title.textContent = "Importaci√≥n pendiente";
          text.innerHTML = "Has abierto el enlace desde un navegador interno. <b>Abre en Chrome</b> para importar el compromiso en la app (y poder instalar).";
          bOpen.style.display = "flex";
          bCopy.style.display = "flex";
        } else if(mode === "openchrome"){
          title.textContent = "√Åbrelo en Chrome para instalarla";
          text.innerHTML = "Est√°s en un navegador interno (WhatsApp/Telegram). Para instalar, toca <b>Abrir en Chrome</b>.";
          bOpen.style.display = "flex";
          bCopy.style.display = "flex";
        } else if(mode === "install"){
          title.textContent = "Inst√°lala para usarla como app";
          text.innerHTML = "Pulsa <b>Instalar</b>. Luego se abrir√° como una app normal desde el icono.";
          bInstall.style.display = "flex";
        } else {
          title.textContent = "Consejo";
          text.innerHTML = "Si no ves ‚ÄúInstalar‚Äù en el men√∫, abre en <b>Chrome</b> o instala desde el men√∫ <b>‚ãÆ</b>.";
          bCopy.style.display = "flex";
          if(isInAppBrowser) bOpen.style.display = "flex";
        }

        banner.classList.add("show");
      }

      function hideBanner(){ $("installBanner").classList.remove("show"); }

      async function copyCurrentLink(){
        try{
          await navigator.clipboard.writeText(location.href);
          toast("Enlace copiado ‚úÖ");
        }catch(e){
          prompt("Copia este enlace:", location.href);
        }
      }

      function openInChrome(){
        const url = location.href;
        if(isAndroid){
          try{
            const u = new URL(url);
            const path = (u.pathname || "/") + (u.search || "") + (u.hash || "");
            const intent = "intent://" + u.host + path + "#Intent;scheme=https;package=com.android.chrome;end";
            location.href = intent;
            return;
          }catch(e){}
        }
        try{ window.open(url, "_blank"); }
        catch(e){ copyCurrentLink(); toast("Copia el enlace y p√©galo en Chrome"); }
      }

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        $("btnInstall").style.display = "flex";
      });

      $("btnInstall").addEventListener("click", async () => {
        if(!deferredPrompt){ showBanner(isInAppBrowser ? "openchrome" : "info"); return; }
        deferredPrompt.prompt();
        try{ await deferredPrompt.userChoice; }catch(e){}
        deferredPrompt = null;
        $("btnInstall").style.display = "none";
      });

      $("btnInstallBanner").addEventListener("click", async () => {
        if(!deferredPrompt){
          if(isInAppBrowser){ openInChrome(); return; }
          showBanner("info");
          return;
        }
        deferredPrompt.prompt();
        try{ await deferredPrompt.userChoice; }catch(e){}
        deferredPrompt = null;
        $("btnInstall").style.display = "none";
        hideBanner();
      });

      $("btnOpenChrome").addEventListener("click", openInChrome);
      $("btnCopyLink").addEventListener("click", copyCurrentLink);
      $("btnHideBanner").addEventListener("click", hideBanner);

      // --------- PIN overlay / teclado ----------
      let pinBuf = "";

      function setDots(n){
        $("d1").classList.toggle("on", n>=1);
        $("d2").classList.toggle("on", n>=2);
        $("d3").classList.toggle("on", n>=3);
        $("d4").classList.toggle("on", n>=4);
      }

      function showLockOverlay(){
        if(!settings.pinEnabled) return;
        pinBuf = "";
        setDots(0);
        $("lockOverlay").classList.add("show");
        $("lockOverlay").setAttribute("aria-hidden","false");
      }
      function hideLockOverlay(){
        $("lockOverlay").classList.remove("show");
        $("lockOverlay").setAttribute("aria-hidden","true");
      }

      async function tryUnlockWithPin(pin){
        const ok = await verifyPin(pin);
        if(ok){
          applyUnlock();
          hideLockOverlay();
          toast("Desbloqueado ‚úÖ");
        } else {
          pinBuf = "";
          setDots(0);
          toast("PIN incorrecto");
        }
      }

      $("keypad").addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        const k = btn.getAttribute("data-k");
        if(!k) return;

        if(k === "del"){
          pinBuf = pinBuf.slice(0, -1);
          setDots(pinBuf.length);
          return;
        }
        if(k === "ok"){
          if(pinBuf.length !== 4){ toast("Introduce 4 d√≠gitos"); return; }
          await tryUnlockWithPin(pinBuf);
          return;
        }
        if(/^\d$/.test(k)){
          if(pinBuf.length >= 4) return;
          pinBuf += k;
          setDots(pinBuf.length);
          if(pinBuf.length === 4){
            await tryUnlockWithPin(pinBuf);
          }
        }
      });

      $("btnLockCopyLink").addEventListener("click", copyCurrentLink);
      $("btnLockReset").addEventListener("click", async () => {
        const ok = await Confirm.open({
          title: "Borrar todo",
          msg: `Esto borrar√° <b>TODO</b> (compromisos, contactos y PIN).<br><span class="dangerTxt">No se puede deshacer.</span>`,
          yesText: "S√≠, borrar todo",
          danger: true
        });
        if(!ok) return;
        localStorage.clear();
        location.replace(baseFolderUrl() + "compromisos.html");
      });

      document.addEventListener("visibilitychange", () => {
        if(!settings.pinEnabled) return;
        if(document.visibilityState === "hidden"){
          const m = Number(settings.autoLockMin || 0);
          lockAtTs = (m === 0) ? Date.now() : (Date.now() + m*60*1000);
        } else {
          if(lockAtTs && Date.now() >= lockAtTs){
            forceLock();
          }
          lockAtTs = 0;
        }
      });

      // --------- Modal PIN config ----------
      let pinMode = "enable";
      function openPinModal(mode){
        pinMode = mode;
        $("pinBackdrop").classList.add("show");
        $("pinBackdrop").setAttribute("aria-hidden","false");

        $("pinOld").value = "";
        $("pinNew").value = "";
        $("pinNew2").value = "";

        if(mode === "enable"){
          $("pinTitle").textContent = "Activar PIN";
          $("pinHint").textContent = "Crea un PIN de 4 d√≠gitos para bloquear la app.";
          $("pinOldWrap").style.display = "none";
          $("pinNewWrap").style.display = "";
          $("pinNew2Wrap").style.display = "";
        } else if(mode === "change"){
          $("pinTitle").textContent = "Cambiar PIN";
          $("pinHint").textContent = "Introduce tu PIN actual y el nuevo PIN.";
          $("pinOldWrap").style.display = "";
          $("pinNewWrap").style.display = "";
          $("pinNew2Wrap").style.display = "";
        } else if(mode === "disable"){
          $("pinTitle").textContent = "Desactivar PIN";
          $("pinHint").textContent = "Introduce tu PIN actual para desactivarlo.";
          $("pinOldWrap").style.display = "";
          $("pinNewWrap").style.display = "none";
          $("pinNew2Wrap").style.display = "none";
        }

        setTimeout(()=> {
          const el = (mode === "enable") ? $("pinNew") : $("pinOld");
          try{ el.focus(); }catch(e){}
        }, 60);
      }
      function closePinModal(){
        $("pinBackdrop").classList.remove("show");
        $("pinBackdrop").setAttribute("aria-hidden","true");
      }

      function clampPinInput(el){
        el.value = normalizePin(el.value);
      }
      ["pinOld","pinNew","pinNew2"].forEach(id => {
        $(id).addEventListener("input", () => clampPinInput($(id)));
      });

      $("pinClose").addEventListener("click", closePinModal);
      $("pinCancel").addEventListener("click", closePinModal);
      $("pinBackdrop").addEventListener("click", (e)=>{ if(e.target === $("pinBackdrop")) closePinModal(); });

      $("pinOk").addEventListener("click", async () => {
        try{
          if(pinMode === "enable"){
            const p1 = normalizePin($("pinNew").value);
            const p2 = normalizePin($("pinNew2").value);
            if(p1.length !== 4) { toast("PIN inv√°lido"); return; }
            if(p1 !== p2) { toast("Los PIN no coinciden"); return; }
            await setPin(p1);
            settings.pinEnabled = true;
            settings.unlockUntil = 0;
            sessionUnlocked = false;
            save(SETTINGS_KEY, settings);
            updateSettingsUI();
            closePinModal();
            toast("PIN activado ‚úÖ");
            forceLock();
            return;
          }

          if(pinMode === "change"){
            const oldp = normalizePin($("pinOld").value);
            if(oldp.length !== 4) { toast("PIN actual inv√°lido"); return; }
            const ok = await verifyPin(oldp);
            if(!ok){ toast("PIN actual incorrecto"); return; }

            const p1 = normalizePin($("pinNew").value);
            const p2 = normalizePin($("pinNew2").value);
            if(p1.length !== 4) { toast("Nuevo PIN inv√°lido"); return; }
            if(p1 !== p2) { toast("Los PIN no coinciden"); return; }

            await setPin(p1);
            settings.pinEnabled = true;
            settings.unlockUntil = 0;
            sessionUnlocked = false;
            save(SETTINGS_KEY, settings);
            updateSettingsUI();
            closePinModal();
            toast("PIN cambiado ‚úÖ");
            forceLock();
            return;
          }

          if(pinMode === "disable"){
            const oldp = normalizePin($("pinOld").value);
            if(oldp.length !== 4) { toast("PIN inv√°lido"); return; }
            const ok = await verifyPin(oldp);
            if(!ok){ toast("PIN incorrecto"); return; }

            setPinEnabled(false);
            closePinModal();
            hideLockOverlay();
            toast("PIN desactivado");
            return;
          }
        }catch(e){
          toast("No se pudo aplicar el PIN");
        }
      });

      function toggleSwitchPin(){
        if(settings.pinEnabled){ openPinModal("disable"); }
        else { openPinModal("enable"); }
      }

      async function resetAll(){
        const ok = await Confirm.open({
          title: "Borrar todo",
          msg: `Esto borrar√° <b>TODO</b> (compromisos, contactos y ajustes).<br><span class="dangerTxt">No se puede deshacer.</span>`,
          yesText: "S√≠, borrar todo",
          danger: true
        });
        if(!ok) return;
        localStorage.clear();
        location.replace(baseFolderUrl() + "compromisos.html");
      }

      // --------- Notif switch ----------
      function toggleSwitchNotif(){
        if(!settings.notifEnabled){
          if(notifSupported() && notifPermission() !== "granted"){
            requestNotifPermission().then(ok => {
              if(ok) setNotifEnabled(true);
              else setNotifEnabled(false);
            });
          } else {
            setNotifEnabled(true);
          }
        } else {
          setNotifEnabled(false);
        }
      }

      // --------- Service worker ----------
      (async function registerSW(){
        if(!("serviceWorker" in navigator)) return;
        try{
          await navigator.serviceWorker.register("./sw.js", { scope: "./" });
        }catch(e){}
      })();

      // --------- Modal compartir handlers ----------
      $("shareClose").addEventListener("click", closeShareModal);
      $("shareCancel").addEventListener("click", closeShareModal);
      $("shareBackdrop").addEventListener("click", (e)=>{ if(e.target === $("shareBackdrop")) closeShareModal(); });

      $("shareShort").addEventListener("click", ()=>{ shareState.mode="short"; updateShareUI(); });
      $("shareLong").addEventListener("click", ()=>{ shareState.mode="long"; updateShareUI(); });

      $("shareCopyUrl").addEventListener("click", async ()=> {
        await copyToClipboard(shareState.url || "");
      });
      $("shareCopyAll").addEventListener("click", async ()=> {
        const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
        const combined = (shareState.title ? shareState.title + "\n" : "") + (msg ? msg + "\n" : "") + shareState.url;
        await copyToClipboard(combined);
      });

      $("shareSend").addEventListener("click", doShare);

      // --------- UI eventos ----------
      $("tabCommitments").addEventListener("click", ()=> setPane("commitments"));
      $("tabContacts").addEventListener("click", ()=> setPane("contacts"));
      $("tabSettings").addEventListener("click", ()=> setPane("settings"));

      $("tabPending").addEventListener("click", () => {
        view = "pending";
        $("tabPending").classList.add("active");
        $("tabDone").classList.remove("active");
        renderCommitments();
      });
      $("tabDone").addEventListener("click", () => {
        view = "done";
        $("tabDone").classList.add("active");
        $("tabPending").classList.remove("active");
        renderCommitments();
      });

      $("fab").addEventListener("click", () => {
        if(pane === "contacts"){
          resetContactForm();
          openContactModal();
          $("cName").focus();
          return;
        }
        resetCommitmentForm();
        openModal();
        $("fContact").focus();
      });

      $("btnClose").addEventListener("click", closeModal);
      $("btnCancel").addEventListener("click", closeModal);
      $("backdrop").addEventListener("click", (e)=>{ if(e.target === $("backdrop")) closeModal(); });

      $("fContact").addEventListener("change", onContactSelectChanged);

      $("btnSave").addEventListener("click", async () => {
        const res = createOrEditCommitment();
        if(!res) return;

        closeModal();
        renderAll();

        toast(editingItemId ? "Actualizado ‚úÖ" : "Guardado ‚úÖ");
        await prepareShare(res.ev, data.find(x => x.id === res.itemId));
      });

      // Contact modal
      $("cBtnClose").addEventListener("click", closeContactModal);
      $("cBtnCancel").addEventListener("click", closeContactModal);
      $("cBackdrop").addEventListener("click", (e)=>{ if(e.target === $("cBackdrop")) closeContactModal(); });

      $("cBtnSave").addEventListener("click", () => {
        const c = upsertContact($("cName").value, $("cNote").value);
        if(!c) return;

        closeContactModal();
        renderAll();
        toast("Contacto guardado ‚úÖ");

        // ‚úÖ Mejor UX: tras crear contacto, abrir directamente nuevo compromiso con √©l
        openNewCommitmentForContact(c.id);
      });

      // Ajustes
      $("swPin").addEventListener("click", toggleSwitchPin);
      $("swPin").addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggleSwitchPin(); } });

      $("swNotif").addEventListener("click", toggleSwitchNotif);
      $("swNotif").addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggleSwitchNotif(); } });

      $("btnNotifPerm").addEventListener("click", requestNotifPermission);

      $("selAutoLock").addEventListener("change", () => {
        settings.autoLockMin = Number($("selAutoLock").value || 0);
        save(SETTINGS_KEY, settings);
        toast("Auto-bloqueo actualizado");
      });
      $("selRemember").addEventListener("change", () => {
        settings.rememberMin = Number($("selRemember").value || 0);
        save(SETTINGS_KEY, settings);
        toast("Recordar desbloqueo actualizado");
      });

      $("btnChangePin").addEventListener("click", () => {
        if(!settings.pinEnabled){ toast("Activa primero el PIN"); return; }
        openPinModal("change");
      });

      $("btnLockNow").addEventListener("click", () => {
        if(!settings.pinEnabled){ toast("Activa el PIN para bloquear"); setPane("settings"); return; }
        forceLock();
      });

      $("btnResetAll").addEventListener("click", resetAll);

      // ‚úÖ Texto grande (ahora en hero, zona derecha)
      $("btnA11y").addEventListener("click", toggleTextScale);

      // ‚úÖ Manual plegable
      $("btnHelpToggle").addEventListener("click", toggleHelp);

      // ‚úÖ Pendientes: tocar para limpiar
      $("btnNotifPend").addEventListener("click", () => {
        if(Number(pendingNotifs?.c || 0) <= 0){
          toast("Sin pendientes");
          return;
        }
        clearPendingBadge();
      });

      // --------- Boot ----------
      // Aplica preferencia de accesibilidad
      const a11y = load(A11Y_KEY, { big:false });
      setTextScale(!!a11y.big);

      // Aplica preferencia del manual
      const helpPref = load(HELP_KEY, { show:false });
      setHelpVisible(!!helpPref.show);

      updateSettingsUI();
      renderAll();
      renderPendingBadge();

      // Import desde hash (si viene con #p=...)
      (function tryImportFromUrl(){
        const p = parsePackageFromHash();
        if(!p) return;

        if(isInAppBrowser){
          try{
            localStorage.setItem(INBOX_PACK_KEY, p);
            localStorage.setItem(INBOX_TS_KEY, String(Date.now()));
          }catch(e){}
          clearHashToBase();
          showBanner("openchrome_import");
          toast("Para importar: abre en Chrome");
          return;
        }

        try{
          const pack = parsePackage(p);
          const ev = unpackEvent(pack);
          if(!ev) throw new Error("bad");
          const applied = applyEvent(ev);
          renderAll();
          toast(applied ? "Paquete importado ‚úÖ" : "Paquete ya aplicado (o sin cambios)");
        }catch(e){
          toast("No se pudo importar el paquete");
        }

        clearHashToBase();
      })();

      // Import desde buz√≥n (si antes se abri√≥ desde WhatsApp)
      (function tryImportFromInbox(){
        if(isInAppBrowser) return;
        try{
          const p = localStorage.getItem(INBOX_PACK_KEY);
          if(!p) return;
          localStorage.removeItem(INBOX_PACK_KEY);
          localStorage.removeItem(INBOX_TS_KEY);

          toast("Importando paquete pendiente‚Ä¶");
          const pack = parsePackage(p);
          const ev = unpackEvent(pack);
          if(!ev) throw new Error("bad");
          const applied = applyEvent(ev);
          renderAll();
          toast(applied ? "Paquete importado ‚úÖ" : "Paquete ya aplicado (o sin cambios)");
        }catch(e){}
      })();

      cleanupFiredMaps();

      setTimeout(() => {
        if(isStandalone || isIOSStandalone) return;
        if(isInAppBrowser) showBanner("openchrome");
        else showBanner(deferredPrompt ? "install" : "info");
      }, 650);

      // Demo inicial
      if(data.length === 0){
        const now = new Date().toISOString();
        const ev = {
          id: uid(),
          type: T.CREATE,
          at: now,
          payload: {
            i: uid(),
            c: null,
            w: "Ejemplo: Laura",
            s: "Te paso el PDF del seguro",
            n: new Date(Date.now() + 3*60*60*1000).toISOString(),
            r: 15,
            af: 60,
            aa: new Date(Date.now() + 60*60*1000).toISOString(),
            ca: now
          }
        };
        applyEvent(ev);
        renderAll();
      }

      if(settings.pinEnabled && !isUnlockedNow()){
        showLockOverlay();
      }

      setInterval(() => {
        if(settings.pinEnabled && !isUnlockedNow()) return;
        checkReminders();
      }, 20000);

      setTimeout(() => {
        if(settings.pinEnabled && !isUnlockedNow()) return;
        checkReminders();
      }, 1200);

    })();
  </script>
</body>
</html>