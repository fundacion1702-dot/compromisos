<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compromisos</title>
  <meta name="theme-color" content="#6b5bff"/>
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#0b0c12;
      --surface:#121427;
      --surface2:#171a33;
      --text:#e9ecff;
      --muted:#aab0d6;
      --primary:#6b5bff;
      --primary2:#8a7dff;
      --good:#36d399;
      --bad:#ff5c7a;
      --warn:#ffcc66;
      --stroke:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px;

      /* textos un poco m√°s grandes */
      --fs-base: 16px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-size: var(--fs-base);
      font-family:
        system-ui, -apple-system, Segoe UI, Roboto, Arial,
        "Noto Color Emoji", "Segoe UI Emoji", "Apple Color Emoji",
        "Noto Emoji", sans-serif;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(107,91,255,.35), transparent 60%),
                  radial-gradient(800px 600px at 90% 0%, rgba(255,204,102,.15), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      padding-bottom:96px;
    }

    .wrap{ max-width:560px; margin:0 auto; padding:16px 14px 0; }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:6px;
    }

    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }

    .logo{
      width:44px;height:44px;border-radius:15px; display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.70));
      box-shadow: 0 12px 30px rgba(107,91,255,.25);
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto; font-weight:950; letter-spacing:.5px;
      font-size: 18px;
    }

    .brand h1{
      margin:0; font-size:20px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0; font-size:13.5px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .iconbtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      transition: transform .08s ease, background .15s ease;
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      font-size: 14px;
    }
    .iconbtn:active{ transform: scale(.98); }
    .iconbtn small{ color:var(--muted); font-weight:800; font-size: 12.5px; }

    .hero{
      margin-top: 14px;
      padding: 14px;
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    .hero .row{ display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(107,91,255,.14);
      color: var(--text);
      font-size: 13px;
      font-weight: 850;
      white-space:nowrap;
    }
    .hero h2{ margin: 10px 0 6px; font-size: 18px; line-height:1.25; }
    .hero p{ margin: 0; color: var(--muted); font-size: 15px; line-height:1.4; }

    .banner{
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      display:none;
    }
    .banner.show{ display:block; }
    .banner .title{ font-weight:950; margin:0 0 6px; font-size: 16px; }
    .banner .txt{ margin:0; color:var(--muted); font-size:14.5px; line-height:1.35; }
    .banner .row{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }

    .btn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 11px 12px;
      cursor:pointer;
      font-weight: 950;
      font-size: 15px;
      transition: transform .08s ease, background .15s ease;
      display:flex; align-items:center; justify-content:center; gap:8px;
      flex:1;
    }
    .btn:active{ transform: scale(.99); }

    .btn.primary{
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55));
      border-color: rgba(255,255,255,.16);
    }
    .btn.good{
      background: linear-gradient(135deg, rgba(54,211,153,.95), rgba(54,211,153,.55));
      border-color: rgba(255,255,255,.16);
      color:#06150f;
    }
    .btn.danger{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.35);
    }

    .tabs{
      margin-top: 14px;
      display:flex; gap:10px; padding: 6px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: 0 10px 25px rgba(0,0,0,.15);
    }
    .tab{
      flex:1;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 11px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      font-size: 15px;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .tab.active{
      color: var(--text);
      background: linear-gradient(135deg, rgba(107,91,255,.85), rgba(138,125,255,.55));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 12px 30px rgba(107,91,255,.22);
    }
    .badge{
      display:inline-grid; place-items:center;
      min-width: 24px;
      padding: 2px 9px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 950;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }

    .subtabs{
      margin-top: 12px;
      display:flex; gap:10px; padding: 6px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
    }
    .subtab{
      flex:1;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      font-size: 14.5px;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .subtab.active{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
    }

    .list{ margin-top: 14px; display:flex; flex-direction:column; gap: 10px; }

    .card{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      padding: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .cardTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .who{ min-width:0; }
    .who .name{
      margin:0; font-size: 16px; font-weight: 950; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .who .meta{
      margin: 4px 0 0; font-size: 13px; color: var(--muted);
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 9px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 850;
      font-size: 12.5px;
    }
    .due{
      font-size: 13.5px;
      font-weight: 950;
      padding: 7px 11px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,204,102,.12);
      color: var(--text);
      white-space:nowrap;
    }
    .due.bad{ background: rgba(255,92,122,.14); }

    .desc{
      margin: 10px 0 0;
      font-size: 15px;
      line-height:1.35;
      color: var(--text);
      opacity: .95;
      word-break: break-word;
    }

    .actions{ margin-top: 10px; display:flex; gap: 10px; flex-wrap:wrap; }
    .actions .btn{ flex: 1; min-width: 120px; }
    .actions .btn.icon{ flex: 0 0 auto; min-width: 58px; }

    .empty{
      padding: 18px 14px;
      border-radius: var(--r);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      text-align:center;
      line-height:1.35;
      display:none;
      font-size: 15px;
    }

    .fab{
      position: fixed;
      right: 16px;
      bottom: 18px;
      width: 62px;
      height: 62px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55));
      box-shadow: 0 18px 45px rgba(107,91,255,.25), 0 14px 40px rgba(0,0,0,.35);
      color: white;
      font-size: 30px;
      font-weight: 950;
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      z-index: 50;
    }
    .fab:active{ transform: scale(.98); }

    /* Modal / Bottom Sheet */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 999;
    }
    .backdrop.show{ display:flex; }

    .sheet{
      width: min(560px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(23,26,51,.98), rgba(18,20,39,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }

    .sheetHead{
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .sheetHead h3{ margin:0; font-size: 17px; font-weight: 950; letter-spacing:.2px; }

    .close{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 9px 11px;
      cursor:pointer;
      font-weight: 950;
      font-size: 14px;
    }

    .sheetBody{ padding: 14px; display:flex; flex-direction:column; gap: 10px; }

    .field label{
      display:block;
      font-size: 13.5px;
      font-weight: 950;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select{
      width: 100%;
      padding: 13px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    .field textarea{ min-height: 92px; resize: vertical; }

    .hint{
      font-size: 13.5px;
      color: var(--muted);
      margin-top: 6px;
      line-height:1.35;
    }

    .sheetFoot{ padding: 12px 14px 14px; display:flex; gap: 10px; flex-wrap:wrap; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 90px;
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      font-weight: 850;
      font-size: 14px;
      display:none;
      z-index: 1000;
      max-width: calc(100% - 28px);
      text-align:center;
    }
    .toast.show{ display:block; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      color:var(--muted);
      word-break: break-all;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:10px;
      border-radius:14px;
      margin-top:10px;
      display:none;
    }
    .mono.show{ display:block; }

    .kicker{
      font-size: 13px;
      color: var(--muted);
      margin: 10px 0 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">C</div>
        <div style="min-width:0">
          <h1>Compromisos</h1>
          <p>Paquetes entre m√≥viles ¬∑ sin base de datos</p>
        </div>
      </div>

      <button class="iconbtn" id="btnInstall" style="display:none">‚¨áÔ∏è <small>Instalar</small></button>
    </header>

    <section class="hero">
      <div class="row">
        <div class="pill">üë• Contactos</div>
        <div class="pill">üì¶ Paquetes</div>
        <div class="pill">‚úçÔ∏è Editar</div>
      </div>
      <h2>Comparte cambios como un enlace (sin cuentas).</h2>
      <p>El mensaje puede decir ‚ÄúNuevo compromiso / Compromiso finalizado‚Äù y luego llevar el enlace. El enlace ahora es m√°s corto y los cambios pueden ser CREATE/DONE/EDIT/‚Ä¶</p>
      <div class="mono" id="lastLink"></div>
      <div class="kicker" id="statsKicker" style="display:none"></div>
    </section>

    <!-- Banner inteligente (instalar / abrir en Chrome) -->
    <section class="banner" id="installBanner">
      <p class="title" id="installTitle">Inst√°lala para usarla como app</p>
      <p class="txt" id="installText">
        Si la abres dentro de WhatsApp/Telegram, toca <b>Abrir en Chrome</b> para poder instalar.
      </p>
      <div class="row">
        <button class="btn primary" id="btnInstallBanner" style="display:none">‚¨áÔ∏è Instalar</button>
        <button class="btn primary" id="btnOpenChrome" style="display:none">üåê Abrir en Chrome</button>
        <button class="btn" id="btnCopyLink" style="display:none">üìã Copiar enlace</button>
        <button class="btn" id="btnHideBanner">Ocultar</button>
      </div>
    </section>

    <!-- Vista principal -->
    <nav class="tabs" aria-label="Vistas">
      <button class="tab active" id="tabCommitments">üìù Compromisos</button>
      <button class="tab" id="tabContacts">üë• Amigos <span class="badge" id="bContacts">0</span></button>
    </nav>

    <!-- Subtabs compromisos -->
    <div id="commitmentsPane">
      <nav class="subtabs" aria-label="Pesta√±as">
        <button class="subtab active" id="tabPending">Pendientes <span class="badge" id="bPending">0</span></button>
        <button class="subtab" id="tabDone">Hechos <span class="badge" id="bDone">0</span></button>
      </nav>

      <div class="list" id="list"></div>
      <div class="empty" id="empty">No tienes compromisos aqu√≠. Pulsa <b>+</b> para crear uno nuevo.</div>
    </div>

    <!-- Contactos -->
    <div id="contactsPane" style="display:none">
      <div class="list" id="contactsList"></div>
      <div class="empty" id="contactsEmpty">No tienes contactos a√∫n. Pulsa <b>+</b> para crear el primero.</div>
    </div>
  </div>

  <button class="fab" id="fab" aria-label="Nuevo">+</button>

  <!-- Modal Compromiso (nuevo/editar) -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="modalTitle">Nuevo compromiso</h3>
        <button class="close" id="btnClose">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="field">
          <label for="fContact">¬øCon qui√©n?</label>
          <select id="fContact"></select>
          <div class="hint" id="contactHint">Puedes elegir un contacto o escribir uno nuevo.</div>
        </div>

        <div class="field" id="customWhoField" style="display:none">
          <label for="fWho">Nombre (nuevo contacto)</label>
          <input id="fWho" type="text" placeholder="Ej: Laura / Mam√° / Juan (del trabajo)" autocomplete="off"/>
        </div>

        <div class="field">
          <label for="fWhat">¬øQu√© se acord√≥?</label>
          <textarea id="fWhat" placeholder="Ej: Te paso el PDF / Te devuelvo 20‚Ç¨ / Quedamos el jueves‚Ä¶"></textarea>
        </div>

        <div class="field">
          <label for="fWhen">¬øPara cu√°ndo?</label>
          <input id="fWhen" type="datetime-local" />
          <div class="hint">Puedes dejarlo sin fecha.</div>
        </div>

        <div class="hint">
          Al guardar, podr√°s <b>Compartir</b> el cambio (nuevo / editado / finalizado‚Ä¶).
        </div>
      </div>

      <div class="sheetFoot">
        <button class="btn danger" id="btnCancel">Cancelar</button>
        <button class="btn good" id="btnSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Contacto (nuevo/editar) -->
  <div class="backdrop" id="cBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="cModalTitle">Nuevo contacto</h3>
        <button class="close" id="cBtnClose">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="field">
          <label for="cName">Nombre</label>
          <input id="cName" type="text" placeholder="Ej: Laura" autocomplete="off"/>
        </div>
        <div class="field">
          <label for="cNote">Nota (opcional)</label>
          <input id="cNote" type="text" placeholder="Ej: Trabajo / Vecina / Familia" autocomplete="off"/>
        </div>
        <div class="hint">Esto solo se guarda en tu m√≥vil.</div>
      </div>

      <div class="sheetFoot">
        <button class="btn danger" id="cBtnCancel">Cancelar</button>
        <button class="btn good" id="cBtnSave">Guardar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    (function(){
      "use strict";

      const $ = (id) => document.getElementById(id);

      const KEY = "compromisos_local_v3";
      const EVENTS_KEY = "compromisos_events_v3";
      const CONTACTS_KEY = "compromisos_contacts_v3";

      // Tipos num√©ricos para acortar paquetes
      const T = { CREATE:0, DONE:1, REOPEN:2, DELETE:3, EDIT:4 };

      function uid(){
        return "c" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function pad2(n){ return String(n).padStart(2,"0"); }

      function fmtDate(dt){
        if(!dt) return "Sin fecha";
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return "Sin fecha";
        const now = new Date();
        const sameYear = d.getFullYear() === now.getFullYear();
        const day = pad2(d.getDate());
        const mon = pad2(d.getMonth()+1);
        const hh = pad2(d.getHours());
        const mm = pad2(d.getMinutes());
        return (sameYear ? `${day}/${mon}` : `${day}/${mon}/${d.getFullYear()}`) + ` ${hh}:${mm}`;
      }
      function isOverdue(dt){
        if(!dt) return false;
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return false;
        return d.getTime() < Date.now();
      }

      function toast(msg){
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(()=> t.classList.remove("show"), 2400);
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // Base64URL (utf8-safe)
      function b64urlEncode(str){
        const b64 = btoa(unescape(encodeURIComponent(str)));
        return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
      }
      function b64urlDecode(b64url){
        let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
        while(b64.length % 4) b64 += "=";
        return decodeURIComponent(escape(atob(b64)));
      }

      function load(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          const v = JSON.parse(raw);
          return v ?? fallback;
        }catch(e){ return fallback; }
      }
      function save(key, value){
        localStorage.setItem(key, JSON.stringify(value));
      }

      let data = load(KEY, []);
      let events = load(EVENTS_KEY, []);
      let contacts = load(CONTACTS_KEY, []);

      // migraci√≥n desde v2 si existe (b√°sica)
      (function migrateIfNeeded(){
        const old = localStorage.getItem("compromisos_local_v2");
        if(old && (!data || data.length===0)){
          try{
            const arr = JSON.parse(old);
            if(Array.isArray(arr) && arr.length){
              data = arr.map(x => ({
                id: x.id || uid(),
                whoId: null,
                whoName: x.who || "Sin nombre",
                what: x.what || "",
                when: x.when || null,
                done: !!x.done,
                createdAt: x.createdAt || new Date().toISOString(),
                doneAt: x.doneAt || null,
                updatedAt: x.updatedAt || null
              }));
              save(KEY, data);
            }
          }catch(e){}
        }
      })();

      let view = "pending";
      let pane = "commitments"; // commitments | contacts

      function contactById(id){ return contacts.find(c => c.id === id) || null; }

      function normalizedWho(item){
        if(item.whoId){
          const c = contactById(item.whoId);
          if(c && c.name) return c.name;
        }
        return item.whoName || "Sin nombre";
      }

      // Eventos internos (completos) + paquetes cortos para compartir
      function makeEvent(type, payload){
        return { id: uid(), type, at: new Date().toISOString(), payload };
      }

      function applyEvent(ev){
        if(!ev || ev.type == null) return false;
        if(events.some(x => x.id === ev.id)) return false; // evitar duplicados

        let changed = false;

        if(ev.type === T.CREATE){
          const p = ev.payload || {};
          const itemId = p.i || uid();
          if(!data.some(x => x.id === itemId)){
            data.push({
              id: itemId,
              whoId: p.c || null,
              whoName: p.w || "Sin nombre",
              what: p.s || "",
              when: p.n || null,
              done: false,
              createdAt: p.ca || ev.at,
              doneAt: null,
              updatedAt: null
            });
            changed = true;
          }
        }
        else if(ev.type === T.DONE){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it && !it.done){
            it.done = true;
            it.doneAt = ev.at;
            it.updatedAt = ev.at;
            changed = true;
          }
        }
        else if(ev.type === T.REOPEN){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it && it.done){
            it.done = false;
            it.doneAt = null;
            it.updatedAt = ev.at;
            changed = true;
          }
        }
        else if(ev.type === T.DELETE){
          const p = ev.payload || {};
          const before = data.length;
          data = data.filter(x => x.id !== p.i);
          changed = (data.length !== before);
        }
        else if(ev.type === T.EDIT){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it){
            // solo aplicar si viene algo
            const before = JSON.stringify(it);
            if(p.w != null) it.whoName = p.w;
            if(p.c != null) it.whoId = p.c || null;
            if(p.s != null) it.what = p.s;
            if(p.n != null) it.when = p.n || null;
            it.updatedAt = ev.at;
            changed = (JSON.stringify(it) !== before);
          }
        }

        events.push(ev);
        save(EVENTS_KEY, events);
        save(KEY, data);
        return changed;
      }

      // Paquete compacto:
      // { v:1, e:{ i:<eventId>, t:<typeNum>, a:<iso>, p:{...payloadShort} } }
      function packEvent(ev){
        return { v:1, e:{ i: ev.id, t: ev.type, a: ev.at, p: ev.payload || {} } };
      }
      function unpackEvent(pack){
        if(!pack || pack.v !== 1 || !pack.e) return null;
        const e = pack.e;
        if(!e.i || e.t == null || !e.a) return null;
        return { id: e.i, type: e.t, at: e.a, payload: e.p || {} };
      }
      function makePackage(ev){
        return b64urlEncode(JSON.stringify(packEvent(ev)));
      }
      function parsePackage(p){
        const json = b64urlDecode(p);
        return JSON.parse(json);
      }
      function makeLinkFromPackage(p){
        return location.origin + location.pathname + "#p=" + p;
      }

      function shortPreview(text, n){
        const s = String(text||"").trim();
        if(s.length <= n) return s;
        return s.slice(0, n-1) + "‚Ä¶";
      }

      async function sharePretty({title, text, url}){
        try{
          if(navigator.share){
            await navigator.share({ title, text, url });
            return true;
          }
        }catch(e){}

        // fallback: copiamos un texto bonito
        const full = (title ? (title + "\n") : "") + (text ? (text + "\n") : "") + url;
        try{
          await navigator.clipboard.writeText(full);
          toast("Mensaje copiado ‚úÖ");
          return true;
        }catch(e){
          prompt("Copia este mensaje:", full);
          return true;
        }
      }

      // UI: tabs
      function setPane(newPane){
        pane = newPane;
        $("tabCommitments").classList.toggle("active", pane==="commitments");
        $("tabContacts").classList.toggle("active", pane==="contacts");
        $("commitmentsPane").style.display = (pane==="commitments") ? "" : "none";
        $("contactsPane").style.display = (pane==="contacts") ? "" : "none";

        // FAB cambia seg√∫n vista
        $("fab").setAttribute("aria-label", pane==="contacts" ? "Nuevo contacto" : "Nuevo compromiso");
        renderAll();
      }

      // Render compromisos
      function renderCommitments(){
        const list = $("list");
        list.innerHTML = "";

        const pending = data.filter(x => !x.done);
        const done = data.filter(x => x.done);

        $("bPending").textContent = String(pending.length);
        $("bDone").textContent = String(done.length);
        $("bContacts").textContent = String(contacts.length);

        const items = (view === "pending") ? pending : done;

        $("empty").style.display = items.length ? "none" : "block";

        items
          .sort((a,b) => {
            const ta = a.when ? new Date(a.when).getTime() : (view==="pending" ? Number.POSITIVE_INFINITY : 0);
            const tb = b.when ? new Date(b.when).getTime() : (view==="pending" ? Number.POSITIVE_INFINITY : 0);
            if(view === "pending") return ta - tb;
            return (new Date(b.doneAt||0).getTime()) - (new Date(a.doneAt||0).getTime());
          })
          .forEach(item => list.appendChild(renderCard(item)));

        // kicker
        const k = $("statsKicker");
        const overdue = pending.filter(x => isOverdue(x.when)).length;
        k.style.display = "block";
        k.textContent = overdue ? `‚è∞ Tienes ${overdue} compromiso(s) vencido(s).` : `‚úÖ Todo en orden.`;
      }

      function renderCard(item){
        const card = document.createElement("div");
        card.className = "card";

        const who = normalizedWho(item);
        const dueText = item.when ? fmtDate(item.when) : "Sin fecha";
        const overdue = !item.done && isOverdue(item.when);
        const dueClass = overdue ? "due bad" : "due";

        const meta = [
          `<span class="chip">üìù ${escapeHtml(fmtDate(item.createdAt))}</span>`,
          item.updatedAt ? `<span class="chip">‚úçÔ∏è ${escapeHtml(fmtDate(item.updatedAt))}</span>` : "",
          item.done ? `<span class="chip">‚úÖ ${escapeHtml(fmtDate(item.doneAt))}</span>` : ""
        ].filter(Boolean).join("");

        card.innerHTML = `
          <div class="cardTop">
            <div class="who">
              <p class="name">${escapeHtml(who)}</p>
              <p class="meta">${meta}</p>
            </div>
            <div class="${dueClass}">‚è∞ ${escapeHtml(dueText)}${overdue ? " ¬∑ Vencido" : ""}</div>
          </div>
          <div class="desc">${escapeHtml(item.what || "‚Äî")}</div>
          <div class="actions"></div>
        `;

        const actions = card.querySelector(".actions");

        if(!item.done){
          actions.appendChild(mkBtn("‚úÖ Hecho", "btn good", () => markDone(item.id)));
          actions.appendChild(mkBtn("üì¶ Compartir", "btn primary", () => shareEventForItem("CREATE_OR_EDIT", item.id)));
          actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openEditModal(item.id)));
          actions.appendChild(mkBtn("üóëÔ∏è", "btn danger icon", () => deleteItem(item.id), true));
        }else{
          actions.appendChild(mkBtn("‚Ü©Ô∏è Reabrir", "btn", () => reopen(item.id)));
          actions.appendChild(mkBtn("üì¶ Compartir", "btn primary", () => shareEventForItem("DONE_STATE", item.id)));
          actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openEditModal(item.id)));
          actions.appendChild(mkBtn("üóëÔ∏è", "btn danger icon", () => deleteItem(item.id), true));
        }

        return card;
      }

      function mkBtn(text, cls, onClick, small){
        const b = document.createElement("button");
        b.className = cls;
        b.textContent = text;
        if(small){ b.classList.add("icon"); }
        b.addEventListener("click", onClick);
        return b;
      }

      // Render contactos
      function renderContacts(){
        const list = $("contactsList");
        list.innerHTML = "";

        $("bContacts").textContent = String(contacts.length);

        $("contactsEmpty").style.display = contacts.length ? "none" : "block";

        contacts
          .slice()
          .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
          .forEach(c => list.appendChild(renderContactCard(c)));
      }

      function renderContactCard(c){
        const card = document.createElement("div");
        card.className = "card";
        const note = c.note ? `<span class="chip">üõà ${escapeHtml(c.note)}</span>` : "";
        card.innerHTML = `
          <div class="cardTop">
            <div class="who">
              <p class="name">${escapeHtml(c.name || "Sin nombre")}</p>
              <p class="meta">
                <span class="chip">üë• Contacto</span>
                ${note}
              </p>
            </div>
            <div class="due">‚≠ê</div>
          </div>
          <div class="desc">${escapeHtml(c.note || "‚Äî")}</div>
          <div class="actions"></div>
        `;
        const actions = card.querySelector(".actions");
        actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openContactEdit(c.id)));
        actions.appendChild(mkBtn("üóëÔ∏è", "btn danger", () => deleteContact(c.id)));
        return card;
      }

      function renderAll(){
        renderCommitments();
        renderContacts();
        fillContactSelect();
      }

      // --------- Modal Compromiso (nuevo/editar) ----------
      let editingItemId = null;

      function openModal(){
        $("backdrop").classList.add("show");
        $("backdrop").setAttribute("aria-hidden","false");
      }
      function closeModal(){
        $("backdrop").classList.remove("show");
        $("backdrop").setAttribute("aria-hidden","true");
      }

      function resetCommitmentForm(){
        editingItemId = null;
        $("modalTitle").textContent = "Nuevo compromiso";
        $("fWhat").value = "";
        $("fWhen").value = "";
        $("fWho").value = "";
        // select por defecto
        fillContactSelect();
        $("fContact").value = "__custom__";
        toggleCustomWho(true);
      }

      function toggleCustomWho(show){
        $("customWhoField").style.display = show ? "" : "none";
      }

      function toInputDatetimeLocal(iso){
        if(!iso) return "";
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return "";
        // YYYY-MM-DDTHH:MM
        const yyyy = d.getFullYear();
        const mm = pad2(d.getMonth()+1);
        const dd = pad2(d.getDate());
        const hh = pad2(d.getHours());
        const mi = pad2(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }

      function openEditModal(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }

        editingItemId = itemId;
        $("modalTitle").textContent = "Editar compromiso";

        // Contacto
        fillContactSelect();
        if(it.whoId && contactById(it.whoId)){
          $("fContact").value = it.whoId;
          toggleCustomWho(false);
          $("fWho").value = "";
        } else {
          $("fContact").value = "__custom__";
          toggleCustomWho(true);
          $("fWho").value = it.whoName || "";
        }

        $("fWhat").value = it.what || "";
        $("fWhen").value = toInputDatetimeLocal(it.when);

        openModal();
        $("fWhat").focus();
      }

      // --------- Modal Contacto ----------
      let editingContactId = null;

      function openContactModal(){
        $("cBackdrop").classList.add("show");
        $("cBackdrop").setAttribute("aria-hidden","false");
      }
      function closeContactModal(){
        $("cBackdrop").classList.remove("show");
        $("cBackdrop").setAttribute("aria-hidden","true");
      }
      function resetContactForm(){
        editingContactId = null;
        $("cModalTitle").textContent = "Nuevo contacto";
        $("cName").value = "";
        $("cNote").value = "";
      }

      function openContactEdit(id){
        const c = contacts.find(x => x.id === id);
        if(!c){ toast("Contacto no encontrado"); return; }
        editingContactId = id;
        $("cModalTitle").textContent = "Editar contacto";
        $("cName").value = c.name || "";
        $("cNote").value = c.note || "";
        openContactModal();
        $("cName").focus();
      }

      // --------- Contact select ----------
      function fillContactSelect(){
        const sel = $("fContact");
        const current = sel.value;
        sel.innerHTML = "";

        const optCustom = document.createElement("option");
        optCustom.value = "__custom__";
        optCustom.textContent = "‚úçÔ∏è Escribir un nombre (sin guardar)";
        sel.appendChild(optCustom);

        if(contacts.length){
          const sep = document.createElement("option");
          sep.disabled = true;
          sep.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
          sel.appendChild(sep);

          contacts
            .slice()
            .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
            .forEach(c => {
              const o = document.createElement("option");
              o.value = c.id;
              o.textContent = "üë§ " + (c.name || "Sin nombre");
              sel.appendChild(o);
            });
        }

        const optNew = document.createElement("option");
        optNew.value = "__new_contact__";
        optNew.textContent = "‚ûï Crear contacto‚Ä¶";
        sel.appendChild(optNew);

        // restablecer selecci√≥n si sigue existiendo
        if(current){
          sel.value = current;
          if(sel.value !== current){
            sel.value = "__custom__";
          }
        } else {
          sel.value = "__custom__";
        }
      }

      function onContactSelectChanged(){
        const v = $("fContact").value;
        if(v === "__custom__"){
          toggleCustomWho(true);
          return;
        }
        if(v === "__new_contact__"){
          // abrir modal contacto, y al guardar lo seleccionamos
          resetContactForm();
          openContactModal();
          $("cName").focus();
          // volvemos a custom temporalmente para evitar estado raro
          $("fContact").value = "__custom__";
          toggleCustomWho(true);
          return;
        }
        // es un contacto
        toggleCustomWho(false);
        $("fWho").value = "";
      }

      // --------- Acciones compromisos ----------
      function createOrEditCommitment(){
        const contactSel = $("fContact").value;
        const what = $("fWhat").value.trim();
        const whenISO = $("fWhen").value ? new Date($("fWhen").value).toISOString() : null;

        if(!what){
          toast("Escribe qu√© se acord√≥");
          $("fWhat").focus();
          return null;
        }

        let whoId = null;
        let whoName = "";

        if(contactSel && contactSel !== "__custom__" && contactSel !== "__new_contact__"){
          const c = contactById(contactSel);
          if(!c){
            toast("Contacto no v√°lido");
            return null;
          }
          whoId = c.id;
          whoName = c.name || "Sin nombre";
        } else {
          whoName = $("fWho").value.trim();
          if(!whoName){
            toast("Pon con qui√©n es el compromiso");
            $("fWho").focus();
            return null;
          }
        }

        const now = new Date().toISOString();

        if(!editingItemId){
          // CREATE
          const itemId = uid();
          const ev = {
            id: uid(),
            type: T.CREATE,
            at: now,
            payload: {
              i: itemId,
              c: whoId || null,
              w: whoName,
              s: what,
              n: whenISO || null,
              ca: now
            }
          };
          const changed = applyEvent(ev);
          if(!changed){
            toast("No se pudo guardar");
            return null;
          }
          return { itemId, ev };
        } else {
          // EDIT
          const it = data.find(x => x.id === editingItemId);
          if(!it){ toast("No encontrado"); return null; }

          const ev = {
            id: uid(),
            type: T.EDIT,
            at: now,
            payload: {
              i: editingItemId,
              c: whoId || null,
              w: whoName,
              s: what,
              n: whenISO || null
            }
          };

          const changed = applyEvent(ev);
          if(!changed){
            toast("Sin cambios");
            return null;
          }
          return { itemId: editingItemId, ev };
        }
      }

      function markDone(itemId){
        const ev = makeEvent(T.DONE, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Marcado como hecho ‚úÖ");
          shareEvent(ev, "Compromiso finalizado");
        }else toast("Sin cambios");
      }

      function reopen(itemId){
        const ev = makeEvent(T.REOPEN, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Reabierto");
          shareEvent(ev, "Compromiso reabierto");
        }else toast("Sin cambios");
      }

      function deleteItem(itemId){
        const ev = makeEvent(T.DELETE, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Eliminado");
          // compartir borrado solo si quieres; por defecto no.
        }else toast("Sin cambios");
      }

      // Decide qu√© evento compartir desde un item
      async function shareEventForItem(kind, itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }

        if(kind === "DONE_STATE"){
          const title = it.done ? "Compromiso finalizado" : "Compromiso reabierto";
          // creamos un evento m√≠nimo del estado actual para compartir
          const ev = it.done ? makeEvent(T.DONE, { i: itemId }) : makeEvent(T.REOPEN, { i: itemId });
          await shareEvent(ev, title, it);
          return;
        }

        // CREATE_OR_EDIT: comparte el estado completo (lo m√°s √∫til)
        const title = it.updatedAt ? "Compromiso actualizado" : "Nuevo compromiso";
        const ev = {
          id: uid(),
          type: T.CREATE, // enviamos CREATE completo como snapshot (para importar aunque no lo tengan)
          at: new Date().toISOString(),
          payload: {
            i: it.id,
            c: it.whoId || null,
            w: normalizedWho(it),
            s: it.what || "",
            n: it.when || null,
            ca: it.createdAt || new Date().toISOString()
          }
        };
        await shareEvent(ev, title, it);
      }

      async function shareEvent(ev, title, itemOverride){
        const p = makePackage(ev);
        const link = makeLinkFromPackage(p);

        $("lastLink").textContent = "√öltimo enlace:\n" + link;
        $("lastLink").classList.add("show");

        const it = itemOverride || (ev.payload && ev.payload.i ? data.find(x => x.id === ev.payload.i) : null);
        const who = it ? normalizedWho(it) : "";
        const what = it ? shortPreview(it.what, 80) : "";

        // Mensaje ‚Äúbonito‚Äù: esto es lo que ver√°n en WhatsApp/Telegram como texto
        const text =
          (who ? `üë§ ${who}\n` : "") +
          (what ? `üìù ${what}\n` : "") +
          `üîó Abre para importar en la app.`;

        await sharePretty({ title, text, url: link });
      }

      // --------- Contactos ----------
      function upsertContact(name, note){
        const n = String(name||"").trim();
        if(!n){ toast("Pon un nombre"); return null; }

        if(!editingContactId){
          const c = { id: uid(), name: n, note: String(note||"").trim(), createdAt: new Date().toISOString() };
          contacts.push(c);
          save(CONTACTS_KEY, contacts);
          return c;
        } else {
          const c = contacts.find(x => x.id === editingContactId);
          if(!c){ toast("No encontrado"); return null; }
          c.name = n;
          c.note = String(note||"").trim();
          c.updatedAt = new Date().toISOString();
          save(CONTACTS_KEY, contacts);

          // actualizar compromisos que usan ese contacto (solo visual; id permanece)
          save(KEY, data);
          return c;
        }
      }

      function deleteContact(id){
        const c = contacts.find(x => x.id === id);
        if(!c){ toast("No encontrado"); return; }

        // si est√° en uso, lo dejamos pero ‚Äúdesvinculamos‚Äù (para no romper nombres)
        data.forEach(it => {
          if(it.whoId === id){
            it.whoName = normalizedWho(it);
            it.whoId = null;
          }
        });
        contacts = contacts.filter(x => x.id !== id);

        save(CONTACTS_KEY, contacts);
        save(KEY, data);

        renderAll();
        toast("Contacto eliminado");
      }

      // --------- Import desde URL ----------
      function tryImportFromUrl(){
        const h = location.hash || "";
        const m = h.match(/#p=([A-Za-z0-9\-_]+)/);
        if(!m) return false;

        const p = m[1];
        try{
          const pack = parsePackage(p);
          const ev = unpackEvent(pack);
          if(!ev) throw new Error("Paquete inv√°lido");

          const applied = applyEvent(ev);
          renderAll();

          // limpiar hash (solo https)
          history.replaceState(null, "", location.origin + location.pathname);

          toast(applied ? "Paquete importado ‚úÖ" : "Paquete ya aplicado (o sin cambios)");
          return true;
        }catch(e){
          history.replaceState(null, "", location.origin + location.pathname);
          toast("No se pudo importar el paquete");
          return false;
        }
      }

      // --------- PWA / instalaci√≥n / abrir en Chrome ----------
      const isAndroid = /Android/i.test(navigator.userAgent || "");
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const isIOSStandalone = !!navigator.standalone;
      const isInAppBrowser = (function(){
        const ua = (navigator.userAgent || "").toLowerCase();
        return ua.includes("wv") || ua.includes("webview") ||
               ua.includes("instagram") ||
               ua.includes("fbav") || ua.includes("fb_iab") ||
               ua.includes("telegram") ||
               ua.includes("whatsapp");
      })();

      let deferredPrompt = null;

      function showBanner(mode){
        // mode: "install" | "openchrome" | "info"
        const banner = $("installBanner");
        const title = $("installTitle");
        const text = $("installText");
        const bInstall = $("btnInstallBanner");
        const bOpen = $("btnOpenChrome");
        const bCopy = $("btnCopyLink");

        bInstall.style.display = "none";
        bOpen.style.display = "none";
        bCopy.style.display = "none";

        if(mode === "openchrome"){
          title.textContent = "√Åbrelo en Chrome para instalarla";
          text.innerHTML =
            "Est√°s en un navegador interno (WhatsApp/Telegram). Para instalar, toca <b>Abrir en Chrome</b>.";
          bOpen.style.display = "flex";
          bCopy.style.display = "flex";
        } else if(mode === "install"){
          title.textContent = "Inst√°lala para usarla como app";
          text.innerHTML = "Pulsa <b>Instalar</b>. Luego se abrir√° como una app normal desde el icono.";
          bInstall.style.display = "flex";
        } else {
          title.textContent = "Consejo";
          text.innerHTML = "Si no ves ‚ÄúInstalar‚Äù en el men√∫, abre en <b>Chrome</b> o instala desde el men√∫ <b>‚ãÆ</b>.";
          bCopy.style.display = "flex";
          if(isInAppBrowser) bOpen.style.display = "flex";
        }

        banner.classList.add("show");
      }

      function hideBanner(){ $("installBanner").classList.remove("show"); }

      async function copyCurrentLink(){
        try{
          await navigator.clipboard.writeText(location.href);
          toast("Enlace copiado ‚úÖ");
        }catch(e){
          prompt("Copia este enlace:", location.href);
        }
      }

      function openInChrome(){
        const url = location.href;
        if(isAndroid){
          try{
            const u = new URL(url);
            const path = (u.pathname || "/") + (u.search || "") + (u.hash || "");
            const intent = "intent://" + u.host + path + "#Intent;scheme=https;package=com.android.chrome;end";
            location.href = intent;
            return;
          }catch(e){}
        }
        try{
          window.open(url, "_blank");
        }catch(e){
          copyCurrentLink();
          toast("Copia el enlace y p√©galo en Chrome");
        }
      }

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        $("btnInstall").style.display = "flex";
      });

      $("btnInstall").addEventListener("click", async () => {
        if(!deferredPrompt){
          showBanner(isInAppBrowser ? "openchrome" : "info");
          return;
        }
        deferredPrompt.prompt();
        try{ await deferredPrompt.userChoice; }catch(e){}
        deferredPrompt = null;
        $("btnInstall").style.display = "none";
      });

      $("btnInstallBanner").addEventListener("click", async () => {
        if(!deferredPrompt){
          if(isInAppBrowser){ openInChrome(); return; }
          showBanner("info");
          return;
        }
        deferredPrompt.prompt();
        try{ await deferredPrompt.userChoice; }catch(e){}
        deferredPrompt = null;
        $("btnInstall").style.display = "none";
        hideBanner();
      });

      $("btnOpenChrome").addEventListener("click", openInChrome);
      $("btnCopyLink").addEventListener("click", copyCurrentLink);
      $("btnHideBanner").addEventListener("click", hideBanner);

      // --------- Eventos UI ----------
      $("tabCommitments").addEventListener("click", ()=> setPane("commitments"));
      $("tabContacts").addEventListener("click", ()=> setPane("contacts"));

      $("tabPending").addEventListener("click", () => {
        view = "pending";
        $("tabPending").classList.add("active");
        $("tabDone").classList.remove("active");
        renderCommitments();
      });
      $("tabDone").addEventListener("click", () => {
        view = "done";
        $("tabDone").classList.add("active");
        $("tabPending").classList.remove("active");
        renderCommitments();
      });

      $("fab").addEventListener("click", () => {
        if(pane === "contacts"){
          resetContactForm();
          openContactModal();
          $("cName").focus();
          return;
        }
        resetCommitmentForm();
        openModal();
        $("fContact").focus();
      });

      $("btnClose").addEventListener("click", closeModal);
      $("btnCancel").addEventListener("click", closeModal);
      $("backdrop").addEventListener("click", (e)=>{ if(e.target === $("backdrop")) closeModal(); });

      $("fContact").addEventListener("change", onContactSelectChanged);

      $("btnSave").addEventListener("click", async () => {
        const res = createOrEditCommitment();
        if(!res) return;

        closeModal();
        renderAll();

        if(editingItemId){
          toast("Actualizado ‚úÖ");
          await shareEvent(res.ev, "Compromiso actualizado");
        } else {
          toast("Guardado ‚úÖ");
          await shareEvent(res.ev, "Nuevo compromiso");
        }
      });

      // Contact modal
      $("cBtnClose").addEventListener("click", closeContactModal);
      $("cBtnCancel").addEventListener("click", closeContactModal);
      $("cBackdrop").addEventListener("click", (e)=>{ if(e.target === $("cBackdrop")) closeContactModal(); });

      $("cBtnSave").addEventListener("click", () => {
        const c = upsertContact($("cName").value, $("cNote").value);
        if(!c) return;

        closeContactModal();
        renderAll();
        toast("Contacto guardado ‚úÖ");

        // si ven√≠amos de ‚Äúcrear contacto‚Äù desde el select, lo seleccionamos autom√°ticamente
        fillContactSelect();
        if(pane === "commitments"){
          $("fContact").value = c.id;
          toggleCustomWho(false);
        }
      });

      // --------- SW ----------
      (async function registerSW(){
        if(!("serviceWorker" in navigator)) return;
        try{
          await navigator.serviceWorker.register("./sw.js", { scope: "./" });
        }catch(e){}
      })();

      // --------- Boot ----------
      renderAll();
      tryImportFromUrl();

      // Banner: si no est√° instalada y est√° en in-app, mostrar abrir en Chrome
      setTimeout(() => {
        if(isStandalone || isIOSStandalone) return;
        if(isInAppBrowser){
          showBanner("openchrome");
        } else {
          // si Chrome no dispara beforeinstallprompt, al menos damos info
          showBanner(deferredPrompt ? "install" : "info");
        }
      }, 600);

      // Demo inicial
      if(data.length === 0){
        const now = new Date().toISOString();
        const ev = {
          id: uid(),
          type: T.CREATE,
          at: now,
          payload: {
            i: uid(),
            c: null,
            w: "Ejemplo: Laura",
            s: "Te paso el PDF del seguro",
            n: new Date(Date.now() + 3*60*60*1000).toISOString(),
            ca: now
          }
        };
        applyEvent(ev);
        renderAll();
      }

    })();
  </script>
</body>
</html>