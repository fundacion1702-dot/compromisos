<!-- compromisos.html (1/3) -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Compromisos</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#F2F3F5"/>

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Compromisos">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- CSS separado -->
  <link rel="stylesheet" href="compromisos.css?v=1">

</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand" role="banner" aria-label="Compromisos">
        <div class="logo" aria-hidden="true"><span>ğŸ—“ï¸</span></div>
        <div class="titleBox">
          <p class="title">Compromisos</p>
          <p class="subtitle" id="statsKicker">Todo en tarjetas, mÃ¡s visual.</p>
        </div>
      </div>

      <!-- âœ… Accesibilidad arriba a la derecha + pills fijas (no scroll) -->
      <div class="topActions">
        <button class="a11yBtn" id="btnA11yTop" type="button" title="Cambiar tamaÃ±o de letra">ğŸ” Texto grande</button>

        <div class="pills" aria-label="Indicadores">
          <button class="pillBtn danger" id="btnOverdue" type="button" title="Vencidos">
            <span class="pillDot" aria-hidden="true"></span>
            <span>Vencidos</span>
            <span class="pillCount" id="bOverdue">0</span>
          </button>

          <button class="pillBtn good" id="btnReceived" type="button" title="Recibidos">
            <span class="pillDot" aria-hidden="true"></span>
            <span>Recibidos</span>
            <span class="pillCount" id="bReceived">0</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- MenÃº visual -->
    <div class="menuGrid" aria-label="MenÃº">
      <div class="tile" id="tilePending" role="button" tabindex="0">
        <div class="tileIcon"><span>ğŸ“</span></div>
        <div class="tileText">
          <p class="tileTitle">Pendientes</p>
          <p class="tileMeta">
            <span class="badge primary" id="tilePendingCount">0</span>
            <span>compromisos</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileDone" role="button" tabindex="0">
        <div class="tileIcon"><span>âœ…</span></div>
        <div class="tileText">
          <p class="tileTitle">Hechos</p>
          <p class="tileMeta">
            <span class="badge good" id="tileDoneCount">0</span>
            <span>completados</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileContacts" role="button" tabindex="0">
        <div class="tileIcon"><span>ğŸ‘¥</span></div>
        <div class="tileText">
          <p class="tileTitle">Amigos</p>
          <p class="tileMeta">
            <span class="badge" id="tileContactsCount">0</span>
            <span>guardados</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileSettings" role="button" tabindex="0">
        <div class="tileIcon"><span>âš™ï¸</span></div>
        <div class="tileText">
          <p class="tileTitle">Ajustes</p>
          <p class="tileMeta">
            <span class="badge">ğŸ”’</span>
            <span>seguridad</span>
          </p>
        </div>
      </div>
    </div>

    <!-- PANE: COMPROMISOS -->
    <div id="commitmentsPane" class="section" style="margin-top:14px;">
      <div class="sectionHead">
        <div>
          <h2>Compromisos</h2>
          <p>Todo ordenado y fÃ¡cil de ver.</p>
        </div>
        <div class="segTabs" role="tablist" aria-label="Pendientes o Hechos">
          <button class="segBtn active" id="tabPending" type="button">Pendientes</button>
          <button class="segBtn" id="tabDone" type="button">Hechos</button>
        </div>
      </div>

      <div class="list" id="list"></div>
      <div class="empty" id="empty">No hay compromisos aquÃ­ todavÃ­a.</div>
    </div>

    <!-- PANE: CONTACTOS -->
    <div id="contactsPane" class="section" style="display:none;">
      <div class="sectionHead">
        <div>
          <h2>Amigos</h2>
          <p>Toca una tarjeta para crear un compromiso con ese amigo.</p>
        </div>
        <div class="segTabs">
          <span class="badge" id="bContacts">0</span>
        </div>
      </div>

      <div class="list" id="contactsList"></div>
      <div class="empty" id="contactsEmpty">AÃºn no has creado amigos.</div>
    </div>

    <!-- PANE: SETTINGS -->
    <div id="settingsPane" class="section" style="display:none;">
      <div class="sectionHead">
        <div>
          <h2>Ajustes</h2>
          <p>Bloqueo, notificaciones y accesibilidad.</p>
        </div>
      </div>

      <div class="list" style="gap:12px;">
        <!-- Accesibilidad -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Accesibilidad</p>
              <p class="meta"><span class="chip">ğŸ‘ï¸ Texto grande</span></p>
            </div>
            <div class="due">Ajuste</div>
          </div>
          <div class="actions">
            <button class="btn primary" id="btnA11y" type="button">ğŸ” Texto grande</button>
          </div>
        </div>

        <!-- PIN -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Bloqueo con PIN</p>
              <p class="meta">
                <span class="chip">ğŸ”’ Seguridad</span>
                <span class="chip">Auto-bloqueo</span>
              </p>
            </div>
            <div class="switch" id="swPin" role="switch" aria-checked="false" tabindex="0" aria-label="Activar PIN">
              <span class="knob"></span>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="btnChangePin" type="button">ğŸ” Cambiar PIN</button>
            <button class="btn danger" id="btnLockNow" type="button">ğŸ”’ Bloquear ahora</button>
          </div>

          <div class="field" style="margin-top:10px;">
            <label class="label" for="selAutoLock">Auto-bloqueo al salir</label>
            <select id="selAutoLock">
              <option value="0">Inmediato</option>
              <option value="1">1 min</option>
              <option value="2">2 min</option>
              <option value="5">5 min</option>
              <option value="10">10 min</option>
            </select>
            <div class="hint">Se aplica cuando sales de la app o la minimizas.</div>
          </div>

          <div class="field">
            <label class="label" for="selRemember">Recordar desbloqueo</label>
            <select id="selRemember">
              <option value="0">No recordar</option>
              <option value="5">5 min</option>
              <option value="10">10 min</option>
              <option value="30">30 min</option>
              <option value="60">1 hora</option>
            </select>
            <div class="hint">Si lo activas, no te pedirÃ¡ el PIN durante ese tiempo.</div>
          </div>
        </div>

        <!-- Notificaciones -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Notificaciones</p>
              <p class="meta"><span class="chip">ğŸ”” Recordatorios</span></p>
            </div>
            <div class="switch" id="swNotif" role="switch" aria-checked="false" tabindex="0" aria-label="Activar notificaciones">
              <span class="knob"></span>
            </div>
          </div>

          <div class="desc" id="notifHint">â„¹ï¸ Pulsa â€œPermitirâ€ para recibir recordatorios.</div>

          <div class="actions">
            <button class="btn primary" id="btnNotifPerm" type="button">âœ… Permitir</button>
          </div>
        </div>

        <!-- Borrar todo -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Mantenimiento</p>
              <p class="meta"><span class="chip">ğŸ§¹ Reinicio</span></p>
            </div>
            <div class="due">âš ï¸</div>
          </div>
          <div class="actions">
            <button class="btn danger" id="btnResetAll" type="button">ğŸ§¹ Borrar todo</button>
          </div>
          <div class="hint">Borra compromisos, amigos y ajustes del mÃ³vil.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div class="bottomBar">
    <div class="bottomInner">
      <button class="navBtn active" id="tabCommitments" type="button"><span>ğŸ—“ï¸ Compromisos</span></button>
      <button class="fab" id="fab" type="button" aria-label="Nuevo">ï¼‹</button>
      <button class="navBtn" id="tabContacts" type="button"><span>ğŸ‘¥ Amigos</span></button>

      <!-- compat / no layout -->
      <button class="navBtn" id="btnInstall" type="button" style="display:none;">â¬‡ï¸ Instalar</button>
    </div>
  </div>

  <!-- Banner instalaciÃ³n -->
  <div class="installBanner" id="installBanner" aria-hidden="true">
    <div class="installCard">
      <div class="installRow">
        <div>
          <p class="installTitle" id="installTitle">InstÃ¡lala</p>
          <p class="installText" id="installText">Consejo</p>
        </div>
        <button class="iconBtn" id="btnHideBanner" type="button" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn primary" id="btnInstallBanner" type="button" style="display:none;">â¬‡ï¸ Instalar</button>
        <button class="btn" id="btnOpenChrome" type="button" style="display:none;">ğŸŒ Abrir en Chrome</button>
        <button class="btn" id="btnCopyLink" type="button" style="display:none;">ğŸ”— Copiar enlace</button>
      </div>
    </div>
  </div>

  <!-- MODALES (los mismos IDs que tu versiÃ³n) -->
  <!-- Modal Compromiso -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">Nuevo compromiso</h3>
        <button class="iconBtn" id="btnClose" type="button" aria-label="Cerrar">âœ•</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label class="label" for="fContact">Â¿Con quiÃ©n?</label>
          <select id="fContact"></select>
          <div class="hint" id="contactHint">Elige un amigo o escribe un nombre sin guardar.</div>
        </div>

        <div class="field" id="customWhoField" style="display:none">
          <label class="label" for="fWho">Nombre (sin guardar)</label>
          <input id="fWho" type="text" placeholder="Ej: Laura / MamÃ¡ / Juan (del trabajo)" autocomplete="off"/>
        </div>

        <div class="field">
          <label class="label" for="fWhat">Â¿QuÃ© se acordÃ³?</label>
          <textarea id="fWhat" placeholder="Ej: Te paso el PDF / Te devuelvo 20â‚¬ / Quedamos el juevesâ€¦"></textarea>
        </div>

        <div class="twoCol">
          <div class="field">
            <label class="label" for="fWhen">Â¿Para cuÃ¡ndo?</label>
            <input id="fWhen" type="datetime-local"/>
            <div class="hint">Puedes dejarlo sin fecha.</div>
          </div>

          <div class="field">
            <label class="label" for="fRemind">Recordatorio (por fecha)</label>
            <select id="fRemind">
              <option value="0">Ninguno</option>
              <option value="5">5 min antes</option>
              <option value="15">15 min antes</option>
              <option value="60">1 hora antes</option>
              <option value="1440">1 dÃ­a antes</option>
            </select>
            <div class="hint">Requiere fecha.</div>
          </div>
        </div>

        <div class="field">
          <label class="label" for="fAfter">Avisar â€œdesde ahoraâ€ (viaja en el enlace)</label>
          <select id="fAfter">
            <option value="0">No</option>
            <option value="5">En 5 minutos</option>
            <option value="15">En 15 minutos</option>
            <option value="60">En 1 hora</option>
            <option value="180">En 3 horas</option>
            <option value="1440">MaÃ±ana (24h)</option>
          </select>
          <div class="hint">El receptor debe abrir el enlace para que se programe en su mÃ³vil.</div>
        </div>

        <div class="hint">Al guardar, se abrirÃ¡ el modal de <b>Compartir</b>.</div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="btnCancel" type="button">Cancelar</button>
        <button class="btn good" id="btnSave" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Contacto -->
  <div class="backdrop" id="cBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="cModalTitle">Nuevo amigo</h3>
        <button class="iconBtn" id="cBtnClose" type="button" aria-label="Cerrar">âœ•</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label class="label" for="cName">Nombre</label>
          <input id="cName" type="text" placeholder="Ej: Laura" autocomplete="off"/>
        </div>
        <div class="field">
          <label class="label" for="cNote">Nota (opcional)</label>
          <input id="cNote" type="text" placeholder="Ej: Trabajo / Vecina / Familia" autocomplete="off"/>
        </div>
        <div class="hint">Esto solo se guarda en tu mÃ³vil.</div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="cBtnCancel" type="button">Cancelar</button>
        <button class="btn good" id="cBtnSave" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal PIN -->
  <div class="backdrop" id="pinBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="pinTitle">Configurar PIN</h3>
        <button class="iconBtn" id="pinClose" type="button" aria-label="Cerrar">âœ•</button>
      </div>

      <div class="modalBody">
        <div class="hint" id="pinHint" style="margin-top:0"></div>

        <div class="field" id="pinOldWrap" style="display:none">
          <label class="label" for="pinOld">PIN actual</label>
          <input id="pinOld" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="â€¢â€¢â€¢â€¢"/>
        </div>

        <div class="field" id="pinNewWrap">
          <label class="label" for="pinNew">Nuevo PIN (4 dÃ­gitos)</label>
          <input id="pinNew" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="â€¢â€¢â€¢â€¢"/>
        </div>

        <div class="field" id="pinNew2Wrap">
          <label class="label" for="pinNew2">Repite el PIN</label>
          <input id="pinNew2" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="â€¢â€¢â€¢â€¢"/>
        </div>

        <div class="hint" id="pinHelp">Consejo: usa un PIN que solo tÃº sepas.</div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="pinCancel" type="button">Cancelar</button>
        <button class="btn good" id="pinOk" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Compartir -->
  <div class="backdrop" id="shareBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3>Compartir paquete</h3>
        <button class="iconBtn" id="shareClose" type="button" aria-label="Cerrar">âœ•</button>
      </div>

      <div class="modalBody">
        <div class="hint" id="shareTitle" style="margin-top:0"></div>

        <div class="seg" role="tablist" aria-label="Formato">
          <button id="shareShort" class="active" type="button">Corto</button>
          <button id="shareLong" type="button">Detallado</button>
        </div>

        <div class="mono" id="shareTextBox" style="margin-top:10px;"></div>

        <div class="hint" style="margin-top:10px;">Enlace (puedes copiarlo directo):</div>
        <div class="mono" id="shareUrlBox" style="margin-top:8px;"></div>

        <div class="hint">Pulsa <b>Compartir</b> para enviarlo por WhatsApp/Telegram. Si no aparece, usa copiar.</div>
      </div>

      <div class="modalFoot">
        <button class="btn" id="shareCopyUrl" type="button">ğŸ”— Copiar enlace</button>
        <button class="btn" id="shareCopyAll" type="button">ğŸ“‹ Copiar texto+enlace</button>
        <button class="btn primary" id="shareSend" type="button">ğŸ“¤ Compartir</button>
        <button class="btn danger" id="shareCancel" type="button">Hecho</button>
      </div>
    </div>
  </div>

  <!-- Overlay bloqueo -->
  <div class="backdrop" id="lockOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h3>ğŸ”’ App bloqueada</h3>
        <button class="iconBtn" id="lockClose" type="button" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modalBody">
        <p class="hint" style="margin-top:0">Introduce tu PIN para continuar.</p>
        <div class="pinDots" aria-label="PIN">
          <div class="dot" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
          <div class="dot" id="d4"></div>
        </div>

        <div class="keypad" id="keypad">
          <button class="key" data-k="1" type="button">1</button>
          <button class="key" data-k="2" type="button">2</button>
          <button class="key" data-k="3" type="button">3</button>
          <button class="key" data-k="4" type="button">4</button>
          <button class="key" data-k="5" type="button">5</button>
          <button class="key" data-k="6" type="button">6</button>
          <button class="key" data-k="7" type="button">7</button>
          <button class="key" data-k="8" type="button">8</button>
          <button class="key" data-k="9" type="button">9</button>
          <button class="key danger" data-k="del" type="button">âŒ«</button>
          <button class="key" data-k="0" type="button">0</button>
          <button class="key primary" data-k="ok" type="button">OK</button>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn" id="btnLockCopyLink" type="button">ğŸ”— Copiar enlace actual</button>
          <button class="btn danger" id="btnLockReset" type="button">ğŸ§¹ Borrar todo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirm (propio) -->
  <div class="backdrop" id="confirmBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="confirmTitle">Confirmar</h3>
        <button class="iconBtn" id="confirmClose" type="button" aria-label="Cerrar">âœ•</button>
      </div>
      <div class="modalBody">
        <div id="confirmMsg" class="hint" style="margin-top:0; color:#111827;"></div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="confirmNo" type="button">Cancelar</button>
        <button class="btn danger" id="confirmYes" type="button">SÃ­, continuar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- JS separado -->
  <script src="compromisos.js?v=1"></script>
</body>
</html>

/* compromisos.css (2/3) */
:root{
  --bg:#F2F3F5;
  --surface:#FFFFFF;
  --surface2:#F7F8FA;
  --text:#111827;
  --muted:#6B7280;
  --border:#E5E7EB;
  --shadow:0 10px 28px rgba(17,24,39,.08);
  --shadow2:0 6px 18px rgba(17,24,39,.06);

  --primary:#2563EB;
  --primarySoft:rgba(37,99,235,.10);

  --danger:#DC2626;
  --dangerSoft:rgba(220,38,38,.10);

  --good:#16A34A;
  --goodSoft:rgba(22,163,74,.10);

  --chip:#EEF2FF;
  --chipText:#1F2A5A;

  --radius:18px;
  --radius2:22px;
  --max:880px;

  --tap:48px;
  --fs:16px;
  --fsBig:18px;

  --icon:#111827;

  --bottomH:76px;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  font-size:var(--fs);
}
a{ color:inherit; }

.wrap{
  width:min(var(--max), calc(100% - 24px));
  margin:0 auto;
  padding:14px 0 calc(var(--bottomH) + 22px);
}

/* Top bar */
.topbar{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(242,243,245,.85);
  backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(229,231,235,.7);
}
.topbarInner{
  width:min(var(--max), calc(100% - 24px));
  margin:0 auto;
  padding:12px 0;
  display:grid;
  grid-template-columns:1fr auto;
  gap:10px 12px;
  align-items:center;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.logo{
  width:42px;height:42px;
  border-radius:14px;
  background:linear-gradient(180deg,#fff,#f3f4f6);
  border:1px solid var(--border);
  box-shadow:var(--shadow2);
  display:grid;
  place-items:center;
  flex:0 0 auto;
}
.logo span{ font-size:20px; }
.titleBox{ min-width:0; }
.title{
  margin:0;
  font-size:18px;
  font-weight:800;
  letter-spacing:.2px;
  line-height:1.1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.subtitle{
  margin:3px 0 0;
  font-size:12.5px;
  color:var(--muted);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* âœ… TOP actions: botÃ³n texto grande arriba derecha, pills fijas (no scroll) */
.topActions{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  min-width:0;
}

.a11yBtn{
  height:34px;
  padding:0 12px;
  border-radius:999px;
  background:var(--surface2);
  border:1px solid var(--border);
  box-shadow:var(--shadow2);
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  font-weight:900;
  color:var(--text);
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  white-space:nowrap;
  flex:0 0 auto;
}
.a11yBtn:active{ transform:translateY(1px); }

/* Pills (fijas, sin desplazamiento) */
.pills{
  display:flex;
  gap:8px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:nowrap;
  overflow:visible;           /* âœ… no scroll */
  max-width:100%;
}
.pillBtn{
  height:34px;
  padding:0 12px;
  border-radius:999px;
  background:var(--surface);
  border:1px solid var(--border);
  box-shadow:var(--shadow2);
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  color:var(--text);
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  white-space:nowrap;
  flex:0 0 auto;
}
.pillBtn:active{ transform:translateY(1px); }
.pillDot{
  width:10px;height:10px;
  border-radius:999px;
  background:var(--muted);
  opacity:.35;
  flex:0 0 auto;
}
.pillCount{
  min-width:22px;
  height:22px;
  padding:0 7px;
  border-radius:999px;
  display:grid;
  place-items:center;
  font-weight:800;
  font-size:12px;
  background:var(--surface2);
  border:1px solid var(--border);
  color:var(--text);
  flex:0 0 auto;
}
.pillBtn.primary .pillDot{ background:var(--primary); opacity:.9; }
.pillBtn.primary .pillCount{ background:var(--primarySoft); border-color:rgba(37,99,235,.18); }
.pillBtn.danger .pillDot{ background:var(--danger); opacity:.9; }
.pillBtn.danger .pillCount{ background:var(--dangerSoft); border-color:rgba(220,38,38,.18); }
.pillBtn.good .pillDot{ background:var(--good); opacity:.9; }
.pillBtn.good .pillCount{ background:var(--goodSoft); border-color:rgba(22,163,74,.18); }

/* MenÃº grid */
.menuGrid{
  margin-top:14px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.tile{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius2);
  box-shadow:var(--shadow2);
  padding:14px 14px;
  cursor:pointer;
  user-select:none;
  -webkit-tap-highlight-color:transparent;
  display:flex;
  align-items:center;
  gap:12px;
  min-height:72px;
}
.tile:active{ transform:translateY(1px); }
.tileIcon{
  width:44px;height:44px;
  border-radius:16px;
  display:grid;
  place-items:center;
  background:var(--surface2);
  border:1px solid var(--border);
  color:var(--icon);
  flex:0 0 auto;
}
.tileIcon span{ font-size:20px; }
.tileText{ min-width:0; flex:1 1 auto; }
.tileTitle{
  margin:0;
  font-weight:900;
  letter-spacing:.2px;
  font-size:16px;
  line-height:1.1;
}
.tileMeta{
  margin:5px 0 0;
  font-size:12.5px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  min-width:28px;
  height:22px;
  padding:0 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--surface2);
  font-weight:900;
  font-size:12px;
  color:var(--text);
}
.badge.primary{ background:var(--primarySoft); border-color:rgba(37,99,235,.20); color:#1E40AF; }
.badge.danger{ background:var(--dangerSoft); border-color:rgba(220,38,38,.20); color:#991B1B; }
.badge.good{ background:var(--goodSoft); border-color:rgba(22,163,74,.20); color:#14532D; }

/* Secciones */
.section{
  margin-top:16px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius2);
  box-shadow:var(--shadow2);
  overflow:hidden;
}
.sectionHead{
  padding:14px 14px 12px;
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid rgba(229,231,235,.8);
  background:linear-gradient(180deg,#fff,#fbfbfc);
}
.sectionHead h2{
  margin:0;
  font-size:16px;
  font-weight:950;
  letter-spacing:.2px;
}
.sectionHead p{
  margin:4px 0 0;
  font-size:12.5px;
  color:var(--muted);
}
.segTabs{ display:flex; align-items:center; gap:8px; }
.segBtn{
  height:34px;
  padding:0 12px;
  border-radius:999px;
  background:var(--surface2);
  border:1px solid var(--border);
  cursor:pointer;
  font-weight:800;
  font-size:13px;
  color:var(--text);
  -webkit-tap-highlight-color:transparent;
  white-space:nowrap;
}
.segBtn.active{
  background:var(--primarySoft);
  border-color:rgba(37,99,235,.22);
  color:#1E40AF;
}

/* List / cards */
.list{
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius2);
  box-shadow:var(--shadow2);
  padding:12px 12px;
}
.cardTop{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}
.who .name{
  margin:0;
  font-weight:950;
  letter-spacing:.2px;
  font-size:15.5px;
}
.who .meta{
  margin:6px 0 0;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
  background:var(--chip);
  color:var(--chipText);
  border:1px solid rgba(99,102,241,.18);
}
.due{
  flex:0 0 auto;
  font-size:12.5px;
  color:var(--muted);
  background:var(--surface2);
  border:1px solid var(--border);
  border-radius:999px;
  padding:8px 10px;
  font-weight:800;
  white-space:nowrap;
}
.due.bad{
  color:#991B1B;
  background:var(--dangerSoft);
  border-color:rgba(220,38,38,.20);
}
.desc{
  margin-top:10px;
  color:var(--text);
  line-height:1.35;
  font-size:14.5px;
  padding:10px 10px;
  border-radius:14px;
  background:#FAFAFB;
  border:1px solid rgba(229,231,235,.9);
}
.actions{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

/* Buttons */
.btn{
  height:40px;
  padding:0 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--surface2);
  color:var(--text);
  font-weight:900;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}
.btn:active{ transform:translateY(1px); }
.btn.primary{ background:var(--primarySoft); border-color:rgba(37,99,235,.22); color:#1E40AF; }
.btn.good{ background:var(--goodSoft); border-color:rgba(22,163,74,.22); color:#14532D; }
.btn.danger{ background:var(--dangerSoft); border-color:rgba(220,38,38,.22); color:#991B1B; }

/* Empty */
.empty{
  padding:14px 12px 18px;
  color:var(--muted);
  text-align:center;
  font-size:13.5px;
}

/* Bottom bar */
.bottomBar{
  position:fixed;
  left:0; right:0; bottom:0;
  background:rgba(255,255,255,.88);
  backdrop-filter:blur(10px);
  border-top:1px solid rgba(229,231,235,.9);
  padding:10px 12px;
  z-index:20;
}
.bottomInner{
  width:min(var(--max), calc(100% - 24px));
  margin:0 auto;
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:10px;
  align-items:center;
}
.navBtn{
  height:44px;
  border-radius:16px;
  border:1px solid var(--border);
  background:var(--surface);
  box-shadow:var(--shadow2);
  cursor:pointer;
  font-weight:950;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  -webkit-tap-highlight-color:transparent;
  min-width:0;
  padding:0 10px;
  white-space:nowrap;
}
.navBtn span{ overflow:hidden; text-overflow:ellipsis; }
.navBtn.active{
  background:var(--primarySoft);
  border-color:rgba(37,99,235,.22);
  color:#1E40AF;
}

.fab{
  position:static;
  width:56px;
  height:56px;
  border-radius:20px;
  border:1px solid rgba(37,99,235,.18);
  background:#2563EB;
  color:#fff;
  font-size:28px;
  font-weight:900;
  display:grid;
  place-items:center;
  cursor:pointer;
  box-shadow:0 18px 40px rgba(37,99,235,.22);
  z-index:25;
  -webkit-tap-highlight-color:transparent;
  margin:-18px auto 0;
}
.fab:active{ transform:translateY(1px); }

/* Modals */
.backdrop{
  position:fixed;
  inset:0;
  background:rgba(17,24,39,.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:50;
}
.backdrop.show{ display:flex; }

.modal{
  width:min(560px, 100%);
  border-radius:22px;
  background:var(--surface);
  border:1px solid rgba(229,231,235,.9);
  box-shadow:0 24px 70px rgba(17,24,39,.20);
  overflow:hidden;
}
.modalHead{
  padding:14px 14px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid rgba(229,231,235,.9);
  background:linear-gradient(180deg,#fff,#fbfbfc);
}
.modalHead h3{ margin:0; font-size:16px; font-weight:950; }
.iconBtn{
  width:42px;
  height:42px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--surface2);
  cursor:pointer;
  font-weight:900;
}
.modalBody{ padding:12px 14px 14px; }
.modalFoot{
  padding:12px 14px 14px;
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  border-top:1px solid rgba(229,231,235,.9);
  justify-content:flex-end;
  background:#fff;
}

.field{ margin-top:10px; }
.label{
  display:block;
  font-size:12.5px;
  color:var(--muted);
  margin:0 0 6px;
  font-weight:800;
}
input,select,textarea{
  width:100%;
  border-radius:16px;
  border:1px solid var(--border);
  background:#fff;
  padding:12px 12px;
  font-size:15px;
  outline:none;
}
textarea{ min-height:92px; resize:vertical; }
input:focus,select:focus,textarea:focus{
  border-color:rgba(37,99,235,.35);
  box-shadow:0 0 0 4px rgba(37,99,235,.10);
}

/* Toast */
.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:calc(var(--bottomH) + 12px);
  background:rgba(17,24,39,.92);
  color:#fff;
  padding:10px 12px;
  border-radius:14px;
  font-weight:800;
  font-size:13.5px;
  box-shadow:0 18px 60px rgba(0,0,0,.25);
  display:none;
  z-index:60;
  max-width:min(560px, calc(100% - 24px));
  width:fit-content;
  text-align:center;
}
.toast.show{ display:block; }

.twoCol{ display:flex; gap:10px; flex-wrap:wrap; }
.twoCol > *{ flex:1; min-width:170px; }

.hint{
  margin-top:8px;
  color:var(--muted);
  font-size:12.5px;
  line-height:1.35;
}

/* Share mono box */
.mono{
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size:12.5px;
  color:#111827;
  background:#FAFAFB;
  border:1px solid rgba(229,231,235,.95);
  padding:10px 10px;
  border-radius:16px;
  word-break:break-all;
  white-space:pre-wrap;
}

/* Seg (share mode) */
.seg{
  display:flex;
  gap:8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--surface2);
  padding:6px;
}
.seg button{
  flex:1;
  height:34px;
  border-radius:999px;
  border:1px solid transparent;
  background:transparent;
  font-weight:900;
  cursor:pointer;
}
.seg button.active{
  background:var(--surface);
  border-color:rgba(229,231,235,.95);
  box-shadow:var(--shadow2);
  color:#111827;
}

/* Keypad / lock */
.keypad{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:10px;
  margin-top:12px;
}
.key{
  height:52px;
  border-radius:16px;
  border:1px solid var(--border);
  background:var(--surface2);
  font-weight:950;
  font-size:18px;
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
}
.key:active{ transform:translateY(1px); }
.key.primary{ background:var(--primarySoft); border-color:rgba(37,99,235,.22); color:#1E40AF; }
.key.danger{ background:var(--dangerSoft); border-color:rgba(220,38,38,.22); color:#991B1B; }

.pinDots{ display:flex; justify-content:center; gap:10px; margin-top:8px; }
.dot{
  width:12px;height:12px;
  border-radius:999px;
  border:2px solid rgba(17,24,39,.22);
  background:rgba(17,24,39,.08);
}
.dot.on{
  background:rgba(37,99,235,.9);
  border-color:rgba(37,99,235,.25);
  box-shadow:0 10px 26px rgba(37,99,235,.18);
}

/* Switch (PIN / Notif) */
.switch{
  width:56px;
  height:32px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--surface2);
  position:relative;
  cursor:pointer;
  flex:0 0 auto;
  -webkit-tap-highlight-color:transparent;
  box-shadow:var(--shadow2);
}
.switch .knob{
  position:absolute;
  top:3px; left:3px;
  width:26px; height:26px;
  border-radius:999px;
  background:#fff;
  border:1px solid rgba(229,231,235,.95);
  box-shadow:0 8px 20px rgba(17,24,39,.10);
  transition:transform .18s ease;
}
.switch.on{
  background:rgba(37,99,235,.15);
  border-color:rgba(37,99,235,.25);
}
.switch.on .knob{
  transform:translateX(24px);
}

/* Install banner */
.installBanner{
  position:fixed;
  left:12px; right:12px;
  bottom:calc(var(--bottomH) + 70px);
  z-index:30;
  display:none;
}
.installBanner.show{ display:block; }
.installCard{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:22px;
  box-shadow:var(--shadow);
  padding:12px 12px;
}
.installRow{
  display:flex;
  gap:10px;
  align-items:flex-start;
  justify-content:space-between;
}
.installTitle{ margin:0; font-weight:950; font-size:14.5px; }
.installText{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.3; }

/* Responsive */
@media (min-width:720px){
  .menuGrid{ grid-template-columns:1fr 1fr 1fr 1fr; }
  .tile{ min-height:78px; }
}

/* âœ… En mÃ³viles estrechos: seguimos manteniendo botÃ³n texto grande a la derecha y pills debajo si no caben */
@media (max-width:520px){
  .topbarInner{ grid-template-columns:1fr; }
  .topActions{
    justify-content:space-between;
    flex-wrap:wrap;
  }
  .pills{
    width:100%;
    justify-content:flex-start;
  }
}

/* âœ… PARTE 3/3 â€” LÃ“GICA FINAL (applyEvent + render + navegaciÃ³n + boot + cierre)
   ğŸ‘‰ PÃ‰GALA A CONTINUACIÃ“N DE LA PARTE 2 (SIN DUPLICAR <script>).
*/

/* =========================
   FIX UI (sin scroll en pills + â€œTexto grandeâ€ fijo arriba derecha)
   ========================= */
(function injectUiFixes(){
  try{
    const st = document.createElement("style");
    st.textContent = `
      /* Pills NO deslizantes (quedan fijas en su ubicaciÃ³n) */
      .pills{ overflow-x: visible !important; flex-wrap: nowrap !important; scrollbar-width: none !important; }
      .pills::-webkit-scrollbar{ display:none !important; }

      /* BotÃ³n â€œTexto grandeâ€ SIEMPRE esquina superior derecha */
      .topbarInner{ position: relative; }
      .topActions{ position: static; }
      #btnA11yTop{
        position: absolute !important;
        top: 12px !important;
        right: 0 !important;
        z-index: 11 !important;
      }
      /* Dejamos hueco a la derecha para que no se pise con el contenido */
      .brand{ padding-right: 160px; }
      @media (max-width:520px){
        .brand{ padding-right: 0; }
        #btnA11yTop{ top: 12px !important; right: 0 !important; }
      }
    `;
    document.head.appendChild(st);
  }catch(e){}
})();

/* =========================
   applyEvent + limpieza firedMaps
   ========================= */
function firedKey(it){
  return `${it.id}|${it.when||""}|${Number(it.remindMin||0)}|${it.done?"1":"0"}`;
}
function afterKey(it){
  return `${it.id}|${it.afterAt||""}|${Number(it.afterMin||0)}|${it.done?"1":"0"}`;
}

function cleanupFiredMaps(){
  const liveA = new Set();
  const liveB = new Set();

  for(const it of data){
    if(it.done) continue;

    if(it.when && Number(it.remindMin||0) > 0){
      liveA.add(firedKey(it));
    }
    if(it.afterAt && Number(it.afterMin||0) > 0){
      liveB.add(afterKey(it));
    }
  }

  const nextA = {};
  for(const k of Object.keys(firedMap||{})){
    if(liveA.has(k)) nextA[k] = firedMap[k];
  }
  firedMap = nextA;
  save(REMIND_FIRED_KEY, firedMap);

  const nextB = {};
  for(const k of Object.keys(afterFired||{})){
    if(liveB.has(k)) nextB[k] = afterFired[k];
  }
  afterFired = nextB;
  save(AFTER_FIRED_KEY, afterFired);
}

function applyEvent(ev){
  if(!ev || ev.type == null) return false;
  if(events.some(x => x.id === ev.id)) return false;

  let changed = false;

  if(ev.type === T.CREATE){
    const p = ev.payload || {};
    const itemId = p.i || uid();

    const afterMin = Number(p.af || 0);
    const afterAt = p.aa || null;

    if(!data.some(x => x.id === itemId)){
      data.push({
        id: itemId,
        whoId: p.c || null,
        whoName: p.w || "Sin nombre",
        what: p.s || "",
        when: p.n || null,
        remindMin: Number(p.r || 0),

        afterMin: afterMin,
        afterAt: afterAt,

        done: false,
        createdAt: p.ca || ev.at,
        doneAt: null,
        updatedAt: null
      });
      changed = true;
    } else {
      const it = data.find(x => x.id === itemId);
      if(it){
        const before = JSON.stringify(it);
        it.whoId = p.c || null;
        it.whoName = p.w || it.whoName;
        it.what = p.s ?? it.what;
        it.when = (p.n ?? it.when) || null;
        it.remindMin = Number(p.r ?? it.remindMin ?? 0);

        if(p.af != null) it.afterMin = afterMin;
        if(p.aa != null) it.afterAt = afterAt;

        it.updatedAt = ev.at;
        changed = (JSON.stringify(it) !== before);
      }
    }
  }
  else if(ev.type === T.DONE){
    const p = ev.payload || {};
    const it = data.find(x => x.id === p.i);
    if(it && !it.done){
      it.done = true;
      it.doneAt = ev.at;
      it.updatedAt = ev.at;
      changed = true;
    }
  }
  else if(ev.type === T.REOPEN){
    const p = ev.payload || {};
    const it = data.find(x => x.id === p.i);
    if(it && it.done){
      it.done = false;
      it.doneAt = null;
      it.updatedAt = ev.at;
      changed = true;
    }
  }
  else if(ev.type === T.DELETE){
    const p = ev.payload || {};
    const before = data.length;
    data = data.filter(x => x.id !== p.i);
    changed = (data.length !== before);
  }
  else if(ev.type === T.EDIT){
    const p = ev.payload || {};
    const it = data.find(x => x.id === p.i);
    if(it){
      const before = JSON.stringify(it);
      if(p.w != null) it.whoName = p.w;
      if(p.c != null) it.whoId = p.c || null;
      if(p.s != null) it.what = p.s;
      if(p.n != null) it.when = p.n || null;
      if(p.r != null) it.remindMin = Number(p.r || 0);

      if(p.af != null) it.afterMin = Number(p.af || 0);
      if(p.aa != null) it.afterAt = p.aa || null;

      it.updatedAt = ev.at;
      changed = (JSON.stringify(it) !== before);
    }
  }

  events.push(ev);
  save(EVENTS_KEY, events);
  save(KEY, data);

  cleanupFiredMaps();
  return changed;
}

/* =========================
   Helpers (compromisos / contactos)
   ========================= */
function contactById(id){ return contacts.find(c => c.id === id) || null; }

function normalizedWho(item){
  if(item.whoId){
    const c = contactById(item.whoId);
    if(c && c.name) return c.name;
  }
  return item.whoName || "Sin nombre";
}

function shortPreview(text, n){
  const s = String(text||"").trim();
  if(s.length <= n) return s;
  return s.slice(0, n-1) + "â€¦";
}

function remindLabel(min){
  const m = Number(min||0);
  if(!m) return "";
  if(m === 5) return "ğŸ”” 5m";
  if(m === 15) return "ğŸ”” 15m";
  if(m === 60) return "ğŸ”” 1h";
  if(m === 1440) return "ğŸ”” 1d";
  return "ğŸ””";
}

/* =========================
   UI state / pestaÃ±as
   ========================= */
let pane = "commitments";  // commitments | contacts | settings
let view = "pending";      // pending | done

function safeShow(el, show){
  if(!el) return;
  el.style.display = show ? "" : "none";
}

function setPane(newPane){
  pane = newPane;

  const tC = $("tabCommitments");
  const tA = $("tabContacts");

  if(tC) tC.classList.toggle("active", pane==="commitments");
  if(tA) tA.classList.toggle("active", pane==="contacts");

  safeShow($("commitmentsPane"), pane==="commitments");
  safeShow($("contactsPane"), pane==="contacts");
  safeShow($("settingsPane"), pane==="settings");

  const fab = $("fab");
  if(fab){
    if(pane === "settings") fab.style.display = "none";
    else{
      fab.style.display = "grid";
      fab.setAttribute("aria-label", pane==="contacts" ? "Nuevo amigo" : "Nuevo compromiso");
    }
  }

  renderAll();
  try{ window.scrollTo({ top: 0, behavior: "smooth" }); }catch(e){ window.scrollTo(0,0); }
}

function setViewPending(){
  view = "pending";
  const a = $("tabPending");
  const b = $("tabDone");
  if(a) a.classList.add("active");
  if(b) b.classList.remove("active");
  renderCommitments();
}
function setViewDone(){
  view = "done";
  const a = $("tabDone");
  const b = $("tabPending");
  if(a) a.classList.add("active");
  if(b) b.classList.remove("active");
  renderCommitments();
}

/* =========================
   Render (contadores + listas)
   ========================= */
function updateTileCounts(){
  const pending = data.filter(x => !x.done);
  const done = data.filter(x => x.done);

  if($("tilePendingCount")) $("tilePendingCount").textContent = String(pending.length);
  if($("tileDoneCount")) $("tileDoneCount").textContent = String(done.length);
  if($("tileContactsCount")) $("tileContactsCount").textContent = String(contacts.length);

  // TambiÃ©n el badge del panel amigos
  if($("bContacts")) $("bContacts").textContent = String(contacts.length);
}

function updateTopBadges(){
  const pending = data.filter(x => !x.done);
  const overdueCount = pending.filter(x => isOverdue(x.when)).length;

  if($("bPending")) $("bPending").textContent = String(pending.length);
  if($("bOverdue")) $("bOverdue").textContent = String(overdueCount);

  renderNotifAlertsBadge();
  renderReceivedBadge();
  updateTileCounts();
}

function renderCommitments(){
  updateTopBadges();

  const list = $("list");
  const empty = $("empty");
  if(!list) return;

  list.innerHTML = "";

  const pending = data.filter(x => !x.done);
  const done = data.filter(x => x.done);
  const items = (view === "pending") ? pending : done;

  if(empty) empty.style.display = items.length ? "none" : "block";

  items
    .slice()
    .sort((a,b)=>{
      if(view === "pending"){
        const ao = isOverdue(a.when) ? 1 : 0;
        const bo = isOverdue(b.when) ? 1 : 0;
        if(ao !== bo) return bo - ao;
        const ta = a.when ? new Date(a.when).getTime() : Number.POSITIVE_INFINITY;
        const tb = b.when ? new Date(b.when).getTime() : Number.POSITIVE_INFINITY;
        if(ta !== tb) return ta - tb;
        const ua = new Date(a.updatedAt || a.createdAt || 0).getTime();
        const ub = new Date(b.updatedAt || b.createdAt || 0).getTime();
        return ub - ua;
      }
      return (new Date(b.doneAt||0).getTime()) - (new Date(a.doneAt||0).getTime());
    })
    .forEach((it, idx)=> list.appendChild(renderCommitmentCard(it, idx)));
}

function renderCommitmentCard(item, idx){
  const card = document.createElement("div");
  card.className = "card";

  card.style.background = (idx % 2)
    ? "linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.86))"
    : "linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90))";

  const who = normalizedWho(item);
  const dueText = item.when ? fmtDate(item.when) : "Sin fecha";
  const overdue = !item.done && isOverdue(item.when);

  const chips = [
    `<span class="chip">ğŸ“ ${escapeHtml(fmtDate(item.createdAt))}</span>`,
    item.updatedAt ? `<span class="chip">âœï¸ ${escapeHtml(fmtDate(item.updatedAt))}</span>` : "",
    item.done ? `<span class="chip">âœ… ${escapeHtml(fmtDate(item.doneAt))}</span>` : "",
    item.when && Number(item.remindMin||0) > 0 ? `<span class="chip">${escapeHtml(remindLabel(item.remindMin))}</span>` : "",
    item.afterAt && Number(item.afterMin||0) > 0 ? `<span class="chip">â³ ${escapeHtml(item.afterMin>=60 ? (item.afterMin/60)+"h" : item.afterMin+"m")}</span>` : ""
  ].filter(Boolean).join("");

  card.innerHTML = `
    <div class="cardTop" style="align-items:flex-start;">
      <div class="who" style="min-width:0;">
        <p class="name" title="${escapeHtml(who)}">${escapeHtml(who)}</p>
        <p class="meta">${chips}</p>
      </div>
      <div class="due ${overdue ? "bad" : ""}" style="white-space:nowrap;">
        â° ${escapeHtml(dueText)}${overdue ? " Â· Vencido" : ""}
      </div>
    </div>

    <div class="desc">${escapeHtml(item.what || "â€”")}</div>

    <div class="actions">
      <button class="btn" type="button" data-act="cal">ğŸ“… Calendario</button>
      <button class="btn primary" type="button" data-act="share">ğŸ“¦ Compartir</button>
      ${item.done
        ? `<button class="btn" type="button" data-act="reopen">â†©ï¸ Reabrir</button>`
        : `<button class="btn good" type="button" data-act="done">âœ… Hecho</button>`
      }
      <button class="btn" type="button" data-act="edit">âœï¸ Editar</button>
      <button class="btn danger" type="button" data-act="del">ğŸ—‘ï¸ Eliminar</button>
    </div>
  `;

  card.querySelector('[data-act="cal"]').addEventListener("click", ()=> addToCalendar(item.id));
  card.querySelector('[data-act="share"]').addEventListener("click", ()=> shareSnapshot(item.id));
  card.querySelector('[data-act="edit"]').addEventListener("click", ()=> openEditModal(item.id));
  card.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteItem(item.id));
  if(item.done) card.querySelector('[data-act="reopen"]').addEventListener("click", ()=> reopen(item.id));
  else card.querySelector('[data-act="done"]').addEventListener("click", ()=> markDone(item.id));

  return card;
}

function renderContacts(){
  const list = $("contactsList");
  const empty = $("contactsEmpty");
  if(!list) return;

  list.innerHTML = "";
  if(empty) empty.style.display = contacts.length ? "none" : "block";

  contacts
    .slice()
    .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
    .forEach((c, idx)=> list.appendChild(renderContactCard(c, idx)));
}

function renderContactCard(c, idx){
  const card = document.createElement("div");
  card.className = "card";
  card.style.background = (idx % 2)
    ? "linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90))"
    : "linear-gradient(180deg, rgba(255,255,255,.93), rgba(255,255,255,.86))";

  const note = c.note ? `<span class="chip">ğŸ›ˆ ${escapeHtml(c.note)}</span>` : "";

  card.innerHTML = `
    <div class="cardTop">
      <div class="who" style="min-width:0;">
        <p class="name">${escapeHtml(c.name || "Sin nombre")}</p>
        <p class="meta">
          <span class="chip">ğŸ‘¥ Amigo</span>
          ${note}
        </p>
      </div>
      <button class="btn primary" type="button" data-act="new" style="flex:0 0 auto;">â• Compromiso</button>
    </div>
    <div class="desc">${escapeHtml(c.note || "Amigo guardado en tu mÃ³vil.")}</div>
    <div class="actions">
      <button class="btn" type="button" data-act="edit">âœï¸ Editar</button>
      <button class="btn danger" type="button" data-act="del">ğŸ—‘ï¸ Eliminar</button>
    </div>
  `;

  const openCommitWithFriend = () => openNewCommitmentForContact(c.id);

  card.addEventListener("click", (e)=>{
    const inBtn = e.target.closest("button");
    if(inBtn) return;
    openCommitWithFriend();
  });
  card.style.cursor = "pointer";
  card.setAttribute("role","button");
  card.setAttribute("tabindex","0");
  card.addEventListener("keydown",(e)=>{
    if(e.key==="Enter" || e.key===" "){
      e.preventDefault();
      openCommitWithFriend();
    }
  });

  card.querySelector('[data-act="new"]').addEventListener("click", openCommitWithFriend);
  card.querySelector('[data-act="edit"]').addEventListener("click", ()=> openContactEdit(c.id));
  card.querySelector('[data-act="del"]').addEventListener("click", ()=> deleteContact(c.id));

  return card;
}

function renderAll(){
  renderCommitments();
  renderContacts();
  fillContactSelect();
  updateSettingsUI();
  renderNotifAlertsBadge();
  renderReceivedBadge();
  updateTileCounts();
}

/* =========================
   NAVEGACIÃ“N: Tiles (Pendiente/Hecho/Amigos/Ajustes) â€” (esto era lo que faltaba)
   ========================= */
function bindTileNav(){
  const bind = (id, fn) => {
    const el = $(id);
    if(!el) return;
    el.addEventListener("click", fn);
    el.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" || e.key===" "){ e.preventDefault(); fn(); }
    });
  };

  bind("tilePending", () => { setPane("commitments"); setViewPending(); toast("ğŸ“ Pendientes"); });
  bind("tileDone",    () => { setPane("commitments"); setViewDone();    toast("âœ… Hechos"); });
  bind("tileContacts",() => { setPane("contacts");                   toast("ğŸ‘¥ Amigos"); });
  bind("tileSettings",() => { setPane("settings");                   toast("âš™ï¸ Ajustes"); });
}

/* =========================
   Pills (dejamos Vencidos/Recibidos fijos + acciÃ³n)
   ========================= */
function goToCommitmentsPending(){
  setPane("commitments");
  setViewPending();
  try{ window.scrollTo({ top: 0, behavior: "smooth" }); }catch(e){ window.scrollTo(0,0); }
}
function scrollToFirstOverdue(){
  const list = $("list");
  if(!list) return;
  const first = list.querySelector(".due.bad");
  if(first){
    const card = first.closest(".card");
    if(card){
      try{ card.scrollIntoView({ behavior:"smooth", block:"start" }); }catch(e){}
    }
  }
}
if($("btnOverdue")){
  $("btnOverdue").addEventListener("click", ()=>{
    goToCommitmentsPending();
    const overdueCount = data.filter(x => !x.done && isOverdue(x.when)).length;
    if(overdueCount > 0){
      toast(`â° ${overdueCount} vencido(s)`);
      setTimeout(scrollToFirstOverdue, 250);
    } else toast("Sin vencidos âœ…");
  });
}
if($("btnReceived")){
  $("btnReceived").addEventListener("click", async () => {
    const c = Math.max(0, Number(received?.c || 0));
    const alreadyThere = (pane === "commitments" && view === "pending");
    if(!alreadyThere){
      goToCommitmentsPending();
      toast(c > 0 ? "ğŸ“¥ Paquetes recibidos" : "Sin recibidos");
      return;
    }
    if(c <= 0){ toast("Sin recibidos"); return; }

    const ok = await Confirm.open({
      title: "Recibidos",
      msg: `Has recibido <b>${c}</b> paquete(s).<br>Â¿Marcar como vistos y poner el contador a 0?`,
      yesText: "SÃ­, marcar vistos",
      danger: false
    });
    if(ok){
      clearReceived();
      renderReceivedBadge();
      toast("Recibidos marcados âœ…");
    }
  });
}

/* =========================
   IMPORTANTE: reenganche de handlers base que deben existir sÃ­ o sÃ­
   (si por cualquier cosa se perdieron al pegar partes)
   ========================= */
(function ensureCoreHandlers(){
  // Bottom tabs (solo 2)
  if($("tabCommitments")) $("tabCommitments").onclick = ()=> setPane("commitments");
  if($("tabContacts")) $("tabContacts").onclick = ()=> setPane("contacts");

  // Subtabs
  if($("tabPending")) $("tabPending").onclick = setViewPending;
  if($("tabDone")) $("tabDone").onclick = setViewDone;

  // Texto grande top (por si no quedÃ³)
  if($("btnA11yTop")) $("btnA11yTop").onclick = toggleTextScale;

  bindTileNav();
})();

/* =========================
   BOOT (final)
   ========================= */
// Preferencia texto
const a11y = load(A11Y_KEY, { big:false });
setTextScale(!!a11y.big);

updateSettingsUI();
renderAll();
bindTileNav();

// Demo inicial
if(data.length === 0){
  const now = new Date().toISOString();
  const ev = {
    id: uid(),
    type: T.CREATE,
    at: now,
    payload: {
      i: uid(),
      c: null,
      w: "Ejemplo: Laura",
      s: "Te paso el PDF del seguro",
      n: new Date(Date.now() + 3*60*60*1000).toISOString(),
      r: 15,
      af: 60,
      aa: new Date(Date.now() + 60*60*1000).toISOString(),
      ca: now
    }
  };
  applyEvent(ev);
  renderAll();
}

cleanupFiredMaps();

if(settings.pinEnabled && !isUnlockedNow()){
  showLockOverlay();
} else {
  hideLockOverlay();
}

setInterval(() => {
  if(settings.pinEnabled && !isUnlockedNow()) return;
  checkReminders();
}, 20000);

setTimeout(() => {
  if(settings.pinEnabled && !isUnlockedNow()) return;
  checkReminders();
}, 1200);

})();  // ğŸ”š FIN IIFE que empezaba en PARTE 2
</script>
</body>
</html>