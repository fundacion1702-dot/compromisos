<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compromisos</title>
  <meta name="theme-color" content="#6b5bff"/>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{
      --bg:#0b0c12;
      --surface:#121427;
      --surface2:#171a33;
      --text:#e9ecff;
      --muted:#aab0d6;
      --primary:#6b5bff;
      --primary2:#8a7dff;
      --good:#36d399;
      --bad:#ff5c7a;
      --warn:#ffcc66;
      --stroke:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px;
      --fs-base: 16px; /* se ajusta desde JS (texto grande) */
    }
    *{ box-sizing:border-box; }

    /* ‚úÖ A11y: toda la UI escalar√° porque usamos rem */
    html{ font-size: var(--fs-base); }

    body{
      margin:0;
      font-size: 1rem;
      font-family:
        system-ui, -apple-system, Segoe UI, Roboto, Arial,
        "Noto Color Emoji", "Segoe UI Emoji", "Apple Color Emoji",
        "Noto Emoji", sans-serif;
      background: radial-gradient(62.5rem 37.5rem at 20% -10%, rgba(107,91,255,.35), transparent 60%),
                  radial-gradient(50rem 37.5rem at 90% 0%, rgba(255,204,102,.15), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      padding-bottom:6rem;
    }
    .wrap{ max-width:35rem; margin:0 auto; padding:1rem .875rem 0; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-top:.375rem; }
    .brand{ display:flex; align-items:center; gap:.625rem; min-width:0; }
    .logo{
      width:2.75rem;height:2.75rem;border-radius:.9375rem; display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.70));
      box-shadow: 0 .75rem 1.875rem rgba(107,91,255,.25);
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto; font-weight:950; letter-spacing:.03125rem;
      font-size: 1.125rem;
    }
    .brand h1{ margin:0; font-size:1.25rem; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brand p{ margin:.125rem 0 0; font-size:.84375rem; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .iconbtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: .875rem;
      padding: .6875rem .75rem;
      cursor:pointer;
      box-shadow: 0 .625rem 1.5rem rgba(0,0,0,.18);
      transition: transform .08s ease, background .15s ease;
      display:flex; align-items:center; gap:.5rem;
      font-weight:900;
      font-size: .875rem;
      flex:0 0 auto;
      white-space:nowrap;
    }
    .iconbtn:active{ transform: scale(.98); }
    .iconbtn small{ color:var(--muted); font-weight:800; font-size: .78125rem; }

    .hero{
      margin-top: .75rem;
      padding: .75rem; /* ‚úÖ m√°s compacto */
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
    }

    /* ‚úÖ Barra superior del hero (izq: pills + avisos, der: texto grande) */
    .heroBar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:.625rem;
    }
    .heroLeft{
      display:flex;
      flex-direction:column;
      gap:.5rem;
      min-width:0;
      flex:1;
    }
    .pillRow{
      display:flex;
      align-items:center;
      gap:.5rem;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex; align-items:center; gap:.5rem;
      padding: .5rem .625rem;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(107,91,255,.14);
      color: var(--text);
      font-size: .8125rem;
      font-weight: 850;
      white-space:nowrap;
      user-select:none;
    }

    /* ‚úÖ pill clicable */
    .pill.btnPill{
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
    }
    .pill.btnPill:active{ transform: scale(.99); }

    .pill .badge{
      margin-left:.125rem;
      min-width: 1.375rem;
      padding: .125rem .5rem;
      font-size: .78125rem;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
    }

    /* ‚úÖ estados visuales */
    .pill.muted{
      background: rgba(255,255,255,.06);
      color: var(--muted);
      border-color: rgba(255,255,255,.12);
    }
    .pill.warn{
      background: rgba(255,204,102,.12);
      border-color: rgba(255,204,102,.28);
    }
    .pill.bad{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.30);
    }
    .pill.good{
      background: rgba(54,211,153,.14);
      border-color: rgba(54,211,153,.28);
      color:#eafff6;
    }

    .hero h2{
      margin: .5rem 0 .3125rem; /* ‚úÖ m√°s compacto */
      font-size: 1.125rem;
      line-height:1.25;
    }
    .hero p{
      margin: 0;
      color: var(--muted);
      font-size: .9375rem;
      line-height:1.4;
    }

    .banner{
      margin-top: .75rem;
      padding: .75rem;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: 0 .75rem 1.875rem rgba(0,0,0,.18);
      display:none;
    }
    .banner.show{ display:block; }
    .banner .title{ font-weight:950; margin:0 0 .375rem; font-size: 1rem; }
    .banner .txt{ margin:0; color:var(--muted); font-size:.90625rem; line-height:1.35; }
    .banner .row{ display:flex; gap:.625rem; margin-top:.625rem; flex-wrap:wrap; }

    .btn{
      border-radius: .875rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: .6875rem .75rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .9375rem;
      transition: transform .08s ease, background .15s ease;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      flex:1;
      min-width: 7.5rem;
      white-space:nowrap;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{ background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55)); border-color: rgba(255,255,255,.16); }
    .btn.good{ background: linear-gradient(135deg, rgba(54,211,153,.95), rgba(54,211,153,.55)); border-color: rgba(255,255,255,.16); color:#06150f; }
    .btn.danger{ background: rgba(255,92,122,.12); border-color: rgba(255,92,122,.35); }
    .btn.ghost{ background: rgba(255,255,255,.04); border-color: rgba(255,255,255,.12); }

    .tabs{
      margin-top: .875rem;
      display:flex; gap:.625rem; padding: .375rem;
      border-radius: 1rem;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: 0 .625rem 1.5625rem rgba(0,0,0,.15);
    }
    .tab{
      flex:1;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: .6875rem .75rem;
      border-radius: .875rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .9375rem;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      min-width: 0;
      white-space:nowrap;
    }
    .tab.active{
      color: var(--text);
      background: linear-gradient(135deg, rgba(107,91,255,.85), rgba(138,125,255,.55));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 .75rem 1.875rem rgba(107,91,255,.22);
    }
    .badge{
      display:inline-grid; place-items:center;
      min-width: 1.5rem;
      padding: .125rem .5625rem;
      border-radius: 999px;
      font-size: .8125rem;
      font-weight: 950;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }

    .subtabs{
      margin-top: .75rem;
      display:flex; gap:.625rem; padding: .375rem;
      border-radius: 1rem;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
    }
    .subtab{
      flex:1;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: .625rem .75rem;
      border-radius: .875rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .90625rem;
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      min-width:0;
      white-space:nowrap;
    }
    .subtab.active{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
    }

    .list{ margin-top: .875rem; display:flex; flex-direction:column; gap: .75rem; }

    /* ‚úÖ Tarjetas con m√°s separaci√≥n visual */
    .card{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.035));
      border:1px solid rgba(255,255,255,.14);
      padding: .85rem .85rem .8rem;
      box-shadow: 0 .85rem 2.1rem rgba(0,0,0,.24);
      position:relative;
      overflow:hidden;
    }
    /* Alterna ligeramente el fondo para diferenciar inicio/fin */
    .list .card:nth-child(odd){
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.04));
      border-color: rgba(255,255,255,.16);
    }
    /* Barra lateral */
    .card::before{
      content:"";
      position:absolute;
      left:0; top:.65rem; bottom:.65rem;
      width:.3rem;
      border-radius: 999px;
      background: rgba(107,91,255,.75);
      box-shadow: 0 .625rem 1.25rem rgba(107,91,255,.18);
    }
    .card.overdue::before{ background: rgba(255,92,122,.85); box-shadow: 0 .625rem 1.25rem rgba(255,92,122,.18); }
    .card.done::before{ background: rgba(54,211,153,.85); box-shadow: 0 .625rem 1.25rem rgba(54,211,153,.18); }

    .cardTop{ display:flex; justify-content:space-between; gap:.625rem; align-items:flex-start; }
    .who{ min-width:0; }
    .who .name{
      margin:0; font-size: 1rem; font-weight: 950; letter-spacing:.0125rem;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .who .meta{
      margin: .25rem 0 0; font-size: .8125rem; color: var(--muted);
      display:flex; gap:.5rem; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:.375rem;
      padding: .25rem .5625rem; border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 850;
      font-size: .78125rem;
    }
    .due{
      font-size: .84375rem;
      font-weight: 950;
      padding: .4375rem .6875rem;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,204,102,.12);
      color: var(--text);
      white-space:nowrap;
    }
    .due.bad{ background: rgba(255,92,122,.14); border-color: rgba(255,92,122,.30); }
    .desc{
      margin: .7rem 0 0;
      font-size: .95rem;
      line-height:1.38;
      color: var(--text);
      opacity: .97;
      word-break: break-word;
      padding-left: .15rem;
    }
    .actions{ margin-top: .7rem; display:flex; gap: .625rem; flex-wrap:wrap; }
    .empty{
      padding: 1.125rem .875rem;
      border-radius: var(--r);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      text-align:center;
      line-height:1.35;
      display:none;
      font-size: .9375rem;
    }

    .fab{
      position: fixed;
      right: 1rem;
      bottom: 1.125rem;
      width: 3.875rem;
      height: 3.875rem;
      border-radius: 1.25rem;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55));
      box-shadow: 0 1.125rem 2.8125rem rgba(107,91,255,.25), 0 .875rem 2.5rem rgba(0,0,0,.35);
      color: white;
      font-size: 1.875rem;
      font-weight: 950;
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      z-index: 50;
    }
    .fab:active{ transform: scale(.98); }

    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: .875rem;
      z-index: 999;
    }
    .backdrop.show{ display:flex; }

    .sheet{
      width: min(35rem, 100%);
      border-radius: 1.375rem;
      background: linear-gradient(180deg, rgba(23,26,51,.98), rgba(18,20,39,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 1.375rem 3.75rem rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheetHead{
      padding: .75rem .875rem;
      display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .sheetHead h3{ margin:0; font-size: 1.0625rem; font-weight: 950; letter-spacing:.0125rem; }
    .close{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: .875rem;
      padding: .5625rem .6875rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .875rem;
    }
    .sheetBody{ padding: .875rem; display:flex; flex-direction:column; gap: .625rem; }
    .field label{
      display:block;
      font-size: .84375rem;
      font-weight: 950;
      color: var(--muted);
      margin-bottom: .375rem;
    }
    .field input, .field textarea, .field select{
      width: 100%;
      padding: .8125rem .75rem;
      border-radius: .875rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      font-size: 1rem;
    }
    .field textarea{ min-height: 5.75rem; resize: vertical; }

    .hint{
      font-size: .84375rem;
      color: var(--muted);
      margin-top: .375rem;
      line-height:1.35;
    }

    .sheetFoot{ padding: .75rem .875rem .875rem; display:flex; gap:.625rem; flex-wrap:wrap; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 5.625rem;
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding: .625rem .75rem;
      border-radius: .875rem;
      box-shadow: 0 1.125rem 2.5rem rgba(0,0,0,.45);
      font-weight: 850;
      font-size: .875rem;
      display:none;
      z-index: 1000;
      max-width: calc(100% - 1.75rem);
      text-align:center;
    }
    .toast.show{ display:block; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.8125rem;
      color:var(--muted);
      word-break: break-all;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:.625rem;
      border-radius:.875rem;
      margin-top:.625rem;
      display:none;
    }
    .mono.show{ display:block; }

    /* üîª statsKicker ya no se usa abajo (todo arriba en pills) */
    .kicker{
      font-size: .8125rem;
      color: var(--muted);
      margin: .625rem 0 0;
      display:none !important;
    }

    .rowline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
      padding: .75rem;
      border-radius: 1rem;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: 0 .625rem 1.5625rem rgba(0,0,0,.12);
    }
    .rowline .ttl{ font-weight: 950; }
    .rowline .sub{ font-size: .84375rem; color: var(--muted); margin-top: .1875rem; line-height:1.25; }
    .stack{ display:flex; flex-direction:column; min-width:0; }
    .right{ display:flex; gap:.625rem; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .switch{
      width: 3.25rem;
      height: 2rem;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      position: relative;
      cursor:pointer;
      flex:0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      width: 1.625rem;
      height: 1.625rem;
      border-radius: 50%;
      top: .125rem;
      left: .125rem;
      background: rgba(255,255,255,.90);
      box-shadow: 0 .625rem 1.25rem rgba(0,0,0,.35);
      transition: transform .18s ease, background .18s ease;
    }
    .switch.on{
      background: rgba(107,91,255,.35);
      border-color: rgba(255,255,255,.22);
    }
    .switch.on::after{ transform: translateX(1.25rem); background: rgba(255,255,255,.96); }

    .lockOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 1rem;
      z-index: 2000;
    }
    .lockOverlay.show{ display:flex; }
    .lockCard{
      width: min(26.25rem, 100%);
      border-radius: 1.375rem;
      background: linear-gradient(180deg, rgba(23,26,51,.98), rgba(18,20,39,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 1.375rem 3.75rem rgba(0,0,0,.55);
      overflow:hidden;
    }
    .lockHead{
      padding: .875rem .875rem .625rem;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .lockHead h3{ margin:0; font-size: 1.125rem; font-weight: 950; }
    .lockHead p{ margin:.375rem 0 0; color: var(--muted); font-size: .875rem; line-height:1.25; }
    .lockBody{ padding: .875rem; display:flex; flex-direction:column; gap: .75rem; }
    .pinDots{ display:flex; justify-content:center; gap:.625rem; margin-top: .125rem; }
    .dot{
      width: .875rem; height: .875rem;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
    }
    .dot.on{
      background: rgba(107,91,255,.85);
      border-color: rgba(255,255,255,.30);
      box-shadow: 0 .625rem 1.5625rem rgba(107,91,255,.22);
    }
    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: .625rem;
      margin-top: .375rem;
    }
    .key{
      border-radius: 1rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: .875rem .75rem;
      font-size: 1.125rem;
      font-weight: 950;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      text-align:center;
    }
    .key:active{ transform: scale(.99); }
    .key.primary{ background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55)); border-color: rgba(255,255,255,.18); }
    .key.danger{ background: rgba(255,92,122,.12); border-color: rgba(255,92,122,.35); }
    .lockFoot{ padding: .75rem .875rem .875rem; display:flex; gap:.625rem; flex-wrap:wrap; }

    .seg{
      display:flex;
      gap:.625rem;
      padding: .375rem;
      border-radius: 1rem;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .seg button{
      flex:1;
      border-radius: .875rem;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: .625rem .75rem;
      cursor:pointer;
      font-weight: 950;
      font-size: .90625rem;
      white-space:nowrap;
    }
    .seg button.active{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
    }

    .twoCol{ display:flex; gap:.625rem; flex-wrap:wrap; }
    .twoCol > *{ flex:1; min-width: 10rem; }

    /* Modal confirm propio */
    .confirmMsg{ font-size:.9375rem; color:var(--text); opacity:.95; line-height:1.35; }
    .dangerTxt{ color: rgba(255,92,122,.95); font-weight: 950; }

    /* Bot√≥n texto grande */
    .iconbtn.tgl.on{
      background: rgba(107,91,255,.20);
      border-color: rgba(255,255,255,.18);
    }

    /* ‚úÖ Manual plegable */
    .helpWrap{ margin-top:.625rem; }
    .helpMiniBtn{ width:100%; justify-content:space-between; }
    .helpBox{
      margin-top:.625rem;
      padding:.75rem;
      border-radius: 1rem;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
    }
    .helpBox h3{
      margin:0 0 .375rem;
      font-size: .9375rem;
      font-weight: 950;
    }
    .helpBox ul{
      margin:.375rem 0 0 1.1rem;
      padding:0;
      color: var(--muted);
      font-size: .90625rem;
      line-height:1.35;
    }
    .helpBox li{ margin:.25rem 0; }

    /* ‚úÖ Contacto clickable */
    .contactCard{
      cursor:pointer;
      user-select:none;
    }
    .contactCard:active{ transform: scale(.995); }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">C</div>
        <div style="min-width:0">
          <h1>Compromisos</h1>
          <p>Paquetes entre m√≥viles ¬∑ sin base de datos</p>
        </div>
      </div>

      <!-- ‚úÖ En header dejamos solo instalar (texto grande va en el hero) -->
      <div style="display:flex; gap:.625rem; align-items:center; flex:0 0 auto;">
        <button class="iconbtn" id="btnInstall" style="display:none">‚¨áÔ∏è <small>Instalar</small></button>
      </div>
    </header>

    <section class="hero">
      <!-- ‚úÖ TODO lo de ‚Äúnotificaciones/pendientes/recibidos/vencidos‚Äù arriba -->
      <div class="heroBar">
        <div class="heroLeft">
          <div class="pillRow" aria-label="Avisos y notificaciones">
            <div class="pill btnPill muted" id="btnNotifPend" title="Avisos pendientes (toca para limpiar)">
              üîî Avisos <span class="badge" id="bNotifPend">0</span>
            </div>

            <div class="pill btnPill muted" id="btnPendingTop" title="Compromisos pendientes (toca para ir)">
              üìù Pendientes <span class="badge" id="bPendingTop">0</span>
            </div>

            <div class="pill btnPill muted" id="btnOverdueTop" title="Compromisos vencidos (toca para ver)">
              ‚è∞ Vencidos <span class="badge" id="bOverdueTop">0</span>
            </div>

            <div class="pill btnPill muted" id="btnReceivedTop" title="Cambios/compromisos recibidos (toca para limpiar)">
              üì• Recibidos <span class="badge" id="bReceivedTop">0</span>
            </div>

            <div class="pill btnPill muted" id="btnInboxTop" title="Paquete pendiente de importar (toca para abrir banner)" style="display:none">
              üì¶ Importaci√≥n <span class="badge" id="bInboxTop">1</span>
            </div>
          </div>
        </div>

        <!-- ‚úÖ Zona derecha (c√≠rculo rojo en tu captura): texto grande -->
        <button class="iconbtn tgl" id="btnA11y" title="Texto grande">üëì <small id="a11yLabel">Texto</small></button>
      </div>

      <h2>Comparte cambios como un enlace (sin cuentas).</h2>
      <p>Ahora puedes enviar un compromiso con un <b>aviso ‚Äúdesde ahora‚Äù</b> (5 min / 1 hora‚Ä¶) que se programa al importar.</p>

      <!-- ‚úÖ Manual plegable -->
      <div class="helpWrap">
        <button class="iconbtn helpMiniBtn" id="btnHelpToggle" title="Gu√≠a r√°pida">
          üìò <span id="helpToggleLabel" style="font-weight:950">Ver gu√≠a r√°pida</span>
          <small id="helpToggleHint">Toques</small>
        </button>
        <div class="helpBox" id="helpBox" style="display:none">
          <h3>Gu√≠a r√°pida</h3>
          <ul>
            <li><b>+</b> crea un compromiso (o un contacto si est√°s en ‚ÄúAmigos‚Äù).</li>
            <li><b>üì¶ Compartir</b> env√≠a el paquete por WhatsApp/Telegram.</li>
            <li>El receptor abre el enlace y se <b>importa</b> en su m√≥vil.</li>
            <li><b>‚è≥ Desde ahora</b> crea un aviso relativo (5 min / 1 h‚Ä¶).</li>
            <li><b>üìÖ Calendario</b> es la opci√≥n m√°s fiable para recordatorios.</li>
          </ul>
        </div>
      </div>

      <!-- ya no se usa: se mantiene por compat, pero oculto por CSS -->
      <div class="kicker" id="statsKicker" style="display:none"></div>
    </section>

    <section class="banner" id="installBanner">
      <p class="title" id="installTitle">Inst√°lala para usarla como app</p>
      <p class="txt" id="installText">
        Si la abres dentro de WhatsApp/Telegram, toca <b>Abrir en Chrome</b> para poder instalar e importar bien.
      </p>
      <div class="row">
        <button class="btn primary" id="btnInstallBanner" style="display:none">‚¨áÔ∏è Instalar</button>
        <button class="btn primary" id="btnOpenChrome" style="display:none">üåê Abrir en Chrome</button>
        <button class="btn" id="btnCopyLink" style="display:none">üìã Copiar enlace</button>
        <button class="btn" id="btnHideBanner">Ocultar</button>
      </div>
    </section>

    <nav class="tabs" aria-label="Vistas">
      <button class="tab active" id="tabCommitments">üìù Compromisos</button>
      <button class="tab" id="tabContacts">üë• Amigos <span class="badge" id="bContacts">0</span></button>
      <button class="tab" id="tabSettings">‚öôÔ∏è Ajustes</button>
    </nav>

    <div id="commitmentsPane">
      <nav class="subtabs" aria-label="Pesta√±as">
        <button class="subtab active" id="tabPending">Pendientes <span class="badge" id="bPending">0</span></button>
        <button class="subtab" id="tabDone">Hechos <span class="badge" id="bDone">0</span></button>
      </nav>

      <div class="list" id="list"></div>
      <div class="empty" id="empty">No tienes compromisos aqu√≠. Pulsa <b>+</b> para crear uno nuevo.</div>
    </div>

    <div id="contactsPane" style="display:none">
      <div class="list" id="contactsList"></div>
      <div class="empty" id="contactsEmpty">No tienes contactos a√∫n. Pulsa <b>+</b> para crear el primero.</div>
    </div>

    <div id="settingsPane" style="display:none">
      <div class="list">

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîî Notificaciones</div>
            <div class="sub">Recordatorios locales (fiables con la app abierta; en segundo plano depende del m√≥vil). Usa Calendario si quieres 100%.</div>
          </div>
          <div class="right">
            <div class="switch" id="swNotif" role="switch" aria-checked="false" tabindex="0"></div>
            <button class="btn" id="btnNotifPerm" style="flex:0 0 auto; min-width: 10rem;">Permitir</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîí Bloqueo por PIN</div>
            <div class="sub">Protege la app con un PIN de 4 d√≠gitos. Puedes activarlo o desactivarlo cuando quieras.</div>
          </div>
          <div class="right">
            <div class="switch" id="swPin" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">‚è±Ô∏è Auto-bloqueo</div>
            <div class="sub">Cuando sales de la app, se bloquea pasado este tiempo.</div>
          </div>
          <div class="right">
            <select id="selAutoLock" style="min-width:10rem">
              <option value="0">Inmediato</option>
              <option value="1">1 minuto</option>
              <option value="5">5 minutos</option>
              <option value="15">15 minutos</option>
              <option value="60">60 minutos</option>
            </select>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üïí Recordar desbloqueo</div>
            <div class="sub">Durante este tiempo no pedir√° PIN (si el PIN est√° activado).</div>
          </div>
          <div class="right">
            <select id="selRemember" style="min-width:10rem">
              <option value="0">No recordar</option>
              <option value="10">10 minutos</option>
              <option value="30">30 minutos</option>
              <option value="60">60 minutos</option>
            </select>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîÅ Cambiar PIN</div>
            <div class="sub">Requiere el PIN actual (si est√° activado).</div>
          </div>
          <div class="right">
            <button class="btn" id="btnChangePin">Cambiar</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîí Bloquear ahora</div>
            <div class="sub">Te pide el PIN en la pr√≥xima apertura (o ahora mismo si el PIN est√° activado).</div>
          </div>
          <div class="right">
            <button class="btn danger" id="btnLockNow">Bloquear</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üßπ Restablecer app</div>
            <div class="sub">Borra compromisos, contactos y ajustes del m√≥vil (irreversible).</div>
          </div>
          <div class="right">
            <button class="btn danger" id="btnResetAll">Borrar todo</button>
          </div>
        </div>

        <div class="hint" style="margin-top:.375rem" id="notifHint"></div>

      </div>
    </div>
  </div>

  <button class="fab" id="fab" aria-label="Nuevo">+</button>

  <!-- Modal Compromiso -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="modalTitle">Nuevo compromiso</h3>
        <button class="close" id="btnClose">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="field">
          <label for="fContact">¬øCon qui√©n?</label>
          <select id="fContact"></select>
          <div class="hint" id="contactHint">Puedes elegir un contacto o escribir uno nuevo.</div>
        </div>

        <div class="field" id="customWhoField" style="display:none">
          <label for="fWho">Nombre (nuevo contacto)</label>
          <input id="fWho" type="text" placeholder="Ej: Laura / Mam√° / Juan (del trabajo)" autocomplete="off"/>
        </div>

        <div class="field">
          <label for="fWhat">¬øQu√© se acord√≥?</label>
          <textarea id="fWhat" placeholder="Ej: Te paso el PDF / Te devuelvo 20‚Ç¨ / Quedamos el jueves‚Ä¶"></textarea>
        </div>

        <div class="twoCol">
          <div class="field">
            <label for="fWhen">¬øPara cu√°ndo?</label>
            <input id="fWhen" type="datetime-local" />
            <div class="hint">Puedes dejarlo sin fecha.</div>
          </div>

          <div class="field">
            <label for="fRemind">Recordatorio (por fecha)</label>
            <select id="fRemind">
              <option value="0">Ninguno</option>
              <option value="5">5 min antes</option>
              <option value="15">15 min antes</option>
              <option value="60">1 hora antes</option>
              <option value="1440">1 d√≠a antes</option>
            </select>
            <div class="hint">Requiere fecha.</div>
          </div>
        </div>

        <div class="field">
          <label for="fAfter">Avisar ‚Äúdesde ahora‚Äù (viaja en el enlace)</label>
          <select id="fAfter">
            <option value="0">No</option>
            <option value="5">En 5 minutos</option>
            <option value="15">En 15 minutos</option>
            <option value="60">En 1 hora</option>
            <option value="180">En 3 horas</option>
            <option value="1440">Ma√±ana (24h)</option>
          </select>
          <div class="hint">El receptor debe abrir el enlace para que se programe en su m√≥vil.</div>
        </div>

        <div class="hint">
          Al guardar, se abrir√° el modal de <b>Compartir</b> (con copiar enlace directo).
        </div>
      </div>

      <div class="sheetFoot">
        <button class="btn danger" id="btnCancel">Cancelar</button>
        <button class="btn good" id="btnSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Contacto -->
  <div class="backdrop" id="cBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="cModalTitle">Nuevo contacto</h3>
        <button class="close" id="cBtnClose">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="field">
          <label for="cName">Nombre</label>
          <input id="cName" type="text" placeholder="Ej: Laura" autocomplete="off"/>
        </div>
        <div class="field">
          <label for="cNote">Nota (opcional)</label>
          <input id="cNote" type="text" placeholder="Ej: Trabajo / Vecina / Familia" autocomplete="off"/>
        </div>
        <div class="hint">Esto solo se guarda en tu m√≥vil.</div>
      </div>

      <div class="sheetFoot">
        <button class="btn danger" id="cBtnCancel">Cancelar</button>
        <button class="btn good" id="cBtnSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal PIN -->
  <div class="backdrop" id="pinBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="pinTitle">Configurar PIN</h3>
        <button class="close" id="pinClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="hint" id="pinHint" style="margin-top:0"></div>

        <div class="field" id="pinOldWrap" style="display:none">
          <label for="pinOld">PIN actual</label>
          <input id="pinOld" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNewWrap">
          <label for="pinNew">Nuevo PIN (4 d√≠gitos)</label>
          <input id="pinNew" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNew2Wrap">
          <label for="pinNew2">Repite el PIN</label>
          <input id="pinNew2" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="hint" id="pinHelp">Consejo: usa un PIN que solo t√∫ sepas. Puedes desactivarlo en Ajustes.</div>
      </div>
      <div class="sheetFoot">
        <button class="btn danger" id="pinCancel">Cancelar</button>
        <button class="btn good" id="pinOk">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Compartir -->
  <div class="backdrop" id="shareBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3>Compartir paquete</h3>
        <button class="close" id="shareClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="hint" id="shareTitle" style="margin-top:0"></div>

        <div class="seg" role="tablist" aria-label="Formato">
          <button id="shareShort" class="active" type="button">Corto</button>
          <button id="shareLong" type="button">Detallado</button>
        </div>

        <div class="mono show" id="shareTextBox"></div>

        <div class="hint" style="margin-top:.125rem">
          Enlace (puedes copiarlo directo):
        </div>
        <div class="mono show" id="shareUrlBox"></div>

        <div class="hint">Pulsa <b>Compartir</b> para enviarlo por WhatsApp/Telegram. Si no aparece, usa copiar.</div>
      </div>
      <div class="sheetFoot">
        <button class="btn" id="shareCopyUrl">üîó Copiar enlace</button>
        <button class="btn" id="shareCopyAll">üìã Copiar texto+enlace</button>
        <button class="btn primary" id="shareSend">üì§ Compartir</button>
        <button class="btn danger" id="shareCancel">Hecho</button>
      </div>
    </div>
  </div>

  <!-- Overlay bloqueo -->
  <div class="lockOverlay" id="lockOverlay" aria-hidden="true">
    <div class="lockCard" role="dialog" aria-modal="true">
      <div class="lockHead">
        <h3>üîí App bloqueada</h3>
        <p>Introduce tu PIN para continuar.</p>
      </div>
      <div class="lockBody">
        <div class="pinDots" aria-label="PIN">
          <div class="dot" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
          <div class="dot" id="d4"></div>
        </div>

        <div class="keypad" id="keypad">
          <button class="key" data-k="1">1</button>
          <button class="key" data-k="2">2</button>
          <button class="key" data-k="3">3</button>
          <button class="key" data-k="4">4</button>
          <button class="key" data-k="5">5</button>
          <button class="key" data-k="6">6</button>
          <button class="key" data-k="7">7</button>
          <button class="key" data-k="8">8</button>
          <button class="key" data-k="9">9</button>
          <button class="key danger" data-k="del">‚å´</button>
          <button class="key" data-k="0">0</button>
          <button class="key primary" data-k="ok">OK</button>
        </div>
      </div>
      <div class="lockFoot">
        <button class="btn ghost" id="btnLockCopyLink">üìã Copiar enlace actual</button>
        <button class="btn danger" id="btnLockReset">Borrar todo</button>
      </div>
    </div>
  </div>

  <!-- Modal Confirm (propio) -->
  <div class="backdrop" id="confirmBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="confirmTitle">Confirmar</h3>
        <button class="close" id="confirmClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="confirmMsg" id="confirmMsg"></div>
      </div>
      <div class="sheetFoot">
        <button class="btn" id="confirmNo">Cancelar</button>
        <button class="btn danger" id="confirmYes">S√≠, continuar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    (function(){
      "use strict";

      const $ = (id) => document.getElementById(id);

      const KEY = "compromisos_local_v5";
      const EVENTS_KEY = "compromisos_events_v5";
      const CONTACTS_KEY = "compromisos_contacts_v5";
      const SETTINGS_KEY = "compromisos_settings_v3";
      const REMIND_FIRED_KEY = "compromisos_remind_fired_v2";
      const AFTER_FIRED_KEY = "compromisos_after_fired_v1";

      // ‚úÖ Buz√≥n para importaci√≥n ‚Äúdesde in-app browser‚Äù
      const INBOX_PACK_KEY = "compromisos_inbox_pack_v1";
      const INBOX_TS_KEY   = "compromisos_inbox_ts_v1";

      // ‚úÖ Accesibilidad: texto grande
      const A11Y_KEY = "compromisos_a11y_v1";

      // ‚úÖ Manual plegable
      const HELP_KEY = "compromisos_help_v1";

      // ‚úÖ Avisos locales (notifs disparadas)
      const PENDING_NOTIF_KEY = "compromisos_pending_notifs_v1";

      // ‚úÖ Recibidos (cambios importados)
      const RECEIVED_KEY = "compromisos_received_v1";

      // Tipos num√©ricos para acortar paquetes
      const T = { CREATE:0, DONE:1, REOPEN:2, DELETE:3, EDIT:4 };

      function uid(){
        return "c" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function pad2(n){ return String(n).padStart(2,"0"); }

      function fmtDate(dt){
        if(!dt) return "Sin fecha";
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return "Sin fecha";
        const now = new Date();
        const sameYear = d.getFullYear() === now.getFullYear();
        const day = pad2(d.getDate());
        const mon = pad2(d.getMonth()+1);
        const hh = pad2(d.getHours());
        const mm = pad2(d.getMinutes());
        return (sameYear ? `${day}/${mon}` : `${day}/${mon}/${d.getFullYear()}`) + ` ${hh}:${mm}`;
      }
      function isOverdue(dt){
        if(!dt) return false;
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return false;
        return d.getTime() < Date.now();
      }

      function toast(msg){
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(()=> t.classList.remove("show"), 2400);
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // Base64URL (utf8-safe)
      function b64urlEncode(str){
        const b64 = btoa(unescape(encodeURIComponent(str)));
        return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
      }
      function b64urlDecode(b64url){
        let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
        while(b64.length % 4) b64 += "=";
        return decodeURIComponent(escape(atob(b64)));
      }

      function load(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          const v = JSON.parse(raw);
          return v ?? fallback;
        }catch(e){ return fallback; }
      }
      function save(key, value){
        localStorage.setItem(key, JSON.stringify(value));
      }

      // --------- Estado ‚Äúavisos‚Äù arriba ----------
      // A) Avisos (notificaciones disparadas) -> ya lo ten√≠as, lo mantenemos
      let pendingNotifs = load(PENDING_NOTIF_KEY, { c:0, at:0 });

      // B) Recibidos (importaciones / cambios aplicados por link)
      let received = load(RECEIVED_KEY, { c:0, at:0 });

      function setPillState(el, count, kind){
        const c = Math.max(0, Number(count || 0));
        el.classList.toggle("muted", c <= 0);
        el.classList.toggle("warn", kind === "warn" && c > 0);
        el.classList.toggle("bad",  kind === "bad"  && c > 0);
        el.classList.toggle("good", kind === "good" && c > 0);
      }

      function renderTopPills(){
        // Avisos
        const a = Math.max(0, Number(pendingNotifs?.c || 0));
        $("bNotifPend").textContent = String(a);
        setPillState($("btnNotifPend"), a, "good");

        // Recibidos
        const r = Math.max(0, Number(received?.c || 0));
        $("bReceivedTop").textContent = String(r);
        setPillState($("btnReceivedTop"), r, "good");

        // Pendientes / Vencidos se actualizan desde renderCommitments()
        // Inbox (paquete pendiente)
        let hasInbox = false;
        try{ hasInbox = !!localStorage.getItem(INBOX_PACK_KEY); }catch(e){ hasInbox = false; }
        $("btnInboxTop").style.display = hasInbox ? "" : "none";
        if(hasInbox){
          $("bInboxTop").textContent = "1";
          setPillState($("btnInboxTop"), 1, "warn");
        }
      }

      function incPendingBadge(){
        pendingNotifs.c = Math.max(0, Number(pendingNotifs.c || 0)) + 1;
        pendingNotifs.at = Date.now();
        save(PENDING_NOTIF_KEY, pendingNotifs);
        renderTopPills();
      }

      function clearPendingBadge(){
        pendingNotifs.c = 0;
        pendingNotifs.at = Date.now();
        save(PENDING_NOTIF_KEY, pendingNotifs);
        renderTopPills();
        toast("Avisos limpiados");
      }

      function incReceived(){
        received.c = Math.max(0, Number(received.c || 0)) + 1;
        received.at = Date.now();
        save(RECEIVED_KEY, received);
        renderTopPills();
      }

      function clearReceived(){
        received.c = 0;
        received.at = Date.now();
        save(RECEIVED_KEY, received);
        renderTopPills();
        toast("Recibidos limpiados");
      }

      // --------- Confirm modal (propio) ----------
      const Confirm = (function(){
        let resolver = null;

        function open({ title, msg, yesText, danger }){
          $("confirmTitle").textContent = title || "Confirmar";
          $("confirmMsg").innerHTML = msg || "";
          $("confirmYes").textContent = yesText || "S√≠, continuar";
          $("confirmYes").classList.toggle("danger", !!danger);

          $("confirmBackdrop").classList.add("show");
          $("confirmBackdrop").setAttribute("aria-hidden","false");
          return new Promise((resolve)=>{ resolver = resolve; });
        }
        function close(val){
          $("confirmBackdrop").classList.remove("show");
          $("confirmBackdrop").setAttribute("aria-hidden","true");
          const r = resolver;
          resolver = null;
          if(r) r(!!val);
        }

        $("confirmClose").addEventListener("click", ()=> close(false));
        $("confirmNo").addEventListener("click", ()=> close(false));
        $("confirmYes").addEventListener("click", ()=> close(true));
        $("confirmBackdrop").addEventListener("click", (e)=>{ if(e.target === $("confirmBackdrop")) close(false); });

        return { open };
      })();

      // --------- Accesibilidad (texto grande) ----------
      function setTextScale(on){
        const isOn = !!on;
        const root = document.documentElement;

        root.style.setProperty("--fs-base", isOn ? "18px" : "16px");

        const b = $("btnA11y");
        b.classList.toggle("on", isOn);
        $("a11yLabel").textContent = isOn ? "Grande" : "Texto";

        save(A11Y_KEY, { big: isOn });
      }
      function toggleTextScale(){
        const s = load(A11Y_KEY, { big:false });
        setTextScale(!s.big);
      }

      // --------- Manual plegable ----------
      function setHelpVisible(on){
        const show = !!on;
        $("helpBox").style.display = show ? "" : "none";
        $("helpToggleLabel").textContent = show ? "Ocultar gu√≠a r√°pida" : "Ver gu√≠a r√°pida";
        $("helpToggleHint").textContent = show ? "Menos" : "Ayuda";
        save(HELP_KEY, { show });
      }
      function toggleHelp(){
        const s = load(HELP_KEY, { show:false });
        setHelpVisible(!s.show);
      }

      // --------- Ajustes (PIN / notifs) ----------
      const defaultSettings = {
        notifEnabled: false,
        pinEnabled: false,
        pinHash: null,
        autoLockMin: 0,
        rememberMin: 10,
        unlockUntil: 0
      };
      let settings = Object.assign({}, defaultSettings, load(SETTINGS_KEY, {}));

      let sessionUnlocked = false;
      let lockAtTs = 0;

      async function sha256Base64Url(str){
        try{
          if(!crypto || !crypto.subtle) throw new Error("no subtle");
          const enc = new TextEncoder();
          const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
          const bytes = Array.from(new Uint8Array(buf));
          const b64 = btoa(String.fromCharCode(...bytes));
          return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
        }catch(e){
          let h = 0;
          const s = String(str);
          for(let i=0;i<s.length;i++){
            h = ((h<<5)-h) + s.charCodeAt(i);
            h |= 0;
          }
          return "fh_" + String(h);
        }
      }

      function normalizePin(pin){
        return String(pin||"").trim().replaceAll(/\D/g,"").slice(0,4);
      }

      async function verifyPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) return false;
        const h = await sha256Base64Url("pin:" + p);
        return settings.pinHash && h === settings.pinHash;
      }

      async function setPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) throw new Error("pin");
        settings.pinHash = await sha256Base64Url("pin:" + p);
        save(SETTINGS_KEY, settings);
      }

      function isUnlockedNow(){
        if(!settings.pinEnabled) return true;
        const now = Date.now();
        if(settings.unlockUntil && now < settings.unlockUntil) return true;
        return sessionUnlocked === true;
      }

      function applyUnlock(){
        if(!settings.pinEnabled) return;
        const now = Date.now();
        const rem = Number(settings.rememberMin || 0);
        if(rem > 0){
          settings.unlockUntil = now + rem*60*1000;
          sessionUnlocked = false;
        } else {
          settings.unlockUntil = 0;
          sessionUnlocked = true;
        }
        save(SETTINGS_KEY, settings);
      }

      function forceLock(){
        if(!settings.pinEnabled) return;
        settings.unlockUntil = 0;
        sessionUnlocked = false;
        lockAtTs = 0;
        save(SETTINGS_KEY, settings);
        showLockOverlay();
      }

      function setPinEnabled(on){
        settings.pinEnabled = !!on;
        if(!settings.pinEnabled){
          settings.pinHash = null;
          settings.unlockUntil = 0;
          sessionUnlocked = false;
          lockAtTs = 0;
        }
        save(SETTINGS_KEY, settings);
        updateSettingsUI();
      }

      function setNotifEnabled(on){
        settings.notifEnabled = !!on;
        save(SETTINGS_KEY, settings);
        updateSettingsUI();
      }

      function notifPermission(){
        try{ return Notification.permission; }catch(e){ return "unsupported"; }
      }
      function notifSupported(){
        return typeof Notification !== "undefined";
      }

      async function requestNotifPermission(){
        if(!notifSupported()){
          toast("Tu navegador no soporta notificaciones");
          return false;
        }
        try{
          const p = await Notification.requestPermission();
          updateSettingsUI();
          if(p === "granted"){ toast("Notificaciones permitidas ‚úÖ"); return true; }
          toast("Permiso no concedido");
          return false;
        }catch(e){
          toast("No se pudo pedir permiso");
          return false;
        }
      }

      function updateSettingsUI(){
        const swP = $("swPin");
        swP.classList.toggle("on", !!settings.pinEnabled);
        swP.setAttribute("aria-checked", settings.pinEnabled ? "true":"false");

        const swN = $("swNotif");
        swN.classList.toggle("on", !!settings.notifEnabled);
        swN.setAttribute("aria-checked", settings.notifEnabled ? "true":"false");

        $("selAutoLock").value = String(settings.autoLockMin ?? 0);
        $("selRemember").value = String(settings.rememberMin ?? 10);

        const hint = $("notifHint");
        const perm = notifPermission();
        const sup = notifSupported();
        if(!sup){
          hint.textContent = "‚ö†Ô∏è Este navegador no soporta notificaciones. Usa ‚ÄúüìÖ Calendario‚Äù en cada compromiso.";
          $("btnNotifPerm").style.display = "none";
        }else{
          $("btnNotifPerm").style.display = "";
          if(perm === "granted"){
            hint.textContent = settings.notifEnabled
              ? "‚úÖ Notificaciones activadas."
              : "‚ÑπÔ∏è Tienes permiso concedido, pero est√°n desactivadas. Act√≠valas con el switch.";
          } else if(perm === "denied"){
            hint.textContent = "üö´ Notificaciones bloqueadas. Perm√≠telas en Ajustes de Android/Chrome o reinstala la PWA. Usa Calendario como alternativa.";
          } else {
            hint.textContent = "‚ÑπÔ∏è Pulsa ‚ÄúPermitir‚Äù para recibir recordatorios. Si no, usa Calendario.";
          }
        }
      }

      // --------- Datos ----------
      let data = load(KEY, []);
      let events = load(EVENTS_KEY, []);
      let contacts = load(CONTACTS_KEY, []);
      let firedMap = load(REMIND_FIRED_KEY, {});
      let afterFired = load(AFTER_FIRED_KEY, {});

      let view = "pending";
      let pane = "commitments";

      function contactById(id){ return contacts.find(c => c.id === id) || null; }

      function normalizedWho(item){
        if(item.whoId){
          const c = contactById(item.whoId);
          if(c && c.name) return c.name;
        }
        return item.whoName || "Sin nombre";
      }

      function remindLabel(min){
        const m = Number(min||0);
        if(!m) return "";
        if(m === 5) return "üîî 5m";
        if(m === 15) return "üîî 15m";
        if(m === 60) return "üîî 1h";
        if(m === 1440) return "üîî 1d";
        return "üîî";
      }

        function baseUrl(){
        const h = location.href.split("#")[0];
        return h.split("?")[0];
      }

      function detectInAppBrowser(){
        const ua = navigator.userAgent || "";
        // Heur√≠stica simple: WhatsApp/Telegram/Facebook/Instagram webviews
        return /WhatsApp|FBAN|FBAV|Instagram|Telegram|Line|Twitter|TikTok|Snapchat/i.test(ua);
      }

      function safeClipboardWrite(text){
        return (navigator.clipboard && navigator.clipboard.writeText)
          ? navigator.clipboard.writeText(text)
          : Promise.reject(new Error("no-clipboard"));
      }

      function downloadText(filename, text){
        const blob = new Blob([text], { type:"text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 500);
      }

      function toLocalDateTimeValue(dt){
        if(!dt) return "";
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return "";
        const yyyy = d.getFullYear();
        const mm = pad2(d.getMonth()+1);
        const dd = pad2(d.getDate());
        const hh = pad2(d.getHours());
        const mi = pad2(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }

      function fromLocalDateTimeValue(v){
        const s = String(v||"").trim();
        if(!s) return "";
        const d = new Date(s);
        if(Number.isNaN(d.getTime())) return "";
        return d.toISOString();
      }

      function normalizeText(s, max){
        let x = String(s ?? "").trim();
        if(max && x.length > max) x = x.slice(0, max);
        return x;
      }

      function nowIso(){ return new Date().toISOString(); }

      function upsertContactByName(name){
        const n = normalizeText(name, 80);
        if(!n) return null;
        const exists = contacts.find(c => (c.name||"").trim().toLowerCase() === n.toLowerCase());
        if(exists) return exists;
        const c = { id: uid(), name: n, note:"", createdAt: nowIso(), updatedAt: nowIso(), _ts: Date.now() };
        contacts.unshift(c);
        save(CONTACTS_KEY, contacts);
        return c;
      }

      function upsertContact(contact){
        if(!contact || !contact.id) return null;
        const ts = Number(contact._ts || contact.ts || Date.now());
        const idx = contacts.findIndex(c => c.id === contact.id);
        if(idx >= 0){
          const cur = contacts[idx];
          const curTs = Number(cur._ts || 0);
          if(ts >= curTs){
            contacts[idx] = Object.assign({}, cur, contact, { _ts: ts, updatedAt: contact.updatedAt || nowIso() });
          }
        }else{
          contacts.unshift(Object.assign({}, contact, { _ts: ts }));
        }
        save(CONTACTS_KEY, contacts);
        return contact;
      }

      function upsertCommitment(item){
        if(!item || !item.id) return null;
        const ts = Number(item._ts || item.ts || Date.now());
        const idx = data.findIndex(x => x.id === item.id);
        if(idx >= 0){
          const cur = data[idx];
          const curTs = Number(cur._ts || 0);
          if(ts >= curTs){
            data[idx] = Object.assign({}, cur, item, { _ts: ts, updatedAt: item.updatedAt || nowIso() });
          }
        }else{
          data.unshift(Object.assign({}, item, { _ts: ts }));
        }
        save(KEY, data);
        return item;
      }

      function removeCommitment(id){
        data = data.filter(x => x.id !== id);
        save(KEY, data);
      }

      function removeContact(id){
        contacts = contacts.filter(x => x.id !== id);
        // Adem√°s, desvincula compromisos que usaban ese contacto
        data = data.map(it => it.whoId === id ? Object.assign({}, it, { whoId:null, whoName: it.whoName || "Contacto" }) : it);
        save(CONTACTS_KEY, contacts);
        save(KEY, data);
      }

      // =======================
      // UI / pesta√±as
      // =======================
      function setPane(name){
        pane = name;
        $("commitmentsPane").style.display = (pane==="commitments") ? "" : "none";
        $("contactsPane").style.display    = (pane==="contacts") ? "" : "none";
        $("settingsPane").style.display    = (pane==="settings") ? "" : "none";

        $("tabCommitments").classList.toggle("active", pane==="commitments");
        $("tabContacts").classList.toggle("active", pane==="contacts");
        $("tabSettings").classList.toggle("active", pane==="settings");

        // FAB
        $("fab").style.display = (pane==="settings") ? "none" : "";

        renderAll();
      }

      function setView(v){
        view = v;
        $("tabPending").classList.toggle("active", view==="pending");
        $("tabDone").classList.toggle("active", view==="done");
        renderCommitments();
      }

      // =======================
      // Modal Compromiso
      // =======================
      let editingId = null;

      function openModalForNew(){
        editingId = null;
        $("modalTitle").textContent = "Nuevo compromiso";
        $("fWhat").value = "";
        $("fWhen").value = "";
        $("fRemind").value = "0";
        $("fAfter").value = "0";
        $("customWhoField").style.display = "none";
        $("fWho").value = "";

        populateContactSelect(null);
        openBackdrop($("backdrop"));
      }

      function openModalForEdit(id){
        const it = data.find(x => x.id === id);
        if(!it) return;

        editingId = id;
        $("modalTitle").textContent = "Editar compromiso";
        $("fWhat").value = it.what || "";
        $("fWhen").value = toLocalDateTimeValue(it.when);
        $("fRemind").value = String(it.remindMin || 0);
        $("fAfter").value = String(it.afterMin || 0);

        populateContactSelect(it.whoId || null, it.whoName || "");
        openBackdrop($("backdrop"));
      }

      function closeModal(){
        closeBackdrop($("backdrop"));
      }

      function populateContactSelect(selectedId, fallbackName){
        // Opciones: (nuevo) + lista contactos
        const sel = $("fContact");
        sel.innerHTML = "";

        const optNew = document.createElement("option");
        optNew.value = "__new__";
        optNew.textContent = "‚ûï Nuevo contacto (escribir nombre)";
        sel.appendChild(optNew);

        const optNone = document.createElement("option");
        optNone.value = "__none__";
        optNone.textContent = "‚Äî Sin contacto ‚Äî";
        sel.appendChild(optNone);

        if(contacts.length){
          const grp = document.createElement("optgroup");
          grp.label = "Contactos";
          contacts
            .slice()
            .sort((a,b)=> (a.name||"").localeCompare(b.name||"", "es", { sensitivity:"base" }))
            .forEach(c=>{
              const o = document.createElement("option");
              o.value = c.id;
              o.textContent = c.name + (c.note ? ` ¬∑ ${c.note}` : "");
              grp.appendChild(o);
            });
          sel.appendChild(grp);
        }

        // Selecci√≥n
        if(selectedId && contacts.some(c=>c.id===selectedId)){
          sel.value = selectedId;
          $("customWhoField").style.display = "none";
          $("fWho").value = "";
        } else if(fallbackName){
          // Si no hay whoId pero hay nombre, selecciona none y muestra el nombre como "nuevo" si el usuario quiere
          sel.value = "__none__";
          $("customWhoField").style.display = "none";
          $("fWho").value = "";
        } else {
          sel.value = "__none__";
          $("customWhoField").style.display = "none";
          $("fWho").value = "";
        }

        updateCustomWhoField();
      }

      function updateCustomWhoField(){
        const v = $("fContact").value;
        const show = (v === "__new__");
        $("customWhoField").style.display = show ? "" : "none";
        if(!show) $("fWho").value = "";
      }

      function buildCommitmentFromForm(){
        const what = normalizeText($("fWhat").value, 1000);
        if(!what){
          toast("Escribe qu√© se acord√≥");
          return null;
        }

        const sel = $("fContact").value;
        let whoId = null;
        let whoName = "";

        if(sel === "__new__"){
          const nm = normalizeText($("fWho").value, 80);
          if(!nm){
            toast("Escribe el nombre del nuevo contacto");
            return null;
          }
          const c = upsertContactByName(nm);
          whoId = c ? c.id : null;
          whoName = c ? c.name : nm;
        }else if(sel === "__none__"){
          whoId = null;
          whoName = "Sin contacto";
        }else{
          whoId = sel;
          const c = contactById(sel);
          whoName = c?.name || "Contacto";
        }

        const whenIso = fromLocalDateTimeValue($("fWhen").value);
        const remindMin = Number($("fRemind").value || 0) || 0;
        const afterMin  = Number($("fAfter").value || 0) || 0;

        // afterAt: si se selecciona "desde ahora", se programa ya para este m√≥vil
        let afterAt = "";
        if(afterMin > 0){
          afterAt = new Date(Date.now() + afterMin*60*1000).toISOString();
        }

        const base = {
          whoId,
          whoName,
          what,
          when: whenIso || "",
          remindMin,
          afterMin,
          afterAt,
          status: "pending"
        };
        return base;
      }

      function commitSaveAndShare(createdOrEdited){
        // abre modal compartir autom√°ticamente
        openShareForCommitment(createdOrEdited.id);
      }

      // =======================
      // Modal Contacto
      // =======================
      let editingContactId = null;

      function openContactModalNew(){
        editingContactId = null;
        $("cModalTitle").textContent = "Nuevo contacto";
        $("cName").value = "";
        $("cNote").value = "";
        openBackdrop($("cBackdrop"));
      }

      function openContactModalEdit(id){
        const c = contacts.find(x => x.id === id);
        if(!c) return;
        editingContactId = id;
        $("cModalTitle").textContent = "Editar contacto";
        $("cName").value = c.name || "";
        $("cNote").value = c.note || "";
        openBackdrop($("cBackdrop"));
      }

      function closeContactModal(){
        closeBackdrop($("cBackdrop"));
      }

      // =======================
      // Modal Compartir
      // =======================
      let shareMode = "short";
      let currentSharePack = null;

      function setShareMode(mode){
        shareMode = mode;
        $("shareShort").classList.toggle("active", shareMode==="short");
        $("shareLong").classList.toggle("active",  shareMode==="long");
        renderShareBoxes();
      }

      function buildPackForCommitment(id){
        const it = data.find(x => x.id === id);
        if(!it) return null;

        const c = it.whoId ? contactById(it.whoId) : null;

        // Para importaci√≥n, el receptor recalcula afterAt si afterMin>0
        const pack = {
          v: 1,
          kind: "commitment",
          at: Date.now(),
          commitment: Object.assign({}, it),
          contact: c ? Object.assign({}, c) : null
        };

        return pack;
      }

      function packToUrl(pack){
        const enc = b64urlEncode(JSON.stringify(pack));
        return baseUrl() + "?p=" + enc;
      }

      function renderShareBoxes(){
        if(!currentSharePack) return;

        const it = currentSharePack.commitment || {};
        const who = normalizedWho(it);
        const whenTxt = it.when ? fmtDate(it.when) : "Sin fecha";
        const afterTxt = it.afterMin ? ` ¬∑ ‚è≥ Desde ahora: ${it.afterMin} min` : "";
        const remindTxt = (it.when && it.remindMin) ? ` ¬∑ ${remindLabel(it.remindMin)} antes` : "";

        const url = packToUrl(currentSharePack);

        const shortMsg =
`üìù Compromiso
üë§ ${who}
üìå ${it.what || ""}
üìÖ ${whenTxt}${afterTxt}${remindTxt}

üîó Abrir e importar:
${url}`;

        const longMsg =
`üìù COMPROMISO (detallado)
üë§ Con: ${who}
üìå Texto: ${it.what || ""}
üìÖ Fecha: ${whenTxt}
üîî Recordatorio (por fecha): ${it.remindMin ? `${it.remindMin} min antes` : "No"}
‚è≥ Aviso ‚Äúdesde ahora‚Äù: ${it.afterMin ? `S√≠, en ${it.afterMin} min` : "No"}
‚úÖ Estado: ${it.status === "done" ? "Hecho" : "Pendiente"}

üîó Enlace de importaci√≥n:
${url}`;

        $("shareTextBox").textContent = (shareMode==="short") ? shortMsg : longMsg;
        $("shareUrlBox").textContent  = url;

        $("shareTitle").innerHTML = `Comparte este compromiso con <b>${escapeHtml(who)}</b>.`;
      }

      function openShareForCommitment(id){
        const pack = buildPackForCommitment(id);
        if(!pack){
          toast("No se pudo preparar el paquete");
          return;
        }
        currentSharePack = pack;
        setShareMode("short");
        openBackdrop($("shareBackdrop"));
      }

      function closeShare(){
        closeBackdrop($("shareBackdrop"));
        currentSharePack = null;
      }

      // =======================
      // Backdrops helpers
      // =======================
      function openBackdrop(el){
        if(settings.pinEnabled && !isUnlockedNow()){
          showLockOverlay();
          return;
        }
        el.classList.add("show");
        el.setAttribute("aria-hidden","false");
      }
      function closeBackdrop(el){
        el.classList.remove("show");
        el.setAttribute("aria-hidden","true");
      }

      // =======================
      // Render compromisos
      // =======================
      function renderCommitments(){
        const list = $("list");
        list.innerHTML = "";

        const pending = data.filter(x => (x.status||"pending") !== "done");
        const done    = data.filter(x => (x.status||"pending") === "done");

        const pendingCount = pending.length;
        const doneCount = done.length;

        // Vencidos: pendientes con fecha y ya pas√≥
        const overdueCount = pending.filter(x => x.when && isOverdue(x.when)).length;

        $("bPending").textContent = String(pendingCount);
        $("bDone").textContent = String(doneCount);

        // Top pills
        $("bPendingTop").textContent = String(pendingCount);
        $("bOverdueTop").textContent = String(overdueCount);

        setPillState($("btnPendingTop"), pendingCount, "good");
        setPillState($("btnOverdueTop"), overdueCount, "bad");

        const arr = (view==="pending") ? pending : done;

        if(arr.length === 0){
          $("empty").style.display = "";
        } else {
          $("empty").style.display = "none";
        }

        // Orden: pendientes por fecha asc (sin fecha al final). Hechos por doneAt desc.
        const sorted = arr.slice().sort((a,b)=>{
          if(view==="done"){
            return (new Date(b.doneAt||0).getTime() - new Date(a.doneAt||0).getTime());
          }
          const aw = a.when ? new Date(a.when).getTime() : Infinity;
          const bw = b.when ? new Date(b.when).getTime() : Infinity;
          if(aw !== bw) return aw - bw;
          return (new Date(b.updatedAt||0).getTime() - new Date(a.updatedAt||0).getTime());
        });

        sorted.forEach(it=>{
          const card = document.createElement("div");
          const overdue = (it.status!=="done" && it.when && isOverdue(it.when));
          card.className = "card" + (overdue ? " overdue" : "") + (it.status==="done" ? " done" : "");

          const who = normalizedWho(it);
          const metaBits = [];
          if(it.when) metaBits.push(`<span class="chip">üìÖ ${escapeHtml(fmtDate(it.when))}</span>`);
          if(it.when && it.remindMin) metaBits.push(`<span class="chip">${escapeHtml(remindLabel(it.remindMin))}</span>`);
          if(it.afterMin) metaBits.push(`<span class="chip">‚è≥ ${escapeHtml(String(it.afterMin))}m</span>`);
          if(it.status==="done") metaBits.push(`<span class="chip">‚úÖ Hecho</span>`);
          if(overdue) metaBits.push(`<span class="chip" style="border-color:rgba(255,92,122,.35); background: rgba(255,92,122,.10); color: rgba(255,230,235,.95)">‚è∞ Vencido</span>`);

          const duePill = it.when
            ? `<div class="due ${overdue ? "bad" : ""}">${overdue ? "‚è∞ Vencido" : "üìÖ Con fecha"}</div>`
            : `<div class="due" style="background: rgba(255,255,255,.06); color: var(--muted);">Sin fecha</div>`;

          card.innerHTML = `
            <div class="cardTop">
              <div class="who">
                <p class="name">${escapeHtml(who)}</p>
                <div class="meta">${metaBits.join("")}</div>
              </div>
              ${duePill}
            </div>
            <div class="desc">${escapeHtml(it.what || "")}</div>
            <div class="actions"></div>
          `;

          const actions = card.querySelector(".actions");

          function addBtn(txt, cls, onClick){
            const b = document.createElement("button");
            b.className = "btn " + (cls||"");
            b.type = "button";
            b.textContent = txt;
            b.addEventListener("click", onClick);
            actions.appendChild(b);
          }

          if(it.status==="done"){
            addBtn("‚Ü©Ô∏è Reabrir", "", async ()=>{
              const ok = await Confirm.open({
                title: "Reabrir compromiso",
                msg: `¬øReabrir este compromiso con <b>${escapeHtml(who)}</b>?`,
                yesText: "Reabrir",
                danger: false
              });
              if(!ok) return;
              it.status = "pending";
              it.doneAt = "";
              it.updatedAt = nowIso();
              it._ts = Date.now();
              upsertCommitment(it);
              renderAll();
              toast("Reabierto");
            });
          }else{
            addBtn("‚úÖ Hecho", "good", async ()=>{
              const ok = await Confirm.open({
                title: "Marcar como hecho",
                msg: `¬øMarcar como hecho el compromiso con <b>${escapeHtml(who)}</b>?`,
                yesText: "S√≠, hecho",
                danger: false
              });
              if(!ok) return;
              it.status = "done";
              it.doneAt = nowIso();
              it.updatedAt = nowIso();
              it._ts = Date.now();
              upsertCommitment(it);
              renderAll();
              toast("Marcado como hecho");
            });
          }

          addBtn("‚úèÔ∏è Editar", "", ()=>{
            openModalForEdit(it.id);
          });

          addBtn("üì§ Compartir", "primary", ()=>{
            openShareForCommitment(it.id);
          });

          // Calendario (ICS)
          addBtn("üìÖ Calendario", "", ()=>{
            if(!it.when){
              toast("Pon una fecha para exportar");
              return;
            }
            const dt = new Date(it.when);
            if(Number.isNaN(dt.getTime())){
              toast("Fecha inv√°lida");
              return;
            }
            const end = new Date(dt.getTime() + 30*60*1000); // 30 min
            const ics = buildICS({
              title: `Compromiso: ${normalizedWho(it)}`,
              desc: it.what || "",
              start: dt,
              end
            });
            downloadText("compromiso.ics", ics);
            toast("ICS descargado");
          });

          addBtn("üóëÔ∏è Eliminar", "danger", async ()=>{
            const ok = await Confirm.open({
              title: "Eliminar",
              msg: `<span class="dangerTxt">Esta acci√≥n no se puede deshacer.</span><br><br>¬øEliminar el compromiso con <b>${escapeHtml(who)}</b>?`,
              yesText: "Eliminar",
              danger: true
            });
            if(!ok) return;

            // limpiar disparos asociados
            delete firedMap[it.id + "|remind"];
            delete firedMap[it.id + "|due"];
            delete afterFired[it.id];

            save(REMIND_FIRED_KEY, firedMap);
            save(AFTER_FIRED_KEY, afterFired);

            removeCommitment(it.id);
            renderAll();
            toast("Eliminado");
          });

          list.appendChild(card);
        });

        // Tambi√©n en contactos tab badge
        $("bContacts").textContent = String(contacts.length);

        // Pills superiores (las otras)
        renderTopPills();
      }

      function renderContacts(){
        const list = $("contactsList");
        list.innerHTML = "";

        $("bContacts").textContent = String(contacts.length);

        if(!contacts.length){
          $("contactsEmpty").style.display = "";
        }else{
          $("contactsEmpty").style.display = "none";
        }

        const sorted = contacts.slice().sort((a,b)=> (a.name||"").localeCompare(b.name||"", "es", { sensitivity:"base" }));
        sorted.forEach(c=>{
          const card = document.createElement("div");
          card.className = "card contactCard";
          card.innerHTML = `
            <div class="cardTop">
              <div class="who">
                <p class="name">${escapeHtml(c.name||"")}</p>
                <div class="meta">
                  ${c.note ? `<span class="chip">üìù ${escapeHtml(c.note)}</span>` : `<span class="chip">Sin nota</span>`}
                  <span class="chip">üë• Contacto</span>
                </div>
              </div>
              <div class="due" style="background: rgba(255,255,255,.06); color: var(--muted);">Amigo</div>
            </div>
            <div class="desc" style="color: var(--muted);">Toca para editar ¬∑ o mant√©n para borrar</div>
          `;

          // click -> editar
          card.addEventListener("click", ()=>{
            openContactModalEdit(c.id);
          });

          // long press -> borrar (sencillo: contextmenu)
          card.addEventListener("contextmenu", async (e)=>{
            e.preventDefault();
            const ok = await Confirm.open({
              title: "Eliminar contacto",
              msg: `<span class="dangerTxt">Esta acci√≥n no se puede deshacer.</span><br><br>¬øEliminar a <b>${escapeHtml(c.name||"")}</b>?<br><small style="color:var(--muted)">Los compromisos vinculados quedar√°n como ‚Äúsin contacto‚Äù.</small>`,
              yesText: "Eliminar",
              danger: true
            });
            if(!ok) return;
            removeContact(c.id);
            renderAll();
            toast("Contacto eliminado");
          });

          list.appendChild(card);
        });

        renderTopPills();
      }

      function renderAll(){
        if(pane==="commitments"){
          renderCommitments();
        }else if(pane==="contacts"){
          renderContacts();
        }else{
          // settings
          updateSettingsUI();
          renderTopPills();
        }
      }

      // =======================
      // Importaci√≥n por URL
      // =======================
      function getPackFromUrl(){
        try{
          const u = new URL(location.href);
          const p = u.searchParams.get("p");
          if(!p) return null;
          const json = b64urlDecode(p);
          const pack = JSON.parse(json);
          if(!pack || !pack.v) return null;
          return pack;
        }catch(e){ return null; }
      }

      function clearUrlParamP(){
        try{
          const u = new URL(location.href);
          if(!u.searchParams.has("p")) return;
          u.searchParams.delete("p");
          history.replaceState({}, "", u.toString());
        }catch(e){}
      }

      function storeInboxPack(pack){
        try{
          localStorage.setItem(INBOX_PACK_KEY, JSON.stringify(pack));
          localStorage.setItem(INBOX_TS_KEY, String(Date.now()));
        }catch(e){}
      }

      function readInboxPack(){
        try{
          const raw = localStorage.getItem(INBOX_PACK_KEY);
          if(!raw) return null;
          return JSON.parse(raw);
        }catch(e){ return null; }
      }

      function clearInboxPack(){
        try{
          localStorage.removeItem(INBOX_PACK_KEY);
          localStorage.removeItem(INBOX_TS_KEY);
        }catch(e){}
      }

      function applyPack(pack){
        if(!pack) return false;
        if(pack.kind !== "commitment") return false;

        // Upsert contacto si viene
        if(pack.contact && pack.contact.id){
          upsertContact(pack.contact);
        }

        // Upsert compromiso
        if(pack.commitment && pack.commitment.id){
          const it = Object.assign({}, pack.commitment);

          // Recalcula afterAt en el receptor si afterMin>0
          const afterMin = Number(it.afterMin || 0) || 0;
          if(afterMin > 0){
            it.afterAt = new Date(Date.now() + afterMin*60*1000).toISOString();
          }else{
            it.afterAt = it.afterAt || "";
          }

          // Asegura campos m√≠nimos
          it.status = (it.status==="done") ? "done" : "pending";
          it.updatedAt = nowIso();
          it._ts = Date.now();

          upsertCommitment(it);
        }

        incReceived();
        renderAll();
        return true;
      }

      // =======================
      // Banner din√°mico: instalar / abrir en chrome / importar
      // =======================
      let deferredPrompt = null;

      function ensureImportButton(){
        let btn = $("btnImportNow");
        if(btn) return btn;

        btn = document.createElement("button");
        btn.className = "btn good";
        btn.id = "btnImportNow";
        btn.textContent = "üì• Importar ahora";

        // insertarlo en la fila del banner
        const row = $("installBanner").querySelector(".row");
        row.insertBefore(btn, $("btnHideBanner"));

        btn.addEventListener("click", ()=>{
          const pack = readInboxPack();
          if(!pack){
            toast("No hay paquete pendiente");
            renderTopPills();
            return;
          }
          const ok = applyPack(pack);
          if(ok){
            clearInboxPack();
            $("installBanner").classList.remove("show");
            renderTopPills();
            toast("Importado ‚úÖ");
          }else{
            toast("No se pudo importar");
          }
        });

        return btn;
      }

      function showInstallBanner(reason){
        // reason: "install" | "openChrome" | "inbox"
        const banner = $("installBanner");

        // reset
        $("btnInstallBanner").style.display = "none";
        $("btnOpenChrome").style.display = "none";
        $("btnCopyLink").style.display = "none";
        const imp = ensureImportButton();
        imp.style.display = "none";

        if(reason === "inbox"){
          $("installTitle").textContent = "üì¶ Paquete pendiente de importar";
          $("installText").innerHTML = `Tienes un paquete listo. Pulsa <b>Importar ahora</b>. Si est√°s dentro de una app (WhatsApp/Telegram), mejor <b>Abrir en Chrome</b>.`;
          imp.style.display = "";
          $("btnOpenChrome").style.display = detectInAppBrowser() ? "" : "none";
          $("btnCopyLink").style.display = detectInAppBrowser() ? "" : "none";
        } else if(reason === "openChrome"){
          $("installTitle").textContent = "üåê Abre en Chrome";
          $("installText").innerHTML = `Si est√°s dentro de WhatsApp/Telegram, toca <b>Abrir en Chrome</b> (o ‚ÄúAbrir en navegador‚Äù) para que la instalaci√≥n/importaci√≥n funcione mejor.`;
          $("btnOpenChrome").style.display = "";
          $("btnCopyLink").style.display = "";
        } else {
          $("installTitle").textContent = "Inst√°lala para usarla como app";
          $("installText").innerHTML = `Recomendado para recordatorios y para importar enlaces sin fallos.`;
          $("btnInstallBanner").style.display = deferredPrompt ? "" : "none";
          $("btnCopyLink").style.display = detectInAppBrowser() ? "" : "none";
          $("btnOpenChrome").style.display = detectInAppBrowser() ? "" : "none";
        }

        banner.classList.add("show");
      }

      function maybeShowBanner(){
        // prioridad: inbox
        const inbox = !!localStorage.getItem(INBOX_PACK_KEY);
        if(inbox){
          showInstallBanner("inbox");
          return;
        }
        // si est√° en in-app browser, aconseja abrir en chrome
        if(detectInAppBrowser()){
          showInstallBanner("openChrome");
          return;
        }
        // si hay install prompt, sugiere instalaci√≥n
        if(deferredPrompt){
          showInstallBanner("install");
        }
      }

      // =======================
      // Notificaciones / recordatorios
      // =======================
      function showNotification(title, body){
        // siempre toast como fallback
        toast(title);

        if(!settings.notifEnabled) return;
        if(!notifSupported()) return;
        if(notifPermission() !== "granted") return;

        try{
          const n = new Notification(title, { body: body || "" });
          setTimeout(()=>{ try{ n.close(); }catch(e){} }, 7000);
        }catch(e){}
      }

      function checkAndFireReminders(){
        const now = Date.now();

        // PIN: si est√° bloqueado, no molestamos con notifs internas (pero los push del sistema s√≠)
        // Aun as√≠ contamos vencidos para pills, etc.
        data.forEach(it=>{
          if(it.status === "done") return;

          // A) Recordatorio por fecha
          if(it.when && it.remindMin){
            const when = new Date(it.when).getTime();
            if(!Number.isFinite(when)) return;

            const remindAt = when - Number(it.remindMin)*60*1000;
            const key = it.id + "|remind";
            if(remindAt <= now && !firedMap[key]){
              firedMap[key] = now;
              save(REMIND_FIRED_KEY, firedMap);

              const who = normalizedWho(it);
              showNotification(`üîî Recordatorio (${who})`, it.what || "");
              incPendingBadge();
            }
          }

          // B) Aviso ‚Äúdesde ahora‚Äù (afterAt)
          if(it.afterAt){
            const at = new Date(it.afterAt).getTime();
            if(Number.isFinite(at) && at <= now && !afterFired[it.id]){
              afterFired[it.id] = now;
              save(AFTER_FIRED_KEY, afterFired);

              const who = normalizedWho(it);
              showNotification(`‚è≥ Aviso (${who})`, it.what || "");
              incPendingBadge();
            }
          }

          // C) Vencido (una sola vez)
          if(it.when){
            const when = new Date(it.when).getTime();
            const key2 = it.id + "|due";
            if(Number.isFinite(when) && when <= now && !firedMap[key2]){
              // solo si han pasado al menos 1 min para no duplicar con recordatorio
              if(now - when >= 60*1000){
                firedMap[key2] = now;
                save(REMIND_FIRED_KEY, firedMap);

                const who = normalizedWho(it);
                showNotification(`‚è∞ Compromiso vencido (${who})`, it.what || "");
                incPendingBadge();
              }
            }
          }
        });

        // refresca pills (vencidos/pending)
        if(pane==="commitments") renderCommitments();
        else renderTopPills();
      }

      // =======================
      // ICS (Calendario)
      // =======================
      function icsDate(d){
        const z = (n)=> String(n).padStart(2,"0");
        return d.getUTCFullYear()
          + z(d.getUTCMonth()+1)
          + z(d.getUTCDate())
          + "T"
          + z(d.getUTCHours())
          + z(d.getUTCMinutes())
          + z(d.getUTCSeconds())
          + "Z";
      }

      function buildICS({title, desc, start, end}){
        const uidv = uid() + "@local";
        const dtstamp = icsDate(new Date());
        const dtstart = icsDate(start);
        const dtend = icsDate(end);

        const esc = (s)=> String(s||"")
          .replaceAll("\\","\\\\")
          .replaceAll("\n","\\n")
          .replaceAll(",","\\,")
          .replaceAll(";","\\;");

        return [
          "BEGIN:VCALENDAR",
          "VERSION:2.0",
          "PRODID:-//Compromisos Local//ES",
          "CALSCALE:GREGORIAN",
          "METHOD:PUBLISH",
          "BEGIN:VEVENT",
          `UID:${uidv}`,
          `DTSTAMP:${dtstamp}`,
          `DTSTART:${dtstart}`,
          `DTEND:${dtend}`,
          `SUMMARY:${esc(title)}`,
          `DESCRIPTION:${esc(desc)}`,
          "END:VEVENT",
          "END:VCALENDAR"
        ].join("\r\n");
      }

      // =======================
      // PIN overlay
      // =======================
      let pinBuffer = "";

      function setDots(n){
        $("d1").classList.toggle("on", n>=1);
        $("d2").classList.toggle("on", n>=2);
        $("d3").classList.toggle("on", n>=3);
        $("d4").classList.toggle("on", n>=4);
      }

      function showLockOverlay(){
        if(!settings.pinEnabled) return;
        $("lockOverlay").classList.add("show");
        $("lockOverlay").setAttribute("aria-hidden","false");
        pinBuffer = "";
        setDots(0);
      }

      function hideLockOverlay(){
        $("lockOverlay").classList.remove("show");
        $("lockOverlay").setAttribute("aria-hidden","true");
        pinBuffer = "";
        setDots(0);
      }

      async function handleKey(k){
        if(k === "del"){
          pinBuffer = pinBuffer.slice(0,-1);
          setDots(pinBuffer.length);
          return;
        }
        if(k === "ok"){
          if(pinBuffer.length !== 4){
            toast("PIN incompleto");
            return;
          }
          const ok = await verifyPin(pinBuffer);
          if(ok){
            applyUnlock();
            hideLockOverlay();
            toast("Desbloqueado ‚úÖ");
          }else{
            pinBuffer = "";
            setDots(0);
            toast("PIN incorrecto");
          }
          return;
        }
        if(/^\d$/.test(k)){
          if(pinBuffer.length >= 4) return;
          pinBuffer += k;
          setDots(pinBuffer.length);
          if(pinBuffer.length === 4){
            // auto OK
            const ok = await verifyPin(pinBuffer);
            if(ok){
              applyUnlock();
              hideLockOverlay();
              toast("Desbloqueado ‚úÖ");
            }else{
              pinBuffer = "";
              setDots(0);
              toast("PIN incorrecto");
            }
          }
        }
      }

      function scheduleAutoLock(){
        if(!settings.pinEnabled) return;
        const min = Number(settings.autoLockMin || 0);
        if(min <= 0){
          // inmediato al perder foco
          lockAtTs = Date.now() + 1;
        }else{
          lockAtTs = Date.now() + min*60*1000;
        }
      }

      function checkAutoLockTick(){
        if(!settings.pinEnabled) return;
        if(isUnlockedNow()) return; // si hay unlockUntil vigente, no bloquear
        if(lockAtTs && Date.now() >= lockAtTs){
          forceLock();
        }
      }

      // =======================
      // Handlers
      // =======================
      $("tabCommitments").addEventListener("click", ()=> setPane("commitments"));
      $("tabContacts").addEventListener("click", ()=> setPane("contacts"));
      $("tabSettings").addEventListener("click", ()=> setPane("settings"));

      $("tabPending").addEventListener("click", ()=> setView("pending"));
      $("tabDone").addEventListener("click", ()=> setView("done"));

      $("btnHelpToggle").addEventListener("click", toggleHelp);

      $("btnA11y").addEventListener("click", toggleTextScale);

      $("fContact").addEventListener("change", updateCustomWhoField);

      $("btnClose").addEventListener("click", closeModal);
      $("btnCancel").addEventListener("click", closeModal);
      $("backdrop").addEventListener("click", (e)=>{ if(e.target === $("backdrop")) closeModal(); });

      $("cBtnClose").addEventListener("click", closeContactModal);
      $("cBtnCancel").addEventListener("click", closeContactModal);
      $("cBackdrop").addEventListener("click", (e)=>{ if(e.target === $("cBackdrop")) closeContactModal(); });

      $("shareClose").addEventListener("click", closeShare);
      $("shareCancel").addEventListener("click", closeShare);
      $("shareBackdrop").addEventListener("click", (e)=>{ if(e.target === $("shareBackdrop")) closeShare(); });

      $("shareShort").addEventListener("click", ()=> setShareMode("short"));
      $("shareLong").addEventListener("click",  ()=> setShareMode("long"));

      $("shareCopyUrl").addEventListener("click", async ()=>{
        const url = $("shareUrlBox").textContent || "";
        try{
          await safeClipboardWrite(url);
          toast("Enlace copiado ‚úÖ");
        }catch(e){
          toast("No se pudo copiar (usa copiar manual)");
        }
      });

      $("shareCopyAll").addEventListener("click", async ()=>{
        const txt = $("shareTextBox").textContent || "";
        try{
          await safeClipboardWrite(txt);
          toast("Texto copiado ‚úÖ");
        }catch(e){
          toast("No se pudo copiar");
        }
      });

      $("shareSend").addEventListener("click", async ()=>{
        const txt = $("shareTextBox").textContent || "";
        const url = $("shareUrlBox").textContent || "";
        if(navigator.share){
          try{
            await navigator.share({ text: txt, url });
            toast("Compartido ‚úÖ");
          }catch(e){
            toast("Compartir cancelado");
          }
        }else{
          try{
            await safeClipboardWrite(txt);
            toast("Copiado ‚úÖ (p√©galo en WhatsApp)");
          }catch(e){
            toast("No se pudo copiar");
          }
        }
      });

      $("btnInstall").addEventListener("click", async ()=>{
        if(!deferredPrompt) return;
        try{
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
        }catch(e){}
        deferredPrompt = null;
        $("btnInstall").style.display = "none";
      });

      $("btnInstallBanner").addEventListener("click", async ()=>{
        if(!deferredPrompt) return;
        try{
          deferredPrompt.prompt();
          await deferredPrompt.userChoice;
        }catch(e){}
        deferredPrompt = null;
        $("btnInstallBanner").style.display = "none";
        $("btnInstall").style.display = "none";
        toast("Listo ‚úÖ");
      });

      $("btnOpenChrome").addEventListener("click", async ()=>{
        // No podemos ‚Äúforzar‚Äù abrir Chrome desde un webview;
        // ofrecemos copiar el enlace para pegarlo en Chrome.
        try{
          await safeClipboardWrite(location.href);
          toast("Enlace copiado. P√©galo en Chrome.");
        }catch(e){
          toast("Copia el enlace y √°brelo en Chrome");
        }
      });

      $("btnCopyLink").addEventListener("click", async ()=>{
        try{
          await safeClipboardWrite(location.href);
          toast("Enlace copiado ‚úÖ");
        }catch(e){
          toast("No se pudo copiar");
        }
      });

      $("btnHideBanner").addEventListener("click", ()=>{
        $("installBanner").classList.remove("show");
      });

      // Pills superiores
      $("btnNotifPend").addEventListener("click", async ()=>{
        if((pendingNotifs.c||0) <= 0) return;
        const ok = await Confirm.open({
          title: "Limpiar avisos",
          msg: `¬øQuieres poner a 0 los avisos pendientes?`,
          yesText: "Limpiar",
          danger: false
        });
        if(ok) clearPendingBadge();
      });

      $("btnReceivedTop").addEventListener("click", async ()=>{
        if((received.c||0) <= 0) return;
        const ok = await Confirm.open({
          title: "Limpiar recibidos",
          msg: `¬øQuieres poner a 0 los recibidos?`,
          yesText: "Limpiar",
          danger: false
        });
        if(ok) clearReceived();
      });

      $("btnPendingTop").addEventListener("click", ()=>{
        setPane("commitments");
        setView("pending");
        window.scrollTo({ top: 0, behavior:"smooth" });
      });

      $("btnOverdueTop").addEventListener("click", ()=>{
        setPane("commitments");
        setView("pending");
        window.scrollTo({ top: 0, behavior:"smooth" });
      });

      $("btnInboxTop").addEventListener("click", ()=>{
        showInstallBanner("inbox");
      });

      // FAB
      $("fab").addEventListener("click", ()=>{
        if(pane === "commitments") openModalForNew();
        else if(pane === "contacts") openContactModalNew();
      });

      // Guardar compromiso
      $("btnSave").addEventListener("click", ()=>{
        const base = buildCommitmentFromForm();
        if(!base) return;

        if(editingId){
          const cur = data.find(x => x.id === editingId);
          if(!cur){
            toast("No encontrado");
            closeModal();
            return;
          }
          const updated = Object.assign({}, cur, base, {
            updatedAt: nowIso(),
            _ts: Date.now()
          });
          // si pasa a pending, conserva doneAt vac√≠o
          if(updated.status !== "done") updated.doneAt = "";
          upsertCommitment(updated);
          closeModal();
          renderAll();
          toast("Guardado");
          commitSaveAndShare(updated);
        }else{
          const it = Object.assign({}, base, {
            id: uid(),
            createdAt: nowIso(),
            updatedAt: nowIso(),
            doneAt: "",
            _ts: Date.now()
          });
          upsertCommitment(it);
          closeModal();
          renderAll();
          toast("Creado");
          commitSaveAndShare(it);
        }
      });

      // Guardar contacto
      $("cBtnSave").addEventListener("click", ()=>{
        const name = normalizeText($("cName").value, 80);
        const note = normalizeText($("cNote").value, 120);

        if(!name){
          toast("Escribe el nombre");
          return;
        }

        if(editingContactId){
          const idx = contacts.findIndex(x => x.id === editingContactId);
          if(idx < 0){
            toast("Contacto no encontrado");
            closeContactModal();
            return;
          }
          contacts[idx] = Object.assign({}, contacts[idx], {
            name, note,
            updatedAt: nowIso(),
            _ts: Date.now()
          });
          save(CONTACTS_KEY, contacts);
          closeContactModal();
          renderAll();
          toast("Contacto actualizado");
        }else{
          const c = { id: uid(), name, note, createdAt: nowIso(), updatedAt: nowIso(), _ts: Date.now() };
          contacts.unshift(c);
          save(CONTACTS_KEY, contacts);
          closeContactModal();
          renderAll();
          toast("Contacto creado");
        }
      });

      // Ajustes switches
      $("swNotif").addEventListener("click", async ()=>{
        if(!notifSupported()){
          toast("No soportado");
          return;
        }
        const perm = notifPermission();
        if(perm !== "granted"){
          const ok = await requestNotifPermission();
          if(!ok) return;
        }
        setNotifEnabled(!settings.notifEnabled);
        toast(settings.notifEnabled ? "Notificaciones ON" : "Notificaciones OFF");
      });

      $("btnNotifPerm").addEventListener("click", requestNotifPermission);

      $("swPin").addEventListener("click", async ()=>{
        if(settings.pinEnabled){
          // desactivar: pide confirm y pin actual
          const ok = await Confirm.open({
            title: "Desactivar PIN",
            msg: `¬øDesactivar el PIN?`,
            yesText: "Desactivar",
            danger: true
          });
          if(!ok) return;
          // pedir pin actual
          openPinModal("disable");
        }else{
          openPinModal("enable");
        }
      });

      $("selAutoLock").addEventListener("change", ()=>{
        settings.autoLockMin = Number($("selAutoLock").value || 0) || 0;
        save(SETTINGS_KEY, settings);
        toast("Auto-bloqueo actualizado");
      });

      $("selRemember").addEventListener("change", ()=>{
        settings.rememberMin = Number($("selRemember").value || 0) || 0;
        save(SETTINGS_KEY, settings);
        toast("Recordar desbloqueo actualizado");
      });

      $("btnChangePin").addEventListener("click", ()=>{
        openPinModal("change");
      });

      $("btnLockNow").addEventListener("click", ()=>{
        if(!settings.pinEnabled){
          toast("Activa el PIN primero");
          return;
        }
        forceLock();
      });

      $("btnResetAll").addEventListener("click", async ()=>{
        const ok = await Confirm.open({
          title: "Borrar todo",
          msg: `<span class="dangerTxt">Irreversible.</span><br><br>Se borrar√°n compromisos, contactos y ajustes del m√≥vil.`,
          yesText: "Borrar todo",
          danger: true
        });
        if(!ok) return;

        localStorage.removeItem(KEY);
        localStorage.removeItem(CONTACTS_KEY);
        localStorage.removeItem(SETTINGS_KEY);
        localStorage.removeItem(REMIND_FIRED_KEY);
        localStorage.removeItem(AFTER_FIRED_KEY);
        localStorage.removeItem(PENDING_NOTIF_KEY);
        localStorage.removeItem(RECEIVED_KEY);
        clearInboxPack();

        data = [];
        contacts = [];
        settings = Object.assign({}, defaultSettings);
        firedMap = {};
        afterFired = {};
        pendingNotifs = { c:0, at:0 };
        received = { c:0, at:0 };

        updateSettingsUI();
        renderAll();
        toast("Restablecido ‚úÖ");
      });

      // PIN modal (configurar/cambiar/desactivar)
      let pinMode = "enable"; // enable | change | disable
      function openPinModal(mode){
        pinMode = mode || "enable";

        $("pinOld").value = "";
        $("pinNew").value = "";
        $("pinNew2").value = "";

        if(pinMode === "enable"){
          $("pinTitle").textContent = "Activar PIN";
          $("pinHint").textContent = "Crea un PIN de 4 d√≠gitos.";
          $("pinOldWrap").style.display = "none";
          $("pinNewWrap").style.display = "";
          $("pinNew2Wrap").style.display = "";
        }else if(pinMode === "change"){
          if(!settings.pinEnabled){
            toast("Activa el PIN primero");
            return;
          }
          $("pinTitle").textContent = "Cambiar PIN";
          $("pinHint").textContent = "Introduce el PIN actual y el nuevo PIN.";
          $("pinOldWrap").style.display = "";
          $("pinNewWrap").style.display = "";
          $("pinNew2Wrap").style.display = "";
        }else{
          // disable
          if(!settings.pinEnabled){
            toast("PIN no activo");
            return;
          }
          $("pinTitle").textContent = "Desactivar PIN";
          $("pinHint").textContent = "Introduce tu PIN actual para desactivar.";
          $("pinOldWrap").style.display = "";
          $("pinNewWrap").style.display = "none";
          $("pinNew2Wrap").style.display = "none";
        }

        openBackdrop($("pinBackdrop"));
      }

      function closePinModal(){
        closeBackdrop($("pinBackdrop"));
      }

      $("pinClose").addEventListener("click", closePinModal);
      $("pinCancel").addEventListener("click", closePinModal);
      $("pinBackdrop").addEventListener("click", (e)=>{ if(e.target === $("pinBackdrop")) closePinModal(); });

      $("pinOk").addEventListener("click", async ()=>{
        try{
          if(pinMode === "enable"){
            const p1 = normalizePin($("pinNew").value);
            const p2 = normalizePin($("pinNew2").value);
            if(p1.length !== 4 || p2.length !== 4){
              toast("PIN debe tener 4 d√≠gitos");
              return;
            }
            if(p1 !== p2){
              toast("Los PIN no coinciden");
              return;
            }
            await setPin(p1);
            settings.pinEnabled = true;
            settings.unlockUntil = 0;
            sessionUnlocked = true; // tras crear, deja desbloqueado
            save(SETTINGS_KEY, settings);
            updateSettingsUI();
            closePinModal();
            toast("PIN activado ‚úÖ");
          }
          else if(pinMode === "change"){
            const oldp = normalizePin($("pinOld").value);
            const ok = await verifyPin(oldp);
            if(!ok){
              toast("PIN actual incorrecto");
              return;
            }
            const p1 = normalizePin($("pinNew").value);
            const p2 = normalizePin($("pinNew2").value);
            if(p1.length !== 4 || p2.length !== 4){
              toast("Nuevo PIN debe tener 4 d√≠gitos");
              return;
            }
            if(p1 !== p2){
              toast("Los PIN no coinciden");
              return;
            }
            await setPin(p1);
            settings.pinEnabled = true;
            settings.unlockUntil = 0;
            sessionUnlocked = true;
            save(SETTINGS_KEY, settings);
            updateSettingsUI();
            closePinModal();
            toast("PIN cambiado ‚úÖ");
          }
          else {
            // disable
            const oldp = normalizePin($("pinOld").value);
            const ok = await verifyPin(oldp);
            if(!ok){
              toast("PIN incorrecto");
              return;
            }
            setPinEnabled(false);
            closePinModal();
            toast("PIN desactivado");
          }
        }catch(e){
          toast("No se pudo guardar el PIN");
        }
      });

      // Keypad overlay
      $("keypad").addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if(!btn) return;
        const k = btn.getAttribute("data-k");
        handleKey(k);
      });

      $("btnLockReset").addEventListener("click", async ()=>{
        const ok = await Confirm.open({
          title: "Borrar todo",
          msg: `<span class="dangerTxt">Irreversible.</span><br><br>Se borrar√° todo para recuperar acceso.`,
          yesText: "Borrar todo",
          danger: true
        });
        if(!ok) return;
        localStorage.clear();
        location.reload();
      });

      $("btnLockCopyLink").addEventListener("click", async ()=>{
        try{
          await safeClipboardWrite(location.href);
          toast("Enlace copiado ‚úÖ");
        }catch(e){
          toast("No se pudo copiar");
        }
      });

      // Auto lock por visibilidad
      document.addEventListener("visibilitychange", ()=>{
        if(document.visibilityState === "hidden"){
          scheduleAutoLock();
        }else{
          // al volver, si deber√≠a bloquear ya
          if(settings.pinEnabled && !isUnlockedNow()){
            showLockOverlay();
          }
        }
      });

      window.addEventListener("blur", ()=>{
        scheduleAutoLock();
      });

      // =======================
      // Boot
      // =======================
      function boot(){
        // A11Y
        const a = load(A11Y_KEY, { big:false });
        setTextScale(!!a.big);

        // Help
        const h = load(HELP_KEY, { show:false });
        setHelpVisible(!!h.show);

        // Settings UI
        updateSettingsUI();

        // pills
        renderTopPills();

        // Import URL param (p)
        const pack = getPackFromUrl();
        if(pack){
          // si est√° en in-app browser, guarda en inbox para importaci√≥n manual
          if(detectInAppBrowser()){
            storeInboxPack(pack);
            toast("Paquete recibido (pendiente de importar)");
            clearUrlParamP();
          }else{
            // importa directamente
            const ok = applyPack(pack);
            if(ok){
              toast("Importado ‚úÖ");
              clearUrlParamP();
            }else{
              toast("No se pudo importar");
            }
          }
        }

        // si hay inbox guardado, muestra banner
        if(localStorage.getItem(INBOX_PACK_KEY)){
          showInstallBanner("inbox");
        }else{
          maybeShowBanner();
        }

        // Re-render
        setPane("commitments");
        setView("pending");
        renderAll();

        // Notif check loop
        setInterval(checkAndFireReminders, 30*1000);
        setInterval(checkAutoLockTick, 2*1000);

        // Si PIN est√° activo y no est√° desbloqueado, bloquea al entrar
        if(settings.pinEnabled && !isUnlockedNow()){
          showLockOverlay();
        }
      }

      // Install prompt
      window.addEventListener("beforeinstallprompt", (e)=>{
        e.preventDefault();
        deferredPrompt = e;
        $("btnInstall").style.display = "";
        $("btnInstallBanner").style.display = "";
        // si no hay inbox, sugerimos banner
        if(!localStorage.getItem(INBOX_PACK_KEY)){
          maybeShowBanner();
        }
      });

      // =======================
      // Ajuste de counts iniciales
      // =======================
      renderTopPills();
      boot();

    })();
  </script>
</body>
</html>