<!-- ‚úÖ PARTE 1/3 ‚Äî compromisos.html (TOP: bot√≥n texto grande arriba derecha FUNCIONA + pills SOLO Vencidos/Recibidos + tiles filtran y muestran X/Y + Ajustes vuelve completo) -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Compromisos</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#F2F3F5"/>

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Compromisos">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <style>
    :root{
      /* üé® Look & feel tipo ‚Äúmen√∫ visual‚Äù */
      --bg: #F2F3F5;
      --surface: #FFFFFF;
      --surface2: #F7F8FA;
      --text: #111827;
      --muted: #6B7280;
      --border: #E5E7EB;
      --shadow: 0 10px 28px rgba(17,24,39,.08);
      --shadow2: 0 6px 18px rgba(17,24,39,.06);

      --primary: #2563EB;
      --primarySoft: rgba(37,99,235,.10);

      --danger: #DC2626;
      --dangerSoft: rgba(220,38,38,.10);

      --good: #16A34A;
      --goodSoft: rgba(22,163,74,.10);

      --chip: #EEF2FF;
      --chipText: #1F2A5A;

      --radius: 18px;
      --radius2: 22px;
      --max: 880px;

      --tap: 48px;

      /* ‚úÖ Accesibilidad global (se multiplica TODO el texto con --textScale) */
      --fs: 16px;
      --textScale: 1;

      --icon: #111827;

      --bottomH: 76px; /* altura aproximada bottom bar */
    }

    *{ box-sizing: border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      font-size: calc(var(--fs) * var(--textScale));
    }

    a{ color:inherit; }

    .wrap{
      width: min(var(--max), calc(100% - 24px));
      margin: 0 auto;
      padding: 14px 0 calc(var(--bottomH) + 22px);
    }

    /* Top bar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(242,243,245,.85);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(229,231,235,.7);
    }

    .topbarInner{
      width: min(var(--max), calc(100% - 24px));
      margin: 0 auto;
      padding: 12px 0;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px 12px;
      align-items: center;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .logo{
      width: 42px; height: 42px;
      border-radius: 14px;
      background: linear-gradient(180deg, #fff, #f3f4f6);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      display:grid;
      place-items:center;
      flex: 0 0 auto;
    }
    .logo span{ font-size: calc(20px * var(--textScale)); }
    .titleBox{ min-width:0; }
    .title{
      margin:0;
      font-size: calc(18px * var(--textScale));
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      margin: 3px 0 0;
      font-size: calc(12.5px * var(--textScale));
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topActions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex: 0 0 auto;
      justify-content: flex-end;
      min-width: 0;
    }

    /* ‚úÖ Bot√≥n accesibilidad arriba derecha */
    .a11yBtn{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      background: var(--surface2);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: calc(13px * var(--textScale));
      font-weight: 900;
      color: var(--text);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .a11yBtn:active{ transform: translateY(1px); }

    /* ‚úÖ P√≠ldoras arriba (SOLO vencidos / recibidos) */
    .pills{
      display:flex;
      gap: 8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: nowrap;
      overflow-x: auto;
      overscroll-behavior-x: contain;
      -webkit-overflow-scrolling: touch;
      max-width: 100%;
      padding-bottom: 2px;
      scrollbar-width: none;
    }
    .pills::-webkit-scrollbar{ display:none; }

    .pillBtn{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      gap: 8px;
      font-size: calc(13px * var(--textScale));
      color: var(--text);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .pillBtn:active{ transform: translateY(1px); }
    .pillDot{
      width: 10px; height: 10px;
      border-radius: 999px;
      background: var(--muted);
      opacity: .35;
      flex: 0 0 auto;
    }
    .pillCount{
      min-width: 22px;
      height: 22px;
      padding: 0 7px;
      border-radius: 999px;
      display:grid;
      place-items:center;
      font-weight: 800;
      font-size: calc(12px * var(--textScale));
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      flex: 0 0 auto;
    }

    .pillBtn.danger .pillDot{ background: var(--danger); opacity: .9; }
    .pillBtn.danger .pillCount{ background: var(--dangerSoft); border-color: rgba(220,38,38,.18); }

    .pillBtn.good .pillDot{ background: var(--good); opacity: .9; }
    .pillBtn.good .pillCount{ background: var(--goodSoft); border-color: rgba(22,163,74,.18); }

    /* Men√∫ visual tipo ‚Äúcuadr√≠culas‚Äù */
    .menuGrid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .tile{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      padding: 14px 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      gap: 12px;
      min-height: 72px;
    }
    .tile:active{ transform: translateY(1px); }
    .tileIcon{
      width: 44px; height: 44px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--icon);
      flex: 0 0 auto;
    }
    .tileIcon span{ font-size: calc(20px * var(--textScale)); }
    .tileText{ min-width:0; flex: 1 1 auto; }
    .tileTitle{
      margin:0;
      font-weight: 900;
      letter-spacing: .2px;
      font-size: calc(16px * var(--textScale));
      line-height: 1.1;
    }
    .tileMeta{
      margin: 5px 0 0;
      font-size: calc(12.5px * var(--textScale));
      color: var(--muted);
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 28px;
      height: 22px;
      padding: 0 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      font-weight: 900;
      font-size: calc(12px * var(--textScale));
      color: var(--text);
    }
    .badge.primary{ background: var(--primarySoft); border-color: rgba(37,99,235,.20); color: #1E40AF; }
    .badge.danger{ background: var(--dangerSoft); border-color: rgba(220,38,38,.20); color: #991B1B; }
    .badge.good{ background: var(--goodSoft); border-color: rgba(22,163,74,.20); color: #14532D; }

    /* Secciones */
    .section{
      margin-top: 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow: hidden;
    }
    .sectionHead{
      padding: 14px 14px 12px;
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(229,231,235,.8);
      background: linear-gradient(180deg, #fff, #fbfbfc);
    }
    .sectionHead h2{
      margin:0;
      font-size: calc(16px * var(--textScale));
      font-weight: 950;
      letter-spacing: .2px;
    }
    .sectionHead p{
      margin: 4px 0 0;
      font-size: calc(12.5px * var(--textScale));
      color: var(--muted);
    }
    .segTabs{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .segBtn{
      height: 34px;
      padding: 0 12px;
      border-radius: 999px;
      background: var(--surface2);
      border: 1px solid var(--border);
      cursor:pointer;
      font-weight: 800;
      font-size: calc(13px * var(--textScale));
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .segBtn.active{
      background: var(--primarySoft);
      border-color: rgba(37,99,235,.22);
      color: #1E40AF;
    }

    /* Tarjetas */
    .list{
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .card{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      padding: 12px 12px;
    }
    .cardTop{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .who .name{
      margin:0;
      font-weight: 950;
      letter-spacing: .2px;
      font-size: calc(15.5px * var(--textScale));
    }
    .who .meta{
      margin: 6px 0 0;
      display:flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: calc(12px * var(--textScale));
      background: var(--chip);
      color: var(--chipText);
      border: 1px solid rgba(99,102,241,.18);
    }

    .due{
      flex: 0 0 auto;
      font-size: calc(12.5px * var(--textScale));
      color: var(--muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 800;
      white-space: nowrap;
    }
    .due.bad{
      color: #991B1B;
      background: var(--dangerSoft);
      border-color: rgba(220,38,38,.20);
    }

    .desc{
      margin-top: 10px;
      color: var(--text);
      line-height: 1.35;
      font-size: calc(14.5px * var(--textScale));
      padding: 10px 10px;
      border-radius: 14px;
      background: #FAFAFB;
      border: 1px solid rgba(229,231,235,.9);
    }

    .actions{
      margin-top: 10px;
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Botones */
    .btn{
      height: 40px;
      padding: 0 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      font-size: calc(14px * var(--textScale));
    }
    .btn:active{ transform: translateY(1px); }

    .btn.primary{
      background: var(--primarySoft);
      border-color: rgba(37,99,235,.22);
      color: #1E40AF;
    }
    .btn.good{
      background: var(--goodSoft);
      border-color: rgba(22,163,74,.22);
      color: #14532D;
    }
    .btn.danger{
      background: var(--dangerSoft);
      border-color: rgba(220,38,38,.22);
      color: #991B1B;
    }

    /* Vac√≠o */
    .empty{
      padding: 14px 12px 18px;
      color: var(--muted);
      text-align:center;
      font-size: calc(13.5px * var(--textScale));
    }

    /* Bottom bar */
    .bottomBar{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(229,231,235,.9);
      padding: 10px 12px;
      z-index: 20;
    }
    .bottomInner{
      width: min(var(--max), calc(100% - 24px));
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 10px;
      align-items:center;
    }

    .navBtn{
      height: 44px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow2);
      cursor:pointer;
      font-weight: 950;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      -webkit-tap-highlight-color: transparent;
      min-width: 0;
      padding: 0 10px;
      white-space: nowrap;
      font-size: calc(14px * var(--textScale));
    }
    .navBtn span{
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .navBtn.active{
      background: var(--primarySoft);
      border-color: rgba(37,99,235,.22);
      color: #1E40AF;
    }

    .fab{
      position: static;
      width: 56px;
      height: 56px;
      border-radius: 20px;
      border: 1px solid rgba(37,99,235,.18);
      background: #2563EB;
      color: #fff;
      font-size: calc(28px * var(--textScale));
      font-weight: 900;
      display:grid;
      place-items:center;
      cursor:pointer;
      box-shadow: 0 18px 40px rgba(37,99,235,.22);
      z-index: 25;
      -webkit-tap-highlight-color: transparent;
      margin: -18px auto 0;
    }
    .fab:active{ transform: translateY(1px); }

    /* Modales */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .backdrop.show{ display:flex; }

    .modal{
      width: min(560px, 100%);
      border-radius: 22px;
      background: var(--surface);
      border: 1px solid rgba(229,231,235,.9);
      box-shadow: 0 24px 70px rgba(17,24,39,.20);
      overflow:hidden;
    }
    .modalHead{
      padding: 14px 14px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(229,231,235,.9);
      background: linear-gradient(180deg, #fff, #fbfbfc);
    }
    .modalHead h3{
      margin:0;
      font-size: calc(16px * var(--textScale));
      font-weight: 950;
    }
    .iconBtn{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface2);
      cursor:pointer;
      font-weight: 900;
      font-size: calc(14px * var(--textScale));
    }
    .modalBody{ padding: 12px 14px 14px; }
    .field{ margin-top: 10px; }
    .label{
      display:block;
      font-size: calc(12.5px * var(--textScale));
      color: var(--muted);
      margin: 0 0 6px;
      font-weight: 800;
    }
    input, select, textarea{
      width: 100%;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: #fff;
      padding: 12px 12px;
      font-size: calc(15px * var(--textScale));
      outline: none;
    }
    textarea{ min-height: 92px; resize: vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 0 0 4px rgba(37,99,235,.10);
    }

    .modalFoot{
      padding: 12px 14px 14px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      border-top: 1px solid rgba(229,231,235,.9);
      justify-content:flex-end;
      background: #fff;
    }

    /* ‚úÖ Switch (para Ajustes: PIN/Notificaciones) */
    .switchRow{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .switchHint{
      margin-top: 8px;
      color: var(--muted);
      font-size: calc(12.5px * var(--textScale));
      line-height: 1.35;
    }
    .switch{
      width: 60px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #E5E7EB;
      position: relative;
      cursor: pointer;
      flex: 0 0 auto;
      -webkit-tap-highlight-color: transparent;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.35);
    }
    .switch::after{
      content:"";
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 4px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid rgba(17,24,39,.10);
      box-shadow: 0 10px 22px rgba(17,24,39,.12);
      transition: left .18s ease, background .18s ease;
    }
    .switch.on{
      background: rgba(37,99,235,.25);
      border-color: rgba(37,99,235,.30);
    }
    .switch.on::after{ left: 30px; }

    /* Banner instalaci√≥n */
    .installBanner{
      position: fixed;
      left: 12px; right: 12px;
      bottom: calc(var(--bottomH) + 70px);
      z-index: 30;
      display:none;
    }
    .installBanner.show{ display:block; }
    .installCard{
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 12px 12px;
    }
    .installRow{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      justify-content: space-between;
    }
    .installTitle{
      margin: 0;
      font-weight: 950;
      font-size: calc(14.5px * var(--textScale));
    }
    .installText{
      margin: 6px 0 0;
      color: var(--muted);
      font-size: calc(13px * var(--textScale));
      line-height: 1.3;
    }

    /* Responsive */
    @media (min-width: 720px){
      .menuGrid{ grid-template-columns: 1fr 1fr 1fr 1fr; }
      .tile{ min-height: 78px; }
    }
    @media (max-width: 520px){
      .topbarInner{ grid-template-columns: 1fr; }
      .topActions{ justify-content: flex-start; }
      .pills{ justify-content: flex-start; }
    }
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand" role="banner" aria-label="Compromisos">
        <div class="logo" aria-hidden="true"><span>üóìÔ∏è</span></div>
        <div class="titleBox">
          <p class="title">Compromisos</p>
          <p class="subtitle" id="statsKicker">Todo en tarjetas, m√°s visual.</p>
        </div>
      </div>

      <div class="topActions">
        <!-- ‚úÖ arriba a la derecha -->
        <button class="a11yBtn" id="btnA11yTop" type="button" title="Cambiar tama√±o de letra">üîé Texto grande</button>

        <div class="pills" aria-label="Indicadores">
          <button class="pillBtn danger" id="btnOverdue" type="button" title="Vencidos">
            <span class="pillDot" aria-hidden="true"></span>
            <span>Vencidos</span>
            <span class="pillCount" id="bOverdue">0</span>
          </button>

          <button class="pillBtn good" id="btnReceived" type="button" title="Recibidos">
            <span class="pillDot" aria-hidden="true"></span>
            <span>Recibidos</span>
            <span class="pillCount" id="bReceived">0</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- Men√∫ visual -->
    <div class="menuGrid" aria-label="Men√∫">
      <div class="tile" id="tilePending" role="button" tabindex="0" title="Ver compromisos pendientes">
        <div class="tileIcon"><span>üìù</span></div>
        <div class="tileText">
          <p class="tileTitle">Pendientes</p>
          <p class="tileMeta">
            <!-- ‚úÖ ahora muestra X/Y -->
            <span class="badge primary" id="tilePendingCount">0/0</span>
            <span>compromisos</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileDone" role="button" tabindex="0" title="Ver compromisos hechos">
        <div class="tileIcon"><span>‚úÖ</span></div>
        <div class="tileText">
          <p class="tileTitle">Hechos</p>
          <p class="tileMeta">
            <!-- ‚úÖ ahora muestra X/Y -->
            <span class="badge good" id="tileDoneCount">0/0</span>
            <span>completados</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileContacts" role="button" tabindex="0" title="Ver amigos">
        <div class="tileIcon"><span>üë•</span></div>
        <div class="tileText">
          <p class="tileTitle">Amigos</p>
          <p class="tileMeta">
            <span class="badge" id="tileContactsCount">0</span>
            <span>guardados</span>
          </p>
        </div>
      </div>

      <div class="tile" id="tileSettings" role="button" tabindex="0" title="Abrir ajustes">
        <div class="tileIcon"><span>‚öôÔ∏è</span></div>
        <div class="tileText">
          <p class="tileTitle">Ajustes</p>
          <p class="tileMeta">
            <span class="badge">üîí</span>
            <span>privacidad</span>
          </p>
        </div>
      </div>
    </div>

    <!-- PANE: COMPROMISOS -->
    <div id="commitmentsPane" class="section" style="margin-top:14px;">
      <div class="sectionHead">
        <div>
          <h2>Compromisos</h2>
          <p>Todo ordenado y f√°cil de ver.</p>
        </div>
        <div class="segTabs" role="tablist" aria-label="Pendientes o Hechos">
          <button class="segBtn active" id="tabPending" type="button">Pendientes</button>
          <button class="segBtn" id="tabDone" type="button">Hechos</button>
        </div>
      </div>

      <div class="list" id="list"></div>
      <div class="empty" id="empty">No hay compromisos aqu√≠ todav√≠a.</div>
    </div>

    <!-- PANE: CONTACTOS -->
    <div id="contactsPane" class="section" style="display:none;">
      <div class="sectionHead">
        <div>
          <h2>Amigos</h2>
          <p>Toca una tarjeta para crear un compromiso con ese amigo.</p>
        </div>
        <div class="segTabs">
          <span class="badge" id="bContacts">0</span>
        </div>
      </div>

      <div class="list" id="contactsList"></div>
      <div class="empty" id="contactsEmpty">A√∫n no has creado amigos.</div>
    </div>

    <!-- PANE: SETTINGS -->
    <div id="settingsPane" class="section" style="display:none;">
      <div class="sectionHead">
        <div>
          <h2>Ajustes</h2>
          <p>PIN, notificaciones, avisos y accesibilidad.</p>
        </div>
      </div>

      <div class="list" style="gap:12px;">
        <!-- Accesibilidad -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Accesibilidad</p>
              <p class="meta"><span class="chip">üëÅÔ∏è Tama√±o de letra</span></p>
            </div>
            <div class="due">Ajuste r√°pido</div>
          </div>
          <div class="actions">
            <button class="btn primary" id="btnA11y" type="button">üîé Texto grande</button>
          </div>
        </div>

        <!-- Seguridad / PIN -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Seguridad</p>
              <p class="meta"><span class="chip">üîí Bloqueo por PIN</span></p>
            </div>

            <div class="switchRow" style="gap:12px;">
              <div class="switch" id="swPin" role="switch" aria-checked="false" tabindex="0" title="Activar/Desactivar PIN"></div>
            </div>
          </div>

          <div class="desc">
            Si activas el PIN, la app se puede bloquear autom√°ticamente cuando salgas.
          </div>

          <div class="actions">
            <button class="btn" id="btnChangePin" type="button">üîÅ Cambiar PIN</button>
            <button class="btn primary" id="btnLockNow" type="button">üîí Bloquear ahora</button>
          </div>

          <div class="actions" style="margin-top:8px;">
            <div style="flex:1; min-width: 220px;">
              <label class="label" for="selAutoLock">Auto-bloqueo al salir</label>
              <select id="selAutoLock">
                <option value="0">Al volver (inmediato)</option>
                <option value="1">1 minuto</option>
                <option value="5">5 minutos</option>
                <option value="15">15 minutos</option>
                <option value="60">1 hora</option>
              </select>
            </div>
            <div style="flex:1; min-width: 220px;">
              <label class="label" for="selRemember">Recordar desbloqueo</label>
              <select id="selRemember">
                <option value="0">No recordar</option>
                <option value="5">5 min</option>
                <option value="10">10 min</option>
                <option value="30">30 min</option>
                <option value="60">1 hora</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Notificaciones -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Notificaciones</p>
              <p class="meta"><span class="chip">üîî Recordatorios</span></p>
            </div>
            <div class="switchRow" style="gap:12px;">
              <div class="switch" id="swNotif" role="switch" aria-checked="false" tabindex="0" title="Activar/Desactivar notificaciones"></div>
            </div>
          </div>

          <div class="desc">
            Las notificaciones solo funcionan si el navegador lo permite. Alternativa: usa <b>üìÖ Calendario</b>.
          </div>

          <div class="actions">
            <button class="btn" id="btnNotifPerm" type="button">‚úÖ Permitir</button>
            <span class="chip" id="notifHint">‚ÑπÔ∏è Pulsa ‚ÄúPermitir‚Äù para recibir recordatorios.</span>
          </div>
        </div>

        <!-- Avisos / contadores (sin pills arriba) -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Avisos</p>
              <p class="meta">
                <span class="chip">üì• Recibidos: <b id="bReceivedSettings">0</b></span>
                <span class="chip">üîî Notifs: <b id="bNotifSettings">0</b></span>
              </p>
            </div>
            <div class="due">Contadores</div>
          </div>

          <div class="actions">
            <button class="btn" id="btnClearReceived" type="button">üì• Limpiar recibidos</button>
            <button class="btn" id="btnClearNotifs" type="button">üîî Marcar notifs le√≠das</button>
          </div>
        </div>

        <!-- Borrar todo -->
        <div class="card">
          <div class="cardTop">
            <div class="who">
              <p class="name">Datos</p>
              <p class="meta"><span class="chip">üßπ Reinicio</span></p>
            </div>
            <div class="due bad">Peligroso</div>
          </div>
          <div class="desc">
            Borra compromisos, amigos y ajustes de este m√≥vil.
          </div>
          <div class="actions">
            <button class="btn danger" id="btnResetAll" type="button">üßπ Borrar todo</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bottom nav (fijo) -->
  <div class="bottomBar">
    <div class="bottomInner">
      <button class="navBtn active" id="tabCommitments" type="button"><span>üóìÔ∏è Compromisos</span></button>

      <button class="fab" id="fab" type="button" aria-label="Nuevo">Ôºã</button>

      <button class="navBtn" id="tabContacts" type="button"><span>üë• Amigos</span></button>

      <!-- mantenemos el ID por compatibilidad, pero oculto -->
      <button class="navBtn" id="btnInstall" type="button" style="display:none;">‚¨áÔ∏è Instalar</button>
    </div>
  </div>

  <!-- Banner instalaci√≥n -->
  <div class="installBanner" id="installBanner" aria-hidden="true">
    <div class="installCard">
      <div class="installRow">
        <div>
          <p class="installTitle" id="installTitle">Inst√°lala</p>
          <p class="installText" id="installText">Consejo</p>
        </div>
        <button class="iconBtn" id="btnHideBanner" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="actions" style="margin-top:10px;">
        <button class="btn primary" id="btnInstallBanner" type="button" style="display:none;">‚¨áÔ∏è Instalar</button>
        <button class="btn" id="btnOpenChrome" type="button" style="display:none;">üåê Abrir en Chrome</button>
        <button class="btn" id="btnCopyLink" type="button" style="display:none;">üîó Copiar enlace</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODALES + JS COMPLETO EN PARTE 2 y PARTE 3 -->
  <!-- ‚úÖ PARTE 2/3 ‚Äî MODALES + BASE JS (helpers/estado) -->
<!-- ‚úÖ PARTE 2/3 ‚Äî MODALES + BASE JS (helpers/estado + A11Y global + counters X/Y + helpers de filtros) -->

  <style>
    /* Extras de UI (toast, teclado PIN, etc.) */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(var(--bottomH) + 12px);
      background: rgba(17,24,39,.92);
      color: #fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 800;
      font-size: calc(13.5px * var(--textScale));
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      display:none;
      z-index: 60;
      max-width: min(560px, calc(100% - 24px));
      width: fit-content;
      text-align:center;
    }
    .toast.show{ display:block; }

    .twoCol{ display:flex; gap: 10px; flex-wrap: wrap; }
    .twoCol > *{ flex:1; min-width: 170px; }

    .hint{
      margin-top: 8px;
      color: var(--muted);
      font-size: calc(12.5px * var(--textScale));
      line-height: 1.35;
    }

    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .key{
      height: 52px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface2);
      font-weight: 950;
      font-size: calc(18px * var(--textScale));
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .key:active{ transform: translateY(1px); }
    .key.primary{ background: var(--primarySoft); border-color: rgba(37,99,235,.22); color:#1E40AF; }
    .key.danger{ background: var(--dangerSoft); border-color: rgba(220,38,38,.22); color:#991B1B; }

    .pinDots{ display:flex; justify-content:center; gap: 10px; margin-top: 8px; }
    .dot{
      width: 12px; height: 12px;
      border-radius: 999px;
      border: 2px solid rgba(17,24,39,.22);
      background: rgba(17,24,39,.08);
    }
    .dot.on{
      background: rgba(37,99,235,.9);
      border-color: rgba(37,99,235,.25);
      box-shadow: 0 10px 26px rgba(37,99,235,.18);
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: calc(12.5px * var(--textScale));
      color: #111827;
      background: #FAFAFB;
      border: 1px solid rgba(229,231,235,.95);
      padding: 10px 10px;
      border-radius: 16px;
      word-break: break-all;
      white-space: pre-wrap;
    }
    .seg{
      display:flex;
      gap: 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface2);
      padding: 6px;
    }
    .seg button{
      flex:1;
      height: 34px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      font-weight: 900;
      cursor:pointer;
      font-size: calc(13px * var(--textScale));
    }
    .seg button.active{
      background: var(--surface);
      border-color: rgba(229,231,235,.95);
      box-shadow: var(--shadow2);
      color: #111827;
    }
  </style>

  <!-- Modal Compromiso -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="modalTitle">Nuevo compromiso</h3>
        <button class="iconBtn" id="btnClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label class="label" for="fContact">¬øCon qui√©n?</label>
          <select id="fContact"></select>
          <div class="hint" id="contactHint">Elige un amigo o escribe un nombre sin guardar.</div>
        </div>

        <div class="field" id="customWhoField" style="display:none">
          <label class="label" for="fWho">Nombre (sin guardar)</label>
          <input id="fWho" type="text" placeholder="Ej: Laura / Mam√° / Juan (del trabajo)" autocomplete="off"/>
        </div>

        <div class="field">
          <label class="label" for="fWhat">¬øQu√© se acord√≥?</label>
          <textarea id="fWhat" placeholder="Ej: Te paso el PDF / Te devuelvo 20‚Ç¨ / Quedamos el jueves‚Ä¶"></textarea>
        </div>

        <div class="twoCol">
          <div class="field">
            <label class="label" for="fWhen">¬øPara cu√°ndo?</label>
            <input id="fWhen" type="datetime-local"/>
            <div class="hint">Puedes dejarlo sin fecha.</div>
          </div>

          <div class="field">
            <label class="label" for="fRemind">Recordatorio (por fecha)</label>
            <select id="fRemind">
              <option value="0">Ninguno</option>
              <option value="5">5 min antes</option>
              <option value="15">15 min antes</option>
              <option value="60">1 hora antes</option>
              <option value="1440">1 d√≠a antes</option>
            </select>
            <div class="hint">Requiere fecha.</div>
          </div>
        </div>

        <div class="field">
          <label class="label" for="fAfter">Avisar ‚Äúdesde ahora‚Äù (viaja en el enlace)</label>
          <select id="fAfter">
            <option value="0">No</option>
            <option value="5">En 5 minutos</option>
            <option value="15">En 15 minutos</option>
            <option value="60">En 1 hora</option>
            <option value="180">En 3 horas</option>
            <option value="1440">Ma√±ana (24h)</option>
          </select>
          <div class="hint">El receptor debe abrir el enlace para que se programe en su m√≥vil.</div>
        </div>

        <div class="hint">
          Al guardar, se abrir√° el modal de <b>Compartir</b> (con copiar enlace).
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="btnCancel" type="button">Cancelar</button>
        <button class="btn good" id="btnSave" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Contacto -->
  <div class="backdrop" id="cBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="cModalTitle">Nuevo amigo</h3>
        <button class="iconBtn" id="cBtnClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="field">
          <label class="label" for="cName">Nombre</label>
          <input id="cName" type="text" placeholder="Ej: Laura" autocomplete="off"/>
        </div>
        <div class="field">
          <label class="label" for="cNote">Nota (opcional)</label>
          <input id="cNote" type="text" placeholder="Ej: Trabajo / Vecina / Familia" autocomplete="off"/>
        </div>
        <div class="hint">Esto solo se guarda en tu m√≥vil.</div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="cBtnCancel" type="button">Cancelar</button>
        <button class="btn good" id="cBtnSave" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal PIN -->
  <div class="backdrop" id="pinBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="pinTitle">Configurar PIN</h3>
        <button class="iconBtn" id="pinClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="hint" id="pinHint" style="margin-top:0"></div>

        <div class="field" id="pinOldWrap" style="display:none">
          <label class="label" for="pinOld">PIN actual</label>
          <input id="pinOld" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNewWrap">
          <label class="label" for="pinNew">Nuevo PIN (4 d√≠gitos)</label>
          <input id="pinNew" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNew2Wrap">
          <label class="label" for="pinNew2">Repite el PIN</label>
          <input id="pinNew2" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="hint" id="pinHelp">Consejo: usa un PIN que solo t√∫ sepas.</div>
      </div>

      <div class="modalFoot">
        <button class="btn danger" id="pinCancel" type="button">Cancelar</button>
        <button class="btn good" id="pinOk" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Compartir -->
  <div class="backdrop" id="shareBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3>Compartir paquete</h3>
        <button class="iconBtn" id="shareClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="hint" id="shareTitle" style="margin-top:0"></div>

        <div class="seg" role="tablist" aria-label="Formato">
          <button id="shareShort" class="active" type="button">Corto</button>
          <button id="shareLong" type="button">Detallado</button>
        </div>

        <div class="mono" id="shareTextBox" style="margin-top:10px;"></div>

        <div class="hint" style="margin-top:10px;">Enlace (puedes copiarlo directo):</div>
        <div class="mono" id="shareUrlBox" style="margin-top:8px;"></div>

        <div class="hint">Pulsa <b>Compartir</b> para enviarlo por WhatsApp/Telegram. Si no aparece, usa copiar.</div>
      </div>

      <div class="modalFoot">
        <button class="btn" id="shareCopyUrl" type="button">üîó Copiar enlace</button>
        <button class="btn" id="shareCopyAll" type="button">üìã Copiar texto+enlace</button>
        <button class="btn primary" id="shareSend" type="button">üì§ Compartir</button>
        <button class="btn danger" id="shareCancel" type="button">Hecho</button>
      </div>
    </div>
  </div>

  <!-- Overlay bloqueo -->
  <div class="backdrop" id="lockOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <h3>üîí App bloqueada</h3>
        <button class="iconBtn" id="lockClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modalBody">
        <p class="hint" style="margin-top:0">Introduce tu PIN para continuar.</p>
        <div class="pinDots" aria-label="PIN">
          <div class="dot" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
          <div class="dot" id="d4"></div>
        </div>

        <div class="keypad" id="keypad">
          <button class="key" data-k="1" type="button">1</button>
          <button class="key" data-k="2" type="button">2</button>
          <button class="key" data-k="3" type="button">3</button>
          <button class="key" data-k="4" type="button">4</button>
          <button class="key" data-k="5" type="button">5</button>
          <button class="key" data-k="6" type="button">6</button>
          <button class="key" data-k="7" type="button">7</button>
          <button class="key" data-k="8" type="button">8</button>
          <button class="key" data-k="9" type="button">9</button>
          <button class="key danger" data-k="del" type="button">‚å´</button>
          <button class="key" data-k="0" type="button">0</button>
          <button class="key primary" data-k="ok" type="button">OK</button>
        </div>

        <div class="actions" style="margin-top:12px;">
          <button class="btn" id="btnLockCopyLink" type="button">üîó Copiar enlace actual</button>
          <button class="btn danger" id="btnLockReset" type="button">üßπ Borrar todo</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirm (propio) -->
  <div class="backdrop" id="confirmBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <h3 id="confirmTitle">Confirmar</h3>
        <button class="iconBtn" id="confirmClose" type="button" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modalBody">
        <div id="confirmMsg" class="hint" style="margin-top:0; color:#111827;"></div>
      </div>
      <div class="modalFoot">
        <button class="btn" id="confirmNo" type="button">Cancelar</button>
        <button class="btn danger" id="confirmYes" type="button">S√≠, continuar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    (function(){
      "use strict";

      const $ = (id) => document.getElementById(id);

      /* =========================
         Storage keys
         ========================= */
      const KEY = "compromisos_local_v5";
      const EVENTS_KEY = "compromisos_events_v5";
      const CONTACTS_KEY = "compromisos_contacts_v5";
      const SETTINGS_KEY = "compromisos_settings_v3";
      const REMIND_FIRED_KEY = "compromisos_remind_fired_v2";
      const AFTER_FIRED_KEY = "compromisos_after_fired_v1";

      const INBOX_PACK_KEY = "compromisos_inbox_pack_v1";
      const INBOX_TS_KEY   = "compromisos_inbox_ts_v1";

      const A11Y_KEY = "compromisos_a11y_v1";

      const PENDING_NOTIF_KEY = "compromisos_pending_notifs_v1";
      const RECEIVED_KEY = "compromisos_received_v1";

      const T = { CREATE:0, DONE:1, REOPEN:2, DELETE:3, EDIT:4 };

      function uid(){
        return "c" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function pad2(n){ return String(n).padStart(2,"0"); }

      function toast(msg){
        const t = $("toast");
        if(!t) return;
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(()=> t.classList.remove("show"), 2400);
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function load(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          const v = JSON.parse(raw);
          return v ?? fallback;
        }catch(e){ return fallback; }
      }
      function save(key, value){
        localStorage.setItem(key, JSON.stringify(value));
      }

      function fmtDate(dt){
        if(!dt) return "Sin fecha";
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return "Sin fecha";
        const now = new Date();
        const sameYear = d.getFullYear() === now.getFullYear();
        const day = pad2(d.getDate());
        const mon = pad2(d.getMonth()+1);
        const hh = pad2(d.getHours());
        const mm = pad2(d.getMinutes());
        return (sameYear ? `${day}/${mon}` : `${day}/${mon}/${d.getFullYear()}`) + ` ${hh}:${mm}`;
      }

      function isOverdue(dt){
        if(!dt) return false;
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return false;
        return d.getTime() < Date.now();
      }

      /* Base64URL (utf8-safe) */
      function b64urlEncode(str){
        const b64 = btoa(unescape(encodeURIComponent(str)));
        return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
      }
      function b64urlDecode(b64url){
        let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
        while(b64.length % 4) b64 += "=";
        return decodeURIComponent(escape(atob(b64)));
      }

      /* =========================
         Datos
         ========================= */
      let data = load(KEY, []);
      let events = load(EVENTS_KEY, []);
      let contacts = load(CONTACTS_KEY, []);
      let firedMap = load(REMIND_FIRED_KEY, {});
      let afterFired = load(AFTER_FIRED_KEY, {});

      /* =========================
         Notifs ‚Äúpendientes‚Äù (contador local)
         (Se mantienen aunque ya no haya pill en el header; se muestra en Ajustes)
         ========================= */
      let pendingNotifs = load(PENDING_NOTIF_KEY, { c:0, at:0 });

      function renderNotifCounters(){
        const c = Math.max(0, Number(pendingNotifs?.c || 0));
        if($("bNotifSettings")) $("bNotifSettings").textContent = String(c);
      }

      function incNotifAlerts(){
        pendingNotifs.c = Math.max(0, Number(pendingNotifs.c || 0)) + 1;
        pendingNotifs.at = Date.now();
        save(PENDING_NOTIF_KEY, pendingNotifs);
        renderNotifCounters();
      }

      function clearNotifAlerts(){
        pendingNotifs.c = 0;
        pendingNotifs.at = Date.now();
        save(PENDING_NOTIF_KEY, pendingNotifs);
        renderNotifCounters();
        toast("Notificaciones marcadas como le√≠das");
      }

      /* =========================
         Recibidos
         ========================= */
      let received = load(RECEIVED_KEY, { c:0, last:0 });

      function incReceived(){
        received.c = Math.max(0, Number(received.c || 0)) + 1;
        received.last = Date.now();
        save(RECEIVED_KEY, received);
      }
      function clearReceived(){
        received.c = 0;
        received.last = Date.now();
        save(RECEIVED_KEY, received);
      }
      function renderReceivedBadge(){
        const c = Math.max(0, Number(received?.c || 0));
        if($("bReceived")) $("bReceived").textContent = String(c);
        if($("bReceivedSettings")) $("bReceivedSettings").textContent = String(c);
        const pill = $("btnReceived");
        if(pill) pill.classList.toggle("good", c > 0);
      }

      /* =========================
         Confirm modal (propio)
         ========================= */
      const Confirm = (function(){
        let resolver = null;

        function open({ title, msg, yesText, danger }){
          $("confirmTitle").textContent = title || "Confirmar";
          $("confirmMsg").innerHTML = msg || "";
          $("confirmYes").textContent = yesText || "S√≠, continuar";
          $("confirmYes").classList.toggle("danger", !!danger);

          $("confirmBackdrop").classList.add("show");
          $("confirmBackdrop").setAttribute("aria-hidden","false");
          return new Promise((resolve)=>{ resolver = resolve; });
        }
        function close(val){
          $("confirmBackdrop").classList.remove("show");
          $("confirmBackdrop").setAttribute("aria-hidden","true");
          const r = resolver;
          resolver = null;
          if(r) r(!!val);
        }

        $("confirmClose").addEventListener("click", ()=> close(false));
        $("confirmNo").addEventListener("click", ()=> close(false));
        $("confirmYes").addEventListener("click", ()=> close(true));
        $("confirmBackdrop").addEventListener("click", (e)=>{ if(e.target === $("confirmBackdrop")) close(false); });

        return { open };
      })();

      /* =========================
         ‚úÖ Accesibilidad GLOBAL (texto grande en TODA la app)
         - No toca font-size inline; usa CSS var --textScale
         ========================= */
      function setTextScale(on){
        const isOn = !!on;
        document.documentElement.style.setProperty("--textScale", isOn ? "1.12" : "1");
        save(A11Y_KEY, { big: isOn });

        if($("btnA11y")) $("btnA11y").textContent = isOn ? "üîé Texto normal" : "üîé Texto grande";
        if($("btnA11yTop")) $("btnA11yTop").textContent = isOn ? "üîé Texto normal" : "üîé Texto grande";
      }
      function toggleTextScale(){
        const s = load(A11Y_KEY, { big:false });
        setTextScale(!s.big);
      }

      /* =========================
         Ajustes PIN / notifs
         ========================= */
      const defaultSettings = {
        notifEnabled: false,
        pinEnabled: false,
        pinHash: null,
        autoLockMin: 0,
        rememberMin: 10,
        unlockUntil: 0
      };
      let settings = Object.assign({}, defaultSettings, load(SETTINGS_KEY, {}));

      let sessionUnlocked = false;
      let lockAtTs = 0;

      async function sha256Base64Url(str){
        try{
          if(!crypto || !crypto.subtle) throw new Error("no subtle");
          const enc = new TextEncoder();
          const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
          const bytes = Array.from(new Uint8Array(buf));
          const b64 = btoa(String.fromCharCode(...bytes));
          return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
        }catch(e){
          let h = 0;
          const s = String(str);
          for(let i=0;i<s.length;i++){
            h = ((h<<5)-h) + s.charCodeAt(i);
            h |= 0;
          }
          return "fh_" + String(h);
        }
      }
      function normalizePin(pin){
        return String(pin||"").trim().replaceAll(/\D/g,"").slice(0,4);
      }
      async function verifyPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) return false;
        const h = await sha256Base64Url("pin:" + p);
        return settings.pinHash && h === settings.pinHash;
      }
      async function setPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) throw new Error("pin");
        settings.pinHash = await sha256Base64Url("pin:" + p);
        save(SETTINGS_KEY, settings);
      }

      function isUnlockedNow(){
        if(!settings.pinEnabled) return true;
        const now = Date.now();
        if(settings.unlockUntil && now < settings.unlockUntil) return true;
        return sessionUnlocked === true;
      }

      function applyUnlock(){
        if(!settings.pinEnabled) return;
        const now = Date.now();
        const rem = Number(settings.rememberMin || 0);
        if(rem > 0){
          settings.unlockUntil = now + rem*60*1000;
          sessionUnlocked = false;
        } else {
          settings.unlockUntil = 0;
          sessionUnlocked = true;
        }
        save(SETTINGS_KEY, settings);
      }

      function showLockOverlay(){
        if(!settings.pinEnabled) return;
        $("lockOverlay").classList.add("show");
        $("lockOverlay").setAttribute("aria-hidden","false");
      }
      function hideLockOverlay(){
        $("lockOverlay").classList.remove("show");
        $("lockOverlay").setAttribute("aria-hidden","true");
      }

      function forceLock(){
        if(!settings.pinEnabled) return;
        settings.unlockUntil = 0;
        sessionUnlocked = false;
        lockAtTs = 0;
        save(SETTINGS_KEY, settings);
        showLockOverlay();
      }

      function notifPermission(){
        try{ return Notification.permission; }catch(e){ return "unsupported"; }
      }
      function notifSupported(){
        return typeof Notification !== "undefined";
      }
      async function requestNotifPermission(){
        if(!notifSupported()){
          toast("Tu navegador no soporta notificaciones");
          return false;
        }
        try{
          const p = await Notification.requestPermission();
          if(p === "granted"){ toast("Notificaciones permitidas ‚úÖ"); return true; }
          toast("Permiso no concedido");
          return false;
        }catch(e){
          toast("No se pudo pedir permiso");
          return false;
        }
      }

      function canNotify(){
        if(!settings.notifEnabled) return false;
        if(typeof Notification === "undefined") return false;
        return Notification.permission === "granted";
      }
      function sendLocalNotification(title, body){
        try{
          if(canNotify()){
            new Notification(title, { body });
            return true;
          }
        }catch(e){}
        return false;
      }

      /* =========================
         Eventos / paquetes
         ========================= */
      function makeEvent(type, payload){
        return { id: uid(), type, at: new Date().toISOString(), payload };
      }

      function packEvent(ev){
        return { v:1, e:{ i: ev.id, t: ev.type, a: ev.at, p: ev.payload || {} } };
      }
      function unpackEvent(pack){
        if(!pack || pack.v !== 1 || !pack.e) return null;
        const e = pack.e;
        if(!e.i || e.t == null || !e.a) return null;
        return { id: e.i, type: e.t, at: e.a, payload: e.p || {} };
      }
      function makePackage(ev){
        return b64urlEncode(JSON.stringify(packEvent(ev)));
      }
      function parsePackage(p){
        const json = b64urlDecode(p);
        return JSON.parse(json);
      }
      function baseFolderUrl(){
        const path = location.pathname || "/";
        const folder = path.replace(/\/[^\/]*$/, "/");
        return location.origin + folder;
      }
      function baseFileUrl(){
        return location.origin + location.pathname;
      }
      function makeLinkFromPackage(p){
        return baseFolderUrl() + "compromisos.html#p=" + p;
      }

      /* =========================
         ‚úÖ Estado UI / filtros (para tiles)
         ========================= */
      let pane = "commitments";   // commitments | contacts | settings
      let view = "pending";       // pending | done

      // filtro extra: solo vencidos cuando pulsas pill "Vencidos"
      let overdueOnly = false;

      function safeShow(el, show){
        if(!el) return;
        el.style.display = show ? "" : "none";
      }

      /* ‚úÖ FIN PARTE 2/3
         En PARTE 3 va TODO lo que falta:
         - applyEvent completo + limpieza firedMaps
         - render con filtros (pendientes/hechos + overdueOnly)
         - contadores tiles X/Y + amigos count
         - navegaci√≥n tiles/bottom + acciones
         - Ajustes: switches + botones limpiar contadores
         - boot + recordatorios + import + share + calendario (lo que ya ten√≠as)
      */
