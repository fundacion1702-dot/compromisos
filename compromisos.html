<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compromisos</title>
  <meta name="theme-color" content="#6b5bff"/>
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#0b0c12;
      --surface:#121427;
      --surface2:#171a33;
      --text:#e9ecff;
      --muted:#aab0d6;
      --primary:#6b5bff;
      --primary2:#8a7dff;
      --good:#36d399;
      --bad:#ff5c7a;
      --warn:#ffcc66;
      --stroke:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px;

      --fs-base: 16px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-size: var(--fs-base);
      font-family:
        system-ui, -apple-system, Segoe UI, Roboto, Arial,
        "Noto Color Emoji", "Segoe UI Emoji", "Apple Color Emoji",
        "Noto Emoji", sans-serif;
      background: radial-gradient(1000px 600px at 20% -10%, rgba(107,91,255,.35), transparent 60%),
                  radial-gradient(800px 600px at 90% 0%, rgba(255,204,102,.15), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      padding-bottom:96px;
    }

    .wrap{ max-width:560px; margin:0 auto; padding:16px 14px 0; }

    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:6px;
    }

    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }

    .logo{
      width:44px;height:44px;border-radius:15px; display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.70));
      box-shadow: 0 12px 30px rgba(107,91,255,.25);
      border:1px solid rgba(255,255,255,.14);
      flex:0 0 auto; font-weight:950; letter-spacing:.5px;
      font-size: 18px;
    }

    .brand h1{
      margin:0; font-size:20px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brand p{
      margin:2px 0 0; font-size:13.5px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .iconbtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      transition: transform .08s ease, background .15s ease;
      display:flex; align-items:center; gap:8px;
      font-weight:900;
      font-size: 14px;
    }
    .iconbtn:active{ transform: scale(.98); }
    .iconbtn small{ color:var(--muted); font-weight:800; font-size: 12.5px; }

    .hero{
      margin-top: 14px;
      padding: 14px;
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
    }
    .hero .row{ display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(107,91,255,.14);
      color: var(--text);
      font-size: 13px;
      font-weight: 850;
      white-space:nowrap;
    }
    .hero h2{ margin: 10px 0 6px; font-size: 18px; line-height:1.25; }
    .hero p{ margin: 0; color: var(--muted); font-size: 15px; line-height:1.4; }

    .banner{
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--r);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
      display:none;
    }
    .banner.show{ display:block; }
    .banner .title{ font-weight:950; margin:0 0 6px; font-size: 16px; }
    .banner .txt{ margin:0; color:var(--muted); font-size:14.5px; line-height:1.35; }
    .banner .row{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }

    .btn{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 11px 12px;
      cursor:pointer;
      font-weight: 950;
      font-size: 15px;
      transition: transform .08s ease, background .15s ease;
      display:flex; align-items:center; justify-content:center; gap:8px;
      flex:1;
    }
    .btn:active{ transform: scale(.99); }

    .btn.primary{
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55));
      border-color: rgba(255,255,255,.16);
    }
    .btn.good{
      background: linear-gradient(135deg, rgba(54,211,153,.95), rgba(54,211,153,.55));
      border-color: rgba(255,255,255,.16);
      color:#06150f;
    }
    .btn.danger{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.35);
    }
    .btn.ghost{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.12);
    }

    .tabs{
      margin-top: 14px;
      display:flex; gap:10px; padding: 6px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: 0 10px 25px rgba(0,0,0,.15);
    }
    .tab{
      flex:1;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 11px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      font-size: 15px;
      display:flex; align-items:center; justify-content:center; gap:8px;
      min-width: 0;
      white-space:nowrap;
    }
    .tab.active{
      color: var(--text);
      background: linear-gradient(135deg, rgba(107,91,255,.85), rgba(138,125,255,.55));
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 12px 30px rgba(107,91,255,.22);
    }
    .badge{
      display:inline-grid; place-items:center;
      min-width: 24px;
      padding: 2px 9px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 950;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }

    .subtabs{
      margin-top: 12px;
      display:flex; gap:10px; padding: 6px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
    }
    .subtab{
      flex:1;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      font-size: 14.5px;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .subtab.active{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
    }

    .list{ margin-top: 14px; display:flex; flex-direction:column; gap: 10px; }

    .card{
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--stroke);
      padding: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .cardTop{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .who{ min-width:0; }
    .who .name{
      margin:0; font-size: 16px; font-weight: 950; letter-spacing:.2px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .who .meta{
      margin: 4px 0 0; font-size: 13px; color: var(--muted);
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 4px 9px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 850;
      font-size: 12.5px;
    }
    .due{
      font-size: 13.5px;
      font-weight: 950;
      padding: 7px 11px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,204,102,.12);
      color: var(--text);
      white-space:nowrap;
    }
    .due.bad{ background: rgba(255,92,122,.14); }

    .desc{
      margin: 10px 0 0;
      font-size: 15px;
      line-height:1.35;
      color: var(--text);
      opacity: .95;
      word-break: break-word;
    }

    .actions{ margin-top: 10px; display:flex; gap: 10px; flex-wrap:wrap; }
    .actions .btn{ flex: 1; min-width: 120px; }
    .actions .btn.icon{ flex: 0 0 auto; min-width: 58px; }

    .empty{
      padding: 18px 14px;
      border-radius: var(--r);
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      text-align:center;
      line-height:1.35;
      display:none;
      font-size: 15px;
    }

    .fab{
      position: fixed;
      right: 16px;
      bottom: 18px;
      width: 62px;
      height: 62px;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55));
      box-shadow: 0 18px 45px rgba(107,91,255,.25), 0 14px 40px rgba(0,0,0,.35);
      color: white;
      font-size: 30px;
      font-weight: 950;
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
      z-index: 50;
    }
    .fab:active{ transform: scale(.98); }

    /* Modal / Bottom Sheet */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 14px;
      z-index: 999;
    }
    .backdrop.show{ display:flex; }

    .sheet{
      width: min(560px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(23,26,51,.98), rgba(18,20,39,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }

    .sheetHead{
      padding: 12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .sheetHead h3{ margin:0; font-size: 17px; font-weight: 950; letter-spacing:.2px; }

    .close{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 9px 11px;
      cursor:pointer;
      font-weight: 950;
      font-size: 14px;
    }

    .sheetBody{ padding: 14px; display:flex; flex-direction:column; gap: 10px; }

    .field label{
      display:block;
      font-size: 13.5px;
      font-weight: 950;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input, .field textarea, .field select{
      width: 100%;
      padding: 13px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline: none;
      font-size: 16px;
    }
    .field textarea{ min-height: 92px; resize: vertical; }

    .hint{
      font-size: 13.5px;
      color: var(--muted);
      margin-top: 6px;
      line-height:1.35;
    }

    .sheetFoot{ padding: 12px 14px 14px; display:flex; gap: 10px; flex-wrap:wrap; }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 90px;
      background: rgba(0,0,0,.65);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      font-weight: 850;
      font-size: 14px;
      display:none;
      z-index: 1000;
      max-width: calc(100% - 28px);
      text-align:center;
    }
    .toast.show{ display:block; }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      color:var(--muted);
      word-break: break-all;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      padding:10px;
      border-radius:14px;
      margin-top:10px;
      display:none;
    }
    .mono.show{ display:block; }

    .monoRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .monoRow .mono{ flex: 1 1 100%; }
    .monoRow .btn{ flex: 1 1 160px; }

    .kicker{
      font-size: 13px;
      color: var(--muted);
      margin: 10px 0 0;
    }

    /* Ajustes (switch) */
    .rowline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    .rowline .ttl{ font-weight: 950; }
    .rowline .sub{ font-size: 13.5px; color: var(--muted); margin-top: 3px; line-height:1.25; }
    .stack{ display:flex; flex-direction:column; min-width:0; }
    .right{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .switch{
      width: 52px;
      height: 32px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      position: relative;
      cursor:pointer;
      flex:0 0 auto;
    }
    .switch::after{
      content:"";
      position:absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      background: rgba(255,255,255,.90);
      box-shadow: 0 10px 20px rgba(0,0,0,.35);
      transition: transform .18s ease, background .18s ease;
    }
    .switch.on{
      background: rgba(107,91,255,.35);
      border-color: rgba(255,255,255,.22);
    }
    .switch.on::after{
      transform: translateX(20px);
      background: rgba(255,255,255,.96);
    }

    /* Bloqueo (PIN) overlay */
    .lockOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 2000;
    }
    .lockOverlay.show{ display:flex; }
    .lockCard{
      width: min(420px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(23,26,51,.98), rgba(18,20,39,.98));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .lockHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .lockHead h3{ margin:0; font-size: 18px; font-weight: 950; }
    .lockHead p{ margin:6px 0 0; color: var(--muted); font-size: 14px; line-height:1.25; }
    .lockBody{ padding: 14px; display:flex; flex-direction:column; gap: 12px; }
    .pinDots{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top: 2px;
    }
    .dot{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
    }
    .dot.on{
      background: rgba(107,91,255,.85);
      border-color: rgba(255,255,255,.30);
      box-shadow: 0 10px 25px rgba(107,91,255,.22);
    }
    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 6px;
    }
    .key{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 14px 12px;
      font-size: 18px;
      font-weight: 950;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
      text-align:center;
    }
    .key:active{ transform: scale(.99); }
    .key.primary{
      background: linear-gradient(135deg, rgba(107,91,255,.95), rgba(138,125,255,.55));
      border-color: rgba(255,255,255,.18);
    }
    .key.danger{
      background: rgba(255,92,122,.12);
      border-color: rgba(255,92,122,.35);
    }
    .lockFoot{
      padding: 12px 14px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Selector corto/detallado en compartir */
    .seg{
      display:flex;
      gap:10px;
      padding: 6px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .seg button{
      flex:1;
      border-radius: 14px;
      border:1px solid transparent;
      background: transparent;
      color: var(--muted);
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 950;
      font-size: 14.5px;
    }
    .seg button.active{
      color: var(--text);
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
    }

    .shareRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .shareRow .lbl{
      font-weight: 950;
      color: var(--text);
      font-size: 14px;
      flex: 1 1 100%;
    }
    .shareRow select{ flex: 1 1 180px; }
    .shareRow .btn{ flex: 1 1 160px; }

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">C</div>
        <div style="min-width:0">
          <h1>Compromisos</h1>
          <p>Paquetes entre m√≥viles ¬∑ sin base de datos</p>
        </div>
      </div>

      <button class="iconbtn" id="btnInstall" style="display:none">‚¨áÔ∏è <small>Instalar</small></button>
    </header>

    <section class="hero">
      <div class="row">
        <div class="pill">üë• Contactos</div>
        <div class="pill">üì¶ Paquetes</div>
        <div class="pill">üîî Recordatorios</div>
        <div class="pill">üîí PIN</div>
      </div>
      <h2>Comparte cambios como un enlace (sin cuentas).</h2>
      <p>Ahora puedes poner recordatorios ‚Äúpor fecha‚Äù o ‚Äúen X horas‚Äù.</p>

      <div class="monoRow" id="lastLinkRow" style="display:none">
        <div class="mono show" id="lastLink"></div>
        <button class="btn" id="btnCopyLastLink">üìé Copiar enlace</button>
      </div>

      <div class="kicker" id="statsKicker" style="display:none"></div>
    </section>

    <!-- Banner inteligente (instalar / abrir en Chrome) -->
    <section class="banner" id="installBanner">
      <p class="title" id="installTitle">Inst√°lala para usarla como app</p>
      <p class="txt" id="installText">
        Si la abres dentro de WhatsApp/Telegram, toca <b>Abrir en Chrome</b> para poder instalar.
      </p>
      <div class="row">
        <button class="btn primary" id="btnInstallBanner" style="display:none">‚¨áÔ∏è Instalar</button>
        <button class="btn primary" id="btnOpenChrome" style="display:none">üåê Abrir en Chrome</button>
        <button class="btn" id="btnCopyLink" style="display:none">üìã Copiar enlace</button>
        <button class="btn" id="btnHideBanner">Ocultar</button>
      </div>
    </section>

    <!-- Vista principal -->
    <nav class="tabs" aria-label="Vistas">
      <button class="tab active" id="tabCommitments">üìù Compromisos</button>
      <button class="tab" id="tabContacts">üë• Amigos <span class="badge" id="bContacts">0</span></button>
      <button class="tab" id="tabSettings">‚öôÔ∏è Ajustes</button>
    </nav>

    <!-- Compromisos -->
    <div id="commitmentsPane">
      <nav class="subtabs" aria-label="Pesta√±as">
        <button class="subtab active" id="tabPending">Pendientes <span class="badge" id="bPending">0</span></button>
        <button class="subtab" id="tabDone">Hechos <span class="badge" id="bDone">0</span></button>
      </nav>

      <div class="list" id="list"></div>
      <div class="empty" id="empty">No tienes compromisos aqu√≠. Pulsa <b>+</b> para crear uno nuevo.</div>
    </div>

    <!-- Contactos -->
    <div id="contactsPane" style="display:none">
      <div class="list" id="contactsList"></div>
      <div class="empty" id="contactsEmpty">No tienes contactos a√∫n. Pulsa <b>+</b> para crear el primero.</div>
    </div>

    <!-- Ajustes -->
    <div id="settingsPane" style="display:none">
      <div class="list">

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîî Notificaciones</div>
            <div class="sub">Recordatorios locales (funcionan seguro cuando la app est√° abierta; en segundo plano depende del m√≥vil).</div>
          </div>
          <div class="right">
            <div class="switch" id="swNotif" role="switch" aria-checked="false" tabindex="0"></div>
            <button class="btn" id="btnNotifPerm" style="flex:0 0 auto; min-width: 160px;">Permitir</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîí Bloqueo por PIN</div>
            <div class="sub">Protege la app con un PIN de 4 d√≠gitos. Puedes activarlo o desactivarlo cuando quieras.</div>
          </div>
          <div class="right">
            <div class="switch" id="swPin" role="switch" aria-checked="false" tabindex="0"></div>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">‚è±Ô∏è Auto-bloqueo</div>
            <div class="sub">Cuando sales de la app, se bloquea pasado este tiempo.</div>
          </div>
          <div class="right">
            <select id="selAutoLock" style="min-width:160px">
              <option value="0">Inmediato</option>
              <option value="1">1 minuto</option>
              <option value="5">5 minutos</option>
              <option value="15">15 minutos</option>
              <option value="60">60 minutos</option>
            </select>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üïí Recordar desbloqueo</div>
            <div class="sub">Durante este tiempo no pedir√° PIN (si el PIN est√° activado).</div>
          </div>
          <div class="right">
            <select id="selRemember" style="min-width:160px">
              <option value="0">No recordar</option>
              <option value="10">10 minutos</option>
              <option value="30">30 minutos</option>
              <option value="60">60 minutos</option>
            </select>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîÅ Cambiar PIN</div>
            <div class="sub">Requiere el PIN actual (si est√° activado).</div>
          </div>
          <div class="right">
            <button class="btn" id="btnChangePin">Cambiar</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üîí Bloquear ahora</div>
            <div class="sub">Te pide el PIN en la pr√≥xima apertura (o ahora mismo si el PIN est√° activado).</div>
          </div>
          <div class="right">
            <button class="btn danger" id="btnLockNow">Bloquear</button>
          </div>
        </div>

        <div class="rowline">
          <div class="stack" style="min-width:0">
            <div class="ttl">üßπ Restablecer app</div>
            <div class="sub">Borra compromisos, contactos y ajustes del m√≥vil (irreversible).</div>
          </div>
          <div class="right">
            <button class="btn danger" id="btnResetAll">Borrar todo</button>
          </div>
        </div>

        <div class="hint" style="margin-top:6px" id="notifHint"></div>

      </div>
    </div>

  </div>

  <button class="fab" id="fab" aria-label="Nuevo">+</button>

  <!-- Modal Compromiso (nuevo/editar) -->
  <div class="backdrop" id="backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="modalTitle">Nuevo compromiso</h3>
        <button class="close" id="btnClose">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="field">
          <label for="fContact">¬øCon qui√©n?</label>
          <select id="fContact"></select>
          <div class="hint" id="contactHint">Puedes elegir un contacto o escribir uno nuevo.</div>
        </div>

        <div class="field" id="customWhoField" style="display:none">
          <label for="fWho">Nombre (nuevo contacto)</label>
          <input id="fWho" type="text" placeholder="Ej: Laura / Mam√° / Juan (del trabajo)" autocomplete="off"/>
        </div>

        <div class="field">
          <label for="fWhat">¬øQu√© se acord√≥?</label>
          <textarea id="fWhat" placeholder="Ej: Te paso el PDF / Te devuelvo 20‚Ç¨ / Quedamos el jueves‚Ä¶"></textarea>
        </div>

        <div class="field">
          <label for="fWhen">¬øPara cu√°ndo? (opcional)</label>
          <input id="fWhen" type="datetime-local" />
          <div class="hint">Puedes dejarlo sin fecha (sin calendario). Si hay fecha, podr√°s usar recordatorio por fecha.</div>
        </div>

        <div class="field">
          <label for="fRemindByDate">Recordatorio por fecha</label>
          <select id="fRemindByDate">
            <option value="0">Ninguno</option>
            <option value="5">5 min antes</option>
            <option value="15">15 min antes</option>
            <option value="60">1 hora antes</option>
            <option value="1440">1 d√≠a antes</option>
          </select>
          <div class="hint">Requiere fecha. Para notificar, activa ‚ÄúNotificaciones‚Äù en Ajustes.</div>
        </div>

        <div class="field">
          <label for="fRemindAfter">Recordatorio en X horas (desde ahora)</label>
          <select id="fRemindAfter">
            <option value="0">Ninguno</option>
            <option value="1">En 1 hora</option>
            <option value="3">En 3 horas</option>
            <option value="6">En 6 horas</option>
            <option value="24">En 24 horas</option>
          </select>
          <div class="hint">Funciona aunque no haya fecha. Ideal para ‚Äúrecu√©rdamelo luego‚Äù.</div>
        </div>

        <div class="hint">
          Al guardar, podr√°s <b>Compartir</b> el cambio con bot√≥n directo para copiar enlace.
        </div>
      </div>

      <div class="sheetFoot">
        <button class="btn danger" id="btnCancel">Cancelar</button>
        <button class="btn good" id="btnSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Contacto (nuevo/editar) -->
  <div class="backdrop" id="cBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="cModalTitle">Nuevo contacto</h3>
        <button class="close" id="cBtnClose">‚úï</button>
      </div>

      <div class="sheetBody">
        <div class="field">
          <label for="cName">Nombre</label>
          <input id="cName" type="text" placeholder="Ej: Laura" autocomplete="off"/>
        </div>
        <div class="field">
          <label for="cNote">Nota (opcional)</label>
          <input id="cNote" type="text" placeholder="Ej: Trabajo / Vecina / Familia" autocomplete="off"/>
        </div>
        <div class="hint">Esto solo se guarda en tu m√≥vil.</div>
      </div>

      <div class="sheetFoot">
        <button class="btn danger" id="cBtnCancel">Cancelar</button>
        <button class="btn good" id="cBtnSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal PIN (activar/cambiar/desactivar) -->
  <div class="backdrop" id="pinBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3 id="pinTitle">Configurar PIN</h3>
        <button class="close" id="pinClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="hint" id="pinHint" style="margin-top:0"></div>

        <div class="field" id="pinOldWrap" style="display:none">
          <label for="pinOld">PIN actual</label>
          <input id="pinOld" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNewWrap">
          <label for="pinNew">Nuevo PIN (4 d√≠gitos)</label>
          <input id="pinNew" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="field" id="pinNew2Wrap">
          <label for="pinNew2">Repite el PIN</label>
          <input id="pinNew2" inputmode="numeric" autocomplete="off" pattern="[0-9]*" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>

        <div class="hint" id="pinHelp">Consejo: usa un PIN que solo t√∫ sepas. Puedes desactivarlo en Ajustes.</div>
      </div>
      <div class="sheetFoot">
        <button class="btn danger" id="pinCancel">Cancelar</button>
        <button class="btn good" id="pinOk">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal Compartir (mensaje bonito antes de enviar) -->
  <div class="backdrop" id="shareBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheet">
      <div class="sheetHead">
        <h3>Compartir paquete</h3>
        <button class="close" id="shareClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="hint" id="shareTitle" style="margin-top:0"></div>

        <div class="seg" role="tablist" aria-label="Formato">
          <button id="shareShort" class="active" type="button">Corto</button>
          <button id="shareLong" type="button">Detallado</button>
        </div>

        <div class="mono show" id="shareTextBox"></div>
        <div class="mono show" id="shareUrlBox"></div>

        <div class="shareRow">
          <div class="lbl">‚è∞ Recordatorio despu√©s de compartir (opcional)</div>
          <select id="shareAfter">
            <option value="0">Ninguno</option>
            <option value="1">En 1 hora</option>
            <option value="3">En 3 horas</option>
            <option value="6">En 6 horas</option>
            <option value="24">En 24 horas</option>
          </select>
          <button class="btn" id="shareSchedule">Programar</button>
        </div>

        <div class="hint">Pulsa <b>Compartir</b> para enviarlo. O usa <b>Copiar enlace</b> para pegarlo r√°pido.</div>
      </div>
      <div class="sheetFoot">
        <button class="btn" id="shareCopyLink">üìé Copiar enlace</button>
        <button class="btn" id="shareCopyAll">üìã Copiar todo</button>
        <button class="btn primary" id="shareSend">üì§ Compartir</button>
        <button class="btn danger" id="shareCancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Overlay bloqueo -->
  <div class="lockOverlay" id="lockOverlay" aria-hidden="true">
    <div class="lockCard" role="dialog" aria-modal="true">
      <div class="lockHead">
        <h3>üîí App bloqueada</h3>
        <p>Introduce tu PIN para continuar.</p>
      </div>
      <div class="lockBody">
        <div class="pinDots" aria-label="PIN">
          <div class="dot" id="d1"></div>
          <div class="dot" id="d2"></div>
          <div class="dot" id="d3"></div>
          <div class="dot" id="d4"></div>
        </div>

        <div class="keypad" id="keypad">
          <button class="key" data-k="1">1</button>
          <button class="key" data-k="2">2</button>
          <button class="key" data-k="3">3</button>
          <button class="key" data-k="4">4</button>
          <button class="key" data-k="5">5</button>
          <button class="key" data-k="6">6</button>
          <button class="key" data-k="7">7</button>
          <button class="key" data-k="8">8</button>
          <button class="key" data-k="9">9</button>
          <button class="key danger" data-k="del">‚å´</button>
          <button class="key" data-k="0">0</button>
          <button class="key primary" data-k="ok">OK</button>
        </div>
      </div>
      <div class="lockFoot">
        <button class="btn ghost" id="btnLockCopyLink">üìã Copiar enlace actual</button>
        <button class="btn danger" id="btnLockReset">Borrar todo</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    (function(){
      "use strict";

      const $ = (id) => document.getElementById(id);

      const KEY = "compromisos_local_v5";
      const EVENTS_KEY = "compromisos_events_v5";
      const CONTACTS_KEY = "compromisos_contacts_v5";
      const SETTINGS_KEY = "compromisos_settings_v2";
      const REMIND_FIRED_KEY = "compromisos_remind_fired_v1";
      const REMINDERS_KEY = "compromisos_reminders_v1"; // recordatorios absolutos (en X horas)

      // Tipos num√©ricos para acortar paquetes
      const T = { CREATE:0, DONE:1, REOPEN:2, DELETE:3, EDIT:4 };

      function uid(){
        return "c" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      }
      function pad2(n){ return String(n).padStart(2,"0"); }

      function fmtDate(dt){
        if(!dt) return "Sin fecha";
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return "Sin fecha";
        const now = new Date();
        const sameYear = d.getFullYear() === now.getFullYear();
        const day = pad2(d.getDate());
        const mon = pad2(d.getMonth()+1);
        const hh = pad2(d.getHours());
        const mm = pad2(d.getMinutes());
        return (sameYear ? `${day}/${mon}` : `${day}/${mon}/${d.getFullYear()}`) + ` ${hh}:${mm}`;
      }
      function isOverdue(dt){
        if(!dt) return false;
        const d = new Date(dt);
        if(Number.isNaN(d.getTime())) return false;
        return d.getTime() < Date.now();
      }

      function toast(msg){
        const t = $("toast");
        t.textContent = msg;
        t.classList.add("show");
        clearTimeout(toast._timer);
        toast._timer = setTimeout(()=> t.classList.remove("show"), 2400);
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      // Base64URL (utf8-safe)
      function b64urlEncode(str){
        const b64 = btoa(unescape(encodeURIComponent(str)));
        return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
      }
      function b64urlDecode(b64url){
        let b64 = b64url.replaceAll("-","+").replaceAll("_","/");
        while(b64.length % 4) b64 += "=";
        return decodeURIComponent(escape(atob(b64)));
      }

      function load(key, fallback){
        try{
          const raw = localStorage.getItem(key);
          if(!raw) return fallback;
          const v = JSON.parse(raw);
          return v ?? fallback;
        }catch(e){ return fallback; }
      }
      function save(key, value){
        localStorage.setItem(key, JSON.stringify(value));
      }

      // --------- PRIVACIDAD + NOTIFICACIONES (ajustes) ----------
      const defaultSettings = {
        notifEnabled: false,
        pinEnabled: false,
        pinHash: null,
        autoLockMin: 0,
        rememberMin: 10,
        unlockUntil: 0
      };
      let settings = Object.assign({}, defaultSettings, load(SETTINGS_KEY, {}));

      let sessionUnlocked = false;
      let lockAtTs = 0;

      async function sha256Base64Url(str){
        try{
          if(!crypto || !crypto.subtle) throw new Error("no subtle");
          const enc = new TextEncoder();
          const buf = await crypto.subtle.digest("SHA-256", enc.encode(str));
          const bytes = Array.from(new Uint8Array(buf));
          const b64 = btoa(String.fromCharCode(...bytes));
          return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
        }catch(e){
          let h = 0;
          const s = String(str);
          for(let i=0;i<s.length;i++){
            h = ((h<<5)-h) + s.charCodeAt(i);
            h |= 0;
          }
          return "fh_" + String(h);
        }
      }

      function normalizePin(pin){
        return String(pin||"").trim().replaceAll(/\D/g,"").slice(0,4);
      }

      async function verifyPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) return false;
        const h = await sha256Base64Url("pin:" + p);
        return settings.pinHash && h === settings.pinHash;
      }

      async function setPin(pin){
        const p = normalizePin(pin);
        if(p.length !== 4) throw new Error("pin");
        settings.pinHash = await sha256Base64Url("pin:" + p);
        save(SETTINGS_KEY, settings);
      }

      function isUnlockedNow(){
        if(!settings.pinEnabled) return true;
        const now = Date.now();
        if(settings.unlockUntil && now < settings.unlockUntil) return true;
        return sessionUnlocked === true;
      }

      function applyUnlock(){
        if(!settings.pinEnabled) return;
        const now = Date.now();
        const rem = Number(settings.rememberMin || 0);
        if(rem > 0){
          settings.unlockUntil = now + rem*60*1000;
          sessionUnlocked = false;
        } else {
          settings.unlockUntil = 0;
          sessionUnlocked = true;
        }
        save(SETTINGS_KEY, settings);
      }

      function forceLock(){
        if(!settings.pinEnabled) return;
        settings.unlockUntil = 0;
        sessionUnlocked = false;
        lockAtTs = 0;
        save(SETTINGS_KEY, settings);
        showLockOverlay();
      }

      function setPinEnabled(on){
        settings.pinEnabled = !!on;
        if(!settings.pinEnabled){
          settings.pinHash = null;
          settings.unlockUntil = 0;
          sessionUnlocked = false;
          lockAtTs = 0;
        }
        save(SETTINGS_KEY, settings);
        updateSettingsUI();
      }

      function setNotifEnabled(on){
        settings.notifEnabled = !!on;
        save(SETTINGS_KEY, settings);
        updateSettingsUI();
      }

      function notifPermission(){
        try{ return Notification.permission; }catch(e){ return "unsupported"; }
      }

      function notifSupported(){
        return typeof Notification !== "undefined";
      }

      async function requestNotifPermission(){
        if(!notifSupported()){
          toast("Tu navegador no soporta notificaciones");
          return false;
        }
        try{
          const p = await Notification.requestPermission();
          updateSettingsUI();
          if(p === "granted"){
            toast("Notificaciones permitidas ‚úÖ");
            return true;
          }
          toast("Permiso no concedido");
          return false;
        }catch(e){
          toast("No se pudo pedir permiso");
          return false;
        }
      }

      function updateSettingsUI(){
        const swP = $("swPin");
        swP.classList.toggle("on", !!settings.pinEnabled);
        swP.setAttribute("aria-checked", settings.pinEnabled ? "true":"false");

        const swN = $("swNotif");
        swN.classList.toggle("on", !!settings.notifEnabled);
        swN.setAttribute("aria-checked", settings.notifEnabled ? "true":"false");

        $("selAutoLock").value = String(settings.autoLockMin ?? 0);
        $("selRemember").value = String(settings.rememberMin ?? 10);

        const hint = $("notifHint");
        const perm = notifPermission();
        const sup = notifSupported();
        if(!sup){
          hint.textContent = "‚ö†Ô∏è Este navegador no soporta notificaciones. Usa ‚ÄúüìÖ Calendario‚Äù en cada compromiso.";
          $("btnNotifPerm").style.display = "none";
        }else{
          $("btnNotifPerm").style.display = "";
          if(perm === "granted"){
            hint.textContent = settings.notifEnabled
              ? "‚úÖ Notificaciones activadas. Recibir√°s recordatorios seg√∫n la configuraci√≥n."
              : "‚ÑπÔ∏è Tienes permiso concedido, pero est√°n desactivadas. Act√≠valas con el switch.";
          } else if(perm === "denied"){
            hint.textContent = "üö´ Notificaciones bloqueadas. Debes permitirlas en Ajustes de Android/Chrome (o reinstalar la PWA). Usa ‚ÄúüìÖ Calendario‚Äù como alternativa.";
          } else {
            hint.textContent = "‚ÑπÔ∏è Pulsa ‚ÄúPermitir‚Äù para poder recibir recordatorios. Si no, usa ‚ÄúüìÖ Calendario‚Äù.";
          }
        }
      }

      // --------- Datos app ----------
      let data = load(KEY, []);
      let events = load(EVENTS_KEY, []);
      let contacts = load(CONTACTS_KEY, []);
      let firedMap = load(REMIND_FIRED_KEY, {});
      let reminders = load(REMINDERS_KEY, []); // {id, at, title, body, itemId, kind, createdAt, firedAt}

      let view = "pending";
      let pane = "commitments";

      function contactById(id){ return contacts.find(c => c.id === id) || null; }

      function normalizedWho(item){
        if(item.whoId){
          const c = contactById(item.whoId);
          if(c && c.name) return c.name;
        }
        return item.whoName || "Sin nombre";
      }

      function remindLabelByDate(min){
        const m = Number(min||0);
        if(!m) return "";
        if(m === 5) return "üîî 5m";
        if(m === 15) return "üîî 15m";
        if(m === 60) return "üîî 1h";
        if(m === 1440) return "üîî 1d";
        return "üîî";
      }
      function remindLabelAfter(hours){
        const h = Number(hours||0);
        if(!h) return "";
        if(h === 1) return "‚è≥ 1h";
        if(h === 3) return "‚è≥ 3h";
        if(h === 6) return "‚è≥ 6h";
        if(h === 24) return "‚è≥ 24h";
        return "‚è≥";
      }

      // --------- Recordatorios absolutos (en X horas) ----------
      function saveReminders(){
        // Limpieza simple: mantener √∫ltimos 500
        if(reminders.length > 500) reminders = reminders.slice(reminders.length - 500);
        save(REMINDERS_KEY, reminders);
      }

      function scheduleReminderAt(atISO, title, body, itemId, kind){
        const d = new Date(atISO);
        if(Number.isNaN(d.getTime())) return null;
        const r = {
          id: uid(),
          at: d.toISOString(),
          title: String(title||"Recordatorio"),
          body: String(body||""),
          itemId: itemId || null,
          kind: kind || "generic",
          createdAt: new Date().toISOString(),
          firedAt: null
        };
        reminders.push(r);
        saveReminders();
        return r;
      }

      function scheduleReminderInHours(hours, title, body, itemId, kind){
        const h = Number(hours||0);
        if(!h) return null;
        const at = new Date(Date.now() + h*60*60*1000).toISOString();
        return scheduleReminderAt(at, title, body, itemId, kind);
      }

      // --------- Eventos internos + paquetes cortos ----------
      function makeEvent(type, payload){
        return { id: uid(), type, at: new Date().toISOString(), payload };
      }

      function applyEvent(ev){
        if(!ev || ev.type == null) return false;
        if(events.some(x => x.id === ev.id)) return false;

        let changed = false;

        if(ev.type === T.CREATE){
          const p = ev.payload || {};
          const itemId = p.i || uid();
          if(!data.some(x => x.id === itemId)){
            data.push({
              id: itemId,
              whoId: p.c || null,
              whoName: p.w || "Sin nombre",
              what: p.s || "",
              when: p.n || null,

              // recordatorio por fecha:
              remindByDateMin: Number(p.rbd || 0),

              // recordatorio en X horas:
              remindAfterHours: Number(p.rah || 0),
              remindAfterAt: p.raa || null,

              done: false,
              createdAt: p.ca || ev.at,
              doneAt: null,
              updatedAt: null
            });
            changed = true;
          } else {
            const it = data.find(x => x.id === itemId);
            if(it){
              const before = JSON.stringify(it);
              it.whoId = p.c || null;
              it.whoName = p.w || it.whoName;
              it.what = p.s ?? it.what;
              it.when = (p.n ?? it.when) || null;
              it.remindByDateMin = Number(p.rbd ?? it.remindByDateMin ?? 0);
              it.remindAfterHours = Number(p.rah ?? it.remindAfterHours ?? 0);
              it.remindAfterAt = (p.raa ?? it.remindAfterAt) || null;
              it.updatedAt = ev.at;
              changed = (JSON.stringify(it) !== before);
            }
          }
        }
        else if(ev.type === T.DONE){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it && !it.done){
            it.done = true;
            it.doneAt = ev.at;
            it.updatedAt = ev.at;
            changed = true;
          }
        }
        else if(ev.type === T.REOPEN){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it && it.done){
            it.done = false;
            it.doneAt = null;
            it.updatedAt = ev.at;
            changed = true;
          }
        }
        else if(ev.type === T.DELETE){
          const p = ev.payload || {};
          const before = data.length;
          data = data.filter(x => x.id !== p.i);
          changed = (data.length !== before);
        }
        else if(ev.type === T.EDIT){
          const p = ev.payload || {};
          const it = data.find(x => x.id === p.i);
          if(it){
            const before = JSON.stringify(it);
            if(p.w != null) it.whoName = p.w;
            if(p.c != null) it.whoId = p.c || null;
            if(p.s != null) it.what = p.s;
            if(p.n != null) it.when = p.n || null;
            if(p.rbd != null) it.remindByDateMin = Number(p.rbd || 0);
            if(p.rah != null) it.remindAfterHours = Number(p.rah || 0);
            if(p.raa != null) it.remindAfterAt = p.raa || null;
            it.updatedAt = ev.at;
            changed = (JSON.stringify(it) !== before);
          }
        }

        events.push(ev);
        save(EVENTS_KEY, events);
        save(KEY, data);

        cleanupFiredMap();
        return changed;
      }

      // Paquete compacto
      function packEvent(ev){
        return { v:1, e:{ i: ev.id, t: ev.type, a: ev.at, p: ev.payload || {} } };
      }
      function unpackEvent(pack){
        if(!pack || pack.v !== 1 || !pack.e) return null;
        const e = pack.e;
        if(!e.i || e.t == null || !e.a) return null;
        return { id: e.i, type: e.t, at: e.a, payload: e.p || {} };
      }
      function makePackage(ev){
        return b64urlEncode(JSON.stringify(packEvent(ev)));
      }
      function parsePackage(p){
        const json = b64urlDecode(p);
        return JSON.parse(json);
      }

      // ‚úÖ URL corta: generamos siempre con la carpeta (/compromisos/) aunque est√©s en compromisos.html
      function baseFolderUrl(){
        const path = location.pathname || "/";
        const folder = path.replace(/\/[^\/]*$/, "/");
        return location.origin + folder;
      }
      function makeLinkFromPackage(p){
        return baseFolderUrl() + "#p=" + p;
      }

      function shortPreview(text, n){
        const s = String(text||"").trim();
        if(s.length <= n) return s;
        return s.slice(0, n-1) + "‚Ä¶";
      }

      // --------- Compartir (modal con mensaje bonito) ----------
      let shareState = {
        title: "",
        shortText: "",
        longText: "",
        url: "",
        mode: "short",
        who: "",
        what: "",
        itemId: null
      };

      function openShareModal(){
        $("shareBackdrop").classList.add("show");
        $("shareBackdrop").setAttribute("aria-hidden","false");
        $("shareAfter").value = "0";
        updateShareUI();
      }
      function closeShareModal(){
        $("shareBackdrop").classList.remove("show");
        $("shareBackdrop").setAttribute("aria-hidden","true");
      }

      function updateShareUI(){
        $("shareShort").classList.toggle("active", shareState.mode === "short");
        $("shareLong").classList.toggle("active", shareState.mode === "long");
        $("shareTitle").innerHTML = `<b>${escapeHtml(shareState.title || "Compartir")}</b>`;

        const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
        $("shareTextBox").textContent = msg || "";
        $("shareUrlBox").textContent = shareState.url || "";
      }

      async function copyToClipboard(text){
        try{
          await navigator.clipboard.writeText(text);
          toast("Copiado ‚úÖ");
          return true;
        }catch(e){
          prompt("Copia este texto:", text);
          return true;
        }
      }

      async function copyLinkOnly(url){
        if(!url){ toast("No hay enlace"); return; }
        await copyToClipboard(url);
      }

      async function doShare(){
        const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
        const payload = {
          title: shareState.title || "Compromisos",
          text: msg,
          url: shareState.url
        };

        try{
          if(navigator.share){
            await navigator.share(payload);
            toast("Enviado ‚úÖ");
            closeShareModal();
            return true;
          }
        }catch(e){
          // usuario cancel√≥ o error -> fallback
        }

        const combined = (payload.title ? payload.title + "\n" : "") + (payload.text ? payload.text + "\n" : "") + payload.url;
        await copyToClipboard(combined);
        closeShareModal();
        return true;
      }

      function eventTitle(type){
        if(type === T.CREATE) return "üìå Nuevo/Actualizado";
        if(type === T.EDIT) return "‚úçÔ∏è Compromiso editado";
        if(type === T.DONE) return "‚úÖ Compromiso finalizado";
        if(type === T.REOPEN) return "‚Ü©Ô∏è Compromiso reabierto";
        if(type === T.DELETE) return "üóëÔ∏è Compromiso eliminado";
        return "üì¶ Paquete";
      }

      function buildShareMessages(ev, itemMaybe){
        const it = itemMaybe || (ev?.payload?.i ? data.find(x => x.id === ev.payload.i) : null);

        const who = it ? normalizedWho(it) : (ev?.payload?.w || "Sin nombre");
        const what = it ? shortPreview(it.what, 120) : shortPreview(ev?.payload?.s || "", 120);
        const whenTxt = it?.when ? fmtDate(it.when) : (ev?.payload?.n ? fmtDate(ev.payload.n) : "Sin fecha");
        const byDateTxt = (it && it.when && Number(it.remindByDateMin||0) > 0) ? remindLabelByDate(it.remindByDateMin) : "";
        const afterTxt = (it && Number(it.remindAfterHours||0) > 0) ? remindLabelAfter(it.remindAfterHours) : "";

        const title = eventTitle(ev.type);

        const shortMsg =
          `${title}\n` +
          `üë§ ${who}\n` +
          (what ? `üìù ${shortPreview(what, 70)}\n` : "") +
          (it?.when ? `‚è∞ ${whenTxt}\n` : "") +
          ((byDateTxt || afterTxt) ? `${byDateTxt ? byDateTxt+" " : ""}${afterTxt}\n` : "") +
          `üîó Abre el enlace para importar en la app.`;

        const longMsg =
          `${title}\n` +
          `üë§ Con: ${who}\n` +
          (what ? `üìù ${what}\n` : "") +
          `‚è∞ Para: ${whenTxt}\n` +
          ((byDateTxt || afterTxt) ? `üîî Recordatorios: ${byDateTxt ? "por fecha ("+byDateTxt+")" : ""}${byDateTxt && afterTxt ? " + " : ""}${afterTxt ? "en horas ("+afterTxt+")" : ""}\n` : "") +
          `üîó Abre el enlace para importar en la app.`;

        return { title, shortMsg, longMsg, who, what };
      }

      async function prepareShare(ev, itemMaybe){
        const p = makePackage(ev);
        const link = makeLinkFromPackage(p);

        $("lastLink").textContent = "√öltimo enlace:\n" + link;
        $("lastLinkRow").style.display = "";
        $("lastLinkRow").classList.add("show");

        const msgs = buildShareMessages(ev, itemMaybe);

        shareState.title = msgs.title;
        shareState.shortText = msgs.shortMsg;
        shareState.longText = msgs.longMsg;
        shareState.url = link;
        shareState.mode = "short";
        shareState.who = msgs.who;
        shareState.what = msgs.what;
        shareState.itemId = (itemMaybe && itemMaybe.id) ? itemMaybe.id : (ev?.payload?.i || null);

        openShareModal();
      }

      // --------- UI: tabs ----------
      function setPane(newPane){
        pane = newPane;
        $("tabCommitments").classList.toggle("active", pane==="commitments");
        $("tabContacts").classList.toggle("active", pane==="contacts");
        $("tabSettings").classList.toggle("active", pane==="settings");

        $("commitmentsPane").style.display = (pane==="commitments") ? "" : "none";
        $("contactsPane").style.display = (pane==="contacts") ? "" : "none";
        $("settingsPane").style.display = (pane==="settings") ? "" : "none";

        if(pane === "settings"){
          $("fab").style.display = "none";
        } else {
          $("fab").style.display = "grid";
          $("fab").setAttribute("aria-label", pane==="contacts" ? "Nuevo contacto" : "Nuevo compromiso");
        }

        renderAll();
      }

      // --------- Render compromisos ----------
      function renderCommitments(){
        const list = $("list");
        list.innerHTML = "";

        const pending = data.filter(x => !x.done);
        const done = data.filter(x => x.done);

        $("bPending").textContent = String(pending.length);
        $("bDone").textContent = String(done.length);
        $("bContacts").textContent = String(contacts.length);

        const items = (view === "pending") ? pending : done;

        $("empty").style.display = items.length ? "none" : "block";

        items
          .sort((a,b) => {
            const ta = a.when ? new Date(a.when).getTime() : (view==="pending" ? Number.POSITIVE_INFINITY : 0);
            const tb = b.when ? new Date(b.when).getTime() : (view==="pending" ? Number.POSITIVE_INFINITY : 0);
            if(view === "pending") return ta - tb;
            return (new Date(b.doneAt||0).getTime()) - (new Date(a.doneAt||0).getTime());
          })
          .forEach(item => list.appendChild(renderCard(item)));

        const k = $("statsKicker");
        const overdue = pending.filter(x => isOverdue(x.when)).length;
        k.style.display = "block";
        k.textContent = overdue ? `‚è∞ Tienes ${overdue} compromiso(s) vencido(s).` : `‚úÖ Todo en orden.`;
      }

      function renderCard(item){
        const card = document.createElement("div");
        card.className = "card";

        const who = normalizedWho(item);
        const dueText = item.when ? fmtDate(item.when) : "Sin fecha";
        const overdue = !item.done && isOverdue(item.when);
        const dueClass = overdue ? "due bad" : "due";

        const chips = [
          `<span class="chip">üìù ${escapeHtml(fmtDate(item.createdAt))}</span>`,
          item.updatedAt ? `<span class="chip">‚úçÔ∏è ${escapeHtml(fmtDate(item.updatedAt))}</span>` : "",
          item.done ? `<span class="chip">‚úÖ ${escapeHtml(fmtDate(item.doneAt))}</span>` : "",
          item.when && Number(item.remindByDateMin||0) > 0 ? `<span class="chip">${escapeHtml(remindLabelByDate(item.remindByDateMin))}</span>` : "",
          Number(item.remindAfterHours||0) > 0 ? `<span class="chip">${escapeHtml(remindLabelAfter(item.remindAfterHours))}</span>` : ""
        ].filter(Boolean).join("");

        card.innerHTML = `
          <div class="cardTop">
            <div class="who">
              <p class="name">${escapeHtml(who)}</p>
              <p class="meta">${chips}</p>
            </div>
            <div class="${dueClass}">‚è∞ ${escapeHtml(dueText)}${overdue ? " ¬∑ Vencido" : ""}</div>
          </div>
          <div class="desc">${escapeHtml(item.what || "‚Äî")}</div>
          <div class="actions"></div>
        `;

        const actions = card.querySelector(".actions");

        actions.appendChild(mkBtn("üìÖ Calendario", "btn", () => addToCalendar(item.id)));

        // üì¶ Compartir ‚Äúestado completo‚Äù siempre (CREATE como upsert)
        actions.appendChild(mkBtn("üì¶ Compartir", "btn primary", () => shareSnapshot(item.id)));

        if(!item.done){
          actions.appendChild(mkBtn("‚úÖ Hecho", "btn good", () => markDone(item.id)));
          actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openEditModal(item.id)));
          actions.appendChild(mkBtn("üóëÔ∏è", "btn danger icon", () => deleteItem(item.id), true));
        }else{
          actions.appendChild(mkBtn("‚Ü©Ô∏è Reabrir", "btn", () => reopen(item.id)));
          actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openEditModal(item.id)));
          actions.appendChild(mkBtn("üóëÔ∏è", "btn danger icon", () => deleteItem(item.id), true));
        }

        return card;
      }

      function mkBtn(text, cls, onClick, small){
        const b = document.createElement("button");
        b.className = cls;
        b.textContent = text;
        if(small){ b.classList.add("icon"); }
        b.addEventListener("click", onClick);
        return b;
      }

      // --------- Render contactos ----------
      function renderContacts(){
        const list = $("contactsList");
        list.innerHTML = "";

        $("bContacts").textContent = String(contacts.length);
        $("contactsEmpty").style.display = contacts.length ? "none" : "block";

        contacts
          .slice()
          .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
          .forEach(c => list.appendChild(renderContactCard(c)));
      }

      function renderContactCard(c){
        const card = document.createElement("div");
        card.className = "card";
        const note = c.note ? `<span class="chip">üõà ${escapeHtml(c.note)}</span>` : "";
        card.innerHTML = `
          <div class="cardTop">
            <div class="who">
              <p class="name">${escapeHtml(c.name || "Sin nombre")}</p>
              <p class="meta">
                <span class="chip">üë• Contacto</span>
                ${note}
              </p>
            </div>
            <div class="due">‚≠ê</div>
          </div>
          <div class="desc">${escapeHtml(c.note || "‚Äî")}</div>
          <div class="actions"></div>
        `;
        const actions = card.querySelector(".actions");
        actions.appendChild(mkBtn("‚úçÔ∏è Editar", "btn", () => openContactEdit(c.id)));
        actions.appendChild(mkBtn("üóëÔ∏è", "btn danger", () => deleteContact(c.id)));
        return card;
      }

      function renderAll(){
        renderCommitments();
        renderContacts();
        fillContactSelect();
        updateSettingsUI();
      }

      // --------- Modal Compromiso ----------
      let editingItemId = null;

      function openModal(){
        $("backdrop").classList.add("show");
        $("backdrop").setAttribute("aria-hidden","false");
      }
      function closeModal(){
        $("backdrop").classList.remove("show");
        $("backdrop").setAttribute("aria-hidden","true");
      }

      function resetCommitmentForm(){
        editingItemId = null;
        $("modalTitle").textContent = "Nuevo compromiso";
        $("fWhat").value = "";
        $("fWhen").value = "";
        $("fWho").value = "";
        $("fRemindByDate").value = "0";
        $("fRemindAfter").value = "0";
        fillContactSelect();
        $("fContact").value = "__custom__";
        toggleCustomWho(true);
      }

      function toggleCustomWho(show){
        $("customWhoField").style.display = show ? "" : "none";
      }

      function toInputDatetimeLocal(iso){
        if(!iso) return "";
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return "";
        const yyyy = d.getFullYear();
        const mm = pad2(d.getMonth()+1);
        const dd = pad2(d.getDate());
        const hh = pad2(d.getHours());
        const mi = pad2(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }

      function openEditModal(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }

        editingItemId = itemId;
        $("modalTitle").textContent = "Editar compromiso";

        fillContactSelect();
        if(it.whoId && contactById(it.whoId)){
          $("fContact").value = it.whoId;
          toggleCustomWho(false);
          $("fWho").value = "";
        } else {
          $("fContact").value = "__custom__";
          toggleCustomWho(true);
          $("fWho").value = it.whoName || "";
        }

        $("fWhat").value = it.what || "";
        $("fWhen").value = toInputDatetimeLocal(it.when);
        $("fRemindByDate").value = String(Number(it.remindByDateMin||0));
        $("fRemindAfter").value = String(Number(it.remindAfterHours||0));

        openModal();
        $("fWhat").focus();
      }

      // --------- Modal Contacto ----------
      let editingContactId = null;

      function openContactModal(){
        $("cBackdrop").classList.add("show");
        $("cBackdrop").setAttribute("aria-hidden","false");
      }
      function closeContactModal(){
        $("cBackdrop").classList.remove("show");
        $("cBackdrop").setAttribute("aria-hidden","true");
      }
      function resetContactForm(){
        editingContactId = null;
        $("cModalTitle").textContent = "Nuevo contacto";
        $("cName").value = "";
        $("cNote").value = "";
      }

      function openContactEdit(id){
        const c = contacts.find(x => x.id === id);
        if(!c){ toast("Contacto no encontrado"); return; }
        editingContactId = id;
        $("cModalTitle").textContent = "Editar contacto";
        $("cName").value = c.name || "";
        $("cNote").value = c.note || "";
        openContactModal();
        $("cName").focus();
      }

      // --------- Contact select ----------
      function fillContactSelect(){
        const sel = $("fContact");
        const current = sel.value;
        sel.innerHTML = "";

        const optCustom = document.createElement("option");
        optCustom.value = "__custom__";
        optCustom.textContent = "‚úçÔ∏è Escribir un nombre (sin guardar)";
        sel.appendChild(optCustom);

        if(contacts.length){
          const sep = document.createElement("option");
          sep.disabled = true;
          sep.textContent = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
          sel.appendChild(sep);

          contacts
            .slice()
            .sort((a,b) => (a.name||"").localeCompare(b.name||"", "es"))
            .forEach(c => {
              const o = document.createElement("option");
              o.value = c.id;
              o.textContent = "üë§ " + (c.name || "Sin nombre");
              sel.appendChild(o);
            });
        }

        const optNew = document.createElement("option");
        optNew.value = "__new_contact__";
        optNew.textContent = "‚ûï Crear contacto‚Ä¶";
        sel.appendChild(optNew);

        if(current){
          sel.value = current;
          if(sel.value !== current) sel.value = "__custom__";
        } else {
          sel.value = "__custom__";
        }
      }

      function onContactSelectChanged(){
        const v = $("fContact").value;
        if(v === "__custom__"){
          toggleCustomWho(true);
          return;
        }
        if(v === "__new_contact__"){
          resetContactForm();
          openContactModal();
          $("cName").focus();
          $("fContact").value = "__custom__";
          toggleCustomWho(true);
          return;
        }
        toggleCustomWho(false);
        $("fWho").value = "";
      }

      // --------- Acciones compromisos ----------
      function createOrEditCommitment(){
        const contactSel = $("fContact").value;
        const what = $("fWhat").value.trim();
        const whenISO = $("fWhen").value ? new Date($("fWhen").value).toISOString() : null;

        const remindByDateMin = Number($("fRemindByDate").value || 0);
        const remindAfterHours = Number($("fRemindAfter").value || 0);

        if(!what){
          toast("Escribe qu√© se acord√≥");
          $("fWhat").focus();
          return null;
        }

        let whoId = null;
        let whoName = "";

        if(contactSel && contactSel !== "__custom__" && contactSel !== "__new_contact__"){
          const c = contactById(contactSel);
          if(!c){ toast("Contacto no v√°lido"); return null; }
          whoId = c.id;
          whoName = c.name || "Sin nombre";
        } else {
          whoName = $("fWho").value.trim();
          if(!whoName){
            toast("Pon con qui√©n es el compromiso");
            $("fWho").focus();
            return null;
          }
        }

        // Validaciones recordatorio por fecha
        if(remindByDateMin > 0 && !whenISO){
          toast("Para recordatorio por fecha necesitas una fecha");
          $("fWhen").focus();
          return null;
        }

        const now = new Date().toISOString();

        // Recordatorio en X horas: calculamos at absoluto (aunque haya fecha)
        const remindAfterAt = (remindAfterHours > 0)
          ? new Date(Date.now() + remindAfterHours*60*60*1000).toISOString()
          : null;

        if(!editingItemId){
          const itemId = uid();
          const ev = {
            id: uid(),
            type: T.CREATE,
            at: now,
            payload: {
              i: itemId,
              c: whoId || null,
              w: whoName,
              s: what,
              n: whenISO || null,
              rbd: remindByDateMin || 0,
              rah: remindAfterHours || 0,
              raa: remindAfterAt || null,
              ca: now
            }
          };
          const changed = applyEvent(ev);
          if(!changed){ toast("No se pudo guardar"); return null; }

          // Programar recordatorio ‚Äúen X horas‚Äù al crear
          if(remindAfterHours > 0){
            scheduleReminderAt(
              remindAfterAt,
              `‚è∞ Compromiso: ${whoName}`,
              shortPreview(what, 120),
              itemId,
              "after_create"
            );
          }

          return { itemId, ev };
        } else {
          const it = data.find(x => x.id === editingItemId);
          if(!it){ toast("No encontrado"); return null; }

          const ev = {
            id: uid(),
            type: T.EDIT,
            at: now,
            payload: {
              i: editingItemId,
              c: whoId || null,
              w: whoName,
              s: what,
              n: whenISO || null,
              rbd: remindByDateMin || 0,
              rah: remindAfterHours || 0,
              raa: remindAfterAt || null
            }
          };

          const changed = applyEvent(ev);
          if(!changed){ toast("Sin cambios"); return null; }

          // Programar recordatorio ‚Äúen X horas‚Äù al editar (sobrescribe, pero lo dejamos simple)
          if(remindAfterHours > 0){
            scheduleReminderAt(
              remindAfterAt,
              `‚è∞ Compromiso: ${whoName}`,
              shortPreview(what, 120),
              editingItemId,
              "after_edit"
            );
          }

          return { itemId: editingItemId, ev };
        }
      }

      async function markDone(itemId){
        const ev = makeEvent(T.DONE, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Marcado como hecho ‚úÖ");
          await prepareShare(ev, data.find(x => x.id === itemId));
        } else toast("Sin cambios");
      }

      async function reopen(itemId){
        const ev = makeEvent(T.REOPEN, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Reabierto");
          await prepareShare(ev, data.find(x => x.id === itemId));
        } else toast("Sin cambios");
      }

      async function deleteItem(itemId){
        const ok = confirm("¬øEliminar este compromiso?");
        if(!ok) return;
        const ev = makeEvent(T.DELETE, { i: itemId });
        const changed = applyEvent(ev);
        renderAll();
        if(changed){
          toast("Eliminado");
          await prepareShare(ev, { id:itemId, whoName:"(eliminado)", what:"", when:null, remindByDateMin:0, remindAfterHours:0, done:false });
        } else {
          toast("Sin cambios");
        }
      }

      // üì¶ Compartir ‚Äúestado completo‚Äù (CREATE como upsert) -> √∫til si el otro a√∫n no lo ten√≠a
      async function shareSnapshot(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }
        const ev = {
          id: uid(),
          type: T.CREATE,
          at: new Date().toISOString(),
          payload: {
            i: it.id,
            c: it.whoId || null,
            w: normalizedWho(it),
            s: it.what || "",
            n: it.when || null,
            rbd: Number(it.remindByDateMin || 0),
            rah: Number(it.remindAfterHours || 0),
            raa: it.remindAfterAt || null,
            ca: it.createdAt || new Date().toISOString()
          }
        };
        await prepareShare(ev, it);
      }

      // --------- Contactos ----------
      function upsertContact(name, note){
        const n = String(name||"").trim();
        if(!n){ toast("Pon un nombre"); return null; }

        if(!editingContactId){
          const c = { id: uid(), name: n, note: String(note||"").trim(), createdAt: new Date().toISOString() };
          contacts.push(c);
          save(CONTACTS_KEY, contacts);
          return c;
        } else {
          const c = contacts.find(x => x.id === editingContactId);
          if(!c){ toast("No encontrado"); return null; }
          c.name = n;
          c.note = String(note||"").trim();
          c.updatedAt = new Date().toISOString();
          save(CONTACTS_KEY, contacts);
          save(KEY, data);
          return c;
        }
      }

      function deleteContact(id){
        const ok = confirm("¬øEliminar este contacto?");
        if(!ok) return;

        data.forEach(it => {
          if(it.whoId === id){
            it.whoName = normalizedWho(it);
            it.whoId = null;
          }
        });
        contacts = contacts.filter(x => x.id !== id);

        save(CONTACTS_KEY, contacts);
        save(KEY, data);

        renderAll();
        toast("Contacto eliminado");
      }

      // --------- Import desde URL ----------
      function tryImportFromUrl(){
        const h = location.hash || "";
        const m = h.match(/#p=([A-Za-z0-9\-_]+)/);
        if(!m) return false;

        const p = m[1];
        try{
          const pack = parsePackage(p);
          const ev = unpackEvent(pack);
          if(!ev) throw new Error("Paquete inv√°lido");

          const applied = applyEvent(ev);
          renderAll();

          history.replaceState(null, "", baseFolderUrl());

          toast(applied ? "Paquete importado ‚úÖ" : "Paquete ya aplicado (o sin cambios)");
          return true;
        }catch(e){
          history.replaceState(null, "", baseFolderUrl());
          toast("No se pudo importar el paquete");
          return false;
        }
      }

      // --------- PWA / instalaci√≥n / abrir en Chrome ----------
      const isAndroid = /Android/i.test(navigator.userAgent || "");
      const isStandalone = window.matchMedia && window.matchMedia("(display-mode: standalone)").matches;
      const isIOSStandalone = !!navigator.standalone;
      const isInAppBrowser = (function(){
        const ua = (navigator.userAgent || "").toLowerCase();
        return ua.includes("wv") || ua.includes("webview") ||
               ua.includes("instagram") ||
               ua.includes("fbav") || ua.includes("fb_iab") ||
               ua.includes("telegram") ||
               ua.includes("whatsapp");
      })();

      let deferredPrompt = null;

      function showBanner(mode){
        const banner = $("installBanner");
        const title = $("installTitle");
        const text = $("installText");
        const bInstall = $("btnInstallBanner");
        const bOpen = $("btnOpenChrome");
        const bCopy = $("btnCopyLink");

        bInstall.style.display = "none";
        bOpen.style.display = "none";
        bCopy.style.display = "none";

        if(mode === "openchrome"){
          title.textContent = "√Åbrelo en Chrome para instalarla";
          text.innerHTML = "Est√°s en un navegador interno (WhatsApp/Telegram). Para instalar, toca <b>Abrir en Chrome</b>.";
          bOpen.style.display = "flex";
          bCopy.style.display = "flex";
        } else if(mode === "install"){
          title.textContent = "Inst√°lala para usarla como app";
          text.innerHTML = "Pulsa <b>Instalar</b>. Luego se abrir√° como una app normal desde el icono.";
          bInstall.style.display = "flex";
        } else {
          title.textContent = "Consejo";
          text.innerHTML = "Si no ves ‚ÄúInstalar‚Äù en el men√∫, abre en <b>Chrome</b> o instala desde el men√∫ <b>‚ãÆ</b>.";
          bCopy.style.display = "flex";
          if(isInAppBrowser) bOpen.style.display = "flex";
        }

        banner.classList.add("show");
      }

      function hideBanner(){ $("installBanner").classList.remove("show"); }

      async function copyCurrentLink(){
        try{
          await navigator.clipboard.writeText(location.href);
          toast("Enlace copiado ‚úÖ");
        }catch(e){
          prompt("Copia este enlace:", location.href);
        }
      }

      function openInChrome(){
        const url = location.href;
        if(isAndroid){
          try{
            const u = new URL(url);
            const path = (u.pathname || "/") + (u.search || "") + (u.hash || "");
            const intent = "intent://" + u.host + path + "#Intent;scheme=https;package=com.android.chrome;end";
            location.href = intent;
            return;
          }catch(e){}
        }
        try{
          window.open(url, "_blank");
        }catch(e){
          copyCurrentLink();
          toast("Copia el enlace y p√©galo en Chrome");
        }
      }

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        $("btnInstall").style.display = "flex";
      });

      $("btnInstall").addEventListener("click", async () => {
        if(!deferredPrompt){
          showBanner(isInAppBrowser ? "openchrome" : "info");
          return;
        }
        deferredPrompt.prompt();
        try{ await deferredPrompt.userChoice; }catch(e){}
        deferredPrompt = null;
        $("btnInstall").style.display = "none";
      });

      $("btnInstallBanner").addEventListener("click", async () => {
        if(!deferredPrompt){
          if(isInAppBrowser){ openInChrome(); return; }
          showBanner("info");
          return;
        }
        deferredPrompt.prompt();
        try{ await deferredPrompt.userChoice; }catch(e){}
        deferredPrompt = null;
        $("btnInstall").style.display = "none";
        hideBanner();
      });

      $("btnOpenChrome").addEventListener("click", openInChrome);
      $("btnCopyLink").addEventListener("click", copyCurrentLink);
      $("btnHideBanner").addEventListener("click", hideBanner);

      // --------- PIN overlay / teclado ----------
      let pinBuf = "";

      function setDots(n){
        $("d1").classList.toggle("on", n>=1);
        $("d2").classList.toggle("on", n>=2);
        $("d3").classList.toggle("on", n>=3);
        $("d4").classList.toggle("on", n>=4);
      }

      function showLockOverlay(){
        if(!settings.pinEnabled) return;
        pinBuf = "";
        setDots(0);
        $("lockOverlay").classList.add("show");
        $("lockOverlay").setAttribute("aria-hidden","false");
      }
      function hideLockOverlay(){
        $("lockOverlay").classList.remove("show");
        $("lockOverlay").setAttribute("aria-hidden","true");
      }

      async function tryUnlockWithPin(pin){
        const ok = await verifyPin(pin);
        if(ok){
          applyUnlock();
          hideLockOverlay();
          toast("Desbloqueado ‚úÖ");
        } else {
          pinBuf = "";
          setDots(0);
          toast("PIN incorrecto");
        }
      }

      $("keypad").addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        const k = btn.getAttribute("data-k");
        if(!k) return;

        if(k === "del"){
          pinBuf = pinBuf.slice(0, -1);
          setDots(pinBuf.length);
          return;
        }
        if(k === "ok"){
          if(pinBuf.length !== 4){ toast("Introduce 4 d√≠gitos"); return; }
          await tryUnlockWithPin(pinBuf);
          return;
        }
        if(/^\d$/.test(k)){
          if(pinBuf.length >= 4) return;
          pinBuf += k;
          setDots(pinBuf.length);
          if(pinBuf.length === 4){
            await tryUnlockWithPin(pinBuf);
          }
        }
      });

      $("btnLockCopyLink").addEventListener("click", copyCurrentLink);
      $("btnLockReset").addEventListener("click", () => {
        const ok = confirm("Esto borrar√° TODO (compromisos, contactos y PIN). ¬øSeguro?");
        if(!ok) return;
        localStorage.clear();
        location.replace(baseFolderUrl());
      });

      document.addEventListener("visibilitychange", () => {
        if(!settings.pinEnabled) return;
        if(document.visibilityState === "hidden"){
          const m = Number(settings.autoLockMin || 0);
          lockAtTs = (m === 0) ? Date.now() : (Date.now() + m*60*1000);
        } else {
          if(lockAtTs && Date.now() >= lockAtTs){
            forceLock();
          }
          lockAtTs = 0;
        }
      });

      // --------- Modal PIN config ----------
      let pinMode = "enable";
      function openPinModal(mode){
        pinMode = mode;
        $("pinBackdrop").classList.add("show");
        $("pinBackdrop").setAttribute("aria-hidden","false");

        $("pinOld").value = "";
        $("pinNew").value = "";
        $("pinNew2").value = "";

        if(mode === "enable"){
          $("pinTitle").textContent = "Activar PIN";
          $("pinHint").textContent = "Crea un PIN de 4 d√≠gitos para bloquear la app.";
          $("pinOldWrap").style.display = "none";
          $("pinNewWrap").style.display = "";
          $("pinNew2Wrap").style.display = "";
        } else if(mode === "change"){
          $("pinTitle").textContent = "Cambiar PIN";
          $("pinHint").textContent = "Introduce tu PIN actual y el nuevo PIN.";
          $("pinOldWrap").style.display = "";
          $("pinNewWrap").style.display = "";
          $("pinNew2Wrap").style.display = "";
        } else if(mode === "disable"){
          $("pinTitle").textContent = "Desactivar PIN";
          $("pinHint").textContent = "Introduce tu PIN actual para desactivarlo.";
          $("pinOldWrap").style.display = "";
          $("pinNewWrap").style.display = "none";
          $("pinNew2Wrap").style.display = "none";
        }

        setTimeout(()=> {
          const el = (mode === "enable") ? $("pinNew") : $("pinOld");
          try{ el.focus(); }catch(e){}
        }, 60);
      }
      function closePinModal(){
        $("pinBackdrop").classList.remove("show");
        $("pinBackdrop").setAttribute("aria-hidden","true");
      }

      function clampPinInput(el){
        el.value = normalizePin(el.value);
      }
      ["pinOld","pinNew","pinNew2"].forEach(id => {
        $(id).addEventListener("input", () => clampPinInput($(id)));
      });

      $("pinClose").addEventListener("click", closePinModal);
      $("pinCancel").addEventListener("click", closePinModal);
      $("pinBackdrop").addEventListener("click", (e)=>{ if(e.target === $("pinBackdrop")) closePinModal(); });

      $("pinOk").addEventListener("click", async () => {
        try{
          if(pinMode === "enable"){
            const p1 = normalizePin($("pinNew").value);
            const p2 = normalizePin($("pinNew2").value);
            if(p1.length !== 4) { toast("PIN inv√°lido"); return; }
            if(p1 !== p2) { toast("Los PIN no coinciden"); return; }
            await setPin(p1);
            settings.pinEnabled = true;
            settings.unlockUntil = 0;
            sessionUnlocked = false;
            save(SETTINGS_KEY, settings);
            updateSettingsUI();
            closePinModal();
            toast("PIN activado ‚úÖ");
            forceLock();
            return;
          }

          if(pinMode === "change"){
            const oldp = normalizePin($("pinOld").value);
            if(oldp.length !== 4) { toast("PIN actual inv√°lido"); return; }
            const ok = await verifyPin(oldp);
            if(!ok){ toast("PIN actual incorrecto"); return; }

            const p1 = normalizePin($("pinNew").value);
            const p2 = normalizePin($("pinNew2").value);
            if(p1.length !== 4) { toast("Nuevo PIN inv√°lido"); return; }
            if(p1 !== p2) { toast("Los PIN no coinciden"); return; }

            await setPin(p1);
            settings.pinEnabled = true;
            settings.unlockUntil = 0;
            sessionUnlocked = false;
            save(SETTINGS_KEY, settings);
            updateSettingsUI();
            closePinModal();
            toast("PIN cambiado ‚úÖ");
            forceLock();
            return;
          }

          if(pinMode === "disable"){
            const oldp = normalizePin($("pinOld").value);
            if(oldp.length !== 4) { toast("PIN inv√°lido"); return; }
            const ok = await verifyPin(oldp);
            if(!ok){ toast("PIN incorrecto"); return; }

            setPinEnabled(false);
            closePinModal();
            hideLockOverlay();
            toast("PIN desactivado");
            return;
          }
        }catch(e){
          toast("No se pudo aplicar el PIN");
        }
      });

      function toggleSwitchPin(){
        if(settings.pinEnabled){
          openPinModal("disable");
        } else {
          openPinModal("enable");
        }
      }

      function resetAll(){
        const ok = confirm("Esto borrar√° TODO (compromisos, contactos y ajustes). ¬øSeguro?");
        if(!ok) return;
        localStorage.clear();
        location.replace(baseFolderUrl());
      }

      // --------- RECORDATORIOS (local) ----------
      function firedKey(it){
        return `${it.id}|${it.when||""}|${Number(it.remindByDateMin||0)}|${it.done?"1":"0"}`;
      }

      function cleanupFiredMap(){
        const live = new Set();
        for(const it of data){
          if(it.done) continue;
          if(!it.when) continue;
          if(Number(it.remindByDateMin||0) <= 0) continue;
          live.add(firedKey(it));
        }
        const next = {};
        for(const k of Object.keys(firedMap||{})){
          if(live.has(k)) next[k] = firedMap[k];
        }
        firedMap = next;
        save(REMIND_FIRED_KEY, firedMap);
      }

      function canNotify(){
        if(!settings.notifEnabled) return false;
        if(!notifSupported()) return false;
        return notifPermission() === "granted";
      }

      function sendLocalNotification(title, body){
        try{
          if(canNotify()){
            new Notification(title, { body });
            return true;
          }
        }catch(e){}
        return false;
      }

      // Recordatorios por fecha (antes de ‚Äúwhen‚Äù)
      function checkRemindersByDate(){
        const now = Date.now();
        for(const it of data){
          if(it.done) continue;
          const rm = Number(it.remindByDateMin||0);
          if(!it.when || rm <= 0) continue;

          const due = new Date(it.when).getTime();
          if(Number.isNaN(due)) continue;

          const trigger = due - rm*60*1000;

          if(now < trigger) continue;
          if(now > due + 30*60*1000) continue;

          const k = firedKey(it);
          if(firedMap && firedMap[k]) continue;

          const who = normalizedWho(it);
          const what = shortPreview(it.what, 80);
          const dueTxt = fmtDate(it.when);

          const title = `‚è∞ Compromiso: ${who}`;
          const body = (what ? what + " ¬∑ " : "") + `Para: ${dueTxt}`;

          sendLocalNotification(title, body);
          toast(`‚è∞ Recordatorio: ${who}`);

          firedMap[k] = now;
          save(REMIND_FIRED_KEY, firedMap);
        }
      }

      // Recordatorios absolutos (en X horas)
      function checkAbsoluteReminders(){
        const now = Date.now();
        let changed = false;

        for(const r of reminders){
          if(r.firedAt) continue;
          const t = new Date(r.at).getTime();
          if(Number.isNaN(t)) { r.firedAt = "invalid"; changed = true; continue; }

          // Ventana: dispara si est√° vencido pero no hace m√°s de 2h
          if(now >= t && now <= (t + 2*60*60*1000)){
            sendLocalNotification(r.title, r.body);
            toast(`üîî ${r.title}`);
            r.firedAt = new Date().toISOString();
            changed = true;
          }
        }

        if(changed) saveReminders();
      }

      // --------- Calendario (.ics) ----------
      function dtToICS(iso){
        const d = new Date(iso);
        if(Number.isNaN(d.getTime())) return null;
        const y = d.getUTCFullYear();
        const m = pad2(d.getUTCMonth()+1);
        const da = pad2(d.getUTCDate());
        const h = pad2(d.getUTCHours());
        const mi = pad2(d.getUTCMinutes());
        const s = pad2(d.getUTCSeconds());
        return `${y}${m}${da}T${h}${mi}${s}Z`;
      }

      function makeICSForItem(it){
        if(!it.when) return null;

        const dtStart = dtToICS(it.when);
        if(!dtStart) return null;

        const startMs = new Date(it.when).getTime();
        const endMs = startMs + 15*60*1000;
        const dtEnd = dtToICS(new Date(endMs).toISOString());

        const who = normalizedWho(it);
        const summary = `Compromiso: ${who}`;
        const desc = (it.what || "").replaceAll("\n","\\n");
        const uidv = `${it.id}@compromisos.local`;
        const stamp = dtToICS(new Date().toISOString());

        return [
          "BEGIN:VCALENDAR",
          "VERSION:2.0",
          "PRODID:-//Compromisos//Local//ES",
          "CALSCALE:GREGORIAN",
          "METHOD:PUBLISH",
          "BEGIN:VEVENT",
          `UID:${uidv}`,
          `DTSTAMP:${stamp}`,
          `DTSTART:${dtStart}`,
          `DTEND:${dtEnd}`,
          `SUMMARY:${summary}`,
          `DESCRIPTION:${desc}`,
          "END:VEVENT",
          "END:VCALENDAR"
        ].join("\r\n");
      }

      async function addToCalendar(itemId){
        const it = data.find(x => x.id === itemId);
        if(!it){ toast("No encontrado"); return; }
        if(!it.when){ toast("Pon una fecha para usar calendario"); return; }

        const ics = makeICSForItem(it);
        if(!ics){ toast("No se pudo crear el evento"); return; }

        const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
        const filename = `compromiso_${itemId}.ics`;

        try{
          if(navigator.canShare && navigator.share){
            const file = new File([blob], filename, { type: "text/calendar" });
            if(navigator.canShare({ files: [file] })){
              await navigator.share({
                title: "A√±adir al calendario",
                text: "Abre el archivo para a√±adirlo a tu calendario.",
                files: [file]
              });
              toast("Evento listo ‚úÖ");
              return;
            }
          }
        }catch(e){}

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=> URL.revokeObjectURL(url), 1200);
        toast("Descargado .ics ‚úÖ (√°brelo)");
      }

      // --------- Notif switch ----------
      function toggleSwitchNotif(){
        if(!settings.notifEnabled){
          if(notifSupported() && notifPermission() !== "granted"){
            requestNotifPermission().then(ok => {
              if(ok) setNotifEnabled(true);
              else setNotifEnabled(false);
            });
          } else {
            setNotifEnabled(true);
          }
        } else {
          setNotifEnabled(false);
        }
      }

      // --------- Modal Compartir handlers ----------
      $("shareClose").addEventListener("click", closeShareModal);
      $("shareCancel").addEventListener("click", closeShareModal);
      $("shareBackdrop").addEventListener("click", (e)=>{ if(e.target === $("shareBackdrop")) closeShareModal(); });

      $("shareShort").addEventListener("click", ()=>{ shareState.mode="short"; updateShareUI(); });
      $("shareLong").addEventListener("click", ()=>{ shareState.mode="long"; updateShareUI(); });

      $("shareCopyLink").addEventListener("click", async ()=>{
        await copyLinkOnly(shareState.url);
      });

      $("shareCopyAll").addEventListener("click", async ()=>{
        const msg = (shareState.mode === "long") ? shareState.longText : shareState.shortText;
        const combined = (shareState.title ? shareState.title + "\n" : "") + (msg ? msg + "\n" : "") + shareState.url;
        await copyToClipboard(combined);
      });

      $("shareSend").addEventListener("click", doShare);

      $("shareSchedule").addEventListener("click", () => {
        const h = Number($("shareAfter").value || 0);
        if(!h){ toast("Elige horas"); return; }
        const who = shareState.who || "compromiso";
        const what = shareState.what || "";
        const r = scheduleReminderInHours(
          h,
          `üîî Revisa: ${who}`,
          what ? shortPreview(what, 160) : "Recordatorio despu√©s de compartir",
          shareState.itemId,
          "after_share"
        );
        if(r){
          toast(`Recordatorio en ${h}h ‚úÖ`);
          $("shareAfter").value = "0";
        } else {
          toast("No se pudo programar");
        }
      });

      // Bot√≥n copiar ‚Äú√∫ltimo enlace‚Äù en la cabecera del hero
      $("btnCopyLastLink").addEventListener("click", async () => {
        const txt = $("lastLink").textContent || "";
        const m = txt.match(/https?:\/\/\S+/);
        if(!m){ toast("No hay enlace"); return; }
        await copyLinkOnly(m[0]);
      });

      // --------- UI Eventos ----------
      $("tabCommitments").addEventListener("click", ()=> setPane("commitments"));
      $("tabContacts").addEventListener("click", ()=> setPane("contacts"));
      $("tabSettings").addEventListener("click", ()=> setPane("settings"));

      $("tabPending").addEventListener("click", () => {
        view = "pending";
        $("tabPending").classList.add("active");
        $("tabDone").classList.remove("active");
        renderCommitments();
      });
      $("tabDone").addEventListener("click", () => {
        view = "done";
        $("tabDone").classList.add("active");
        $("tabPending").classList.remove("active");
        renderCommitments();
      });

      $("fab").addEventListener("click", () => {
        if(pane === "contacts"){
          resetContactForm();
          openContactModal();
          $("cName").focus();
          return;
        }
        resetCommitmentForm();
        openModal();
        $("fContact").focus();
      });

      $("btnClose").addEventListener("click", closeModal);
      $("btnCancel").addEventListener("click", closeModal);
      $("backdrop").addEventListener("click", (e)=>{ if(e.target === $("backdrop")) closeModal(); });

      $("fContact").addEventListener("change", onContactSelectChanged);

      $("btnSave").addEventListener("click", async () => {
        const res = createOrEditCommitment();
        if(!res) return;

        closeModal();
        renderAll();

        toast(editingItemId ? "Actualizado ‚úÖ" : "Guardado ‚úÖ");
        await prepareShare(res.ev, data.find(x => x.id === res.itemId));
      });

      // Contact modal
      $("cBtnClose").addEventListener("click", closeContactModal);
      $("cBtnCancel").addEventListener("click", closeContactModal);
      $("cBackdrop").addEventListener("click", (e)=>{ if(e.target === $("cBackdrop")) closeContactModal(); });

      $("cBtnSave").addEventListener("click", () => {
        const c = upsertContact($("cName").value, $("cNote").value);
        if(!c) return;

        closeContactModal();
        renderAll();
        toast("Contacto guardado ‚úÖ");

        fillContactSelect();
        if(pane === "commitments"){
          $("fContact").value = c.id;
          toggleCustomWho(false);
        }
      });

      // Ajustes
      $("swPin").addEventListener("click", toggleSwitchPin);
      $("swPin").addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggleSwitchPin(); } });

      $("swNotif").addEventListener("click", toggleSwitchNotif);
      $("swNotif").addEventListener("keydown", (e)=>{ if(e.key==="Enter" || e.key===" "){ e.preventDefault(); toggleSwitchNotif(); } });

      $("btnNotifPerm").addEventListener("click", requestNotifPermission);

      $("selAutoLock").addEventListener("change", () => {
        settings.autoLockMin = Number($("selAutoLock").value || 0);
        save(SETTINGS_KEY, settings);
        toast("Auto-bloqueo actualizado");
      });
      $("selRemember").addEventListener("change", () => {
        settings.rememberMin = Number($("selRemember").value || 0);
        save(SETTINGS_KEY, settings);
        toast("Recordar desbloqueo actualizado");
      });

      $("btnChangePin").addEventListener("click", () => {
        if(!settings.pinEnabled){ toast("Activa primero el PIN"); return; }
        openPinModal("change");
      });

      $("btnLockNow").addEventListener("click", () => {
        if(!settings.pinEnabled){
          toast("Activa el PIN para bloquear");
          setPane("settings");
          return;
        }
        forceLock();
      });

      $("btnResetAll").addEventListener("click", resetAll);

      // --------- Service worker ----------
      (async function registerSW(){
        if(!("serviceWorker" in navigator)) return;
        try{
          await navigator.serviceWorker.register("./sw.js", { scope: "./" });
        }catch(e){}
      })();

      // --------- Boot ----------
      updateSettingsUI();
      renderAll();
      tryImportFromUrl();
      cleanupFiredMap();

      setTimeout(() => {
        if(isStandalone || isIOSStandalone) return;
        if(isInAppBrowser){
          showBanner("openchrome");
        } else {
          showBanner(deferredPrompt ? "install" : "info");
        }
      }, 650);

      // Demo inicial
      if(data.length === 0){
        const now = new Date().toISOString();
        const ev = {
          id: uid(),
          type: T.CREATE,
          at: now,
          payload: {
            i: uid(),
            c: null,
            w: "Ejemplo: Laura",
            s: "Te paso el PDF del seguro",
            n: new Date(Date.now() + 3*60*60*1000).toISOString(),
            rbd: 15,
            rah: 0,
            raa: null,
            ca: now
          }
        };
        applyEvent(ev);
        renderAll();
      }

      // Aplicar bloqueo si corresponde
      if(settings.pinEnabled){
        if(!isUnlockedNow()){
          showLockOverlay();
        }
      }

      // Loop recordatorios
      function tickReminders(){
        if(settings.pinEnabled && !isUnlockedNow()) return;
        checkRemindersByDate();
        checkAbsoluteReminders();
      }
      setInterval(tickReminders, 20000);
      setTimeout(tickReminders, 1200);

    })();
  </script>
</body>
</html>